<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Codewey</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://codewey.com/"/>
  <updated>2020-05-31T11:14:36.165Z</updated>
  <id>http://codewey.com/</id>
  
  <author>
    <name>Codewey</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>依赖注入（DI）</title>
    <link href="http://codewey.com/post/Spring-IOC-04-DI/"/>
    <id>http://codewey.com/post/Spring-IOC-04-DI/</id>
    <published>2019-12-13T06:15:16.000Z</published>
    <updated>2020-05-31T11:14:36.165Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前面我们主要分析了 FileSystemXmlApplicationContext 这个具体的 IoC 容器实现类 的初始化源码，在 IoC 容器 中建立了 beanName 到 BeanDefinition 的数据映射，通过一个 ConcurrentHashMap。现在我们来看一下 Spring 是如何将 IoC 容器中存在依赖关系的 bean 根据配置联系在一起的。</p><p>Spring 中触发 IoC 容器 “依赖注入” 的方式有两种，一个是应用程序通过 getBean() 方法 向容器索要 bean 实例 时触发依赖注入；另一个是提前给 bean 配置了 lazy-init 属性为 false，Spring 在 IoC 容器 初始化会自动调用此 bean 的 getBean() 方法，提前完成依赖注入。总的来说，想提高运行时获取 bean 的效率，可以考虑配置此属性。</p><p>下面我将分别解读这两种依赖注入的触发方式，先看 getBean() 的，因为 lazy-init 最后也是通过调用 getBean() 完成的依赖注入。</p><p>（PS：可以结合我 GitHub 上对 Spring 框架源码的阅读及个人理解一起看，会更有助于各位开发姥爷理解，地址：<br>spring-beans <a href="https://github.com/AmyliaY/spring-beans-reading" target="_blank" rel="noopener">https://github.com/AmyliaY/spring-beans-reading</a><br>spring-context <a href="https://github.com/AmyliaY/spring-context-reading" target="_blank" rel="noopener">https://github.com/AmyliaY/spring-context-reading</a> ）<br><a id="more"></a></p><h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>首先看一下 AbstractBeanFactory 中的 getBean() 系列方法及 doGetBean() 具体实现。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractBeanFactory</span> <span class="keyword">extends</span> <span class="title">FactoryBeanRegistrySupport</span> <span class="keyword">implements</span> <span class="title">ConfigurableBeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//---------------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// BeanFactory 接口的实现，下列的 getBean() 方法不论是哪种重载，最后都会走</span></span><br><span class="line">    <span class="comment">// doGetBean(final String name, final Class&lt;T&gt; requiredType, final Object[] args, boolean typeCheckOnly) 的具体实现</span></span><br><span class="line">    <span class="comment">//---------------------------------------------------------------------</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取 IoC容器 中指定名称的 bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> doGetBean(name, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取 IoC容器 中指定名称和类型的 bean</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(String name, Class&lt;T&gt; requiredType)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> doGetBean(name, requiredType, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取 IoC容器 中指定名称和参数的 bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getBean</span><span class="params">(String name, Object... args)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> doGetBean(name, <span class="keyword">null</span>, args, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取 IoC容器 中指定名称、类型和参数的 bean</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(String name, Class&lt;T&gt; requiredType, Object... args)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> doGetBean(name, requiredType, args, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 真正实现向 IoC容器 获取 bean 的功能，也是触发 依赖注入(DI) 的地方</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">doGetBean</span><span class="params">(<span class="keyword">final</span> String name, <span class="keyword">final</span> Class&lt;T&gt; requiredType, <span class="keyword">final</span> Object[] args, </span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> typeCheckOnly)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 根据用户给定的名称(也可能是别名alias) 获取 IoC容器 中与 BeanDefinition 唯一对应的 beanName</span></span><br><span class="line">        <span class="keyword">final</span> String beanName = transformedBeanName(name);</span><br><span class="line">        Object bean;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 根据 beanName 查看缓存中是否有已实例化的 单例bean，对于 单例bean，整个 IoC容器 只创建一次</span></span><br><span class="line">        Object sharedInstance = getSingleton(beanName);</span><br><span class="line">        <span class="keyword">if</span> (sharedInstance != <span class="keyword">null</span> &amp;&amp; args == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">                    logger.debug(<span class="string">"Returning eagerly cached instance of singleton bean '"</span> + beanName +</span><br><span class="line">                            <span class="string">"' that is not fully initialized yet - a consequence of a circular reference"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    logger.debug(<span class="string">"Returning cached instance of singleton bean '"</span> + beanName + <span class="string">"'"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 获取给定 bean 的实例对象，主要是完成 FactoryBean 的相关处理  </span></span><br><span class="line">            <span class="comment">// 注意：BeanFactory 是一个 IoC容器，它保存了 bean 的基本配置信息。</span></span><br><span class="line">            <span class="comment">// 而 FactoryBean 是 IoC容器 中一种特殊的 bean，它能够实例化 bean对象，注意两者之间的区别</span></span><br><span class="line">            bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果应用程序要获取的 bean 还未创建</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 获取当前容器的父容器</span></span><br><span class="line">            BeanFactory parentBeanFactory = getParentBeanFactory();</span><br><span class="line">            <span class="comment">// 如果当前容器中没有指定的 bean，且当前容器的父容器不为空</span></span><br><span class="line">            <span class="comment">// 则从父容器中去找，如果父容器也没有，则沿着当前容器的继承体系一直向上查找</span></span><br><span class="line">            <span class="keyword">if</span> (parentBeanFactory != <span class="keyword">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;</span><br><span class="line">                <span class="comment">// 根据用户传入的 name(有可能是别名alias)，获取唯一标识的 beanName</span></span><br><span class="line">                String nameToLookup = originalBeanName(name);</span><br><span class="line">                <span class="keyword">if</span> (args != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 委派父级容器根据指定名称和显式的参数查找</span></span><br><span class="line">                    <span class="keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 委派父容器根据指定名称和类型查找</span></span><br><span class="line">                    <span class="keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 创建的 bean 是否需要进行类型验证，一般不需要</span></span><br><span class="line">            <span class="keyword">if</span> (!typeCheckOnly) &#123;</span><br><span class="line">                <span class="comment">// 向容器标记指定的 bean 已经被创建</span></span><br><span class="line">                markBeanAsCreated(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 根据 beanName 获取对应的 RootBeanDefinition</span></span><br><span class="line">                <span class="keyword">final</span> RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">                checkMergedBeanDefinition(mbd, beanName, args);</span><br><span class="line">    </span><br><span class="line">                <span class="comment">// 获取当前 bean 所依赖bean 的 beanName，下面的 getBean(dependsOnBean) 方法会触发</span></span><br><span class="line">                <span class="comment">// getBean() 的递归调用，直到取到一个不依赖任何其它 bean 的 bean 为止。</span></span><br><span class="line">                <span class="comment">// 比如：beanA 依赖了 beanB，而 beanB 依赖了 beanC，那么在实例化 beanA 时会先实例化</span></span><br><span class="line">                <span class="comment">// beanC，然后实例化 beanB 并将 beanC 注入进去，最后实例化 beanA 时将 beanB 注入</span></span><br><span class="line">                String[] dependsOn = mbd.getDependsOn();</span><br><span class="line">                <span class="keyword">if</span> (dependsOn != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (String dependsOnBean : dependsOn) &#123;</span><br><span class="line">                        <span class="comment">// 递归调用 getBean() 方法，从末级节点依次实例化 依赖的bean</span></span><br><span class="line">                        getBean(dependsOnBean);</span><br><span class="line">                        <span class="comment">// 把 当前bean 直接依赖的bean 进行注册</span></span><br><span class="line">                        <span class="comment">//（也就是通过 setter 或构造方法将依赖的 bean 赋值给当前 bean 对应的属性）</span></span><br><span class="line">                        registerDependentBean(dependsOnBean, beanName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">    </span><br><span class="line">                <span class="comment">// 如果当前 bean 是单例的</span></span><br><span class="line">                <span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">                    <span class="comment">// 这里使用了一个匿名内部类，创建 bean实例对象</span></span><br><span class="line">                    sharedInstance = getSingleton(beanName, <span class="keyword">new</span> ObjectFactory&lt;Object&gt;() &#123;</span><br><span class="line">                        <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="comment">// 根据给定的 beanName 及 RootBeanDefinition对象，创建 bean 实例对象</span></span><br><span class="line">                                <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">                                destroySingleton(beanName);</span><br><span class="line">                                <span class="keyword">throw</span> ex;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                    <span class="comment">// 获取给定 bean 的实例对象</span></span><br><span class="line">                    bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</span><br><span class="line">                &#125;</span><br><span class="line">    </span><br><span class="line">                <span class="comment">// 创建原型模式的 bean 实例对象</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (mbd.isPrototype()) &#123;</span><br><span class="line">                    <span class="comment">// 原型模式 (Prototype) 每次都会创建一个新的对象</span></span><br><span class="line">                    Object prototypeInstance = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// 回调 beforePrototypeCreation() 方法，默认的功能是注册当前创建的原型对象</span></span><br><span class="line">                        beforePrototypeCreation(beanName);</span><br><span class="line">                        <span class="comment">// 创建指定 bean 对象实例</span></span><br><span class="line">                        prototypeInstance = createBean(beanName, mbd, args);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">finally</span> &#123;</span><br><span class="line">                        <span class="comment">// 回调 afterPrototypeCreation() 方法，默认的功能是告诉 IoC容器</span></span><br><span class="line">                        <span class="comment">// 指定 bean 的原型对象不再创建了</span></span><br><span class="line">                        afterPrototypeCreation(beanName);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 获取给定 bean 的实例对象</span></span><br><span class="line">                    bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);</span><br><span class="line">                &#125;</span><br><span class="line">    </span><br><span class="line">                <span class="comment">// 要创建的 bean 既不是单例模式，也不是原型模式，则根据该 bean元素 在配置文件中  </span></span><br><span class="line">                <span class="comment">// 配置的生命周期范围，选择实例化 bean 的合适方法，这种在 Web 应用程序中  </span></span><br><span class="line">                <span class="comment">// 比较常用，如：request、session、application 等的生命周期 </span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 获取此 bean 生命周期的范围</span></span><br><span class="line">                    String scopeName = mbd.getScope();</span><br><span class="line">                    <span class="keyword">final</span> Scope scope = <span class="keyword">this</span>.scopes.get(scopeName);</span><br><span class="line">                    <span class="comment">// bean 定义资源中没有配置生命周期范围，则该 bean 的配置不合法</span></span><br><span class="line">                    <span class="keyword">if</span> (scope == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No Scope registered for scope '"</span> + scopeName + <span class="string">"'"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// 这里又使用了一个 ObjectFactory 的匿名内部类，获取一个指定生命周期范围的实例</span></span><br><span class="line">                        Object scopedInstance = scope.get(beanName, <span class="keyword">new</span> ObjectFactory&lt;Object&gt;() &#123;</span><br><span class="line">                            <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">                                beforePrototypeCreation(beanName);</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">finally</span> &#123;</span><br><span class="line">                                    afterPrototypeCreation(beanName);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                        <span class="comment">// 获取给定 bean 的实例对象</span></span><br><span class="line">                        bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">catch</span> (IllegalStateException ex) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(beanName,</span><br><span class="line">                                <span class="string">"Scope '"</span> + scopeName + <span class="string">"' is not active for the current thread; "</span> +</span><br><span class="line">                                <span class="string">"consider defining a scoped proxy for this bean if you intend to refer to it from a singleton"</span>,</span><br><span class="line">                                ex);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">                cleanupAfterBeanCreationFailure(beanName);</span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 对要返回的 bean实例对象 进行非空验证和类型检查，如果没问题就返回这个已经完成 依赖注入的bean</span></span><br><span class="line">        <span class="keyword">if</span> (requiredType != <span class="keyword">null</span> &amp;&amp; bean != <span class="keyword">null</span> &amp;&amp; !requiredType.isAssignableFrom(bean.getClass())) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> getTypeConverter().convertIfNecessary(bean, requiredType);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (TypeMismatchException ex) &#123;</span><br><span class="line">                <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(<span class="string">"Failed to convert bean '"</span> + name + <span class="string">"' to required type ["</span> +</span><br><span class="line">                            ClassUtils.getQualifiedName(requiredType) + <span class="string">"]"</span>, ex);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (T) bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>总的来说，getBean() 方法是依赖注入的起点，之后会调用 createBean()，根据之前解析生成的 BeanDefinition 对象 生成 bean 对象，下面我们看看 AbstractBeanFactory 的子类 AbstractAutowireCapableBeanFactory 中对 createBean() 的具体实现。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractAutowireCapableBeanFactory</span> <span class="keyword">extends</span> <span class="title">AbstractBeanFactory</span></span></span><br><span class="line"><span class="class"><span class="keyword">implements</span> <span class="title">AutowireCapableBeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建指定的 bean 实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">createBean</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> RootBeanDefinition mbd, <span class="keyword">final</span> Object[] args)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> BeanCreationException </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">"Creating instance of bean '"</span> + beanName + <span class="string">"'"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 判断需要创建的 bean 是否可实例化，是否可以通过当前的类加载器加载</span></span><br><span class="line">        resolveBeanClass(mbd, beanName);</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 校验和准备 bean 中的方法覆盖</span></span><br><span class="line">            mbd.prepareMethodOverrides();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(mbd.getResourceDescription(),</span><br><span class="line">                    beanName, <span class="string">"Validation of method overrides failed"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 如果 bean 配置了后置处理器 PostProcessor，则这里返回一个 proxy 代理对象</span></span><br><span class="line">            Object bean = resolveBeforeInstantiation(beanName, mbd);</span><br><span class="line">            <span class="keyword">if</span> (bean != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> bean;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">                    <span class="string">"BeanPostProcessor before instantiation of bean failed"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 创建 bean 实例对象的具体实现</span></span><br><span class="line">        Object beanInstance = doCreateBean(beanName, mbd, args);</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">"Finished creating instance of bean '"</span> + beanName + <span class="string">"'"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> beanInstance;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 bean 实例对象的具体实现，Spring 中以 do 开头的都是方法的具体实现</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">doCreateBean</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> RootBeanDefinition mbd, <span class="keyword">final</span> Object[] args)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        BeanWrapper instanceWrapper = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 如果这个 bean 是单例的，则从缓存中获取这个 beanName 对应的 BeanWrapper实例，并清除</span></span><br><span class="line">        <span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">            instanceWrapper = <span class="keyword">this</span>.factoryBeanInstanceCache.remove(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (instanceWrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">             * 创建实例对象</span></span><br><span class="line"><span class="comment">             * ！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            instanceWrapper = createBeanInstance(beanName, mbd, args);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取实例化对象和其类型</span></span><br><span class="line">        <span class="keyword">final</span> Object bean = (instanceWrapper != <span class="keyword">null</span> ? instanceWrapper.getWrappedInstance() : <span class="keyword">null</span>);</span><br><span class="line">        Class&lt;?&gt; beanType = (instanceWrapper != <span class="keyword">null</span> ? instanceWrapper.getWrappedClass() : <span class="keyword">null</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 调用 PostProcessor 后置处理器</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mbd.postProcessingLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mbd.postProcessed) &#123;</span><br><span class="line">                applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);</span><br><span class="line">                mbd.postProcessed = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 向容器中缓存单例模式的 bean 对象，以防循环引用</span></span><br><span class="line">        <span class="keyword">boolean</span> earlySingletonExposure = (mbd.isSingleton() &amp;&amp; <span class="keyword">this</span>.allowCircularReferences &amp;&amp;</span><br><span class="line">                isSingletonCurrentlyInCreation(beanName));</span><br><span class="line">        <span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Eagerly caching bean '"</span> + beanName +</span><br><span class="line">                        <span class="string">"' to allow for resolving potential circular references"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 这里是一个 ObjectFactory 的匿名内部类，为了防止循环引用，尽早持有对象的引用</span></span><br><span class="line">            addSingletonFactory(beanName, <span class="keyword">new</span> ObjectFactory&lt;Object&gt;() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> getEarlyBeanReference(beanName, mbd, bean);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// bean 对象的初始化，依赖注入在此触发  </span></span><br><span class="line">        <span class="comment">// 这个 exposedObject 在初始化完成之后，将返回作为依赖注入完成后的 bean</span></span><br><span class="line">        Object exposedObject = bean;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ！！！！！！！！！！！！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">             * 把生成的 bean对象 的依赖关系设置好，完成整个依赖注入过程</span></span><br><span class="line"><span class="comment">             * ！！！！！！！！！！！！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line">            <span class="keyword">if</span> (exposedObject != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 初始化 bean对象 </span></span><br><span class="line">                exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;</span><br><span class="line">                <span class="keyword">throw</span> (BeanCreationException) ex;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName, <span class="string">"Initialization of bean failed"</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">            <span class="comment">// 获取指定名称的已注册的 单例bean对象</span></span><br><span class="line">            Object earlySingletonReference = getSingleton(beanName, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (earlySingletonReference != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果根据名称获取的已注册的 bean 和正在实例化的 bean 是同一个</span></span><br><span class="line">                <span class="keyword">if</span> (exposedObject == bean) &#123;</span><br><span class="line">                    <span class="comment">// 当前实例化的 bean 初始化完成</span></span><br><span class="line">                    exposedObject = earlySingletonReference;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果当前 bean 依赖其他 bean，并且当发生循环引用时不允许新创建实例对象</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;</span><br><span class="line">                    String[] dependentBeans = getDependentBeans(beanName);</span><br><span class="line">                    Set&lt;String&gt; actualDependentBeans = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;(dependentBeans.length);</span><br><span class="line">                    <span class="comment">// 获取当前 bean 所依赖的其他 bean </span></span><br><span class="line">                    <span class="keyword">for</span> (String dependentBean : dependentBeans) &#123;</span><br><span class="line">                        <span class="comment">// 对 依赖bean 进行类型检查</span></span><br><span class="line">                        <span class="keyword">if</span> (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;</span><br><span class="line">                            actualDependentBeans.add(dependentBean);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!actualDependentBeans.isEmpty()) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(beanName,</span><br><span class="line">                                <span class="string">"Bean with name '"</span> + beanName + <span class="string">"' has been injected into other beans ["</span> +</span><br><span class="line">                                StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +</span><br><span class="line">                                <span class="string">"] in its raw version as part of a circular reference, but has eventually been "</span> +</span><br><span class="line">                                <span class="string">"wrapped. This means that said other beans do not use the final version of the "</span> +</span><br><span class="line">                                <span class="string">"bean. This is often the result of over-eager type matching - consider using "</span> +</span><br><span class="line">                                <span class="string">"'getBeanNamesOfType' with the 'allowEagerInit' flag turned off, for example."</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 注册 成完依赖注入的bean</span></span><br><span class="line">            registerDisposableBeanIfNecessary(beanName, bean, mbd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName, <span class="string">"Invalid destruction signature"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 为应用返回所需要的实例对象</span></span><br><span class="line">        <span class="keyword">return</span> exposedObject;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从源码中可以看到 createBeanInstance() 和 populateBean() 这两个方法与依赖注入的实现非常密切，createBeanInstance() 方法中生成了 bean 所包含的 Java 对象，populateBean() 方法对这些生成的 bean 对象之间的依赖关系进行了处理。下面我们先看一下 createBeanInstance() 方法的实现。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建 bean 的实例对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> BeanWrapper <span class="title">createBeanInstance</span><span class="params">(String beanName, RootBeanDefinition mbd, Object[] args)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查确认 bean 是可实例化的</span></span><br><span class="line">    Class&lt;?&gt; beanClass = resolveBeanClass(mbd, beanName);</span><br><span class="line">    <span class="keyword">if</span> (beanClass != <span class="keyword">null</span> &amp;&amp; !Modifier.isPublic(beanClass.getModifiers()) &amp;&amp; !mbd.isNonPublicAccessAllowed()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">                <span class="string">"Bean class isn't public, and non-public access not allowed: "</span> + beanClass.getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 RootBeanDefinition对象 中的 factoryMethodName 对 bean 进行实例化</span></span><br><span class="line">    <span class="keyword">if</span> (mbd.getFactoryMethodName() != <span class="keyword">null</span>)  &#123;</span><br><span class="line">        <span class="keyword">return</span> instantiateUsingFactoryMethod(beanName, mbd, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用容器的自动装配方法进行实例化</span></span><br><span class="line">    <span class="keyword">boolean</span> resolved = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> autowireNecessary = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (args == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mbd.resolvedConstructorOrFactoryMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">                resolved = <span class="keyword">true</span>;</span><br><span class="line">                autowireNecessary = mbd.constructorArgumentsResolved;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (resolved) &#123;</span><br><span class="line">        <span class="keyword">if</span> (autowireNecessary) &#123;</span><br><span class="line">            <span class="comment">// 配置了自动装配属性，使用容器的自动装配实例化，即，根据参数类型匹配 bean 的构造方法</span></span><br><span class="line">            <span class="keyword">return</span> autowireConstructor(beanName, mbd, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 使用默认的无参构造方法进行实例化</span></span><br><span class="line">            <span class="keyword">return</span> instantiateBean(beanName, mbd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 bean 的构造方法进行实例化</span></span><br><span class="line">    Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName);</span><br><span class="line">    <span class="keyword">if</span> (ctors != <span class="keyword">null</span> ||</span><br><span class="line">            mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_CONSTRUCTOR ||</span><br><span class="line">            mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args))  &#123;</span><br><span class="line">        <span class="comment">// 使用容器的自动装配特性，调用匹配的构造方法实例化 </span></span><br><span class="line">        <span class="keyword">return</span> autowireConstructor(beanName, mbd, ctors, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> instantiateBean(beanName, mbd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用默认的无参构造方法实例化 bean对象</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> BeanWrapper <span class="title">instantiateBean</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> RootBeanDefinition mbd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Object beanInstance;</span><br><span class="line">        <span class="keyword">final</span> BeanFactory parent = <span class="keyword">this</span>;</span><br><span class="line">        <span class="comment">// 获取系统的安全管理接口，JDK 标准的安全管理 API</span></span><br><span class="line">        <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 这里使用了一个 PrivilegedAction 的匿名内部类，根据实例化策略创建实例对象</span></span><br><span class="line">            beanInstance = AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Object&gt;() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> getInstantiationStrategy().instantiate(mbd, beanName, parent);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, getAccessControlContext());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">             * 使用初始化策略实例化 bean 对象</span></span><br><span class="line"><span class="comment">             * ！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            beanInstance = getInstantiationStrategy().instantiate(mbd, beanName, parent);</span><br><span class="line">        &#125;</span><br><span class="line">        BeanWrapper bw = <span class="keyword">new</span> BeanWrapperImpl(beanInstance);</span><br><span class="line">        initBeanWrapper(bw);</span><br><span class="line">        <span class="keyword">return</span> bw;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName, <span class="string">"Instantiation of bean failed"</span>, ex);java</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从源码中我们可以看到其调用了 SimpleInstantiationStrategy 实现类来生成 bean 对象，这个类是 Spring 用来生成 bean 对象 的默认类，它提供了两种策略来实例化 bean 对象，一种是利用 Java 的反射机制，另一种是直接使用 CGLIB。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleInstantiationStrategy</span> <span class="keyword">implements</span> <span class="title">InstantiationStrategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用初始化策略实例化 bean对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">instantiate</span><span class="params">(RootBeanDefinition beanDefinition, String beanName, BeanFactory owner)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 如果 配置的bean 中没有方法覆盖，则使用 Java 的反射机制实例化对象，否则使用 CGLIB</span></span><br><span class="line">        <span class="keyword">if</span> (beanDefinition.getMethodOverrides().isEmpty()) &#123;</span><br><span class="line">            Constructor&lt;?&gt; constructorToUse;</span><br><span class="line">            <span class="keyword">synchronized</span> (beanDefinition.constructorArgumentLock) &#123;</span><br><span class="line">                <span class="comment">// 获取对象的构造方法对 bean 进行实例化</span></span><br><span class="line">                constructorToUse = (Constructor&lt;?&gt;) beanDefinition.resolvedConstructorOrFactoryMethod;</span><br><span class="line">                <span class="comment">// 如果前面没有获取到构造方法，则通过反射获取</span></span><br><span class="line">                <span class="keyword">if</span> (constructorToUse == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 使用 JDK 的反射机制，判断要实例化的 bean 是否是接口</span></span><br><span class="line">                    <span class="keyword">final</span> Class clazz = beanDefinition.getBeanClass();</span><br><span class="line">                    <span class="comment">// 如果 clazz 是一个接口，直接抛出异常</span></span><br><span class="line">                    <span class="keyword">if</span> (clazz.isInterface()) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> BeanInstantiationException(clazz, <span class="string">"Specified class is an interface"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// 这里使用了一个 PrivilegedExceptionAction 的匿名内部类，使用反射机制获取 bean 的构造方法</span></span><br><span class="line">                            constructorToUse = AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedExceptionAction&lt;Constructor&gt;() &#123;</span><br><span class="line">                                <span class="function"><span class="keyword">public</span> Constructor <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                                    <span class="keyword">return</span> clazz.getDeclaredConstructor((Class[]) <span class="keyword">null</span>);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            constructorToUse =clazz.getDeclaredConstructor((Class[]) <span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        beanDefinition.resolvedConstructorOrFactoryMethod = constructorToUse;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> BeanInstantiationException(clazz, <span class="string">"No default constructor found"</span>, ex);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 根据传入的 Constructor，在 BeanUtils 中调用该 Constructor 的 </span></span><br><span class="line">            <span class="comment">// newInstance(Object...) 方法，实例化指定对象</span></span><br><span class="line">            <span class="keyword">return</span> BeanUtils.instantiateClass(constructorToUse);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">             * 使用 CGLIB 来实例化对象</span></span><br><span class="line"><span class="comment">             * 调用了 CglibSubclassingInstantiationStrategy 中的实现</span></span><br><span class="line"><span class="comment">             * ！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">return</span> instantiateWithMethodInjection(beanDefinition, beanName, owner);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 SimpleInstantiationStrategy 的子类 CglibSubclassingInstantiationStrategy 中可以看到使用 CGLIB 进行实例化的源码实现。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CglibSubclassingInstantiationStrategy</span> <span class="keyword">extends</span> <span class="title">SimpleInstantiationStrategy</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下面两个方法都通过实例化自己的私有静态内部类 CglibSubclassCreator，</span></span><br><span class="line"><span class="comment">     * 然后调用该内部类对象的实例化方法 instantiate() 完成实例化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">instantiateWithMethodInjection</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            RootBeanDefinition beanDefinition, String beanName, BeanFactory owner)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CglibSubclassCreator(beanDefinition, owner).instantiate(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">instantiateWithMethodInjection</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            RootBeanDefinition beanDefinition, String beanName, BeanFactory owner,</span></span></span><br><span class="line"><span class="function"><span class="params">            Constructor ctor, Object[] args)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CglibSubclassCreator(beanDefinition, owner).instantiate(ctor, args);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 为避免 3.2 之前的 Spring 版本中的外部 cglib 依赖而创建的内部类。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CglibSubclassCreator</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(CglibSubclassCreator.class);</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> RootBeanDefinition beanDefinition;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> BeanFactory owner;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CglibSubclassCreator</span><span class="params">(RootBeanDefinition beanDefinition, BeanFactory owner)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.beanDefinition = beanDefinition;</span><br><span class="line">            <span class="keyword">this</span>.owner = owner;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 使用 CGLIB 进行 bean对象 实例化</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">instantiate</span><span class="params">(Constructor ctor, Object[] args)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 实例化 Enhancer对象，并为 Enhancer对象 设置父类，生成 Java 对象的参数，比如：基类、回调方法等</span></span><br><span class="line">            Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line">            <span class="comment">// 将 bean 本身作为其父类</span></span><br><span class="line">            enhancer.setSuperclass(<span class="keyword">this</span>.beanDefinition.getBeanClass());</span><br><span class="line">            enhancer.setCallbackFilter(<span class="keyword">new</span> CallbackFilterImpl());</span><br><span class="line">            enhancer.setCallbacks(<span class="keyword">new</span> Callback[] &#123;</span><br><span class="line">                    NoOp.INSTANCE,</span><br><span class="line">                    <span class="keyword">new</span> LookupOverrideMethodInterceptor(),</span><br><span class="line">                    <span class="keyword">new</span> ReplaceOverrideMethodInterceptor()</span><br><span class="line">            &#125;);</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 使用 CGLIB 的 create() 方法生成实例对象</span></span><br><span class="line">            <span class="keyword">return</span> (ctor == <span class="keyword">null</span>) ? enhancer.create() : enhancer.create(ctor.getParameterTypes(), args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>至此，完成了 bean 对象 的实例化，然后就可以根据解析得到的 BeanDefinition 对象 完成对各个属性的赋值处理，也就是依赖注入。这个实现方法就是前面 AbstractAutowireCapableBeanFactory 类中的 populateBean() 方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractAutowireCapableBeanFactory</span> <span class="keyword">extends</span> <span class="title">AbstractBeanFactory</span></span></span><br><span class="line"><span class="class"><span class="keyword">implements</span> <span class="title">AutowireCapableBeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 为属性赋值，完成依赖注入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">populateBean</span><span class="params">(String beanName, RootBeanDefinition mbd, BeanWrapper bw)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取 RootBeanDefinition 中设置的 属性值PropertyValues，这些属性值来自对</span></span><br><span class="line">        <span class="comment">// .xml 文件中 bean元素 的解析</span></span><br><span class="line">        PropertyValues pvs = mbd.getPropertyValues();</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 如果 BeanWrapper对象 为 null，而要注入的属性值不为空，则抛出下述异常</span></span><br><span class="line">        <span class="keyword">if</span> (bw == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!pvs.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">                        mbd.getResourceDescription(), beanName, <span class="string">"Cannot apply property values to null instance"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// BeanWrapper对象 为 null，属性值也为空，不需要设置属性值，直接返回 </span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 在设置属性之前调用 bean 的 PostProcessor 后置处理器</span></span><br><span class="line">        <span class="keyword">boolean</span> continueWithPropertyPopulation = <span class="keyword">true</span>;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (bp <span class="keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;</span><br><span class="line">                    InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp;</span><br><span class="line">                    <span class="keyword">if</span> (!ibp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) &#123;</span><br><span class="line">                        continueWithPropertyPopulation = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (!continueWithPropertyPopulation) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 依赖注入开始，首先处理 autowire 自动装配的注入</span></span><br><span class="line">        <span class="keyword">if</span> (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME ||</span><br><span class="line">                mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123;</span><br><span class="line">            MutablePropertyValues newPvs = <span class="keyword">new</span> MutablePropertyValues(pvs);</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 对 autowire 自动装配的处理，根据 bean 名称自动装配注入</span></span><br><span class="line">            <span class="keyword">if</span> (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME) &#123;</span><br><span class="line">                autowireByName(beanName, mbd, bw, newPvs);</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 根据 bean 类型自动装配注入</span></span><br><span class="line">            <span class="keyword">if</span> (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123;</span><br><span class="line">                autowireByType(beanName, mbd, bw, newPvs);</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            pvs = newPvs;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 检查容器是否持有用于处理单例模式 bean 关闭时的后置处理器</span></span><br><span class="line">        <span class="keyword">boolean</span> hasInstAwareBpps = hasInstantiationAwareBeanPostProcessors();</span><br><span class="line">        <span class="comment">// bean实例对象 没有依赖，即没有继承基类</span></span><br><span class="line">        <span class="keyword">boolean</span> needsDepCheck = (mbd.getDependencyCheck() != RootBeanDefinition.DEPENDENCY_CHECK_NONE);</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (hasInstAwareBpps || needsDepCheck) &#123;</span><br><span class="line">            <span class="comment">// 从实例对象中提取属性描述符</span></span><br><span class="line">            PropertyDescriptor[] filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);</span><br><span class="line">            <span class="keyword">if</span> (hasInstAwareBpps) &#123;</span><br><span class="line">                <span class="keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (bp <span class="keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;</span><br><span class="line">                        InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp;</span><br><span class="line">                        <span class="comment">// 使用 BeanPostProcessor 处理器处理属性值</span></span><br><span class="line">                        pvs = ibp.postProcessPropertyValues(pvs, filteredPds, bw.getWrappedInstance(), beanName);</span><br><span class="line">                        <span class="keyword">if</span> (pvs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (needsDepCheck) &#123;</span><br><span class="line">                <span class="comment">// 为要设置的属性进行依赖检查</span></span><br><span class="line">                checkDependencies(beanName, mbd, filteredPds, pvs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">         * 对属性进行依赖注入</span></span><br><span class="line"><span class="comment">         * ！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        applyPropertyValues(beanName, mbd, bw, pvs);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析并注入依赖属性的过程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">applyPropertyValues</span><span class="params">(String beanName, BeanDefinition mbd, BeanWrapper bw, PropertyValues pvs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (pvs == <span class="keyword">null</span> || pvs.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 封装属性值</span></span><br><span class="line">        MutablePropertyValues mpvs = <span class="keyword">null</span>;</span><br><span class="line">        List&lt;PropertyValue&gt; original;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (System.getSecurityManager()!= <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bw <span class="keyword">instanceof</span> BeanWrapperImpl) &#123;</span><br><span class="line">                <span class="comment">// 设置安全上下文，JDK 安全机制</span></span><br><span class="line">                ((BeanWrapperImpl) bw).setSecurityContext(getAccessControlContext());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (pvs <span class="keyword">instanceof</span> MutablePropertyValues) &#123;</span><br><span class="line">            mpvs = (MutablePropertyValues) pvs;</span><br><span class="line">            <span class="comment">// 如果属性值已经转换</span></span><br><span class="line">            <span class="keyword">if</span> (mpvs.isConverted()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 为实例化对象设置属性值</span></span><br><span class="line">                    bw.setPropertyValues(mpvs);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">                            mbd.getResourceDescription(), beanName, <span class="string">"Error setting property values"</span>, ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 获取属性值对象的原始类型值</span></span><br><span class="line">            original = mpvs.getPropertyValueList();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            original = Arrays.asList(pvs.getPropertyValues());</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 获取用户自定义的类型转换</span></span><br><span class="line">        TypeConverter converter = getCustomTypeConverter();</span><br><span class="line">        <span class="keyword">if</span> (converter == <span class="keyword">null</span>) &#123;</span><br><span class="line">            converter = bw;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建一个 BeanDefinition 属性值解析器，将 BeanDefinition 中的属性值解析为 bean 实例对象的实际值</span></span><br><span class="line">        BeanDefinitionValueResolver valueResolver = <span class="keyword">new</span> BeanDefinitionValueResolver(<span class="keyword">this</span>, beanName, mbd, converter);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 为属性的解析值创建一个副本，最后将属性值注入到实例对象中</span></span><br><span class="line">        List&lt;PropertyValue&gt; deepCopy = <span class="keyword">new</span> ArrayList&lt;PropertyValue&gt;(original.size());</span><br><span class="line">        <span class="keyword">boolean</span> resolveNecessary = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (PropertyValue pv : original) &#123;</span><br><span class="line">            <span class="comment">// 如果属性值已经转换，直接添加到 deepCopy 列表中</span></span><br><span class="line">            <span class="keyword">if</span> (pv.isConverted()) &#123;</span><br><span class="line">                deepCopy.add(pv);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果属性值需要转换</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                String propertyName = pv.getName();</span><br><span class="line">                <span class="comment">// 原始的属性值，即转换之前的属性值</span></span><br><span class="line">                Object originalValue = pv.getValue();</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * ！！！！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">                 * 解析属性值，对注入类型进行转换</span></span><br><span class="line"><span class="comment">                 * ！！！！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                Object resolvedValue = valueResolver.resolveValueIfNecessary(pv, originalValue);</span><br><span class="line">                <span class="comment">// 转换之后的属性值</span></span><br><span class="line">                Object convertedValue = resolvedValue;</span><br><span class="line">                <span class="comment">// 属性值是否可以转换</span></span><br><span class="line">                <span class="keyword">boolean</span> convertible = bw.isWritableProperty(propertyName) &amp;&amp;</span><br><span class="line">                        !PropertyAccessorUtils.isNestedOrIndexedProperty(propertyName);</span><br><span class="line">                <span class="keyword">if</span> (convertible) &#123;</span><br><span class="line">                    <span class="comment">// 使用用户自定义的类型转换器转换属性值</span></span><br><span class="line">                    convertedValue = convertForProperty(resolvedValue, propertyName, bw, converter);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 存储转换后的属性值，避免每次属性注入时的转换工作</span></span><br><span class="line">                <span class="keyword">if</span> (resolvedValue == originalValue) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (convertible) &#123;</span><br><span class="line">                        <span class="comment">// 设置属性转换之后的值</span></span><br><span class="line">                        pv.setConvertedValue(convertedValue);</span><br><span class="line">                    &#125;</span><br><span class="line">                    deepCopy.add(pv);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果：属性是可转换的，且属性原始值是字符串类型，且属性的原始类型值不是  </span></span><br><span class="line">                <span class="comment">// 动态生成的字符串，且属性的原始值不是集合或者数组类型</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (convertible &amp;&amp; originalValue <span class="keyword">instanceof</span> TypedStringValue &amp;&amp;</span><br><span class="line">                        !((TypedStringValue) originalValue).isDynamic() &amp;&amp;</span><br><span class="line">                        !(convertedValue <span class="keyword">instanceof</span> Collection || ObjectUtils.isArray(convertedValue))) &#123;</span><br><span class="line">                    pv.setConvertedValue(convertedValue);</span><br><span class="line">                    deepCopy.add(pv);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    resolveNecessary = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="comment">// 重新封装属性的值</span></span><br><span class="line">                    deepCopy.add(<span class="keyword">new</span> PropertyValue(pv, convertedValue));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mpvs != <span class="keyword">null</span> &amp;&amp; !resolveNecessary) &#123;</span><br><span class="line">            <span class="comment">// 标记属性值已经转换过</span></span><br><span class="line">            mpvs.setConverted();</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 进行属性依赖注入</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ！！！！！！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">             * 完成 bean 的属性值注入的入口</span></span><br><span class="line"><span class="comment">             * 走 AbstractPropertyAccessor 中的实现方法</span></span><br><span class="line"><span class="comment">             * ！！！！！！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            bw.setPropertyValues(<span class="keyword">new</span> MutablePropertyValues(deepCopy));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">                    mbd.getResourceDescription(), beanName, <span class="string">"Error setting property values"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BeanDefinitionValueResolver 中解析属性值，对注入类型进行转换的具体实现。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BeanDefinitionValueResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析属性值，对注入类型进行转换</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">resolveValueIfNecessary</span><span class="params">(Object argName, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 对引用类型的属性进行解析，RuntimeBeanReference 是在对 BeanDefinition 进行解析时生成的数据对象</span></span><br><span class="line">        <span class="keyword">if</span> (value <span class="keyword">instanceof</span> RuntimeBeanReference) &#123;</span><br><span class="line">            RuntimeBeanReference ref = (RuntimeBeanReference) value;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">             * 解析引用类型的属性值</span></span><br><span class="line"><span class="comment">             * ！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">return</span> resolveReference(argName, ref);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 对属性值是引用容器中另一个 bean 名称的解析</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> RuntimeBeanNameReference) &#123;</span><br><span class="line">            String refName = ((RuntimeBeanNameReference) value).getBeanName();</span><br><span class="line">            refName = String.valueOf(evaluate(refName));</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.beanFactory.containsBean(refName)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">                        <span class="string">"Invalid bean name '"</span> + refName + <span class="string">"' in bean reference for "</span> + argName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> refName;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 对 BeanDefinitionHolder 类型属性的解析，主要是 bean 中的内部类</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> BeanDefinitionHolder) &#123;</span><br><span class="line">            BeanDefinitionHolder bdHolder = (BeanDefinitionHolder) value;</span><br><span class="line">            <span class="keyword">return</span> resolveInnerBean(argName, bdHolder.getBeanName(), bdHolder.getBeanDefinition());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> BeanDefinition) &#123;</span><br><span class="line">            BeanDefinition bd = (BeanDefinition) value;</span><br><span class="line">            <span class="keyword">return</span> resolveInnerBean(argName, <span class="string">"(inner bean)"</span>, bd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 对集合数组类型的属性解析</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> ManagedArray) &#123;</span><br><span class="line">            ManagedArray array = (ManagedArray) value;</span><br><span class="line">            <span class="comment">// 获取数组的类型</span></span><br><span class="line">            Class&lt;?&gt; elementType = array.resolvedElementType;</span><br><span class="line">            <span class="keyword">if</span> (elementType == <span class="keyword">null</span>) &#123;</span><br><span class="line">                 <span class="comment">// 获取数组元素的类型</span></span><br><span class="line">                String elementTypeName = array.getElementTypeName();</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.hasText(elementTypeName)) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// 使用反射机制创建指定类型的对象</span></span><br><span class="line">                        elementType = ClassUtils.forName(elementTypeName, <span class="keyword">this</span>.beanFactory.getBeanClassLoader());</span><br><span class="line">                        array.resolvedElementType = elementType;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">                                <span class="keyword">this</span>.beanDefinition.getResourceDescription(), <span class="keyword">this</span>.beanName,</span><br><span class="line">                                <span class="string">"Error resolving array type for "</span> + argName, ex);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 没有获取到数组的类型，也没有获取到数组元素的类型 </span></span><br><span class="line">                <span class="comment">// 则直接设置数组的类型为 Object</span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    elementType = Object.class;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 创建指定类型的数组</span></span><br><span class="line">            <span class="keyword">return</span> resolveManagedArray(argName, (List&lt;?&gt;) value, elementType);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析 list 类型的属性值</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> ManagedList) &#123;</span><br><span class="line">            <span class="comment">// May need to resolve contained runtime references.</span></span><br><span class="line">            <span class="keyword">return</span> resolveManagedList(argName, (List&lt;?&gt;) value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析 set 类型的属性值</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> ManagedSet) &#123;</span><br><span class="line">            <span class="comment">// May need to resolve contained runtime references.</span></span><br><span class="line">            <span class="keyword">return</span> resolveManagedSet(argName, (Set&lt;?&gt;) value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析 map 类型的属性值</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> ManagedMap) &#123;</span><br><span class="line">            <span class="comment">// May need to resolve contained runtime references.</span></span><br><span class="line">            <span class="keyword">return</span> resolveManagedMap(argName, (Map&lt;?, ?&gt;) value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析 Properties 类型的属性值，Properties 其实就是 key 和 value 均为字符串的 map</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> ManagedProperties) &#123;</span><br><span class="line">            Properties original = (Properties) value;</span><br><span class="line">            <span class="comment">// 创建一个拷贝，用于作为解析后的返回值</span></span><br><span class="line">            Properties copy = <span class="keyword">new</span> Properties();</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry propEntry : original.entrySet()) &#123;</span><br><span class="line">                Object propKey = propEntry.getKey();</span><br><span class="line">                Object propValue = propEntry.getValue();</span><br><span class="line">                <span class="keyword">if</span> (propKey <span class="keyword">instanceof</span> TypedStringValue) &#123;</span><br><span class="line">                    propKey = evaluate((TypedStringValue) propKey);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (propValue <span class="keyword">instanceof</span> TypedStringValue) &#123;</span><br><span class="line">                    propValue = evaluate((TypedStringValue) propValue);</span><br><span class="line">                &#125;</span><br><span class="line">                copy.put(propKey, propValue);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> copy;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析字符串类型的属性值</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> TypedStringValue) &#123;</span><br><span class="line">            TypedStringValue typedStringValue = (TypedStringValue) value;</span><br><span class="line">            Object valueObject = evaluate(typedStringValue);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 获取属性的目标类型</span></span><br><span class="line">                Class&lt;?&gt; resolvedTargetType = resolveTargetType(typedStringValue);</span><br><span class="line">                <span class="keyword">if</span> (resolvedTargetType != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 对目标类型的属性进行解析，递归调用</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">this</span>.typeConverter.convertIfNecessary(valueObject, resolvedTargetType);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 没有获取到属性的目标对象，则按 Object 类型返回</span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> valueObject;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">                        <span class="keyword">this</span>.beanDefinition.getResourceDescription(), <span class="keyword">this</span>.beanName,</span><br><span class="line">                        <span class="string">"Error converting typed String value for "</span> + argName, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> evaluate(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析引用类型的属性值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">resolveReference</span><span class="params">(Object argName, RuntimeBeanReference ref)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取 所引用bean 的 beanName</span></span><br><span class="line">            String refName = ref.getBeanName();</span><br><span class="line">            refName = String.valueOf(evaluate(refName));</span><br><span class="line">            <span class="comment">// 如果引用的对象在父容器中，则从父容器中获取指定的引用对象</span></span><br><span class="line">            <span class="keyword">if</span> (ref.isToParent()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.beanFactory.getParentBeanFactory() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">                            <span class="keyword">this</span>.beanDefinition.getResourceDescription(), <span class="keyword">this</span>.beanName,</span><br><span class="line">                            <span class="string">"Can't resolve reference to bean '"</span> + refName +</span><br><span class="line">                            <span class="string">"' in parent factory: no parent factory available"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.beanFactory.getParentBeanFactory().getBean(refName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 从当前的容器中获取指定的引用 bean对象，如果指定的 bean 没有被实例化  </span></span><br><span class="line">            <span class="comment">// 则会递归触发引用 bean 的初始化和依赖注入</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                Object bean = <span class="keyword">this</span>.beanFactory.getBean(refName);</span><br><span class="line">                <span class="comment">// 为 refName对应的bean 注入 它所依赖的bean</span></span><br><span class="line">                <span class="keyword">this</span>.beanFactory.registerDependentBean(refName, <span class="keyword">this</span>.beanName);</span><br><span class="line">                <span class="keyword">return</span> bean;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">                    <span class="keyword">this</span>.beanDefinition.getResourceDescription(), <span class="keyword">this</span>.beanName,</span><br><span class="line">                    <span class="string">"Cannot resolve reference to bean '"</span> + ref.getBeanName() + <span class="string">"' while setting "</span> + argName, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析 array 类型的属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">resolveManagedArray</span><span class="params">(Object argName, List&lt;?&gt; ml, Class&lt;?&gt; elementType)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建一个指定类型的数组，用于存放和返回解析后的数组</span></span><br><span class="line">        Object resolved = Array.newInstance(elementType, ml.size());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ml.size(); i++) &#123;</span><br><span class="line">            <span class="comment">// 递归解析 array 的每一个元素，并将解析后的值设置到 resolved 数组中，索引为 i</span></span><br><span class="line">            Array.set(resolved, i,</span><br><span class="line">                    resolveValueIfNecessary(<span class="keyword">new</span> KeyedArgName(argName, i), ml.get(i)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resolved;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析 list 类型的属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List <span class="title">resolveManagedList</span><span class="params">(Object argName, List&lt;?&gt; ml)</span> </span>&#123;</span><br><span class="line">        List&lt;Object&gt; resolved = <span class="keyword">new</span> ArrayList&lt;Object&gt;(ml.size());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ml.size(); i++) &#123;</span><br><span class="line">            <span class="comment">// 递归解析 list 的每一个元素</span></span><br><span class="line">            resolved.add(</span><br><span class="line">                    resolveValueIfNecessary(<span class="keyword">new</span> KeyedArgName(argName, i), ml.get(i)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resolved;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析 set 类型的属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Set <span class="title">resolveManagedSet</span><span class="params">(Object argName, Set&lt;?&gt; ms)</span> </span>&#123;</span><br><span class="line">        Set&lt;Object&gt; resolved = <span class="keyword">new</span> LinkedHashSet&lt;Object&gt;(ms.size());</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 递归解析 set 的每一个元素</span></span><br><span class="line">        <span class="keyword">for</span> (Object m : ms) &#123;</span><br><span class="line">            resolved.add(resolveValueIfNecessary(<span class="keyword">new</span> KeyedArgName(argName, i), m));</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resolved;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析 map 类型的属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map <span class="title">resolveManagedMap</span><span class="params">(Object argName, Map&lt;?, ?&gt; mm)</span> </span>&#123;</span><br><span class="line">        Map&lt;Object, Object&gt; resolved = <span class="keyword">new</span> LinkedHashMap&lt;Object, Object&gt;(mm.size());</span><br><span class="line">        <span class="comment">// 递归解析 map 中每一个元素的 key 和 value</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry entry : mm.entrySet()) &#123;</span><br><span class="line">            Object resolvedKey = resolveValueIfNecessary(argName, entry.getKey());</span><br><span class="line">            Object resolvedValue = resolveValueIfNecessary(</span><br><span class="line">                    <span class="keyword">new</span> KeyedArgName(argName, entry.getKey()), entry.getValue());</span><br><span class="line">            resolved.put(resolvedKey, resolvedValue);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resolved;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>至此，已经为依赖注入做好了准备，下面就该将 bean 对象 设置到它所依赖的另一个 bean 的属性中去。AbstractPropertyAccessor 和其子类 BeanWrapperImpl 完成了依赖注入的详细过程。先看一下 AbstractPropertyAccessor 中的实现。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractPropertyAccessor</span> <span class="keyword">extends</span> <span class="title">TypeConverterSupport</span> <span class="keyword">implements</span> <span class="title">ConfigurablePropertyAccessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * setPropertyValues() 方法有多种重载，但最终都走的是 </span></span><br><span class="line"><span class="comment">     * setPropertyValues(PropertyValues pvs, boolean ignoreUnknown, boolean ignoreInvalid)重载方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPropertyValues</span><span class="params">(Map&lt;?, ?&gt; map)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        setPropertyValues(<span class="keyword">new</span> MutablePropertyValues(map));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPropertyValues</span><span class="params">(PropertyValues pvs, <span class="keyword">boolean</span> ignoreUnknown)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        setPropertyValues(pvs, ignoreUnknown, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPropertyValues</span><span class="params">(PropertyValues pvs)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        setPropertyValues(pvs, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPropertyValues</span><span class="params">(PropertyValues pvs, <span class="keyword">boolean</span> ignoreUnknown, <span class="keyword">boolean</span> ignoreInvalid)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">    </span><br><span class="line">        List&lt;PropertyAccessException&gt; propertyAccessExceptions = <span class="keyword">null</span>;</span><br><span class="line">        List&lt;PropertyValue&gt; propertyValues = (pvs <span class="keyword">instanceof</span> MutablePropertyValues ?</span><br><span class="line">                ((MutablePropertyValues) pvs).getPropertyValueList() : Arrays.asList(pvs.getPropertyValues()));</span><br><span class="line">        <span class="keyword">for</span> (PropertyValue pv : propertyValues) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * ！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">                 * 该方法走 BeanWrapperImpl 中的实现，这是 bean属性值注入 具体实现的入口</span></span><br><span class="line"><span class="comment">                 * ！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                setPropertyValue(pv);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (NotWritablePropertyException ex) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!ignoreUnknown) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> ex;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (NullValueInNestedPathException ex) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!ignoreInvalid) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> ex;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (PropertyAccessException ex) &#123;</span><br><span class="line">                <span class="keyword">if</span> (propertyAccessExceptions == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    propertyAccessExceptions = <span class="keyword">new</span> LinkedList&lt;PropertyAccessException&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                propertyAccessExceptions.add(ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 如果出现 PropertyAccessException 异常，则将这些异常积累起来放到一个集合中，然后一次性抛出！！！</span></span><br><span class="line">        <span class="comment">// 这种抛异常的方式 在实际的开发中也时常使用，可以好好看一下，对比一下</span></span><br><span class="line">        <span class="keyword">if</span> (propertyAccessExceptions != <span class="keyword">null</span>) &#123;</span><br><span class="line">            PropertyAccessException[] paeArray =</span><br><span class="line">                    propertyAccessExceptions.toArray(<span class="keyword">new</span> PropertyAccessException[propertyAccessExceptions.size()]);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PropertyBatchUpdateException(paeArray);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后看一下 BeanWrapperImpl 中的实现。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanWrapperImpl</span> <span class="keyword">extends</span> <span class="title">AbstractPropertyAccessor</span> <span class="keyword">implements</span> <span class="title">BeanWrapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPropertyValue</span><span class="params">(PropertyValue pv)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="comment">// PropertyTokenHolder 是一个用于内部使用的内部类</span></span><br><span class="line">        PropertyTokenHolder tokens = (PropertyTokenHolder) pv.resolvedTokens;</span><br><span class="line">        <span class="keyword">if</span> (tokens == <span class="keyword">null</span>) &#123;</span><br><span class="line">            String propertyName = pv.getName();</span><br><span class="line">            BeanWrapperImpl nestedBw;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                nestedBw = getBeanWrapperForPropertyPath(propertyName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (NotReadablePropertyException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NotWritablePropertyException(getRootClass(), <span class="keyword">this</span>.nestedPath + propertyName,</span><br><span class="line">                        <span class="string">"Nested property in path '"</span> + propertyName + <span class="string">"' does not exist"</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            tokens = getPropertyNameTokens(getFinalPath(nestedBw, propertyName));</span><br><span class="line">            <span class="keyword">if</span> (nestedBw == <span class="keyword">this</span>) &#123;</span><br><span class="line">                pv.getOriginalPropertyValue().resolvedTokens = tokens;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">             * 进入 bean 属性值注入的具体实现</span></span><br><span class="line"><span class="comment">             * ！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            nestedBw.setPropertyValue(tokens, pv);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            setPropertyValue(tokens, pv);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">     * 依赖注入（将某个bean所依赖的值 注入到这个bean中） 的具体实现</span></span><br><span class="line"><span class="comment">     * ！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setPropertyValue</span><span class="params">(PropertyTokenHolder tokens, PropertyValue pv)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="comment">// PropertyTokenHolder 是定义在 BeanWrapperImpl 中的内部类，主要保存属性的名称、路径、</span></span><br><span class="line">        <span class="comment">// 以及集合的 size 等信息</span></span><br><span class="line">        String propertyName = tokens.canonicalName;</span><br><span class="line">        String actualName = tokens.actualName;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 对集合类型的属性注入，PropertyTokenHolder 的 keys 是用来保存集合类型属性的 size</span></span><br><span class="line">        <span class="keyword">if</span> (tokens.keys != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 将属性信息从 tokens 拷贝到 getterTokens</span></span><br><span class="line">            PropertyTokenHolder getterTokens = <span class="keyword">new</span> PropertyTokenHolder();</span><br><span class="line">            getterTokens.canonicalName = tokens.canonicalName;</span><br><span class="line">            getterTokens.actualName = tokens.actualName;</span><br><span class="line">            getterTokens.keys = <span class="keyword">new</span> String[tokens.keys.length - <span class="number">1</span>];</span><br><span class="line">            System.arraycopy(tokens.keys, <span class="number">0</span>, getterTokens.keys, <span class="number">0</span>, tokens.keys.length - <span class="number">1</span>);</span><br><span class="line">            Object propValue;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 通过反射机制，调用属性的 getter 方法获取属性值 </span></span><br><span class="line">                propValue = getPropertyValue(getterTokens);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (NotReadablePropertyException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NotWritablePropertyException(getRootClass(), <span class="keyword">this</span>.nestedPath + propertyName,</span><br><span class="line">                        <span class="string">"Cannot access indexed value in property referenced "</span> +</span><br><span class="line">                        <span class="string">"in indexed property path '"</span> + propertyName + <span class="string">"'"</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 获取集合类型属性的长度</span></span><br><span class="line">            String key = tokens.keys[tokens.keys.length - <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (propValue == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.autoGrowNestedPaths) &#123;</span><br><span class="line">                    <span class="keyword">int</span> lastKeyIndex = tokens.canonicalName.lastIndexOf(<span class="string">'['</span>);</span><br><span class="line">                    getterTokens.canonicalName = tokens.canonicalName.substring(<span class="number">0</span>, lastKeyIndex);</span><br><span class="line">                    propValue = setDefaultValue(getterTokens);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> NullValueInNestedPathException(getRootClass(), <span class="keyword">this</span>.nestedPath + propertyName,</span><br><span class="line">                            <span class="string">"Cannot access indexed value in property referenced "</span> +</span><br><span class="line">                            <span class="string">"in indexed property path '"</span> + propertyName + <span class="string">"': returned null"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果属性值是 Array 数组类型的，则注入 array 类型的属性值</span></span><br><span class="line">            <span class="keyword">if</span> (propValue.getClass().isArray()) &#123;</span><br><span class="line">                <span class="comment">// 获取属性的描述符</span></span><br><span class="line">                PropertyDescriptor pd = getCachedIntrospectionResults().getPropertyDescriptor(actualName);</span><br><span class="line">                <span class="comment">// 获取数组的类型</span></span><br><span class="line">                Class requiredType = propValue.getClass().getComponentType();</span><br><span class="line">                <span class="comment">// 获取数组的长度</span></span><br><span class="line">                <span class="keyword">int</span> arrayIndex = Integer.parseInt(key);</span><br><span class="line">                Object oldValue = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 获取数组以前初始化的值</span></span><br><span class="line">                    <span class="keyword">if</span> (isExtractOldValueForEditor() &amp;&amp; arrayIndex &lt; Array.getLength(propValue)) &#123;</span><br><span class="line">                        oldValue = Array.get(propValue, arrayIndex);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 将属性的值赋值给数组中的元素</span></span><br><span class="line">                    Object convertedValue = convertIfNecessary(propertyName, oldValue, pv.getValue(),</span><br><span class="line">                            requiredType, TypeDescriptor.nested(property(pd), tokens.keys.length));</span><br><span class="line">                    Array.set(propValue, arrayIndex, convertedValue);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (IndexOutOfBoundsException ex) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> InvalidPropertyException(getRootClass(), <span class="keyword">this</span>.nestedPath + propertyName,</span><br><span class="line">                            <span class="string">"Invalid array index in property path '"</span> + propertyName + <span class="string">"'"</span>, ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果属性值是 List 类型的，则注入 list 类型的属性值</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (propValue <span class="keyword">instanceof</span> List) &#123;</span><br><span class="line">                PropertyDescriptor pd = getCachedIntrospectionResults().getPropertyDescriptor(actualName);</span><br><span class="line">                <span class="comment">// 获取 list 集合中元素的类型</span></span><br><span class="line">                Class requiredType = GenericCollectionTypeResolver.getCollectionReturnType(</span><br><span class="line">                        pd.getReadMethod(), tokens.keys.length);</span><br><span class="line">                List list = (List) propValue;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">int</span> index = Integer.parseInt(key);</span><br><span class="line">                Object oldValue = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (isExtractOldValueForEditor() &amp;&amp; index &lt; list.size()) &#123;</span><br><span class="line">                    oldValue = list.get(index);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 获取 list 解析后的属性值</span></span><br><span class="line">                Object convertedValue = convertIfNecessary(propertyName, oldValue, pv.getValue(),</span><br><span class="line">                        requiredType, TypeDescriptor.nested(property(pd), tokens.keys.length));</span><br><span class="line">                <span class="comment">// 获取 list 集合的 size</span></span><br><span class="line">                <span class="keyword">int</span> size = list.size();</span><br><span class="line">                <span class="comment">// 如果 list 的长度大于属性值的长度，则多余的元素赋值为 null </span></span><br><span class="line">                <span class="keyword">if</span> (index &gt;= size &amp;&amp; index &lt; <span class="keyword">this</span>.autoGrowCollectionLimit) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = size; i &lt; index; i++) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            list.add(<span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">catch</span> (NullPointerException ex) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidPropertyException(getRootClass(), <span class="keyword">this</span>.nestedPath + propertyName,</span><br><span class="line">                                    <span class="string">"Cannot set element with index "</span> + index + <span class="string">" in List of size "</span> +</span><br><span class="line">                                    size + <span class="string">", accessed using property path '"</span> + propertyName +</span><br><span class="line">                                    <span class="string">"': List does not support filling up gaps with null elements"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    list.add(convertedValue);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// 为 list 属性赋值</span></span><br><span class="line">                        list.set(index, convertedValue);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">catch</span> (IndexOutOfBoundsException ex) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidPropertyException(getRootClass(), <span class="keyword">this</span>.nestedPath + propertyName,</span><br><span class="line">                                <span class="string">"Invalid list index in property path '"</span> + propertyName + <span class="string">"'"</span>, ex);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果属性值是 Map 类型的，则注入 Map 类型的属性值</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (propValue <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">                PropertyDescriptor pd = getCachedIntrospectionResults().getPropertyDescriptor(actualName);</span><br><span class="line">                <span class="comment">// 获取 map 集合 key 的类型</span></span><br><span class="line">                Class mapKeyType = GenericCollectionTypeResolver.getMapKeyReturnType(</span><br><span class="line">                        pd.getReadMethod(), tokens.keys.length);</span><br><span class="line">                <span class="comment">// 获取 map 集合 value 的类型</span></span><br><span class="line">                Class mapValueType = GenericCollectionTypeResolver.getMapValueReturnType(</span><br><span class="line">                        pd.getReadMethod(), tokens.keys.length);</span><br><span class="line">                Map map = (Map) propValue;</span><br><span class="line">                TypeDescriptor typeDescriptor = (mapKeyType != <span class="keyword">null</span> ?</span><br><span class="line">                        TypeDescriptor.valueOf(mapKeyType) : TypeDescriptor.valueOf(Object.class));</span><br><span class="line">                <span class="comment">// 解析 map 类型属性 key 值</span></span><br><span class="line">                Object convertedMapKey = convertIfNecessary(<span class="keyword">null</span>, <span class="keyword">null</span>, key, mapKeyType, typeDescriptor);</span><br><span class="line">                Object oldValue = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (isExtractOldValueForEditor()) &#123;</span><br><span class="line">                    oldValue = map.get(convertedMapKey);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 解析 map 类型属性 value 值</span></span><br><span class="line">                Object convertedMapValue = convertIfNecessary(propertyName, oldValue, pv.getValue(),</span><br><span class="line">                        mapValueType, TypeDescriptor.nested(property(pd), tokens.keys.length));</span><br><span class="line">                <span class="comment">// 将解析后的 key 和 value 值赋值给 map 集合属性</span></span><br><span class="line">                map.put(convertedMapKey, convertedMapValue);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidPropertyException(getRootClass(), <span class="keyword">this</span>.nestedPath + propertyName,</span><br><span class="line">                        <span class="string">"Property referenced in indexed property path '"</span> + propertyName +</span><br><span class="line">                        <span class="string">"' is neither an array nor a List nor a Map; returned value was ["</span> + pv.getValue() + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 对非集合类型的属性注入</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            PropertyDescriptor pd = pv.resolvedDescriptor;</span><br><span class="line">            <span class="keyword">if</span> (pd == <span class="keyword">null</span> || !pd.getWriteMethod().getDeclaringClass().isInstance(<span class="keyword">this</span>.object)) &#123;</span><br><span class="line">                pd = getCachedIntrospectionResults().getPropertyDescriptor(actualName);</span><br><span class="line">                <span class="comment">// 如果无法获取到属性名或者属性没有提供 setter 赋值方法</span></span><br><span class="line">                <span class="keyword">if</span> (pd == <span class="keyword">null</span> || pd.getWriteMethod() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 如果属性值是可选的，即不是必须的，则忽略该属性值</span></span><br><span class="line">                    <span class="keyword">if</span> (pv.isOptional()) &#123;</span><br><span class="line">                        logger.debug(<span class="string">"Ignoring optional value for property '"</span> + actualName +</span><br><span class="line">                                <span class="string">"' - property not found on bean class ["</span> + getRootClass().getName() + <span class="string">"]"</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 如果属性值是必须的，则抛出无法给属性赋值，因为没提供 setter 方法的异常</span></span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        PropertyMatches matches = PropertyMatches.forProperty(propertyName, getRootClass());</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> NotWritablePropertyException(</span><br><span class="line">                                getRootClass(), <span class="keyword">this</span>.nestedPath + propertyName,</span><br><span class="line">                                matches.buildErrorMessage(), matches.getPossibleMatches());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                pv.getOriginalPropertyValue().resolvedDescriptor = pd;</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            Object oldValue = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Object originalValue = pv.getValue();</span><br><span class="line">                Object valueToApply = originalValue;</span><br><span class="line">                <span class="keyword">if</span> (!Boolean.FALSE.equals(pv.conversionNecessary)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (pv.isConverted()) &#123;</span><br><span class="line">                        valueToApply = pv.getConvertedValue();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (isExtractOldValueForEditor() &amp;&amp; pd.getReadMethod() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// 获取属性的 getter 方法</span></span><br><span class="line">                            <span class="keyword">final</span> Method readMethod = pd.getReadMethod();</span><br><span class="line">                            <span class="comment">// 如果属性的 getter 方法无法访问，则使用 Java 的反射机制强行访问 (暴力读取属性值) </span></span><br><span class="line">                            <span class="keyword">if</span> (!Modifier.isPublic(readMethod.getDeclaringClass().getModifiers()) &amp;&amp;</span><br><span class="line">                                    !readMethod.isAccessible()) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (System.getSecurityManager()!= <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    <span class="comment">// 匿名内部类，根据权限修改属性的读取控制限制 </span></span><br><span class="line">                                    AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Object&gt;() &#123;</span><br><span class="line">                                        <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                            readMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                                            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;);</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">else</span> &#123;</span><br><span class="line">                                    readMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                 <span class="comment">// 属性没有提供 getter 方法时，调用潜在的读取属性值的方法，获取属性值 </span></span><br><span class="line">                                <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    oldValue = AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedExceptionAction&lt;Object&gt;() &#123;</span><br><span class="line">                                        <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                                            <span class="keyword">return</span> readMethod.invoke(object);</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;, acc);</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">else</span> &#123;</span><br><span class="line">                                    oldValue = readMethod.invoke(object);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> PrivilegedActionException) &#123;</span><br><span class="line">                                    ex = ((PrivilegedActionException) ex).getException();</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                                    logger.debug(<span class="string">"Could not read previous value of property '"</span> +</span><br><span class="line">                                            <span class="keyword">this</span>.nestedPath + propertyName + <span class="string">"'"</span>, ex);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 设置属性的注入值</span></span><br><span class="line">                        valueToApply = convertForProperty(propertyName, oldValue, originalValue, pd);</span><br><span class="line">                    &#125;</span><br><span class="line">                    pv.getOriginalPropertyValue().conversionNecessary = (valueToApply != originalValue);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 根据 Java 的内省机制，获取属性的 setter方法</span></span><br><span class="line">                <span class="keyword">final</span> Method writeMethod = (pd <span class="keyword">instanceof</span> GenericTypeAwarePropertyDescriptor ?</span><br><span class="line">                        ((GenericTypeAwarePropertyDescriptor) pd).getWriteMethodForActualAccess() :</span><br><span class="line">                        pd.getWriteMethod());</span><br><span class="line">                <span class="comment">// 如果属性的 setter方法 无法访问，则强行设置 setter方法 可访问 (暴力为属性赋值)  </span></span><br><span class="line">                <span class="keyword">if</span> (!Modifier.isPublic(writeMethod.getDeclaringClass().getModifiers()) &amp;&amp; !writeMethod.isAccessible()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (System.getSecurityManager()!= <span class="keyword">null</span>) &#123;</span><br><span class="line">                        AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Object&gt;() &#123;</span><br><span class="line">                            <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                writeMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        writeMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">final</span> Object value = valueToApply;</span><br><span class="line">                 <span class="comment">// 如果使用了 Java 的安全机制，则需要权限验证 </span></span><br><span class="line">                <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedExceptionAction&lt;Object&gt;() &#123;</span><br><span class="line">                            <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                                <span class="comment">// 将属性值设置到属性上去 </span></span><br><span class="line">                                writeMethod.invoke(object, value);</span><br><span class="line">                                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, acc);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">catch</span> (PrivilegedActionException ex) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> ex.getException();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 将属性值设置到属性上去 </span></span><br><span class="line">                    writeMethod.invoke(<span class="keyword">this</span>.object, value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (TypeMismatchException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">                PropertyChangeEvent propertyChangeEvent =</span><br><span class="line">                        <span class="keyword">new</span> PropertyChangeEvent(<span class="keyword">this</span>.rootObject, <span class="keyword">this</span>.nestedPath + propertyName, oldValue, pv.getValue());</span><br><span class="line">                <span class="keyword">if</span> (ex.getTargetException() <span class="keyword">instanceof</span> ClassCastException) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> TypeMismatchException(propertyChangeEvent, pd.getPropertyType(), ex.getTargetException());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> MethodInvocationException(propertyChangeEvent, ex.getTargetException());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                PropertyChangeEvent pce =</span><br><span class="line">                        <span class="keyword">new</span> PropertyChangeEvent(<span class="keyword">this</span>.rootObject, <span class="keyword">this</span>.nestedPath + propertyName, oldValue, pv.getValue());</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> MethodInvocationException(pce, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>至此，完成了对 bean 的各种属性的依赖注入，在 bean 的实例化和依赖注入的过程中，需要依据 BeanDefinition 中的信息来递归地完成依赖注入。另外，在此过程中存在许多递归调用，一个递归是在上下文体系中查找 当前 bean 依赖的 bean 和创建 当前 bean 依赖的 bean 的递归调用；另一个是在依赖注入时，通过递归调用容器的 getBean() 方法，得到当前 bean 的依赖 bean，同时也触发对依赖 bean 的创建和注入；在对 bean 的属性进行依赖注入时，解析的过程也是递归的。这样，根据依赖关系，从最末层的依赖 bean 开始，一层一层地完成 bean 的创建和注入，直到最后完成当前 bean 的创建。</p><h2 id="lazy-init-属性触发的依赖注入"><a href="#lazy-init-属性触发的依赖注入" class="headerlink" title="lazy-init 属性触发的依赖注入"></a>lazy-init 属性触发的依赖注入</h2><p>最后看一下 lazy-init 触发的预实例化和依赖注入，发生在 IoC 容器完成对 BeanDefinition 的定位、载入、解析和注册之后。通过牺牲 IoC 容器初始化的性能，来有效提升应用第一次获取该 bean 的效率。 lazy-init 实现的入口方法在我们前面解读过的 AbstractApplicationContext 的 refresh() 中，它是 IoC 容器正式启动的标志。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractApplicationContext</span> <span class="keyword">extends</span> <span class="title">DefaultResourceLoader</span></span></span><br><span class="line"><span class="class"><span class="keyword">implements</span> <span class="title">ConfigurableApplicationContext</span>, <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 容器初始化的过程：</span></span><br><span class="line"><span class="comment">     * 1、根据指定规则扫描指定目录，获取所有 用于配置bean的配置文件；</span></span><br><span class="line"><span class="comment">     * 2、根据 Spring定义的规则，解析配置文件中的各个元素，将其封装成 IoC容器 可以装载的 BeanDefinition对象；</span></span><br><span class="line"><span class="comment">     * 3、将封装好的 BeanDefinition 注册进 IoC容器。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * IoC容器的初始化 和 bean的依赖注入 是两个独立的过程，依赖注入一般发生在应用第一次通过 getBean()方法</span></span><br><span class="line"><span class="comment">     * 从容器获取 bean 时。</span></span><br><span class="line"><span class="comment">     * 另外需要注意的是，IoC容器 有一个预实例化的配置（即，将 &lt;bean&gt;元素 的 lazyInit属性 设为 false），</span></span><br><span class="line"><span class="comment">     * 使该 &lt;bean&gt;元素对应的 bean可以提前实例化，而不用等到调用 getBean()方法 时才开始实例化。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">            <span class="comment">// 调用容器准备刷新的方法，获取容器的当前时间，同时给容器设置同步标识</span></span><br><span class="line">            prepareRefresh();</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 告诉子类启动 refreshBeanFactory() 方法，BeanDefinition 资源文件的载入从子类的</span></span><br><span class="line">            <span class="comment">// refreshBeanFactory() 方法启动开始</span></span><br><span class="line">            ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 为 BeanFactory 配置容器特性，例如类加载器、事件处理器等</span></span><br><span class="line">            prepareBeanFactory(beanFactory);</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 为容器的某些子类指定特殊的 BeanPost 事件处理器</span></span><br><span class="line">                postProcessBeanFactory(beanFactory);</span><br><span class="line">    </span><br><span class="line">                <span class="comment">// 调用所有注册的 BeanFactoryPostProcessor</span></span><br><span class="line">                invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line">    </span><br><span class="line">                <span class="comment">// 为 BeanFactory 注册 BeanPost 事件处理器.  </span></span><br><span class="line">                <span class="comment">// BeanPostProcessor 是 Bean 后置处理器，用于监听容器触发的事件 </span></span><br><span class="line">                registerBeanPostProcessors(beanFactory);</span><br><span class="line">    </span><br><span class="line">                <span class="comment">// 初始化信息源，和国际化相关.</span></span><br><span class="line">                initMessageSource();</span><br><span class="line">    </span><br><span class="line">                <span class="comment">// 初始化容器事件传播器</span></span><br><span class="line">                initApplicationEventMulticaster();</span><br><span class="line">    </span><br><span class="line">                <span class="comment">// 调用子类的某些特殊 Bean 初始化方法</span></span><br><span class="line">                onRefresh();</span><br><span class="line">    </span><br><span class="line">                <span class="comment">// 为事件传播器注册事件监听器.</span></span><br><span class="line">                registerListeners();</span><br><span class="line">    </span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * ！！！！！！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">                 * 对配置了 lazy-init属性 为 false 的 bean 进行预实例化</span></span><br><span class="line"><span class="comment">                 * ！！！！！！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                finishBeanFactoryInitialization(beanFactory);</span><br><span class="line">    </span><br><span class="line">                <span class="comment">// 初始化容器的生命周期事件处理器，并发布容器的生命周期事件</span></span><br><span class="line">                finishRefresh();</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">                <span class="comment">// 销毁以创建的单态 Bean</span></span><br><span class="line">                destroyBeans();</span><br><span class="line">    </span><br><span class="line">                <span class="comment">// 取消 refresh 操作，重置容器的同步标识.</span></span><br><span class="line">                cancelRefresh(ex);</span><br><span class="line">    </span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对配置了 lazy-init属性 为 false 的 bean 进行预实例化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishBeanFactoryInitialization</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 这是 Spring3 以后新加的代码，为容器指定一个转换服务 (ConversionService)  </span></span><br><span class="line">        <span class="comment">// 在对某些 bean 属性进行转换时使用  </span></span><br><span class="line">        <span class="keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;</span><br><span class="line">                beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;</span><br><span class="line">            beanFactory.setConversionService(</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * ！！！！！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">                     * 在这里 通过调用 getBean()方法，触发依赖注入</span></span><br><span class="line"><span class="comment">                     * ！！！！！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (String weaverAwareName : weaverAwareNames) &#123;</span><br><span class="line">            getBean(weaverAwareName);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 为了类型匹配，停止使用临时的类加载器  </span></span><br><span class="line">        beanFactory.setTempClassLoader(<span class="keyword">null</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 缓存容器中所有注册的 BeanDefinition 元数据，以防被修改</span></span><br><span class="line">        beanFactory.freezeConfiguration();</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 对配置了 lazy-init属性 为 false 的 单例bean 进行预实例化处理</span></span><br><span class="line">        beanFactory.preInstantiateSingletons();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://github.com/doocs/source-code-hunter/blob/master/docs/Spring/IoC/4%E3%80%81%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5(DI" target="_blank" rel="noopener">原文</a>.md)</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;前面我们主要分析了 FileSystemXmlApplicationContext 这个具体的 IoC 容器实现类 的初始化源码，在 IoC 容器 中建立了 beanName 到 BeanDefinition 的数据映射，通过一个 ConcurrentHashMap。现在我们来看一下 Spring 是如何将 IoC 容器中存在依赖关系的 bean 根据配置联系在一起的。&lt;/p&gt;
&lt;p&gt;Spring 中触发 IoC 容器 “依赖注入” 的方式有两种，一个是应用程序通过 getBean() 方法 向容器索要 bean 实例 时触发依赖注入；另一个是提前给 bean 配置了 lazy-init 属性为 false，Spring 在 IoC 容器 初始化会自动调用此 bean 的 getBean() 方法，提前完成依赖注入。总的来说，想提高运行时获取 bean 的效率，可以考虑配置此属性。&lt;/p&gt;
&lt;p&gt;下面我将分别解读这两种依赖注入的触发方式，先看 getBean() 的，因为 lazy-init 最后也是通过调用 getBean() 完成的依赖注入。&lt;/p&gt;
&lt;p&gt;（PS：可以结合我 GitHub 上对 Spring 框架源码的阅读及个人理解一起看，会更有助于各位开发姥爷理解，地址：&lt;br&gt;spring-beans &lt;a href=&quot;https://github.com/AmyliaY/spring-beans-reading&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/AmyliaY/spring-beans-reading&lt;/a&gt;&lt;br&gt;spring-context &lt;a href=&quot;https://github.com/AmyliaY/spring-context-reading&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/AmyliaY/spring-context-reading&lt;/a&gt; ）&lt;br&gt;
    
    </summary>
    
      <category term="JavaNotes" scheme="http://codewey.com/categories/JavaNotes/"/>
    
    
      <category term="Spring" scheme="http://codewey.com/tags/Spring/"/>
    
      <category term="IOC" scheme="http://codewey.com/tags/IOC/"/>
    
  </entry>
  
  <entry>
    <title>将 BeanDefinition 注册进 IoC 容器</title>
    <link href="http://codewey.com/post/Spring-IOC-03-BeanDefinition/"/>
    <id>http://codewey.com/post/Spring-IOC-03-BeanDefinition/</id>
    <published>2019-12-13T05:15:16.000Z</published>
    <updated>2020-05-31T11:04:36.638Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这篇文章分享一下 spring IoC 容器初始化第三部分的代码，也就是将前面解析出来的 BeanDefinition 对象 注册进 IoC 容器，其实就是存入一个 ConcurrentHashMap&lt;String, BeanDefinition&gt; 中。</p><p>（PS：可以结合我 GitHub 上对 Spring 框架源码的翻译注释一起看，会更有助于各位同学理解，地址：<br>spring-beans <a href="https://github.com/AmyliaY/spring-beans-reading" target="_blank" rel="noopener">https://github.com/AmyliaY/spring-beans-reading</a><br>spring-context <a href="https://github.com/AmyliaY/spring-context-reading" target="_blank" rel="noopener">https://github.com/AmyliaY/spring-context-reading</a> ）<br><a id="more"></a></p><h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>回过头看一下前面在 DefaultBeanDefinitionDocumentReader 中实现的 processBeanDefinition(Element ele, BeanDefinitionParserDelegate delegate) 方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将 .xml 文件中的元素解析成 BeanDefinition对象，并注册到 IoC容器 中</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processBeanDefinition</span><span class="params">(Element ele, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// BeanDefinitionHolder 是对 BeanDefinition 的进一步封装，它持有一个 BeanDefinition 对象 及其对应</span></span><br><span class="line">    <span class="comment">// 的 beanName、aliases别名。</span></span><br><span class="line">    <span class="comment">// 对 Document 对象中 &lt;Bean&gt; 元素的解析由 BeanDefinitionParserDelegate 实现</span></span><br><span class="line">    BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele);</span><br><span class="line">    <span class="keyword">if</span> (bdHolder != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 对 bdHolder 进行包装处理</span></span><br><span class="line">        bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">             * 向 IoC 容器注册解析完成的 BeanDefinition对象，这是 BeanDefinition 向 IoC 容器注册的入口</span></span><br><span class="line"><span class="comment">             * ！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">            getReaderContext().error(<span class="string">"Failed to register bean definition with name '"</span> +</span><br><span class="line">                    bdHolder.getBeanName() + <span class="string">"'"</span>, ele, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 在完成向 IOC容器 注册 BeanDefinition对象 之后，发送注册事件</span></span><br><span class="line">        getReaderContext().fireComponentRegistered(<span class="keyword">new</span> BeanComponentDefinition(bdHolder));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着看一下 BeanDefinitionReaderUtils 的 registerBeanDefinition(BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry) 方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将解析到的 BeanDefinition对象 注册到 IoC容器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取解析的 &lt;bean&gt;元素 的名称 beanName</span></span><br><span class="line">    String beanName = definitionHolder.getBeanName();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">     * 开始向 IoC容器 注册 BeanDefinition对象</span></span><br><span class="line"><span class="comment">     * ！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果解析的 &lt;bean&gt;元素 有别名alias，向容器中注册别名</span></span><br><span class="line">    String[] aliases = definitionHolder.getAliases();</span><br><span class="line">    <span class="keyword">if</span> (aliases != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (String aliase : aliases) &#123;</span><br><span class="line">            registry.registerAlias(beanName, aliase);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BeanDefinitionRegistry 中的 registerBeanDefinition(String beanName, BeanDefinition beanDefinition) 方法在 DefaultListableBeanFactory 实现类中的具体实现。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultListableBeanFactory</span> <span class="keyword">extends</span> <span class="title">AbstractAutowireCapableBeanFactory</span></span></span><br><span class="line"><span class="class"><span class="keyword">implements</span> <span class="title">ConfigurableListableBeanFactory</span>, <span class="title">BeanDefinitionRegistry</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 按注册顺序排列的 beanDefinition名称列表(即 beanName)  */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; beanDefinitionNames = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** IoC容器 的实际体现，key --&gt; beanName，value --&gt; BeanDefinition对象 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, BeanDefinition&gt; beanDefinitionMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, BeanDefinition&gt;(<span class="number">64</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向 IoC容器 注册解析的 beanName 和 BeanDefinition对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">    </span><br><span class="line">        Assert.hasText(beanName, <span class="string">"Bean name must not be empty"</span>);</span><br><span class="line">        Assert.notNull(beanDefinition, <span class="string">"BeanDefinition must not be null"</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 校验解析的 BeanDefiniton对象</span></span><br><span class="line">        <span class="keyword">if</span> (beanDefinition <span class="keyword">instanceof</span> AbstractBeanDefinition) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ((AbstractBeanDefinition) beanDefinition).validate();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(beanDefinition.getResourceDescription(), beanName,</span><br><span class="line">                        <span class="string">"Validation of bean definition failed"</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 注册的过程中需要线程同步，以保证数据的一致性</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.beanDefinitionMap) &#123;</span><br><span class="line">            Object oldBeanDefinition = <span class="keyword">this</span>.beanDefinitionMap.get(beanName);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 检查是否有同名(beanName)的 BeanDefinition 存在于 IoC容器 中，如果已经存在，且不允许覆盖</span></span><br><span class="line">            <span class="comment">// 已注册的 BeanDefinition，则抛出注册异常，allowBeanDefinitionOverriding 默认为 true</span></span><br><span class="line">            <span class="keyword">if</span> (oldBeanDefinition != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">this</span>.allowBeanDefinitionOverriding) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(beanDefinition.getResourceDescription(), beanName,</span><br><span class="line">                            <span class="string">"Cannot register bean definition ["</span> + beanDefinition + <span class="string">"] for bean '"</span> + beanName +</span><br><span class="line">                            <span class="string">"': There is already ["</span> + oldBeanDefinition + <span class="string">"] bound."</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果允许覆盖同名的 bean，后注册的会覆盖先注册的</span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isInfoEnabled()) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.logger.info(<span class="string">"Overriding bean definition for bean '"</span> + beanName +</span><br><span class="line">                                <span class="string">"': replacing ["</span> + oldBeanDefinition + <span class="string">"] with ["</span> + beanDefinition + <span class="string">"]"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 若该 beanName 在 IoC容器 中尚未注册，将其注册到 IoC容器中，</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 将 beanName 注册到 beanDefinitionNames列表</span></span><br><span class="line">                <span class="keyword">this</span>.beanDefinitionNames.add(beanName);</span><br><span class="line">                <span class="keyword">this</span>.frozenBeanDefinitionNames = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// beanDefinitionMap 是 IoC容器 的最主要体现，他是一个 ConcurrentHashMap，</span></span><br><span class="line">            <span class="comment">// 直接存储了 bean的唯一标识 beanName，及其对应的 BeanDefinition对象</span></span><br><span class="line">            <span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 重置所有已经注册过的 BeanDefinition 的缓存</span></span><br><span class="line">        resetBeanDefinition(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://github.com/doocs/source-code-hunter/blob/master/docs/Spring/IoC/3%E3%80%81%E5%B0%86BeanDefinition%E6%B3%A8%E5%86%8C%E8%BF%9BIoC%E5%AE%B9%E5%99%A8.md" target="_blank" rel="noopener">原文</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;这篇文章分享一下 spring IoC 容器初始化第三部分的代码，也就是将前面解析出来的 BeanDefinition 对象 注册进 IoC 容器，其实就是存入一个 ConcurrentHashMap&amp;lt;String, BeanDefinition&amp;gt; 中。&lt;/p&gt;
&lt;p&gt;（PS：可以结合我 GitHub 上对 Spring 框架源码的翻译注释一起看，会更有助于各位同学理解，地址：&lt;br&gt;spring-beans &lt;a href=&quot;https://github.com/AmyliaY/spring-beans-reading&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/AmyliaY/spring-beans-reading&lt;/a&gt;&lt;br&gt;spring-context &lt;a href=&quot;https://github.com/AmyliaY/spring-context-reading&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/AmyliaY/spring-context-reading&lt;/a&gt; ）&lt;br&gt;
    
    </summary>
    
      <category term="JavaNotes" scheme="http://codewey.com/categories/JavaNotes/"/>
    
    
      <category term="Spring" scheme="http://codewey.com/tags/Spring/"/>
    
      <category term="IOC" scheme="http://codewey.com/tags/IOC/"/>
    
  </entry>
  
  <entry>
    <title>将 bean 解析封装成 BeanDefinition</title>
    <link href="http://codewey.com/post/Spring-IOC-02-BeanDefinition/"/>
    <id>http://codewey.com/post/Spring-IOC-02-BeanDefinition/</id>
    <published>2019-12-13T04:12:16.000Z</published>
    <updated>2020-05-31T11:07:09.560Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>接着上一篇的 BeanDefinition 资源定位开始讲。Spring IoC 容器 BeanDefinition 解析过程就是把用户在配置文件中配置的 bean，解析并封装成 IoC 容器可以装载的 BeanDefinition 对象，BeanDefinition 是 Spring 定义的基本数据结构，其中的属性与配置文件中 bean 的属性相对应。</p><a id="more"></a><p>（PS：可以结合我 GitHub 上对 Spring 框架源码的阅读及个人理解一起看，会更有助于各位开发大佬理解。地址如下。<br>spring-beans <a href="https://github.com/AmyliaY/spring-beans-reading" target="_blank" rel="noopener">https://github.com/AmyliaY/spring-beans-reading</a><br>spring-context <a href="https://github.com/AmyliaY/spring-context-reading" target="_blank" rel="noopener">https://github.com/AmyliaY/spring-context-reading</a> ）</p><h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>首先看一下 AbstractRefreshableApplicationContext 的 refreshBeanFactory() 方法，这是一个模板方法，其中调用的 loadBeanDefinitions() 方法是一个抽象方法，交由子类实现。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在这里完成了容器的初始化，并赋值给自己私有的 beanFactory 属性，为下一步调用做准备</span></span><br><span class="line"><span class="comment"> * 从父类 AbstractApplicationContext 继承的抽象方法，自己做了实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">refreshBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">    <span class="comment">// 如果已经建立了 IoC 容器，则销毁并关闭容器</span></span><br><span class="line">    <span class="keyword">if</span> (hasBeanFactory()) &#123;</span><br><span class="line">        destroyBeans();</span><br><span class="line">        closeBeanFactory();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 创建 IoC 容器，DefaultListableBeanFactory 实现了 ConfigurableListableBeanFactory 接口</span></span><br><span class="line">        DefaultListableBeanFactory beanFactory = createBeanFactory();</span><br><span class="line">        beanFactory.setSerializationId(getId());</span><br><span class="line">        <span class="comment">// 对 IoC 容器进行定制化，如设置启动参数，开启注解的自动装配等</span></span><br><span class="line">        customizeBeanFactory(beanFactory);</span><br><span class="line">        <span class="comment">// 载入 BeanDefinition，当前类中只定义了抽象的 loadBeanDefinitions() 方法，具体的实现调用子类容器</span></span><br><span class="line">        loadBeanDefinitions(beanFactory);</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.beanFactoryMonitor) &#123;</span><br><span class="line">            <span class="comment">// 给自己的属性赋值</span></span><br><span class="line">            <span class="keyword">this</span>.beanFactory = beanFactory;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"I/O error parsing bean definition source for "</span> + getDisplayName(), ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面看一下 AbstractRefreshableApplicationContext 的子类 AbstractXmlApplicationContext 对 loadBeanDefinitions() 方法的实现。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(DefaultListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">// DefaultListableBeanFactory 实现了 BeanDefinitionRegistry 接口，所以在初始化 XmlBeanDefinitionReader 时</span></span><br><span class="line">    <span class="comment">// 将该 beanFactory 传入 XmlBeanDefinitionReader 的构造方法中。</span></span><br><span class="line">    <span class="comment">// 从名字也能看出来它的功能，这是一个用于从 .xml文件 中读取 BeanDefinition 的读取器</span></span><br><span class="line">    XmlBeanDefinitionReader beanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</span><br><span class="line"></span><br><span class="line">    beanDefinitionReader.setEnvironment(<span class="keyword">this</span>.getEnvironment());</span><br><span class="line">    <span class="comment">// 为 beanDefinition 读取器设置 资源加载器，由于本类的基类 AbstractApplicationContext</span></span><br><span class="line">    <span class="comment">// 继承了 DefaultResourceLoader，因此，本容器自身也是一个资源加载器</span></span><br><span class="line">    beanDefinitionReader.setResourceLoader(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// 为 beanDefinitionReader 设置用于解析的 SAX 实例解析器，SAX（simple API for XML）是另一种XML解析方法。</span></span><br><span class="line">    <span class="comment">// 相比于DOM，SAX速度更快，占用内存更小。它逐行扫描文档，一边扫描一边解析。相比于先将整个XML文件扫描进内存，</span></span><br><span class="line">    <span class="comment">// 再进行解析的DOM，SAX可以在解析文档的任意时刻停止解析，但操作也比DOM复杂。</span></span><br><span class="line">    beanDefinitionReader.setEntityResolver(<span class="keyword">new</span> ResourceEntityResolver(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 beanDefinition 读取器，该方法同时启用了 XML 的校验机制</span></span><br><span class="line">    initBeanDefinitionReader(beanDefinitionReader);</span><br><span class="line">    <span class="comment">// 用传进来的 XmlBeanDefinitionReader 读取器读取 .xml 文件中配置的 bean</span></span><br><span class="line">    loadBeanDefinitions(beanDefinitionReader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着看一下上面最后一个调用的方法 loadBeanDefinitions(XmlBeanDefinitionReader reader)。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 读取并解析 .xml 文件中配置的 bean，然后封装成 BeanDefinition 对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(XmlBeanDefinitionReader reader)</span> <span class="keyword">throws</span> BeansException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ClassPathXmlApplicationContext 与 FileSystemXmlApplicationContext</span></span><br><span class="line"><span class="comment">     * 在这里的调用出现分歧，各自按不同的方式加载解析 Resource 资源</span></span><br><span class="line"><span class="comment">     * 最后在具体的解析和 BeanDefinition 定位上又会殊途同归</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取存放了 BeanDefinition 的所有 Resource，FileSystemXmlApplicationContext 中未对</span></span><br><span class="line">    <span class="comment">// getConfigResources() 进行重写，所以调用父类的，return null。</span></span><br><span class="line">    <span class="comment">// 而 ClassPathXmlApplicationContext 对该方法进行了重写，返回设置的值</span></span><br><span class="line">    Resource[] configResources = getConfigResources();</span><br><span class="line">    <span class="keyword">if</span> (configResources != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 这里调用的是其父类 AbstractBeanDefinitionReader 中的方法，解析加载 BeanDefinition对象</span></span><br><span class="line">        reader.loadBeanDefinitions(configResources);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用其父类 AbstractRefreshableConfigApplicationContext 中的实现，优先返回</span></span><br><span class="line">    <span class="comment">// FileSystemXmlApplicationContext 构造方法中调用 setConfigLocations() 方法设置的资源路径    </span></span><br><span class="line">    String[] configLocations = getConfigLocations();</span><br><span class="line">    <span class="keyword">if</span> (configLocations != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 这里调用其父类 AbstractBeanDefinitionReader 的方法从配置位置加载 BeanDefinition</span></span><br><span class="line">        reader.loadBeanDefinitions(configLocations);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AbstractBeanDefinitionReader 对 loadBeanDefinitions() 方法的三重重载。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * loadBeanDefinitions() 方法的重载方法之一，调用了另一个重载方法 loadBeanDefinitions(String location)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(String... locations)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">    Assert.notNull(locations, <span class="string">"Location array must not be null"</span>);</span><br><span class="line">    <span class="comment">// 计数器，统计加载了多少个配置文件</span></span><br><span class="line">    <span class="keyword">int</span> counter = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (String location : locations) &#123;</span><br><span class="line">        counter += loadBeanDefinitions(location);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> counter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 重载方法之一，调用了下面的 loadBeanDefinitions(String location, Set&lt;Resource&gt; actualResources) 方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(String location)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> loadBeanDefinitions(location, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取在 IoC 容器初始化过程中设置的资源加载器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(String location, Set&lt;Resource&gt; actualResources)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">    <span class="comment">// 在实例化 XmlBeanDefinitionReader 时 曾将 IoC 容器注入该对象，作为 resourceLoader 属性</span></span><br><span class="line">    ResourceLoader resourceLoader = getResourceLoader();</span><br><span class="line">    <span class="keyword">if</span> (resourceLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">                <span class="string">"Cannot import bean definitions from location ["</span> + location + <span class="string">"]: no ResourceLoader available"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (resourceLoader <span class="keyword">instanceof</span> ResourcePatternResolver) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 将指定位置的 bean 配置文件解析为 BeanDefinition 对象</span></span><br><span class="line">            <span class="comment">// 加载多个指定位置的 BeanDefinition 资源</span></span><br><span class="line">            Resource[] resources = ((ResourcePatternResolver) resourceLoader).getResources(location);</span><br><span class="line">            <span class="comment">// 调用其子类 XmlBeanDefinitionReader 的方法，实现加载功能 </span></span><br><span class="line">            <span class="keyword">int</span> loadCount = loadBeanDefinitions(resources);</span><br><span class="line">            <span class="keyword">if</span> (actualResources != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Resource resource : resources) &#123;</span><br><span class="line">                    actualResources.add(resource);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Loaded "</span> + loadCount + <span class="string">" bean definitions from location pattern ["</span> + location + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> loadCount;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">                    <span class="string">"Could not resolve bean definition resource pattern ["</span> + location + <span class="string">"]"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">         * AbstractApplicationContext 继承了 DefaultResourceLoader，所以 AbstractApplicationContext</span></span><br><span class="line"><span class="comment">         * 及其子类都可以调用 DefaultResourceLoader 中的方法，将指定位置的资源文件解析为 Resource，</span></span><br><span class="line"><span class="comment">         * 至此完成了对 BeanDefinition 的资源定位</span></span><br><span class="line"><span class="comment">         * ！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Resource resource = resourceLoader.getResource(location);</span><br><span class="line">        <span class="comment">// 从 resource 中加载 BeanDefinition，loadCount 为加载的 BeanDefinition 个数</span></span><br><span class="line">        <span class="comment">// 该 loadBeanDefinitions() 方法来自其 implements 的 BeanDefinitionReader 接口，</span></span><br><span class="line">        <span class="comment">// 且本类是一个抽象类，并未对该方法进行实现。而是交由子类进行实现，如果是用 xml 文件进行</span></span><br><span class="line">        <span class="comment">// IoC 容器初始化的，则调用 XmlBeanDefinitionReader 中的实现</span></span><br><span class="line">        <span class="keyword">int</span> loadCount = loadBeanDefinitions(resource);</span><br><span class="line">        <span class="keyword">if</span> (actualResources != <span class="keyword">null</span>) &#123;</span><br><span class="line">            actualResources.add(resource);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">"Loaded "</span> + loadCount + <span class="string">" bean definitions from location ["</span> + location + <span class="string">"]"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> loadCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>XmlBeanDefinitionReader 读取器中的方法执行流，按代码的先后顺序。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * XmlBeanDefinitionReader 加载资源的入口方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(Resource resource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">    <span class="comment">// 调用本类的重载方法，通过 new EncodedResource(resource) 获得的 EncodedResource 对象</span></span><br><span class="line">    <span class="comment">// 能够将资源与读取资源所需的编码组合在一起</span></span><br><span class="line">    <span class="keyword">return</span> loadBeanDefinitions(<span class="keyword">new</span> EncodedResource(resource));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过 encodedResource 进行资源解析，encodedResource 对象持有 resource 对象和 encoding 编码格式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(EncodedResource encodedResource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">    Assert.notNull(encodedResource, <span class="string">"EncodedResource must not be null"</span>);</span><br><span class="line">    <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">        logger.info(<span class="string">"Loading XML bean definitions from "</span> + encodedResource.getResource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Set&lt;EncodedResource&gt; currentResources = <span class="keyword">this</span>.resourcesCurrentlyBeingLoaded.get();</span><br><span class="line">    <span class="keyword">if</span> (currentResources == <span class="keyword">null</span>) &#123;</span><br><span class="line">        currentResources = <span class="keyword">new</span> HashSet&lt;EncodedResource&gt;(<span class="number">4</span>);</span><br><span class="line">        <span class="keyword">this</span>.resourcesCurrentlyBeingLoaded.set(currentResources);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!currentResources.add(encodedResource)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">                <span class="string">"Detected cyclic loading of "</span> + encodedResource + <span class="string">" - check your import definitions!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 从 resource 中获取输入流，对 resource 中的内容进行读取</span></span><br><span class="line">        InputStream inputStream = encodedResource.getResource().getInputStream();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 实例化一个"XML 实体的单个输入源"，将 inputStream 作为自己的属性</span></span><br><span class="line">            InputSource inputSource = <span class="keyword">new</span> InputSource(inputStream);</span><br><span class="line">            <span class="comment">// 如果 encodedResource 中的 encoding 属性不为空，就为 inputSource 设置读取 XML 的编码格式</span></span><br><span class="line">            <span class="keyword">if</span> (encodedResource.getEncoding() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                inputSource.setEncoding(encodedResource.getEncoding());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 这里是具体的读取过程</span></span><br><span class="line">            <span class="keyword">return</span> doLoadBeanDefinitions(inputSource, encodedResource.getResource());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 关闭 IO 流</span></span><br><span class="line">            inputStream.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">                <span class="string">"IOException parsing XML document from "</span> + encodedResource.getResource(), ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        currentResources.remove(encodedResource);</span><br><span class="line">        <span class="keyword">if</span> (currentResources.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.resourcesCurrentlyBeingLoaded.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从指定 XML 文件中解析 bean，封装成 BeanDefinition 对象的具体实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">doLoadBeanDefinitions</span><span class="params">(InputSource inputSource, Resource resource)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> validationMode = getValidationModeForResource(resource);</span><br><span class="line">        <span class="comment">// 通过 documentLoader 获取 XML 文件的 Document 对象</span></span><br><span class="line">        Document doc = <span class="keyword">this</span>.documentLoader.loadDocument(</span><br><span class="line">                inputSource, getEntityResolver(), <span class="keyword">this</span>.errorHandler, validationMode, isNamespaceAware());</span><br><span class="line">        <span class="comment">// 启动对 BeanDefinition 的详细解析过程，该解析过程会用到 Spring 的 Bean 配置规则</span></span><br><span class="line">        <span class="keyword">return</span> registerBeanDefinitions(doc, resource);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (SAXParseException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> XmlBeanDefinitionStoreException(resource.getDescription(),</span><br><span class="line">                <span class="string">"Line "</span> + ex.getLineNumber() + <span class="string">" in XML document from "</span> + resource + <span class="string">" is invalid"</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (SAXException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> XmlBeanDefinitionStoreException(resource.getDescription(),</span><br><span class="line">                <span class="string">"XML document from "</span> + resource + <span class="string">" is invalid"</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (ParserConfigurationException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(resource.getDescription(),</span><br><span class="line">                <span class="string">"Parser configuration exception parsing XML from "</span> + resource, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(resource.getDescription(),</span><br><span class="line">                <span class="string">"IOException parsing XML document from "</span> + resource, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(resource.getDescription(),</span><br><span class="line">                <span class="string">"Unexpected exception parsing XML document from "</span> + resource, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 按照 Spring 对配置文件中 bean 元素的语义定义，将 bean 元素 解析成 BeanDefinition 对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">registerBeanDefinitions</span><span class="params">(Document doc, Resource resource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">    <span class="comment">// 得到 BeanDefinitionDocumentReader，将 xml 中配置的 bean 解析成 BeanDefinition 对象</span></span><br><span class="line">    <span class="comment">// BeanDefinitionDocumentReader 只是个接口，这里实际上是一个 DefaultBeanDefinitionDocumentReader 对象</span></span><br><span class="line">    BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader();</span><br><span class="line">    documentReader.setEnvironment(<span class="keyword">this</span>.getEnvironment());</span><br><span class="line">    <span class="comment">// 获得容器中注册的 bean 数量</span></span><br><span class="line">    <span class="keyword">int</span> countBefore = getRegistry().getBeanDefinitionCount();</span><br><span class="line">    <span class="comment">// 解析过程入口</span></span><br><span class="line">    documentReader.registerBeanDefinitions(doc, createReaderContext(resource));</span><br><span class="line">    <span class="comment">// 统计解析的 Bean 数量</span></span><br><span class="line">    <span class="keyword">return</span> getRegistry().getBeanDefinitionCount() - countBefore;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>文档解析器 DefaultBeanDefinitionDocumentReader 对配置文件中元素的解析。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据 Spring 对 Bean 的定义规则进行解析</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(Document doc, XmlReaderContext readerContext)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获得 XML 描述符</span></span><br><span class="line">    <span class="keyword">this</span>.readerContext = readerContext;</span><br><span class="line">    logger.debug(<span class="string">"Loading bean definitions"</span>);</span><br><span class="line">    <span class="comment">// 获得 Document 的根元素</span></span><br><span class="line">    Element root = doc.getDocumentElement();</span><br><span class="line">    <span class="comment">// 解析的具体实现</span></span><br><span class="line">    doRegisterBeanDefinitions(root);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 依次注册 BeanDefinition，使用给定的根元素</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRegisterBeanDefinitions</span><span class="params">(Element root)</span> </span>&#123;</span><br><span class="line">    String profileSpec = root.getAttribute(PROFILE_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(profileSpec)) &#123;</span><br><span class="line">        Assert.state(<span class="keyword">this</span>.environment != <span class="keyword">null</span>, <span class="string">"Environment must be set for evaluating profiles"</span>);</span><br><span class="line">        String[] specifiedProfiles = StringUtils.tokenizeToStringArray(</span><br><span class="line">                profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.environment.acceptsProfiles(specifiedProfiles)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 具体的解析过程由 BeanDefinitionParserDelegate 实现，  </span></span><br><span class="line">    <span class="comment">// BeanDefinitionParserDelegate中定义了用于解析 bean 的各种属性及方法</span></span><br><span class="line">    BeanDefinitionParserDelegate parent = <span class="keyword">this</span>.delegate;</span><br><span class="line">    <span class="keyword">this</span>.delegate = createDelegate(<span class="keyword">this</span>.readerContext, root, parent);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 前置解析处理，可以在解析 bean 之前进行自定义的解析，增强解析的可扩展性</span></span><br><span class="line">    preProcessXml(root);</span><br><span class="line">    <span class="comment">// 从 Document 的根元素开始进行 Bean 定义的 Document 对象</span></span><br><span class="line">    parseBeanDefinitions(root, <span class="keyword">this</span>.delegate);</span><br><span class="line">    <span class="comment">// 后置解析处理，可以在解析 bean 之后进行自定义的解析，增加解析的可扩展性</span></span><br><span class="line">    postProcessXml(root);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.delegate = parent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据 Spring 的 bean解析规则，从 Document 的根元素开始进行解析</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseBeanDefinitions</span><span class="params">(Element root, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 根节点 root 是否使用了 Spring 默认的 XML 命名空间</span></span><br><span class="line">    <span class="keyword">if</span> (delegate.isDefaultNamespace(root)) &#123;</span><br><span class="line">        <span class="comment">// 获取根元素的所有子节点</span></span><br><span class="line">        NodeList nl = root.getChildNodes();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">            Node node = nl.item(i);</span><br><span class="line">            <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element) &#123;</span><br><span class="line">                Element ele = (Element) node;</span><br><span class="line">                <span class="comment">// 如果 ele 定义的 Document 的元素节点使用的是 Spring 默认的 XML 命名空间 </span></span><br><span class="line">                <span class="keyword">if</span> (delegate.isDefaultNamespace(ele)) &#123;</span><br><span class="line">                    <span class="comment">// 使用 Spring 的 bean解析规则 解析元素节点</span></span><br><span class="line">                    parseDefaultElement(ele, delegate);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 若没有使用 Spring 默认的 XML 命名空间，则使用用户自定义的解析规则解析元素节点</span></span><br><span class="line">                    delegate.parseCustomElement(ele);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 若 Document 的根节点没有使用 Spring 默认的命名空间，则使用用户自定义的解析规则</span></span><br><span class="line">        <span class="comment">// 解析 Document 根节点</span></span><br><span class="line">        delegate.parseCustomElement(root);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用 Spring 的 bean解析规则 解析 Spring元素节点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseDefaultElement</span><span class="params">(Element ele, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 解析 &lt;Import&gt; 元素</span></span><br><span class="line">    <span class="keyword">if</span> (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123;</span><br><span class="line">        importBeanDefinitionResource(ele);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 &lt;Alias&gt; 元素</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123;</span><br><span class="line">        processAliasRegistration(ele);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 若元素节点既不是 &lt;Import&gt; 也不是 &lt;Alias&gt;，即普通的 &lt;Bean&gt; 元素，  </span></span><br><span class="line">    <span class="comment">// 则按照 Spring 的 bean解析规则 解析元素</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) &#123;</span><br><span class="line">        processBeanDefinition(ele, delegate);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果被解析的元素是 beans，则递归调用 doRegisterBeanDefinitions(Element root) 方法进行解析</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123;</span><br><span class="line">        doRegisterBeanDefinitions(ele);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析 &lt;import&gt; 元素</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">importBeanDefinitionResource</span><span class="params">(Element ele)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取给定的导入元素的 location 属性</span></span><br><span class="line">    String location = ele.getAttribute(RESOURCE_ATTRIBUTE);</span><br><span class="line">    <span class="comment">// 如果导入元素的 location 属性值为空，则没有导入任何资源，直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.hasText(location)) &#123;</span><br><span class="line">        getReaderContext().error(<span class="string">"Resource location must not be empty"</span>, ele);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用系统变量值解析 location 属性值</span></span><br><span class="line">    location = environment.resolveRequiredPlaceholders(location);</span><br><span class="line"></span><br><span class="line">    Set&lt;Resource&gt; actualResources = <span class="keyword">new</span> LinkedHashSet&lt;Resource&gt;(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 标识给定的 &lt;Import&gt; 元素的 location 是否是绝对路径</span></span><br><span class="line">    <span class="keyword">boolean</span> absoluteLocation = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        absoluteLocation = ResourcePatternUtils.isUrl(location) || ResourceUtils.toURI(location).isAbsolute();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (URISyntaxException ex) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (absoluteLocation) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 使用资源读取器加载给定路径的 bean</span></span><br><span class="line">            <span class="keyword">int</span> importCount = getReaderContext().getReader().loadBeanDefinitions(location, actualResources);</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Imported "</span> + importCount + <span class="string">" bean definitions from URL location ["</span> + location + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">            getReaderContext().error(</span><br><span class="line">                    <span class="string">"Failed to import bean definitions from URL location ["</span> + location + <span class="string">"]"</span>, ele, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 给定的 &lt;import&gt; 元素的 location 是相对路径</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> importCount;</span><br><span class="line">            <span class="comment">// 将给定 &lt;import&gt; 元素的 location 封装为相对路径资源</span></span><br><span class="line">            Resource relativeResource = getReaderContext().getResource().createRelative(location);</span><br><span class="line">            <span class="comment">// 封装的相对路径资源存在</span></span><br><span class="line">            <span class="keyword">if</span> (relativeResource.exists()) &#123;</span><br><span class="line">                <span class="comment">// 使用资源读取器加载 bean</span></span><br><span class="line">                importCount = getReaderContext().getReader().loadBeanDefinitions(relativeResource);</span><br><span class="line">                actualResources.add(relativeResource);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 封装的相对路径资源不存在</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 获取 Spring IOC 容器资源读取器的基本路径 </span></span><br><span class="line">                String baseLocation = getReaderContext().getResource().getURL().toString();</span><br><span class="line">                <span class="comment">// 根据 Spring IoC 容器资源读取器的基本路径加载给定导入路径的资源</span></span><br><span class="line">                importCount = getReaderContext().getReader().loadBeanDefinitions(</span><br><span class="line">                        StringUtils.applyRelativePath(baseLocation, location), actualResources);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Imported "</span> + importCount + <span class="string">" bean definitions from relative location ["</span> + location + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            getReaderContext().error(<span class="string">"Failed to resolve current resource location"</span>, ele, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">            getReaderContext().error(<span class="string">"Failed to import bean definitions from relative location ["</span> + location + <span class="string">"]"</span>,</span><br><span class="line">                    ele, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Resource[] actResArray = actualResources.toArray(<span class="keyword">new</span> Resource[actualResources.size()]);</span><br><span class="line">    <span class="comment">// 在解析完 &lt;Import&gt; 元素之后，发送容器导入其他资源处理完成事件</span></span><br><span class="line">    getReaderContext().fireImportProcessed(location, actResArray, extractSource(ele));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析 &lt;Alias&gt; 元素</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processAliasRegistration</span><span class="params">(Element ele)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取 &lt;Alias&gt; 元素中的 name 属性值</span></span><br><span class="line">    String name = ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">    <span class="comment">// 获取 &lt;Alias&gt; 元素中的 alias 属性值</span></span><br><span class="line">    String alias = ele.getAttribute(ALIAS_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">boolean</span> valid = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">// 若 &lt;alias&gt; 元素的 name 属性值为空</span></span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.hasText(name)) &#123;</span><br><span class="line">        getReaderContext().error(<span class="string">"Name must not be empty"</span>, ele);</span><br><span class="line">        valid = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 若 &lt;alias&gt; 元素的 alias 属性值为空</span></span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.hasText(alias)) &#123;</span><br><span class="line">        getReaderContext().error(<span class="string">"Alias must not be empty"</span>, ele);</span><br><span class="line">        valid = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (valid) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 向容器的资源读取器 注册别名</span></span><br><span class="line">            getReaderContext().getRegistry().registerAlias(name, alias);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            getReaderContext().error(<span class="string">"Failed to register alias '"</span> + alias +</span><br><span class="line">                    <span class="string">"' for bean with name '"</span> + name + <span class="string">"'"</span>, ele, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 在解析完 &lt;Alias&gt; 元素之后，向容器发送别名处理完成事件</span></span><br><span class="line">        getReaderContext().fireAliasRegistered(name, alias, extractSource(ele));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析 bean 元素</span></span><br><span class="line"><span class="comment">protected void processBeanDefinition(Element ele, BeanDefinitionParserDelegate delegate) &#123;</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    // BeanDefinitionHolder 是对 BeanDefinition 的进一步封装，持有一个 BeanDefinition 对象 及其对应</span></span><br><span class="line"><span class="comment">    // 的 beanName、aliases别名。对 &lt;Bean&gt; 元素的解析由 BeanDefinitionParserDelegate 实现</span></span><br><span class="line"><span class="comment">    BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele);</span></span><br><span class="line"><span class="comment">    if (bdHolder != null) &#123;</span></span><br><span class="line"><span class="comment">        // 对 bdHolder 进行包装处理</span></span><br><span class="line"><span class="comment">        bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder);</span></span><br><span class="line"><span class="comment">        try &#123;</span></span><br><span class="line"><span class="comment">            /**</span></span><br><span class="line"><span class="comment">             * ！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">             * 向 Spring IoC 容器注册解析完成的 BeanDefinition对象，这是 BeanDefinition 向 IoC 容器注册的入口</span></span><br><span class="line"><span class="comment">             * ！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">            getReaderContext().error(<span class="string">"Failed to register bean definition with name '"</span> +</span><br><span class="line">                    bdHolder.getBeanName() + <span class="string">"'"</span>, ele, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 在完成向 Spring IOC 容器注册 BeanDefinition对象 之后，发送注册事件</span></span><br><span class="line">        getReaderContext().fireComponentRegistered(<span class="keyword">new</span> BeanComponentDefinition(bdHolder));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看一下 BeanDefinitionParserDelegate 中对 bean 元素的详细解析过程。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析 &lt;bean&gt; 元素的入口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinitionHolder <span class="title">parseBeanDefinitionElement</span><span class="params">(Element ele)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> parseBeanDefinitionElement(ele, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析 &lt;bean&gt; 元素，这个方法中主要处理 &lt;bean&gt; 元素的 id、name 和 alias 属性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinitionHolder <span class="title">parseBeanDefinitionElement</span><span class="params">(Element ele, BeanDefinition containingBean)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取 &lt;bean&gt; 元素中的 id 属性值</span></span><br><span class="line">    String id = ele.getAttribute(ID_ATTRIBUTE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取 &lt;bean&gt; 元素中的 name 属性值</span></span><br><span class="line">    String nameAttr = ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 &lt;bean&gt; 元素中的 alias 属性值</span></span><br><span class="line">    List&lt;String&gt; aliases = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将 &lt;bean&gt; 元素中的所有 name 属性值存放到别名中</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasLength(nameAttr)) &#123;</span><br><span class="line">        String[] nameArr = StringUtils.tokenizeToStringArray(nameAttr, MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span><br><span class="line">        aliases.addAll(Arrays.asList(nameArr));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String beanName = id;</span><br><span class="line">    <span class="comment">// 如果 &lt;bean&gt; 元素中没有配置 id 属性，则将 别名alias 中的第一个值赋值给 beanName</span></span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.hasText(beanName) &amp;&amp; !aliases.isEmpty()) &#123;</span><br><span class="line">        beanName = aliases.remove(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">"No XML 'id' specified - using '"</span> + beanName +</span><br><span class="line">                    <span class="string">"' as bean name and "</span> + aliases + <span class="string">" as aliases"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查 &lt;bean&gt; 元素所配置的 id 或者 name 的唯一性</span></span><br><span class="line">    <span class="comment">// 元素中是否包含子 &lt;bean&gt; 元素</span></span><br><span class="line">    <span class="keyword">if</span> (containingBean == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 检查 &lt;bean&gt; 元素所配置的 id、name 或者 别名alias 是否重复</span></span><br><span class="line">        checkNameUniqueness(beanName, aliases, ele);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将 &lt;bean&gt; 元素解析成 BeanDefinition对象</span></span><br><span class="line">    AbstractBeanDefinition beanDefinition = parseBeanDefinitionElement(ele, beanName, containingBean);</span><br><span class="line">    <span class="keyword">if</span> (beanDefinition != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(beanName)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 如果 &lt;bean&gt; 元素中没有配置 id、name 或者 alias，且没有包含子元素</span></span><br><span class="line">                <span class="keyword">if</span> (containingBean != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 为解析的 BeanDefinition 生成一个唯一的 beanName</span></span><br><span class="line">                    beanName = BeanDefinitionReaderUtils.generateBeanName(</span><br><span class="line">                            beanDefinition, <span class="keyword">this</span>.readerContext.getRegistry(), <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    beanName = <span class="keyword">this</span>.readerContext.generateBeanName(beanDefinition);</span><br><span class="line">                    <span class="comment">// 在别名集合 aliases 中添加 bean 的类名</span></span><br><span class="line">                    String beanClassName = beanDefinition.getBeanClassName();</span><br><span class="line">                    <span class="keyword">if</span> (beanClassName != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                            beanName.startsWith(beanClassName) &amp;&amp; beanName.length() &gt; beanClassName.length() &amp;&amp;</span><br><span class="line">                            !<span class="keyword">this</span>.readerContext.getRegistry().isBeanNameInUse(beanClassName)) &#123;</span><br><span class="line">                        aliases.add(beanClassName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(<span class="string">"Neither XML 'id' nor 'name' specified - "</span> +</span><br><span class="line">                            <span class="string">"using generated bean name ["</span> + beanName + <span class="string">"]"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                error(ex.getMessage(), ele);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] aliasesArray = StringUtils.toStringArray(aliases);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BeanDefinitionHolder(beanDefinition, beanName, aliasesArray);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 当解析出错时，返回 null</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 详细对 &lt;bean&gt; 元素中的其他属性进行解析，上面的方法中已经对 bean 的 id、name 及 alias 属性进行了处理</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> AbstractBeanDefinition <span class="title">parseBeanDefinitionElement</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        Element ele, String beanName, BeanDefinition containingBean)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录解析的 &lt;bean&gt;</span></span><br><span class="line">    <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> BeanEntry(beanName));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里只读取 &lt;bean&gt; 元素中配置的 class 名字，然后载入到 BeanDefinition 中去  </span></span><br><span class="line">    <span class="comment">// 只是记录配置的 class 名字，不做实例化，对象的实例化在 getBean() 时发生</span></span><br><span class="line">    String className = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (ele.hasAttribute(CLASS_ATTRIBUTE)) &#123;</span><br><span class="line">        className = ele.getAttribute(CLASS_ATTRIBUTE).trim();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String parent = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 如果 &lt;bean&gt; 元素中配置了 parent 属性，则获取 parent 属性的值</span></span><br><span class="line">        <span class="keyword">if</span> (ele.hasAttribute(PARENT_ATTRIBUTE)) &#123;</span><br><span class="line">            parent = ele.getAttribute(PARENT_ATTRIBUTE);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 根据 &lt;bean&gt; 元素配置的 class 名称和 parent 属性值创建 BeanDefinition  </span></span><br><span class="line">        AbstractBeanDefinition bd = createBeanDefinition(className, parent);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对当前的 &lt;bean&gt; 元素中配置的一些属性进行解析和设置，如配置的单例 (singleton) 属性等</span></span><br><span class="line">        parseBeanDefinitionAttributes(ele, beanName, containingBean, bd);</span><br><span class="line">        <span class="comment">// 为 BeanDefinition对象 注入 description属性值</span></span><br><span class="line">        bd.setDescription(DomUtils.getChildElementValueByTagName(ele, DESCRIPTION_ELEMENT));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析 &lt;bean&gt; 元素中的 meta 属性</span></span><br><span class="line">        parseMetaElements(ele, bd);</span><br><span class="line">        <span class="comment">// 解析 &lt;bean&gt; 元素中的 lookup-method 属性</span></span><br><span class="line">        parseLookupOverrideSubElements(ele, bd.getMethodOverrides());</span><br><span class="line">        <span class="comment">// 解析 &lt;bean&gt; 元素中的 replaced-method 属性</span></span><br><span class="line">        parseReplacedMethodSubElements(ele, bd.getMethodOverrides());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析 &lt;bean&gt; 元素的构造方法</span></span><br><span class="line">        parseConstructorArgElements(ele, bd);</span><br><span class="line">        <span class="comment">// 解析 &lt;bean&gt; 元素中的所有 &lt;property&gt; 元素</span></span><br><span class="line">        parsePropertyElements(ele, bd);</span><br><span class="line">        <span class="comment">// 解析 &lt;bean&gt; 元素的 qualifier 属性</span></span><br><span class="line">        parseQualifierElements(ele, bd);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 为当前BeanDefinition对象 设置所需的资源和依赖对象</span></span><br><span class="line">        bd.setResource(<span class="keyword">this</span>.readerContext.getResource());</span><br><span class="line">        bd.setSource(extractSource(ele));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bd;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">        error(<span class="string">"Bean class ["</span> + className + <span class="string">"] not found"</span>, ele, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (NoClassDefFoundError err) &#123;</span><br><span class="line">        error(<span class="string">"Class that bean class ["</span> + className + <span class="string">"] depends on not found"</span>, ele, err);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        error(<span class="string">"Unexpected failure during bean definition parsing"</span>, ele, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.parseState.pop();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 &lt;bean&gt; 元素出错时，返回 null</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对 bean 的部分子元素进行解析的具体实现。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析 &lt;bean&gt; 元素中所有的 &lt;property&gt; 子元素</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parsePropertyElements</span><span class="params">(Element beanEle, BeanDefinition bd)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取对应 &lt;bean&gt; 元素中所有的 &lt;property&gt; 子元素，逐一解析</span></span><br><span class="line">    NodeList nl = beanEle.getChildNodes();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">        Node node = nl.item(i);</span><br><span class="line">        <span class="comment">// 对 &lt;property&gt; 子元素进行详细解析</span></span><br><span class="line">        <span class="keyword">if</span> (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, PROPERTY_ELEMENT)) &#123;</span><br><span class="line">            parsePropertyElement((Element) node, bd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 详细解析 &lt;property&gt; 元素</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parsePropertyElement</span><span class="params">(Element ele, BeanDefinition bd)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取 &lt;property&gt; 元素的名字</span></span><br><span class="line">    String propertyName = ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.hasLength(propertyName)) &#123;</span><br><span class="line">        error(<span class="string">"Tag 'property' must have a 'name' attribute"</span>, ele);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> PropertyEntry(propertyName));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 如果一个 Bean 中已经有同名的 property 存在，则不进行解析，直接返回。  </span></span><br><span class="line">        <span class="comment">// 即如果在同一个 Bean 中配置同名的 property，则只有第一个起作用</span></span><br><span class="line">        <span class="keyword">if</span> (bd.getPropertyValues().contains(propertyName)) &#123;</span><br><span class="line">            error(<span class="string">"Multiple 'property' definitions for property '"</span> + propertyName + <span class="string">"'"</span>, ele);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析获取 propertyName 对应的 value值，propertyName 及其 value值会被封装到</span></span><br><span class="line">        <span class="comment">// PropertyValue 对象中，然后 set 到 BeanDefinition对象中去</span></span><br><span class="line">        Object val = parsePropertyValue(ele, bd, propertyName);</span><br><span class="line">        <span class="comment">// 根据 property 的 名字propertyName 和 值val 创建 PropertyValue实例</span></span><br><span class="line">        PropertyValue pv = <span class="keyword">new</span> PropertyValue(propertyName, val);</span><br><span class="line">        <span class="comment">// 解析 &lt;meta&gt; 元素</span></span><br><span class="line">        parseMetaElements(ele, pv);</span><br><span class="line">        pv.setSource(extractSource(ele));</span><br><span class="line">        <span class="comment">// 为当前的 BeanDefinition对象设置 propertyValues 属性值</span></span><br><span class="line">        bd.getPropertyValues().addPropertyValue(pv);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.parseState.pop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析获取 &lt;property&gt; 元素的属性值 value</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">parsePropertyValue</span><span class="params">(Element ele, BeanDefinition bd, String propertyName)</span> </span>&#123;</span><br><span class="line">    String elementName = (propertyName != <span class="keyword">null</span>) ?</span><br><span class="line">                    <span class="string">"&lt;property&gt; element for property '"</span> + propertyName + <span class="string">"'"</span> :</span><br><span class="line">                    <span class="string">"&lt;constructor-arg&gt; element"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 &lt;property&gt; 的所有子元素，只能是其中一种类型:ref,value,list 等</span></span><br><span class="line">    NodeList nl = ele.getChildNodes();</span><br><span class="line">    Element subElement = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">        Node node = nl.item(i);</span><br><span class="line">        <span class="comment">// 如果子元素不是 description 和 meta 属性</span></span><br><span class="line">        <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element &amp;&amp; !nodeNameEquals(node, DESCRIPTION_ELEMENT) &amp;&amp;</span><br><span class="line">                !nodeNameEquals(node, META_ELEMENT)) &#123;</span><br><span class="line">            <span class="comment">// Child element is what we're looking for.</span></span><br><span class="line">            <span class="keyword">if</span> (subElement != <span class="keyword">null</span>) &#123;</span><br><span class="line">                error(elementName + <span class="string">" must not contain more than one sub-element"</span>, ele);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;<span class="comment">// 当前 &lt;property&gt; 元素包含有子元素</span></span><br><span class="line">                subElement = (Element) node;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断 property 的属性值是 ref 还是 value，不允许既是 ref 又是 value </span></span><br><span class="line">    <span class="keyword">boolean</span> hasRefAttribute = ele.hasAttribute(REF_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">boolean</span> hasValueAttribute = ele.hasAttribute(VALUE_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> ((hasRefAttribute &amp;&amp; hasValueAttribute) ||</span><br><span class="line">            ((hasRefAttribute || hasValueAttribute) &amp;&amp; subElement != <span class="keyword">null</span>)) &#123;</span><br><span class="line">        error(elementName +</span><br><span class="line">                <span class="string">" is only allowed to contain either 'ref' attribute OR 'value' attribute OR sub-element"</span>, ele);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果属性是 ref，创建一个 ref 的数据对象 RuntimeBeanReference</span></span><br><span class="line">    <span class="comment">// 这个对象封装了 ref 信息</span></span><br><span class="line">    <span class="keyword">if</span> (hasRefAttribute) &#123;</span><br><span class="line">        String refName = ele.getAttribute(REF_ATTRIBUTE);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(refName)) &#123;</span><br><span class="line">            error(elementName + <span class="string">" contains empty 'ref' attribute"</span>, ele);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 一个指向运行时所依赖对象的引用</span></span><br><span class="line">        RuntimeBeanReference ref = <span class="keyword">new</span> RuntimeBeanReference(refName);</span><br><span class="line">        <span class="comment">// 设置这个 ref 的数据对象是被当前的 property 对象所引用</span></span><br><span class="line">        ref.setSource(extractSource(ele));</span><br><span class="line">        <span class="keyword">return</span> ref;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果属性是 value，创建一个 value 的数据对象 TypedStringValue</span></span><br><span class="line">    <span class="comment">// 这个对象封装了 value 信息</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (hasValueAttribute) &#123;</span><br><span class="line">        <span class="comment">// 一个持有 String 类型值的对象</span></span><br><span class="line">        TypedStringValue valueHolder = <span class="keyword">new</span> TypedStringValue(ele.getAttribute(VALUE_ATTRIBUTE));</span><br><span class="line">        <span class="comment">// 设置这个 value 数据对象是被当前的 property 对象所引用</span></span><br><span class="line">        valueHolder.setSource(extractSource(ele));</span><br><span class="line">        <span class="keyword">return</span> valueHolder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果当前 &lt;property&gt; 元素还有子元素</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (subElement != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 解析 &lt;property&gt; 的子元素</span></span><br><span class="line">        <span class="keyword">return</span> parsePropertySubElement(subElement, bd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// propery 属性中既不是 ref，也不是 value 属性，解析出错返回 null</span></span><br><span class="line">        error(elementName + <span class="string">" must specify a ref or value"</span>, ele);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析 &lt;property&gt; 元素中 ref,value 或者集合等子元素</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">parsePropertySubElement</span><span class="params">(Element ele, BeanDefinition bd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> parsePropertySubElement(ele, bd, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">parsePropertySubElement</span><span class="params">(Element ele, BeanDefinition bd, String defaultValueType)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 如果 &lt;property&gt; 没有使用 Spring 默认的命名空间，则使用用户自定义的规则解析</span></span><br><span class="line">    <span class="comment">// 内嵌元素</span></span><br><span class="line">    <span class="keyword">if</span> (!isDefaultNamespace(ele)) &#123;</span><br><span class="line">        <span class="keyword">return</span> parseNestedCustomElement(ele, bd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果子元素是 bean，则使用解析 &lt;Bean&gt; 元素的方法解析</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, BEAN_ELEMENT)) &#123;</span><br><span class="line">        BeanDefinitionHolder nestedBd = parseBeanDefinitionElement(ele, bd);</span><br><span class="line">        <span class="keyword">if</span> (nestedBd != <span class="keyword">null</span>) &#123;</span><br><span class="line">            nestedBd = decorateBeanDefinitionIfRequired(ele, nestedBd, bd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nestedBd;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果子元素是 ref，ref 中只能有以下 3 个属性：bean、local、parent</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, REF_ELEMENT)) &#123;</span><br><span class="line">        <span class="comment">// 获取 &lt;property&gt; 元素中的 bean 属性值，引用其他解析的 Bean 的名称  </span></span><br><span class="line">        <span class="comment">// 可以不再同一个 Spring 配置文件中，具体请参考 Spring 对 ref 的配置规则</span></span><br><span class="line">        String refName = ele.getAttribute(BEAN_REF_ATTRIBUTE);</span><br><span class="line">        <span class="keyword">boolean</span> toParent = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasLength(refName)) &#123;</span><br><span class="line">            <span class="comment">// 获取 &lt;property&gt; 元素中的 local 属性值，引用同一个 Xml 文件中配置  </span></span><br><span class="line">            <span class="comment">// 的 Bean 的 id，local 和 ref 不同，local 只能引用同一个配置文件中的 Bean</span></span><br><span class="line">            refName = ele.getAttribute(LOCAL_REF_ATTRIBUTE);</span><br><span class="line">            <span class="keyword">if</span> (!StringUtils.hasLength(refName)) &#123;</span><br><span class="line">                <span class="comment">// 获取 &lt;property&gt; 元素中 parent 属性值，引用父级容器中的 Bean</span></span><br><span class="line">                refName = ele.getAttribute(PARENT_REF_ATTRIBUTE);</span><br><span class="line">                toParent = <span class="keyword">true</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (!StringUtils.hasLength(refName)) &#123;</span><br><span class="line">                    error(<span class="string">"'bean', 'local' or 'parent' is required for &lt;ref&gt; element"</span>, ele);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 没有配置 ref 的目标属性值 </span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(refName)) &#123;</span><br><span class="line">            error(<span class="string">"&lt;ref&gt; element contains empty target attribute"</span>, ele);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建 ref 类型数据，指向被引用的对象</span></span><br><span class="line">        RuntimeBeanReference ref = <span class="keyword">new</span> RuntimeBeanReference(refName, toParent);</span><br><span class="line">        <span class="comment">// 设置引用类型值是被当前子元素所引用</span></span><br><span class="line">        ref.setSource(extractSource(ele));</span><br><span class="line">        <span class="keyword">return</span> ref;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果子元素是 &lt;idref&gt;，使用解析 ref 元素的方法解析</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, IDREF_ELEMENT)) &#123;</span><br><span class="line">        <span class="keyword">return</span> parseIdRefElement(ele);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果子元素是 &lt;value&gt;，使用解析 value 元素的方法解析</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, VALUE_ELEMENT)) &#123;</span><br><span class="line">        <span class="keyword">return</span> parseValueElement(ele, defaultValueType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果子元素是 null，为 &lt;property&gt; 设置一个封装 null 值的字符串数据</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, NULL_ELEMENT)) &#123;</span><br><span class="line">        TypedStringValue nullHolder = <span class="keyword">new</span> TypedStringValue(<span class="keyword">null</span>);</span><br><span class="line">        nullHolder.setSource(extractSource(ele));</span><br><span class="line">        <span class="keyword">return</span> nullHolder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果子元素是 &lt;array&gt;，使用解析 array 集合子元素的方法解析</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, ARRAY_ELEMENT)) &#123;</span><br><span class="line">        <span class="keyword">return</span> parseArrayElement(ele, bd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果子元素是 &lt;list&gt;，使用解析 list 集合子元素的方法解析</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, LIST_ELEMENT)) &#123;</span><br><span class="line">        <span class="keyword">return</span> parseListElement(ele, bd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果子元素是 &lt;set&gt;，使用解析 set 集合子元素的方法解析</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, SET_ELEMENT)) &#123;</span><br><span class="line">        <span class="keyword">return</span> parseSetElement(ele, bd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果子元素是 &lt;map&gt;，使用解析 map 集合子元素的方法解析</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, MAP_ELEMENT)) &#123;</span><br><span class="line">        <span class="keyword">return</span> parseMapElement(ele, bd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果子元素是 &lt;props&gt;，使用解析 props 集合子元素的方法解析</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, PROPS_ELEMENT)) &#123;</span><br><span class="line">        <span class="keyword">return</span> parsePropsElement(ele);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 既不是 ref，又不是 value，也不是集合，则子元素配置错误，返回 null</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        error(<span class="string">"Unknown property sub-element: ["</span> + ele.getNodeName() + <span class="string">"]"</span>, ele);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析 &lt;list&gt; 集合子元素</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List <span class="title">parseListElement</span><span class="params">(Element collectionEle, BeanDefinition bd)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取 &lt;list&gt; 元素中的 value-type 属性，即获取集合元素的数据类型</span></span><br><span class="line">    String defaultElementType = collectionEle.getAttribute(VALUE_TYPE_ATTRIBUTE);</span><br><span class="line">    <span class="comment">// 获取 &lt;list&gt; 集合元素中的所有子节点</span></span><br><span class="line">    NodeList nl = collectionEle.getChildNodes();</span><br><span class="line">    <span class="comment">// Spring 中将 List 封装为 ManagedList</span></span><br><span class="line">    ManagedList&lt;Object&gt; target = <span class="keyword">new</span> ManagedList&lt;Object&gt;(nl.getLength());</span><br><span class="line">    target.setSource(extractSource(collectionEle));</span><br><span class="line">    <span class="comment">// 设置集合目标数据类型</span></span><br><span class="line">    target.setElementTypeName(defaultElementType);</span><br><span class="line">    target.setMergeEnabled(parseMergeAttribute(collectionEle));</span><br><span class="line">    <span class="comment">// 具体的 &lt;list&gt; 元素解析</span></span><br><span class="line">    parseCollectionElements(nl, target, bd, defaultElementType);</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 具体解析 &lt;list&gt; 集合元素，&lt;array&gt;、&lt;list&gt; 和 &lt;set&gt; 都使用该方法解析</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseCollectionElements</span><span class="params">(NodeList elementNodes, Collection&lt;Object&gt; target, </span></span></span><br><span class="line"><span class="function"><span class="params">        BeanDefinition bd, String defaultElementType)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 遍历集合所有节点</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; elementNodes.getLength(); i++) &#123;</span><br><span class="line">        Node node = elementNodes.item(i);</span><br><span class="line">        <span class="comment">// 节点不是 description 节点</span></span><br><span class="line">        <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element &amp;&amp; !nodeNameEquals(node, DESCRIPTION_ELEMENT)) &#123;</span><br><span class="line">            <span class="comment">// 将解析的元素加入集合中，递归调用下一个子元素 </span></span><br><span class="line">            target.add(parsePropertySubElement((Element) node, bd, defaultElementType));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>经过这样逐层地解析，我们在配置文件中定义的 bean 就被整个解析成了 IoC 容器能够装载和使用的 BeanDefinition 对象，这种数据结构可以让 IoC 容器执行索引、查询等操作。经过上述解析，接下来我们就可以将得到的 BeanDefinition 对象 注册到 IoC 容器中咯。</p><p><a href="https://github.com/doocs/source-code-hunter/blob/master/docs/Spring/IoC/2%E3%80%81%E5%B0%86bean%E8%A7%A3%E6%9E%90%E5%B0%81%E8%A3%85%E6%88%90BeanDefinition.md" target="_blank" rel="noopener">原文</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;接着上一篇的 BeanDefinition 资源定位开始讲。Spring IoC 容器 BeanDefinition 解析过程就是把用户在配置文件中配置的 bean，解析并封装成 IoC 容器可以装载的 BeanDefinition 对象，BeanDefinition 是 Spring 定义的基本数据结构，其中的属性与配置文件中 bean 的属性相对应。&lt;/p&gt;
    
    </summary>
    
      <category term="JavaNotes" scheme="http://codewey.com/categories/JavaNotes/"/>
    
    
      <category term="Spring" scheme="http://codewey.com/tags/Spring/"/>
    
      <category term="IOC" scheme="http://codewey.com/tags/IOC/"/>
    
  </entry>
  
  <entry>
    <title>BeanDefinition的资源定位过程</title>
    <link href="http://codewey.com/post/Spring-IOC-01-BeanDefinition/"/>
    <id>http://codewey.com/post/Spring-IOC-01-BeanDefinition/</id>
    <published>2019-12-13T04:00:16.000Z</published>
    <updated>2020-05-31T10:52:32.424Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>之前一直想系统的拜读一下 spring 的源码，看看它到底是如何吸引身边的大神们对它的设计赞不绝口，虽然每天工作很忙，每天下班后总感觉脑子内存溢出，想去放松一下，但总是以此为借口，恐怕会一直拖下去。所以每天下班虽然有些疲惫，但还是按住自己啃下这块硬骨头。</p><p>spring 源码这种东西真的是一回生二回熟，第一遍会被各种设计模式和繁杂的方法调用搞得晕头转向，不知道看到的这些方法调用的是哪个父类的实现（IoC 相关的类图实在太复杂咯，继承体系又深又广），但当你耐下心来多走几遍，会发现越看越熟练，每次都能 get 到新的点。</p><a id="more"></a><p>另外，对于第一次看 spring 源码的同学，建议先在 B 站上搜索相关视频看一下，然后再结合计文柯老师的《spring 技术内幕》深入理解，最后再输出自己的理解（写博文或部门内部授课）加强印象。</p><p>首先对于我们新手来说，还是从我们最常用的两个 IoC 容器开始分析，这次我们先分析 FileSystemXmlApplicationContext 这个 IoC 容器的具体实现，ClassPathXmlApplicationContext 留着下次讲解。</p><p>（PS：可以结合我 GitHub 上对 Spring 框架源码的翻译注释一起看，会更有助于各位同学的理解。地址：<br>spring-beans <a href="https://github.com/AmyliaY/spring-beans-reading" target="_blank" rel="noopener">https://github.com/AmyliaY/spring-beans-reading</a><br>spring-context <a href="https://github.com/AmyliaY/spring-context-reading" target="_blank" rel="noopener">https://github.com/AmyliaY/spring-context-reading</a><br>）</p><h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>当我们传入一个 Spring 配置文件去实例化 FileSystemXmlApplicationContext 时，可以看一下它的构造方法都做了什么。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 下面这 4 个构造方法都调用了第 5 个构造方法</span><br><span class="line"> * @param configLocation</span><br><span class="line"> * @throws BeansException</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">// configLocation 包含了 BeanDefinition 所在的文件路径</span><br><span class="line">public FileSystemXmlApplicationContext(String configLocation) throws BeansException &#123;</span><br><span class="line">    this(new String[] &#123;configLocation&#125;, true, null);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 可以定义多个 BeanDefinition 所在的文件路径</span><br><span class="line">public FileSystemXmlApplicationContext(String... configLocations) throws BeansException &#123;</span><br><span class="line">    this(configLocations, true, null);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 在定义多个 BeanDefinition 所在的文件路径 的同时，还能指定自己的双亲 IoC 容器</span><br><span class="line">public FileSystemXmlApplicationContext(String[] configLocations, ApplicationContext parent) throws BeansException &#123;</span><br><span class="line">    this(configLocations, true, parent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public FileSystemXmlApplicationContext(String[] configLocations, boolean refresh) throws BeansException &#123;</span><br><span class="line">    this(configLocations, refresh, null);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 如果应用直接使用 FileSystemXmlApplicationContext 进行实例化，则都会进到这个构造方法中来</span><br><span class="line"> */</span><br><span class="line">public FileSystemXmlApplicationContext(String[] configLocations, boolean refresh, ApplicationContext parent)</span><br><span class="line">        throws BeansException &#123;</span><br><span class="line"></span><br><span class="line">    // 动态地确定用哪个加载器去加载我们的配置文件</span><br><span class="line">    super(parent);</span><br><span class="line">    // 告诉读取器 配置文件放在哪里，该方法继承于爷类 AbstractRefreshableApplicationContext</span><br><span class="line">    setConfigLocations(configLocations);</span><br><span class="line">    if (refresh) &#123;</span><br><span class="line">        // 容器初始化</span><br><span class="line">        refresh();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 实例化一个 FileSystemResource 并返回，以便后续对资源的 IO 操作</span><br><span class="line"> * 本方法是在其父类 DefaultResourceLoader 的 getResource 方法中被调用的，</span><br><span class="line"> */</span><br><span class="line">@Override</span><br><span class="line">protected Resource getResourceByPath(String path) &#123;</span><br><span class="line">    if (path != null &amp;&amp; path.startsWith(&quot;/&quot;)) &#123;</span><br><span class="line">        path = path.substring(1);</span><br><span class="line">    &#125;</span><br><span class="line">    return new FileSystemResource(path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看看其父类 AbstractApplicationContext 实现的 refresh() 方法，该方法就是 IoC 容器初始化的入口类</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 容器初始化的过程：BeanDefinition 的 Resource 定位、BeanDefinition 的载入、BeanDefinition 的注册。</span><br><span class="line"> * BeanDefinition 的载入和 bean 的依赖注入是两个独立的过程，依赖注入一般发生在 应用第一次通过 </span><br><span class="line"> * getBean() 方法从容器获取 bean 时。</span><br><span class="line"> * </span><br><span class="line"> * 另外需要注意的是，IoC 容器有一个预实例化的配置（即，将 AbstractBeanDefinition 中的 lazyInit 属性</span><br><span class="line"> * 设为 true），使用户可以对容器的初始化过程做一个微小的调控，lazyInit 设为 false 的 bean </span><br><span class="line"> * 将在容器初始化时进行依赖注入，而不会等到 getBean() 方法调用时才进行</span><br><span class="line"> */</span><br><span class="line">public void refresh() throws BeansException, IllegalStateException &#123;</span><br><span class="line">    synchronized (this.startupShutdownMonitor) &#123;</span><br><span class="line">        // 调用容器准备刷新，获取容器的当前时间，同时给容器设置同步标识</span><br><span class="line">        prepareRefresh();</span><br><span class="line"></span><br><span class="line">        // 告诉子类启动 refreshBeanFactory() 方法，BeanDefinition 资源文件的载入从子类的 refreshBeanFactory() 方法启动开始</span><br><span class="line">        ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">        // 为 BeanFactory 配置容器特性，例如类加载器、事件处理器等</span><br><span class="line">        prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            // 为容器的某些子类指定特殊的 BeanPost 事件处理器</span><br><span class="line">            postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">            // 调用所有注册的 BeanFactoryPostProcessor 的 Bean</span><br><span class="line">            invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">            // 为 BeanFactory 注册 BeanPost 事件处理器.  </span><br><span class="line">            // BeanPostProcessor 是 Bean 后置处理器，用于监听容器触发的事件 </span><br><span class="line">            registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">            // 初始化信息源，和国际化相关.</span><br><span class="line">            initMessageSource();</span><br><span class="line"></span><br><span class="line">            // 初始化容器事件传播器</span><br><span class="line">            initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">            // 调用子类的某些特殊 Bean 初始化方法</span><br><span class="line">            onRefresh();</span><br><span class="line"></span><br><span class="line">            // 为事件传播器注册事件监听器.</span><br><span class="line">            registerListeners();</span><br><span class="line"></span><br><span class="line">            // 初始化 Bean，并对 lazy-init 属性进行处理</span><br><span class="line">            finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">            // 初始化容器的生命周期事件处理器，并发布容器的生命周期事件</span><br><span class="line">            finishRefresh();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        catch (BeansException ex) &#123;</span><br><span class="line">            // 销毁以创建的单态 Bean</span><br><span class="line">            destroyBeans();</span><br><span class="line"></span><br><span class="line">            // 取消 refresh 操作，重置容器的同步标识.</span><br><span class="line">            cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">            throw ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看看 obtainFreshBeanFactory() 方法，该方法告诉了子类去刷新内部的 beanFactory</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Tell the subclass to refresh the internal bean factory.</span><br><span class="line"> * 告诉子类去刷新内部的 beanFactory</span><br><span class="line"> */</span><br><span class="line">protected ConfigurableListableBeanFactory obtainFreshBeanFactory() &#123;</span><br><span class="line">    // 自己定义了抽象的 refreshBeanFactory() 方法，具体实现交给了自己的子类</span><br><span class="line">    refreshBeanFactory();</span><br><span class="line">    // getBeanFactory() 也是一个抽象方法，交由子类实现</span><br><span class="line">    // 看到这里是不是很容易想起 “模板方法模式”，父类在模板方法中定义好流程，定义好抽象方法</span><br><span class="line">    // 具体实现交由子类完成</span><br><span class="line">    ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Bean factory for &quot; + getDisplayName() + &quot;: &quot; + beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line">    return beanFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面看一下 AbstractRefreshableApplicationContext 中对 refreshBeanFactory() 方法的实现。FileSystemXmlApplicationContext 从上层体系的各抽象类中继承了大量的方法实现，抽象类中抽取大量公共行为进行具体实现，留下 abstract 的个性化方法交给具体的子类实现，这是一个很好的 OOP 编程设计，我们在自己编码时也可以尝试这样设计自己的类图。理清 FileSystemXmlApplicationContext 的上层体系设计，就不易被各种设计模式搞晕咯。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 在这里完成了容器的初始化，并赋值给自己私有的 beanFactory 属性，为下一步调用做准备</span><br><span class="line"> * 从父类 AbstractApplicationContext 继承的抽象方法，自己做了实现</span><br><span class="line"> */</span><br><span class="line">@Override</span><br><span class="line">protected final void refreshBeanFactory() throws BeansException &#123;</span><br><span class="line">    // 如果已经建立了 IoC 容器，则销毁并关闭容器</span><br><span class="line">    if (hasBeanFactory()) &#123;</span><br><span class="line">        destroyBeans();</span><br><span class="line">        closeBeanFactory();</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        // 创建 IoC 容器，DefaultListableBeanFactory 类实现了 ConfigurableListableBeanFactory 接口</span><br><span class="line">        DefaultListableBeanFactory beanFactory = createBeanFactory();</span><br><span class="line">        beanFactory.setSerializationId(getId());</span><br><span class="line">        // 对 IoC 容器进行定制化，如设置启动参数，开启注解的自动装配等</span><br><span class="line">        customizeBeanFactory(beanFactory);</span><br><span class="line">        // 载入 BeanDefinition，在当前类中只定义了抽象的 loadBeanDefinitions() 方法，具体实现 调用子类容器</span><br><span class="line">        loadBeanDefinitions(beanFactory);</span><br><span class="line">        synchronized (this.beanFactoryMonitor) &#123;</span><br><span class="line">            // 给自己的属性赋值</span><br><span class="line">            this.beanFactory = beanFactory;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (IOException ex) &#123;</span><br><span class="line">        throw new ApplicationContextException(&quot;I/O error parsing bean definition source for &quot; + getDisplayName(), ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AbstractXmlApplicationContext 中对 loadBeanDefinitions(DefaultListableBeanFactory beanFactory) 的实现。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * 实现了基类 AbstractRefreshableApplicationContext 的抽象方法</span><br><span class="line"> */</span><br><span class="line">@Override</span><br><span class="line">protected void loadBeanDefinitions(DefaultListableBeanFactory beanFactory) throws BeansException, IOException &#123;</span><br><span class="line">    // DefaultListableBeanFactory 实现了 BeanDefinitionRegistry 接口，在初始化 XmlBeanDefinitionReader 时</span><br><span class="line">    // 将 BeanDefinition 注册器注入该 BeanDefinition 读取器</span><br><span class="line">    // 创建用于从 Xml 中读取 BeanDefinition 的读取器，并通过回调设置到 IoC 容器中去，容器使用该读取器读取 BeanDefinition 资源</span><br><span class="line">    XmlBeanDefinitionReader beanDefinitionReader = new XmlBeanDefinitionReader(beanFactory);</span><br><span class="line"></span><br><span class="line">    beanDefinitionReader.setEnvironment(this.getEnvironment());</span><br><span class="line">    // 为 beanDefinition 读取器设置 资源加载器，由于本类的基类 AbstractApplicationContext</span><br><span class="line">    // 继承了 DefaultResourceLoader，因此，本容器自身也是一个资源加载器</span><br><span class="line">    beanDefinitionReader.setResourceLoader(this);</span><br><span class="line">    // 设置 SAX 解析器，SAX（simple API for XML）是另一种 XML 解析方法。相比于 DOM，SAX 速度更快，占用内存更小。</span><br><span class="line">    // 它逐行扫描文档，一边扫描一边解析。相比于先将整个 XML 文件扫描近内存，再进行解析的 DOM，SAX 可以在解析文档的</span><br><span class="line">    // 任意时刻停止解析，但操作也比 DOM 复杂。</span><br><span class="line">    beanDefinitionReader.setEntityResolver(new ResourceEntityResolver(this));</span><br><span class="line"></span><br><span class="line">    // 初始化 beanDefinition 读取器，该方法同时启用了 Xml 的校验机制</span><br><span class="line">    initBeanDefinitionReader(beanDefinitionReader);</span><br><span class="line">    // Bean 读取器真正实现加载的方法</span><br><span class="line">    loadBeanDefinitions(beanDefinitionReader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>继续看 AbstractXmlApplicationContext 中 loadBeanDefinitions() 的重载方法。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 用传进来的 XmlBeanDefinitionReader 读取器加载 Xml 文件中的 BeanDefinition</span><br><span class="line"> */</span><br><span class="line">protected void loadBeanDefinitions(XmlBeanDefinitionReader reader) throws BeansException, IOException &#123;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * ClassPathXmlApplicationContext 与 FileSystemXmlApplicationContext 在这里的调用出现分歧，</span><br><span class="line">     * 各自按不同的方式加载解析 Resource 资源，最后在具体的解析和 BeanDefinition 定位上又会殊途同归。</span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    // 获取存放了 BeanDefinition 的所有 Resource，FileSystemXmlApplicationContext 类未对</span><br><span class="line">    // getConfigResources() 进行重写，所以调用父类的，return null。</span><br><span class="line">    // 而 ClassPathXmlApplicationContext 对该方法进行了重写，返回设置的值</span><br><span class="line">    Resource[] configResources = getConfigResources();</span><br><span class="line">    if (configResources != null) &#123;</span><br><span class="line">        // XmlBeanDefinitionReader 调用其父类 AbstractBeanDefinitionReader 的方法加载 BeanDefinition</span><br><span class="line">        reader.loadBeanDefinitions(configResources);</span><br><span class="line">    &#125;</span><br><span class="line">    // 调用父类 AbstractRefreshableConfigApplicationContext 的实现，</span><br><span class="line">    // 优先返回 FileSystemXmlApplicationContext 构造方法中调用 setConfigLocations() 方法设置的资源</span><br><span class="line">    String[] configLocations = getConfigLocations();</span><br><span class="line">    if (configLocations != null) &#123;</span><br><span class="line">        // XmlBeanDefinitionReader 调用其父类 AbstractBeanDefinitionReader 的方法从配置位置加载 BeanDefinition</span><br><span class="line">        reader.loadBeanDefinitions(configLocations);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AbstractBeanDefinitionReader 中对 loadBeanDefinitions 方法的各种重载及调用。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * loadBeanDefinitions() 方法的重载方法之一，调用了另一个重载方法 loadBeanDefinitions(String)</span><br><span class="line"> */</span><br><span class="line">public int loadBeanDefinitions(String... locations) throws BeanDefinitionStoreException &#123;</span><br><span class="line">    Assert.notNull(locations, &quot;Location array must not be null&quot;);</span><br><span class="line">    // 计数器，统计加载了多少个配置文件</span><br><span class="line">    int counter = 0;</span><br><span class="line">    for (String location : locations) &#123;</span><br><span class="line">        counter += loadBeanDefinitions(location);</span><br><span class="line">    &#125;</span><br><span class="line">    return counter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 重载方法之一，调用了下面的 loadBeanDefinitions(String, Set&lt;Resource&gt;) 方法 </span><br><span class="line"> */</span><br><span class="line">public int loadBeanDefinitions(String location) throws BeanDefinitionStoreException &#123;</span><br><span class="line">    return loadBeanDefinitions(location, null);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 获取在 IoC 容器初始化过程中设置的资源加载器</span><br><span class="line"> */</span><br><span class="line">public int loadBeanDefinitions(String location, Set&lt;Resource&gt; actualResources) throws BeanDefinitionStoreException &#123;</span><br><span class="line">    // 在实例化 XmlBeanDefinitionReader 后 IoC 容器将自己注入进该读取器作为 resourceLoader 属性</span><br><span class="line">    ResourceLoader resourceLoader = getResourceLoader();</span><br><span class="line">    if (resourceLoader == null) &#123;</span><br><span class="line">        throw new BeanDefinitionStoreException(</span><br><span class="line">                &quot;Cannot import bean definitions from location [&quot; + location + &quot;]: no ResourceLoader available&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (resourceLoader instanceof ResourcePatternResolver) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // 将指定位置的 BeanDefinition 资源文件解析为 IoC 容器封装的资源  </span><br><span class="line">            // 加载多个指定位置的 BeanDefinition 资源文件  </span><br><span class="line">            Resource[] resources = ((ResourcePatternResolver) resourceLoader).getResources(location);</span><br><span class="line">            // 委派调用其子类 XmlBeanDefinitionReader 的方法，实现加载功能 </span><br><span class="line">            int loadCount = loadBeanDefinitions(resources);</span><br><span class="line">            if (actualResources != null) &#123;</span><br><span class="line">                for (Resource resource : resources) &#123;</span><br><span class="line">                    actualResources.add(resource);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Loaded &quot; + loadCount + &quot; bean definitions from location pattern [&quot; + location + &quot;]&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            return loadCount;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (IOException ex) &#123;</span><br><span class="line">            throw new BeanDefinitionStoreException(</span><br><span class="line">                    &quot;Could not resolve bean definition resource pattern [&quot; + location + &quot;]&quot;, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        /**</span><br><span class="line">         * ！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！</span><br><span class="line">         * AbstractApplicationContext 继承了 DefaultResourceLoader，所以 AbstractApplicationContext</span><br><span class="line">         * 及其子类都会调用 DefaultResourceLoader 中的实现，将指定位置的资源文件解析为 Resource，</span><br><span class="line">         * 至此完成了对 BeanDefinition 的资源定位</span><br><span class="line">         * ！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！</span><br><span class="line">         */</span><br><span class="line">        Resource resource = resourceLoader.getResource(location);</span><br><span class="line">        // 从 resource 中加载 BeanDefinition，loadCount 为加载的 BeanDefinition 个数</span><br><span class="line">        // 该 loadBeanDefinitions() 方法来自其实现的 BeanDefinitionReader 接口，</span><br><span class="line">        // 且本类是一个抽象类，并未对该方法进行实现。而是交由子类进行实现，如果是用 xml 文件进行</span><br><span class="line">        // IoC 容器的初始化，则调用 XmlBeanDefinitionReader 中的实现</span><br><span class="line">        int loadCount = loadBeanDefinitions(resource);</span><br><span class="line">        if (actualResources != null) &#123;</span><br><span class="line">            actualResources.add(resource);</span><br><span class="line">        &#125;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Loaded &quot; + loadCount + &quot; bean definitions from location [&quot; + location + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return loadCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>resourceLoader 的 getResource() 方法有多种实现，看清 FileSystemXmlApplicationContext 的继承体系就可以明确，其走的是 DefaultResourceLoader 中的实现。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 获取 Resource 的具体实现方法</span><br><span class="line"> */</span><br><span class="line">public Resource getResource(String location) &#123;</span><br><span class="line">    Assert.notNull(location, &quot;Location must not be null&quot;);</span><br><span class="line">    // 如果 location 是类路径的方式，返回 ClassPathResource 类型的文件资源对象</span><br><span class="line">    if (location.startsWith(CLASSPATH_URL_PREFIX)) &#123;</span><br><span class="line">        return new ClassPathResource(location.substring(CLASSPATH_URL_PREFIX.length()), getClassLoader());</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // 如果是 URL 方式，返回 UrlResource 类型的文件资源对象，</span><br><span class="line">            // 否则将抛出的异常进入 catch 代码块，返回另一种资源对象</span><br><span class="line">            URL url = new URL(location);</span><br><span class="line">            return new UrlResource(url);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (MalformedURLException ex) &#123;</span><br><span class="line">            // 如果既不是 classpath 标识，又不是 URL 标识的 Resource 定位，则调用容器本身的 </span><br><span class="line">            // getResourceByPath() 方法获取 Resource。根据实例化的子类对象，调用其子类对象中</span><br><span class="line">            // 重写的此方法，如 FileSystemXmlApplicationContext 子类中对此方法的重写</span><br><span class="line">            return getResourceByPath(location);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中的 getResourceByPath(location) 方法的实现则是在 FileSystemXmlApplicationContext 中完成的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 实例化一个 FileSystemResource 并返回，以便后续对资源的 IO 操作</span><br><span class="line"> * 本方法是在 DefaultResourceLoader 的 getResource() 方法中被调用的，</span><br><span class="line"> */</span><br><span class="line">@Override</span><br><span class="line">protected Resource getResourceByPath(String path) &#123;</span><br><span class="line">    if (path != null &amp;&amp; path.startsWith(&quot;/&quot;)) &#123;</span><br><span class="line">        path = path.substring(1);</span><br><span class="line">    &#125;</span><br><span class="line">    return new FileSystemResource(path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>至此，我们可以看到，FileSystemXmlApplicationContext 的 getResourceByPath() 方法返回了一个 FileSystemResource 对象，接下来 spring 就可以对这个对象进行相关的 I/O 操作，进行 BeanDefinition 的读取和载入了。</p><p><a href="https://github.com/doocs/source-code-hunter/blob/master/docs/Spring/IoC/1%E3%80%81BeanDefinition%E7%9A%84%E8%B5%84%E6%BA%90%E5%AE%9A%E4%BD%8D%E8%BF%87%E7%A8%8B.md" target="_blank" rel="noopener">原文</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;之前一直想系统的拜读一下 spring 的源码，看看它到底是如何吸引身边的大神们对它的设计赞不绝口，虽然每天工作很忙，每天下班后总感觉脑子内存溢出，想去放松一下，但总是以此为借口，恐怕会一直拖下去。所以每天下班虽然有些疲惫，但还是按住自己啃下这块硬骨头。&lt;/p&gt;
&lt;p&gt;spring 源码这种东西真的是一回生二回熟，第一遍会被各种设计模式和繁杂的方法调用搞得晕头转向，不知道看到的这些方法调用的是哪个父类的实现（IoC 相关的类图实在太复杂咯，继承体系又深又广），但当你耐下心来多走几遍，会发现越看越熟练，每次都能 get 到新的点。&lt;/p&gt;
    
    </summary>
    
      <category term="JavaNotes" scheme="http://codewey.com/categories/JavaNotes/"/>
    
    
      <category term="Spring" scheme="http://codewey.com/tags/Spring/"/>
    
      <category term="IOC" scheme="http://codewey.com/tags/IOC/"/>
    
  </entry>
  
  <entry>
    <title>一篇关于我的真实回忆录</title>
    <link href="http://codewey.com/post/About-me/"/>
    <id>http://codewey.com/post/About-me/</id>
    <published>2019-10-26T09:06:51.000Z</published>
    <updated>2020-04-04T13:58:05.267Z</updated>
    
    <content type="html"><![CDATA[<h3 id="一篇关于我的真实回忆录"><a href="#一篇关于我的真实回忆录" class="headerlink" title="一篇关于我的真实回忆录"></a>一篇关于我的真实回忆录</h3><hr><p>我出生在一个极其普通传统的家庭，从小被父母带到省会读书。</p><a id="more"></a><p>父母都是普通的农民，零几年在省会中做着餐饮小生意，那个时候餐饮行业还是很挣钱的，竞争相对小，所以我觉得我小学过得还是比较好的，我虽然不是一个很爱花钱的孩子，但是吃穿都不会少。</p><p>后来，小学快毕业，由于家中出了些变故，对于还没上中学的我来说这是一场灾难，我将从此面临各种挫折，困难，当时我便已经认定，我这一生，将会很坎坷，我只能靠自己的双手慢慢爬起来。</p><p>初中，我便开始自力更生，只要放假，就去找兼职，找寒暑假工，做过很多类型的工作。</p><ul><li><strong>发传单</strong></li><li><strong>打字员</strong></li><li><strong>硬件主板流水工作</strong></li><li><strong>饺子工</strong></li><li><strong>餐厅服务员</strong></li><li><strong>物业保安</strong></li><li><strong>工地</strong>（鬼门关走一回）</li></ul><p>还有一些记不得了，暂时能想起这些，大概说下这些工作吧，记忆还是挺深刻的。</p><h4 id="发传单"><a href="#发传单" class="headerlink" title="发传单"></a>发传单</h4><p>发传单这种兼职相信很多学生都做过，是最直接的一种兼职。</p><p>初中不上课的周末，学校附近的开发商总会招兼职去发传单，所以会挤满了人，这是在红绿灯口给马路车辆发，还是很危险的，当然也没那意识，还因为这个，被警察叔叔带回去教育了一番，哈哈。</p><h4 id="打字员"><a href="#打字员" class="headerlink" title="打字员"></a>打字员</h4><p>这个工作是学校校医老师给我介绍的，我们经常有工作来往，所以有什么帮忙也都会找我。</p><p>这项工作是给一所中学的所有学生的体检数据录入到系统，高中部+初中部大概有几千人吧，当然还看到好多老同学在那所学校，哈哈。记得拿到体检表的时候也是惊了，十几打厚厚的文档袋装满了全校的学生体检数据，在我的笔记本上装上体检的系统，录完后导出备份。</p><p>这所学校的校医老师怀孕了，不能长期对着电脑，所以就把这项工作通过我们学校的校医外包给了我，正好，我很需要钱，所以就接下了，给了我七天的时间，我晚上熬夜打，只用了三天，三天500快。</p><h4 id="硬件主板流水工作"><a href="#硬件主板流水工作" class="headerlink" title="硬件主板流水工作"></a>硬件主板流水工作</h4><p>其实就是类似大厂里的流水工作，不过现在都机械化了，我去的也是老师给我介绍的，自己老公的公司，小公司，做硬件的，组装配件需要人工，有些主板焊锡有问题的需要处理一下，还有就是纯手工，拿镊子将那些元件点在主板上，工作类似流水线的工作，一天70，一般都是周末有空去。</p><h4 id="饺子工"><a href="#饺子工" class="headerlink" title="饺子工"></a>饺子工</h4><p>这是我初中第一份暑假工，在一个小店里包饺子，老板和老板娘是五六十岁儿孙满堂的夫妇，人很好，虽然店小，但是还签了个字据（迷你版劳动合同）哈哈，大概意思就是我中途不能跑吧，不然就没工钱了，还摁了手印，现在想想真是有意思呢。我主要负责包饺子，擀皮，还有刷碗和收拾桌子吧，因为店小，杂活都是我干吧，后来也来了一个大学生姐姐，我稍微轻松些，感觉那时候干什么都有力气，能挣钱就行，这是我第一份暑假工（一个月600元）。</p><h4 id="餐厅服务员"><a href="#餐厅服务员" class="headerlink" title="餐厅服务员"></a>餐厅服务员</h4><p>这次是和同学一起去的打工的地方，也是围着周边一家一家找的，最终找到这家要暑假工的，做服务生有很多细节需要注意，有时候也挺无奈的，客人如果没有用完餐，作为服务生的你是不能下班的，要等所有客人都走了，你才能收拾残局再走，一般如果今天是自己加班，基本上都是凌晨才能走的，回家差不多一点了，做服务生还是挺辛苦的，有时候站一天腿都酸的。</p><h4 id="物业保安"><a href="#物业保安" class="headerlink" title="物业保安"></a>物业保安</h4><p>保安这个工作让我觉得一个物业的服务能达到这种程度我是服了，虽然以我的体格根本驾驭不了这份工作吧，哈哈，这份工作是我上大学前的最后一份暑假工，一天工作十二小时。</p><p>开始这份工作是我自己在58上找的，去面试的时候，保安队长看了之后，直接说好一个月多少钱，换上衣服直接就开始干了，没错，到那面试谈妥换上衣服就开始先干，比较缺人手吧，虽然这么唐突，但是还是比较正规的，后来又办了银行卡，该走的流程都走了，其实原则是不招学生暑假工的，但是保安队长人还挺好，说别人问别说我是暑假工，于是就这样做了下去。</p><p>这份工作离我有些远，我每天骑自行车都要快一个小时，干十二个小时，后来我陆陆续续介绍了三个同学过来，但是都干几天就走了，确实很累，站岗要站一天，我同学脚穿着那不合脚的皮鞋都磨出水泡了，最后我坚持了下来吧。</p><p>开始我本来是站岗，后来，被调到了隔壁一期的院里，这个院子里的人要像上帝一样供着，这也是我为什么开头为什么说服务程度令我佩服。</p><p>这个院子小，岗位比较有限，保安加起来就五六个吧，地下停车场两个（东西各一个），地上监控室两个（一般是一个人巡逻一个在监控室），西门两个，一人一个对讲机，我是在监控室的，负责给业主开门，拿快递，拿报纸，每天还要给院子洒洒水（因为在马路在修高架，很多尘土）。</p><p>有一次停水，监控室也就我一个人，我要管着门口，还要去提水上楼给业主，院子里有部分老人，主管要求我们帮忙给提上楼，说时候当时真的觉得我一个人，分身几个角色。</p><p>有意思的是，我们上班管控其实很严格的，虽然我是在监控室里，但是平时是不让坐在里面的，让在门口站岗，我们主管很严格，每次看到我们坐在里面就回呵斥我们一下，我们队长也是一个脾气不好的老头，但是人心很好，有一次上夜班不小心睡着了，被拍照了，可能会罚款，我罚50，队长就是100，主管200，后来我队长和监管人员比较熟，也就没事儿了，一般不熟的人，都直接发微信群了，太难了。</p><p>后来我白班实在太忙受不了，就改上夜班了，凌晨十二点到第二天中午十二点，夜里只要不睡觉，看着监控，就好，还可以坐在那里，于是就拿出了我的《C Primer Plus 》 看了起来，哈哈，这也是我自学C语言的第一本书，视频看过郝斌C语言和Java系列吧，现在来看，郝斌的视频就太老了，不过很经典，郝斌老师讲课很有趣。这也让我觉得《C Primer Plus》不愧是一门经典畅销的专业书籍，讲的很细。</p><p>夜里的时间基本上都是这样消磨的，有时候在监控看到有人睡觉，就拿对讲机把对方喊醒：“检查的来了，检查的来了”，哈哈，我们相互传输信号，谁先遇到谁先喊，现在想想还真是有意思啊。</p><h4 id="工地（鬼门关走一回）"><a href="#工地（鬼门关走一回）" class="headerlink" title="工地（鬼门关走一回）"></a>工地（鬼门关走一回）</h4><p>可能这份工作是我所有做的工作里最累，最委屈、最危险的工作了、这辈子都不想再去工地打工了。</p><p>工作环境是在三十几层的楼顶做钢结构，我属于零工的角色，帮着师傅抬个钢筋，给焊工搭把手，第一次通过那个吊梯上三十几层的楼顶，简直是吓尿了，一晃一晃的，我本身也恐高，后来慢慢才适应。</p><p>因为吃饭都是大锅饭，有一次食物中毒了，整个身体没有力气，发烧，然后就躺在那里，后来被包工头看见了，我就去看病了，输液花了五十吧，输完液，整个人都好多了，第二天接着上工了。</p><p>还有一次就是我给焊工搭把手，把眼睛给闪了，夜里那是真叫痛苦啊，整个眼睛都是涩痛的，闭不了，夜里拿湿毛巾垫在眼上缓解疼痛，那一夜我是在痛苦中度过的。</p><p>不过以上还不是最惨的，有一天，工头让所有人去另一个工地干活，说是要装玻璃，玻璃厂那边安排运输工把玻璃送到了目的地，那么后面，事故就来了。</p><p>运输玻璃的车子本身停的位置就很偏，玻璃是树立捆绑在车上的架子上的，一面各有三块玻璃，长有2米左右，宽一米5左右，后来工人要求再往后停一停，司机没有理会，说可以了。</p><p>结果，司机上车开始解绳，刚解开一遍的绳子，还没来得及反应，玻璃就开始往下倒了，一眨眼的功夫，五六十的那位老大爷被压在了玻璃下，司机的眼睛被划血流不止，另一位工友，压到了胯骨，骨折严重，而我则是从鬼门关走了一波，我腿上都溅上了他们的血，只差一点，我也被压在下面，可能就不会有这篇文章了吧。</p><p>被完全压在玻璃下的老大爷，第一时间，我和另一位有点小伤的工友一起把玻璃迅速搬开，拿开的时候，大爷的四肢都是朝前的，整个人像被压扁了一样，随后120来了之后，抢救已经无效，一个活生生的生命就这样从我眼前消失了，当时我吓傻了，随后就陪着工友去医院了。</p><p>因为这件事情，也不知道是怎么回事工头就跑了，我联系好多人，都无果，我的工钱就这样打了水漂，两个月白干，还差点丢了性命，从那刻起，我发誓，我再也不会来工地做任何工作。</p><hr><p>以上就是我大学前，能想起的做过的工作，总结就是服务类的行业相对是需要用心还要用力的工作，挺辛苦的，工地这种纯卖力气的工作，只能向所有社会上的工人朋友致敬，希望少出现一些黑心不负责的老板，出卖的都是别人的血汗钱，良心怎能过的去。</p><p>通过这些兼职也差不多攒够了大学的学费以及花销，所以大学就没有太注重兼职了。</p><p>正是因为从小这样的生活环境，让我的性格也有些转变，其实有时也挺自卑的，毕业前从没有出过远门，没有出去玩过，没有坐过火车，让我对外界社会的一切都不是很了解，主要还是因为穷吧。</p><p>不过现在看来，对于我生活的唯一的目标就是能尝试没有尝试过的事物，做没有做过的事情，忠于自己的想法，做一个有原则的人，追寻自己认为对的生活。</p><p>不忘初心。</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;一篇关于我的真实回忆录&quot;&gt;&lt;a href=&quot;#一篇关于我的真实回忆录&quot; class=&quot;headerlink&quot; title=&quot;一篇关于我的真实回忆录&quot;&gt;&lt;/a&gt;一篇关于我的真实回忆录&lt;/h3&gt;&lt;hr&gt;
&lt;p&gt;我出生在一个极其普通传统的家庭，从小被父母带到省会读书。&lt;/p&gt;
    
    </summary>
    
      <category term="生活记载" scheme="http://codewey.com/categories/%E7%94%9F%E6%B4%BB%E8%AE%B0%E8%BD%BD/"/>
    
    
      <category term="生活" scheme="http://codewey.com/tags/%E7%94%9F%E6%B4%BB/"/>
    
      <category term="随笔" scheme="http://codewey.com/tags/%E9%9A%8F%E7%AC%94/"/>
    
  </entry>
  
  <entry>
    <title>人生一大极限挑战———我竟然走完了一百公里</title>
    <link href="http://codewey.com/post/100KM/"/>
    <id>http://codewey.com/post/100KM/</id>
    <published>2019-06-03T13:32:40.000Z</published>
    <updated>2020-07-12T10:41:48.657Z</updated>
    
    <content type="html"><![CDATA[<h3 id="K4426故事（续）———赴约"><a href="#K4426故事（续）———赴约" class="headerlink" title="K4426故事（续）———赴约"></a>K4426故事（续）———赴约</h3><a id="more"></a><p>就那么随口的一个约定，我们四人便不约而同的在三月份就在微信群里开始讨论参加百公里徒步的事情，走 1 0 0 km 想想都那么有（花）趣（钱）刺（找）激（虐 :unamused:）。</p><h3 id="百公里培训讲座"><a href="#百公里培训讲座" class="headerlink" title="百公里培训讲座"></a>百公里培训讲座</h3><p>园园 在群里发了百公里讲座的培训，我和 东东、君君 接着都报了名（结果只有我和 园园 去了 :sleeping:）。</p><p>哦，对了，这里我再介绍一下 园园 东东 君君 三人。<br></p><blockquote><p>园园：电商行业，女 <br><br>东东：电商行业，男 <br><br>君君：IT行业（退伍兵） 男</p></blockquote><p>以上三位都是我火车上结识的老乡，上篇文章有说到，这里就不多介绍了，回到正题。</p><p>那次培训报名，下了雨，一大早群里没动静，我以为都去了，就PDPD得起来去了公交站，到培训点那里要一个半小时。上了公交结果群里是这样的 </p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/15/Vt6BzlNxcF7IhQT.png" alt="20190612111850445.png"></p><p>园园 比较近，会比我先到，后来我们就在培训大厅会和了，这是火车上离别后的首次见面，这次讲座的内容，主要就是徒步的一些注意事项，对于我这种徒步小驴，收获还是挺大的。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/15/d6KGkxNnPJrlbWe.png" alt="20190613123959885.png"></p><p>培训比预定的时间快一些，下午4点半就结束了，出来后，我把今天的讲座内容发到了群里，艾特了下 东东、君君 。因为具体的报名时间还没有确定，我们约定好在活动开始报名前两周确定自己时间情况觉得是否能够组队参加（ps：<em>往年都是组队才可以报名，人数齐了才可以报，貌似至少4人，后来得知几年改了报名规则，可以单人报名了，所以这种突发情况不能完成组队的顾虑就可以消除了</em>）。</p><h3 id="报名（名额-2-万人，报名费-150）"><a href="#报名（名额-2-万人，报名费-150）" class="headerlink" title="报名（名额 2 万人，报名费 150）"></a>报名（名额 2 万人，报名费 150）</h3><p>磨坊百公里是深圳的一项全民公益性的大型徒步活动，2001年开始创办，第一届只有52人参与，今年是第十九届。在16年因为参与人数过多，起点是深圳湾，参与人达到6万人，据说这次的活动对当地市民造成了严重的影响，被一位市民举报，差点磨坊百公里这个活动就终结于16届，不过还好，经过与政府的协调，17年出发起点改在了大运体育中心并控制了报名人数。</p><p>不知不觉就到了报名的时间，在那一段时间里，掩盖不住心中的激动，上班的时候总是心不在焉的，哈哈，网上看装备，看注意事项，看官网论坛，看官方微信公众号，关注一切关于百公里的动态，终于盼来了报名。官方先放出了1000名赞助名额，通过好友助力的形式来提高中签率（类似买火车票那种加油），结果通过各种转发，完成了助力，坐等结果，官方剩下的1万9名额仍然报了名，会提升中签率，取两个渠道的其中一个，哪个先中给哪个。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/15/PpLFercqQEng9X7.png" alt="20190613120029958.png"></p><p>就这样，我们老乡四人在群里聊的不亦乐乎，等待报名结果的日子也是很漫长的，可能也是这么多年报名被吐槽最多的一回（理解万岁）。</p><p>最后，终于迎来的报名结果，成功中签（编号：84227），我的是微时光的1000名额，这一千名都是8开头。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/15/fvDpcsU2Rg7bzZl.png" alt="20190613120533268.png"></p><p>相继 园园、君君 也中签了，君君 最终也没有中，不过没中签也能空降，哈哈。</p><h3 id="装备"><a href="#装备" class="headerlink" title="装备"></a>装备</h3><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/15/e7P5lHXbdfFV1Dn.png" alt="20190613120823642.png"><br>说到装备，也是纠结了好久，按照网上、培训讲座、微信群里的各种途径的建议综合下，我买了以下装备：</p><blockquote><p>1、水袋背包（15升的，遵循尽量轻量化的原则） <br><br>2、护膝（不要长时间戴，影响血液循环，主要在后半程间歇性的戴）<br><br>3、冰袖（这个我感觉要戴，不然真的会被晒死的）<br><br>4、头巾（防晒）<br><br>5、帽子（防晒）<br><br>6、徒步鞋（推荐亚瑟士，切记不要穿登山鞋，太硬，还磨脚，穿软底的鞋子）<br><br>7、5双五指袜（每十几公里换一双，最终我的脚都每起一个泡）<br><br>8、登山杖（我觉得非大神，登山杖是必须的，它是支撑你后半程的助力，我后半程就靠这个拖着腿走完的，记得一定要直柄双杖）<br>9、一件防晒衣（很薄的那种，夜里会比较凉，防止着凉）<br><br>10、裤子（可以穿长运动裤，也可以运动短裤，我是那种篮球运动装，里面穿个紧身裤，外面再传一条短裤）<br><br>11、充电宝（不多说了）<br><br>12、垃圾袋（一路上垃圾桶很少，注意环保，我是拿了一个很大的绑在自己的背包上）<br><br>13、运动饮料 (我出发前自己带了一升半的水，两升的水袋，起点有赞助商的饮料补给，可以少带些)<br><br>14、士力架（这个很多人推荐，但是我真的真的不推荐，走到半路都化了，吃起来太腻了，真的是后悔带了，巧克力类的尽量都不要带，你根本吃不下，个人建议）<br><br>15、牛肉干或牛肉丁（超市都有，包括能补充能量和盐分的鸭腿什么的也可以带，我主要包太小，不用带太多吃的，可能走都半路你就想把包扔了）<br><br>16、榨菜（补充盐分）<br><br>17、凡士林润肤霜（出发前涂脚趾间，大腿内侧，总之能摩擦的地方你都涂点，防止摩擦起水泡）<br><br>18、云南白药创可贴（意外擦伤或起水泡）<br><br>19、云南白药气雾剂（这个没买，买的双氯芬酸钠气雾剂，药店员推荐的）<br><br>20、姨妈巾（夜用无翼卫生巾，很多人推荐，这个主要是垫脚的，比较软吧，我没有带，女队友带的有，我用了一次，感觉只要鞋子够软，这个其实作用不大）</p></blockquote><p>我能想起来的装备，只有这些了，如果有漏的我再补充吧，基本上这些就够了。</p><h3 id="行程安排"><a href="#行程安排" class="headerlink" title="行程安排"></a>行程安排</h3><p>因为起点在龙岗大运体育中心，大多数人都离这里比较远，早上6点钟就要出发了，所以要在6点之前赶到，要么就是在附近提前预定房间，要么就是驴友们一起拼车，早上早起过去。我是和附近的群友一起搭车过来的，有一个小伙伴自己开车过去，于是我就搭个顺风车过去，最终我们是四个人组成了拼车团（也成为了一起前行的队友）。</p><h3 id="拉练"><a href="#拉练" class="headerlink" title="拉练"></a>拉练</h3><p>拉练很重要，<br>拉链很重要，<br>拉链很重要，<br>重要的事说三遍。<br><br>但是很遗憾，作为一个苦逼的程序猿，并没有太多的拉练时间，也就平时公司每一周一次的羽毛球和篮球运动，可以忽略。</p><h3 id="线路（全程101-4公里）"><a href="#线路（全程101-4公里）" class="headerlink" title="线路（全程101.4公里）"></a>线路（全程101.4公里）</h3><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/15/hD6MZ9RbmyjfaGu.png" alt="20190613010215045.png"></p><h3 id="启程（2019-05-11）"><a href="#启程（2019-05-11）" class="headerlink" title="启程（2019-05-11）"></a>启程（2019-05-11）</h3><p>这一刻等了好久，大家都非常的兴奋，群里又开始活跃了起来，终于在出发的前一天晚上（周五），我早早的下了班，怀着激动的心情回去好好准备了下装备，群里我们约定好4点钟起床（真的是拼啊），我还专门早早的睡，晚上九点多就开始躺下，翻来覆去就是睡不着，可能真的是太激动了，不知我翻滚了多久，再次睁开眼睛就是被闹钟叫醒了，一想到该起床出发了，丝毫没有感到困意，赶紧看群里有没有消息，顺便发了条消息：“起床了，该出发了”，结果打脸了，我以为我是第一个起来的，别人早已经起来了，都太兴奋了，于是赶忙洗漱，背上装备，按照约定的地点，一分不差一分不多，成功启程。</p><h3 id="一签"><a href="#一签" class="headerlink" title="一签"></a>一签</h3><p>本计划在起点与老乡们会和，看到下图我觉得我方了</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/15/pQbcZqFMP5rwkOj.png" alt="20190613123059004.png"></p><p>人山人海，我们四人也只能先打卡过去，再联系，打卡点人真的是太多了。</p><p>当然，我们在起点留了张纪念照。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/15/KWVUg1Efen8arFl.png" alt="20190613123738560.png"></p><p><center><i>从左到右：亮亮（载我们来的车主），涛涛，丽丽，ME</i></center><br></p><p>随后我与园园进行微信位置共享，园园比我先到达，君君此时还在来的路上，园园穿着比较好认，我们很快就会和了，园园带了一个朋友（敏敏）过来，本应还有两个朋友一起的，结果走丢了，哈哈，感觉太正常不过，真的是一不留神就会走丢的，然后我们就先出发了，与君君联系后，一会再让他来赶上我们，此时我们的队伍很壮大（6人队），很容易走丢的，哈哈哈。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/15/1xNsIrePcQE5uTk.png" alt="20190613124123253.png"></p><p>这一路上边说边走，阵势尤为强大，渐渐烈日升起，今天的天气是如此的热，开始打开包囊把防晒装备都戴上，不过园园和他的朋友背的吃的东西实在是太多了。<br>下面比较搞笑的一幕就出现了，哈哈<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/15/UCLwisSEVlIXNcP.png" alt="20190613124507611.png"></p><p>我们才走了几公里，队伍便停下换姨妈巾了（园园提供的），我的脚涂了凡士林，就先没有换，真是一道美丽的风景线。</p><p>接着边走边聊，联系到了君君，他在我们后面前行，于是我们约定好在二签的时候集合。</p><p>这一路上，边走边看着队友们，生怕走丢了。到了梧桐山脚下的时候，我们停下歇息了会，开始调整，涂抹凡士林，换新的袜子，开始吃些东西，都来分享自己带的食物，就是在这个时候，我发现我买的士力架全部都软了，吃起来贼腻，真的后悔买这个了，所以我建议不要买士力架，周边的垃圾桶是比较少的，所以我就把带来的垃圾袋绑在了身上，供大家使用。</p><p>调整了大概十几分钟，我们开始起身继续行走，此时我也开始取下登山杖来助力行走，此时我的右腿其实是有些不舒服了，一可能就是因为我没有拉练，二就是我走路姿势的问题，我的左腿没有一点感觉，但是右腿已经有点累了，腿弯处有些酸，到了开始爬行梧桐山的时候，我的腿的疼痛感反应就有了，然后我就开始使用了护膝，护膝确实能够起到一定的作用，但是最后还是感觉腿胀胀的，坐下来休息时发现脚腕出现了血丝，然后我就把护膝给取了下来，莫非是血液不流通？总是护膝不能长时间戴着。</p><p>怎么说呢，那天的天气是特别热的，走梧桐山的时候，已经是正午，阳光爆裂的时刻，也是最缺水的一个阶段，好在28.3公里处有补给点，把水袋装满了水。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/15/6telPZmbIz2Q18J.png" alt="20190613020452935.png"></p><p>我从小到大都没有中暑过，就在这段起起伏伏的山坡中，连续中暑两次，身体出冷汗，胸口还有些刺痛感，全身无力，头晕目眩，说话喘不过气来，开始我以为只有我这样，敏敏也和我一样的症状，我觉得我一个男生好丢脸啊，女生还背着那么大的包都走到了这里，真的是挺佩服的，园园的脚已经起了很大的水泡，涛涛和亮亮都还没有事，莉莉在之前与我们走丢了，她已经在我们前面了，很佩服。</p><p>后来，山上有卖水的，我们都没有水了，买了五瓶（五元一瓶的农夫），接着我们继续前行，不知翻过了多少个坡，这段真的好痛苦，这期间我们补充了两次的食物，补充完能量的那瞬间是真的像脱胎换骨一样，豁然开朗了，起身继续前行，这之前我们有尝试使用小跑的方式行进，其实有时候小跑确实比走路痛苦少一些。经过这一段的行走，我们五人的速度已经开始拉开了，先是园园和亮亮在前面，然后又变我和园园在前面，然后我又和敏敏在最后面，中途分分合合了好几次，最后亮亮单独走在了最前面，我和园园在其后跟着，后来我和园园的距离也拉开了，此时离签到时间越来越近，总是被路上的志愿者调侃，走不完的两公里，也是哭笑不得啊。最后我赶上了亮亮，我撑着登山杖，支持着我的双腿，坚毅的往前行，心中默默念着：”快到了，快到了，坚持走下去”。</p><h3 id="二签"><a href="#二签" class="headerlink" title="二签"></a>二签</h3><p>看到二签的那一刻，只有一座桥的间隔，这也是在痛苦中走的最舒心的一段，走在桥间，阵阵风出来，简直别提多舒服了，我和亮亮边走边聊，终于抵达了二签（小三洲）。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/15/4BiHmlA1Dn79FJq.png" alt="2019-09-15_221044.png"><br>于是开始给园园他们打电话，一直打不通，然后我们俩就在签到口等着，不一会儿，园园也赶了上来，表情也是很苦逼啊，随后涛涛，敏敏都赶了上来，就这样我们都到达了二签，很不容易，感觉这对于一个不经常运动人的，真的是太酸爽了，我们找了个角落大歇了一会，调整一下，涂一些凡士林，换换袜子，喷些药，我是累的瘫在了地上，此时感觉自己还不如女生，好惭愧，哈哈。</p><p>调整之后，我们起身准备出发，此时也联系到了我们K4426的老乡君君，他比我们后出发，还比我们先到二签，我们见到的时候，他整个人跟没事儿的人一样，不愧是当过兵的人。</p><p>此时敏敏、亮亮都决定退出了，因为后面的路更难走，时间也比较紧，当然，有时也要量力而行，如果身体传出了信号，就是否要考虑继续往前行了。</p><p>于是我们还合了影进行留念，就此与两位队友告别。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/15/7sePNCQ3UV48zOm.png" alt="2019-09-15_220356.png"></p><p>当然，我可能就比较倔了，我是从始至终都怀着要走完的决心，不竭尽全力，会很不甘心，园园也一样，涛涛在人群中走失了，目前就剩我们三人组了，我们三人火车上相识，作为同乡的三人，达成一致的目标，向终点继续前行。</p><p>在三签到达前的这一路上（40km-73km），我们的体力是不断下降的，路程也比较远，这期间只有君君的体力是最好的，君君来看着地形为我们调整配速，不过从二签离开总体感觉是比前40km舒服很多，因为没有了烈日，唯一就是园园前脚掌起水泡，走起来就很痛苦，但是她仍然坚持着，很是佩服。我的右腿又很不争气，两个脚也开始酸胀感增强。</p><p>走到天黑时，有一段很长的土坡路，很难走，有时候累的不行了，就一起停下来歇歇，手机都没有心思看，只想闭上眼睡一觉，看见地就想躺。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/15/a3wyzeGpirb4MTW.png" alt="2019-09-15_221452.png"></p><p>大概晚上10点钟时候，朋友圈是这样的</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/15/xeq7bmg6sLK8pvA.jpg" alt="photo_2019-09-15_22-20-46.jpg"></p><p>经过一次大歇，我们起身后，真的感觉就无法行走了一样，腿特别的胀痛，真的不要休息太久，包括抬腿回血的时候，不要超过三分钟，不然，起身后，真的是好难走，一路上的拉练也是很重要的，所以会常常看到这个画面。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/15/bWaym5cN3UzxPhw.png" alt="2019-09-15_222311.png"></p><p>这一路上，夜里仍然有很多人，我感觉这些人都好强，大多都是运动达人，身体素质很棒，有些边走边唱的，很悠哉，更牛的人，可能跑着就早已到了终点，剩下的就是我们这些来找虐的小驴了。</p><p>我们边走边听歌，靠着音乐来鼓舞着自己，园园喜欢听许巍，我喜欢听beyond，然后就是相互鼓舞着，不断的靠着那双手臂与毅力来拖着看似半身不遂的躯体。</p><p>也不知道走了多久，看到了有发盒饭吃的，自己打菜，可惜没有筷子，菜也基本剩残渣了，此时已经差不多快十一点了，还有几公里到达三签，然后我们继续前行了，这个时候也饿的不行了，只能再坚持坚持了，到了三签就有泡面了。</p><p>不知道拖着躯体前行了多久，终于走出了山，进入城区，此时看到有些人已经走不下去，开始打车到终点了，当然，我认为这样就不是真正意义上的百公里了，大部分人还是会遵守这个规则的，毕竟这是对个人一个挑战。</p><h3 id="三签"><a href="#三签" class="headerlink" title="三签"></a>三签</h3><p>差不多走了1.5km，我们终于抵达三签（坪山体育馆），此时差不多凌晨十二点中，走路的速度像丧尸一样，晃晃悠悠地走进了签到点，我两眼到处寻找着泡面，已经饿的不行了，我们先找了个墙角落地休息，然后去拿了泡面，吃泡面的时候，别提有多爽了，真想吃饱喝足再睡上一大觉。</p><p>没有办法，时间不允许我们太多的停留，我们吃完，调整后，差不多快一点钟了，然后叫醒睡得正香的君君，我们算了下时间，我们这一路可能就没有太多时间停留了，要在上午9点半之前抵达，9点半就会关闭签到点了，所以以我们的行进速度，就很可能赶不上，于是备好水，继续前行。</p><p>那么三签到终点，有28km左右，有18km左右的路程是城区的马路，刚补充完能量的我们走这18km算是感觉比较舒坦的了，但是后10km简直就是炼狱一样。</p><p>在前18km这段路程中，相对我们走的速度并不是很快，中途我们商讨，在这比较好走的18km里，尽量使用小跑的速度，把速度提升上去，为后面的山路节省一些时间，后面可能就特别的难走。然后我们三人的速度也开始拉开，于是就分开先行，一段是走走又相遇，后来我一直使用小跑的方式，在前面行走，也不知道为什么，可能是能量补充的问题吧，此时收起登山杖，小跑起来其实比走路要舒服一点，园园和君君和我的距离在1-2km的距离，我们通过微信来联系着，我在前面打探着，中途路过了一个补给点，我看了下水带，差不多够用，就没有再装，然后联系了园园他们两个，记得补水，我此时稍作停歇后，继续前行。</p><p>中途，看到一个女孩有些眼熟，猛地一想，哦，原来是在三签吃泡面的时候坐在对面的那个姑娘，看起来很清新的软妹子，但是让我自愧不如，刮目相看的是她竟然没有用登山杖，这也太强了，我觉得要不是登山杖，我根本就走不到现在。她似乎也认出了我，只是各看了一眼，她的体力看起来还很好，我小跑一段后，稍慢一会，就被追上，然后我落后之后，就又追上了，就这样，像比赛一样，交叉追赶了几次后，我最终走在了前面，时间上来看，并不是很乐观，只能要更快些。</p><p>18km的这段，快到山脚入口的时候，遇到一位大姐，她也是组队过来，体力也不够了，于是落下了，然后这段我们结伴走了一段，刚到山口，就听到了喇叭里喊着：”还有最后10km”。感觉充满了希望，这10km感觉就像100km里，山路太痛苦。</p><p>刚入山口，没走多久，和那位大姐，我们就拉开了距离，我在前面继续前行，我也不知翻过了多少个山坡，累的已经真的要绝望了，然后突然后面跑着过来一位，我一看，原来是那位大姐，真的是深藏不露啊，她直接就开启了小跑模式，越走越远。此时的我已经没有力量开启小跑模式了，当然，我在城区小跑就是为了把时间节省在这段山路上，这段真的是痛不欲生，中途我好几次累的摊在地上歇息，在这一段里，天亮之后，烈日又升起，能做的只有前行，一路上被多少位志愿者大哥，说还有5km，然后走了一段又遇到一位志愿者同志，还说有5km（真的5km），我要哭了。</p><p>我不知道怎么表达，这种绝望感，我可以说这10km真的是在用毅力前行，我边走边估摸时间，要尽早赶到，所以基本上是不敢停留，这期间也联系了君君她们，她们两个在一起走着，距离应该还是在1-2km左右吧。</p><p>这10km里是把整座山绕了个圈，感觉翻不完的破，但是坡度还能接受，就是太漫长，此时的很多人的体力都已经不堪了，简直就是炼狱，最考验毅力的一段路程。</p><p>就这样，我靠着毅力终于走出了这座山，到达马路的那一刻，感觉胜利就在眼前，我看了下时间，还算充足，我开始坐在马路边调整，打开手机联系他们两个，没有打通，可能信号不好，路程还剩最后的2km，看到这个心理舒服多了。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/15/4tCIB7kcoKs582b.png" alt="2019-09-15_222431.png"></p><p>就这样，越走越近，又到了最后的500m</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/15/LHtbDk8h1nUGrYX.png" alt="2019-09-15_222610.png"></p><h3 id="终点"><a href="#终点" class="headerlink" title="终点"></a>终点</h3><p>没错，我成功了，我成功的走完了全程，到达终点的时候，我的内心是激动，但是我不得不像一个丧尸一样走进终点，我拿到了这块我认为我目前人生最大的一次挑战所获得的奖牌，很是欣慰。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/15/IsYDrmPuUWAxLBo.png" alt="2019-09-15_222942.png"></p><p>此时，感觉身体已经感觉不是自己的了，找到一个角度坐下，开始联系园园他们，得知他们两个也刚刚下山，从时间上来看，还来得及，然后我就摊在那里，等待着队友的抵达。</p><p>期间，我又看到了在途中遇到的那个女孩，她也成功抵达了终点，在那段小跑阶段，她整体的状态还是不错的，看到她进入签到点时，腿已经有些瘸了，脸色有些泛白，但是这种体能已经甩我几条街了，看到她拿到奖牌的那刻，她欣然的笑了，这是一张胜利者的笑容，她成功了。</p><p>大概等了园园他们半个小时左右，成功抵达签到点，就这样，我们三人，来自K4426列车的同乡，因一句约定，共同走完了这100km，我们成功了。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/15/HozuAVRnC1reN2G.png" alt="2019-09-15_223301.png"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/15/UFvQgnE6bzPjt5T.png" alt="2019-09-15_223725.png"><br>没错，这就是来自K4426的故事。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/15/iEGaZrUgecFyjs9.png" alt="2019-09-15_223922.png"><br>变态认证，哈哈，我这只能算初级变态<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/15/nTmylsf6OYLiAxH.png" alt="2019-09-15_2232218.png"></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;K4426故事（续）———赴约&quot;&gt;&lt;a href=&quot;#K4426故事（续）———赴约&quot; class=&quot;headerlink&quot; title=&quot;K4426故事（续）———赴约&quot;&gt;&lt;/a&gt;K4426故事（续）———赴约&lt;/h3&gt;
    
    </summary>
    
      <category term="随笔" scheme="http://codewey.com/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
      <category term="生活" scheme="http://codewey.com/tags/%E7%94%9F%E6%B4%BB/"/>
    
      <category term="足迹" scheme="http://codewey.com/tags/%E8%B6%B3%E8%BF%B9/"/>
    
      <category term="回忆" scheme="http://codewey.com/tags/%E5%9B%9E%E5%BF%86/"/>
    
  </entry>
  
  <entry>
    <title>来自《K4426》的故事</title>
    <link href="http://codewey.com/post/K4426/"/>
    <id>http://codewey.com/post/K4426/</id>
    <published>2019-05-06T14:48:54.000Z</published>
    <updated>2019-09-22T07:22:03.000Z</updated>
    
    <content type="html"><![CDATA[<p>看到标题，可能会有些诧异！”K4426”?，这是什么标志呢？可能有人也能联想到。。。没错，就是一趟我认为最慢最慢最慢的绿皮火车。</p><p>春节，我很幸运的抢到了这张K4426的硬座？？没错，硬座，像这么便宜的车，硬卧完全抢不到好吗？高铁我完全没有抢的欲望（因为坐不起啊o(╥﹏╥)o），最崩溃的是这趟车是凌晨1点半的(＃￣～￣＃)。<br><a id="more"></a><br>不知不觉就到了回村的日子，当天拎着箱子就到了公司，晚上加会班就直接去火车站了，和预想的一样，我是18年最后一个走的，叫好外卖，下好了火车上消磨时间的电视剧，那段比较火的《大江大河》，帅气的走出了写字楼。</p><p>按照掐好的时间，果然还是提前到了火车站，人真的是多的可怕，其实一个人出行，也挺不方便的，上个厕所，也没有人帮看下行李，不，上大号可以说基本排不上，果断放弃了。</p><p>凌晨一点钟，所有人都起身拥往进站口排队，看着这形形色色的人，可都是自己的老乡啊，大家看起来还都很精神，武警都上阵了，接着开门一个一个放行，很快，我也过了关卡，随着大部队朝着站内跑去。</p><p>这段路是如此的漫长，K4426在最后一段，跑了好久终于到了，验票上车，找到自己的位置，我是靠过道的位置（别人眼中最不好的位置），一共六个人，我静静的等待着。。。等了好久，终于来了一位女士，位置正对我，六个人，才来了一位，心中暗喜：最好都不来了，我可以躺着睡一晚了，哈哈！结果人越来越多，陆续又来了一对情侣，到了火车要快开动的前十分钟，剩下的那两个人都还没有到场（可能真的是把时间记成了下午一点半了吧！！），果真，火车开动了，那两个人也没有到来，不过还好，四个人共用六个位置，宽松了许多，可能最让我落差较大的就是人并没有我想象的那么多，难道是因为凌晨出发？</p><p>就这样，这一晚我们邻座间都没有说什么话，倒是火车上各种推销嚷嚷个不停，夜里火车音乐声还不断，真不知道怎么想的，夜里真的及其痛苦，坐着很难入睡，下好的电视剧，完全没有精神看啊，所以，以后买长途火车票能躺着就别坐着。</p><p>就这样，不知不觉随着火车的汽笛声，天渐渐的亮了，抬头看到的仍是推销不断的推销员走来走去，邻座们也都醒来，当然，火车上少不了的就是泡面，走过看起来并不是很拥挤的过道，洗漱一番，清爽了许多，望着窗外的风景，吃起了我那碗香辣牛肉面。</p><p>时间不知道过了多久，也不知道是什么话题，邻座们之间也渐渐聊起了话题，很巧的是，我们这排，大家都是年轻人，有聊不完的话题，我暂且将旁边的情侣就简称男X，女Y吧，聊天得知对面的女士是我的老乡，简称A吧。</p><p>A是电商行业，我对此行业了解并不是很多，如果细说整个行业，分支可能就多了去了。XY年龄不大但也都结婚了，还没我大，但相貌看起来比我成熟许多，与我同行，我们聊了些关于行业的一些看法吧（瞎聊），还聊得不亦乐乎，头头是道，哈哈。边聊边吃，再加睡觉，不知不觉就快到了傍晚，二十多小时的行程，过去了一大半，于是乎，过道右手边的四人座中的两位B、C也加入了我们的聊天。很巧，B和A都是做电商的，A刚做不久，B已经做了很多年了吧，同行聊起来就是很投机啊，什么B2B,B2C,O2O关于电商营销，外贸什么的聊的也是我一脸懵，不过还好，大学学过一些电商的知识，有些还算明白。对了，还有C是退伍兵，和XYA一样刚来S不久，接着我们就聊起电影，户外，爱好之类的，贼搞笑，聊着聊着XY也到了站，剩下两站的车程，我们接着聊啊，聊着聊着，A便喊道：”我们建个群组吧！”，约定年后一起户外运动，大家相互留了微信。”那群组的名字就叫K4426吧!”,我提议道。哈哈，大家一并赞同。</p><p>就这样，K4426群组就这样成立了，到站后， 我们一并下了车，下车才凌晨两点，我离得比较近，打的士十几分钟便到了，到家中，与家人在被窝中聊着在外的故事，慢慢进入了梦乡。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;看到标题，可能会有些诧异！”K4426”?，这是什么标志呢？可能有人也能联想到。。。没错，就是一趟我认为最慢最慢最慢的绿皮火车。&lt;/p&gt;
&lt;p&gt;春节，我很幸运的抢到了这张K4426的硬座？？没错，硬座，像这么便宜的车，硬卧完全抢不到好吗？高铁我完全没有抢的欲望（因为坐不起啊o(╥﹏╥)o），最崩溃的是这趟车是凌晨1点半的(＃￣～￣＃)。&lt;br&gt;
    
    </summary>
    
      <category term="随笔" scheme="http://codewey.com/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
      <category term="生活" scheme="http://codewey.com/tags/%E7%94%9F%E6%B4%BB/"/>
    
      <category term="足迹" scheme="http://codewey.com/tags/%E8%B6%B3%E8%BF%B9/"/>
    
      <category term="回忆" scheme="http://codewey.com/tags/%E5%9B%9E%E5%BF%86/"/>
    
  </entry>
  
  <entry>
    <title>dubbo 支持的通信协议</title>
    <link href="http://codewey.com/post/Dubbo-Supported-Communication-Protocol/"/>
    <id>http://codewey.com/post/Dubbo-Supported-Communication-Protocol/</id>
    <published>2019-05-04T17:09:45.000Z</published>
    <updated>2019-09-25T17:39:21.000Z</updated>
    
    <content type="html"><![CDATA[<p>dubbo 支持的通信协议</p><p>dubbo 协议</p><p>dubbo://192.168.0.1:20188</p><a id="more"></a><p>默认就是走 dubbo 协议的，单一长连接，NIO 异步通信，基于 hessian 作为序列化协议</p><p>适用的场景就是：传输数据量很小（每次请求在 100kb 以内），但是并发量很高</p><p>为了要支持高并发场景，一般是服务提供者就几台机器，但是服务消费者有上百台，可能每天调用量达到上亿次！此时用长连接是最合适的，就是跟每个服务消费者维持一个长连接就可以，可能总共就 100 个连接。然后后面直接基于长连接 NIO 异步通信，可以支撑高并发请求。</p><p>否则如果上亿次请求每次都是短连接的话，服务提供者会扛不住。</p><p>而且因为走的是单一长连接，所以传输数据量太大的话，会导致并发能力降低。所以一般建议是传输数据量很小，支撑高并发访问。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/26/f72aXsmxoFY3ZdH.png" alt=""></p><p>rmi 协议</p><p>走 java 二进制序列化，多个短连接，适合消费者和提供者数量差不多，适用于文件的传输，一般较少用</p><p>hessian 协议</p><p>走 hessian 序列化协议，多个短连接，适用于提供者数量比消费者数量还多，适用于文件的传输，一般较少用</p><p>http 协议</p><p>走 json 序列化</p><p>webservice</p><p>走 SOAP 文本序列化</p><p>dubbo 支持的序列化协议<br>dubbo 实际基于不同的通信协议，支持 hessian、java 二进制序列化、json、SOAP 文本序列化多种序列化协议。</p><p>但是 hessian 是其默认的序列化协议。</p><p>原文：<a href="https://www.cnblogs.com/mengchunchen/p/10075125.html" target="_blank" rel="noopener">https://www.cnblogs.com/mengchunchen/p/10075125.html</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;dubbo 支持的通信协议&lt;/p&gt;
&lt;p&gt;dubbo 协议&lt;/p&gt;
&lt;p&gt;dubbo://192.168.0.1:20188&lt;/p&gt;
    
    </summary>
    
      <category term="笔记" scheme="http://codewey.com/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="java" scheme="http://codewey.com/tags/java/"/>
    
      <category term="SpringCloud" scheme="http://codewey.com/tags/SpringCloud/"/>
    
      <category term="Dubbo" scheme="http://codewey.com/tags/Dubbo/"/>
    
  </entry>
  
  <entry>
    <title>Spring Boot 静态资源访问原理解析</title>
    <link href="http://codewey.com/post/Spring-Boot-Static-Resource-Access/"/>
    <id>http://codewey.com/post/Spring-Boot-Static-Resource-Access/</id>
    <published>2019-02-25T05:49:18.000Z</published>
    <updated>2019-09-25T15:27:48.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="一-前言"><a href="#一-前言" class="headerlink" title="一 前言"></a>一 前言</h2><p>　　springboot配置静态资源方式是多种多样，接下来我会介绍其中几种方式，并解析一下其中的原理。<br><a id="more"></a></p><h2 id="二、使用properties属性进行配置"><a href="#二、使用properties属性进行配置" class="headerlink" title="二、使用properties属性进行配置"></a>二、使用properties属性进行配置</h2><p>　　应该说 spring.mvc.static-path-pattern 和 spring.resources.static-locations这两属性是成对使用的，如果不明白其中的原理，总会出现资源404的情况。首先收一下spring.mvc.static-path-pattern代表的是一个Ant Path路径，例如resources/<strong>，表示当你的路径中存在resources/</strong>的时候才会处理请求。比如我们访问“<a href="http://localhost:8080/resources/xxx.js”时，很显然，springboot逻辑中会根据模式匹配对url进行匹配，匹配命中后，是如何再定位到具体的资源的呢？这时候spring.resources.static-locations的配置就起作用了。" target="_blank" rel="noopener">http://localhost:8080/resources/xxx.js”时，很显然，springboot逻辑中会根据模式匹配对url进行匹配，匹配命中后，是如何再定位到具体的资源的呢？这时候spring.resources.static-locations的配置就起作用了。</a></p><p>　　忘记说了，在springboot中spring.mvc.static-path-pattern的默认值是/**，spring.resources.static-locations的默认值是classpath:/static,classpath:/public,classpath:/resources,classpath:/META-INF/resources,servlet context:/，springboot中相关的ResourceHttpRequestHandler就会去spring.resources.static-locations配置的所有路径中寻找资源文件。</p><p>　　所以我之前才说spring.mvc.static-path-pattern 和 spring.resources.static-locations这两属性是成对使用的。</p><h2 id="三、springboot中默认对静态资源的处理"><a href="#三、springboot中默认对静态资源的处理" class="headerlink" title="三、springboot中默认对静态资源的处理"></a>三、springboot中默认对静态资源的处理</h2><p>　　调试过程中，通过查看 org.springframework.web.servlet.DispatcherServlet中的handlerMappings变量，我们发现有一个很显眼的 resourceHandlerMapping ，这个是springboot为我们提供的一个默认的静态资源handler，通过全文搜索发现出现在org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport这个类中，也就是这个类包含了@EnableWebMvc注解中的大多数功能，更多的扩展功能请参考org.springframework.web.servlet.config.annotation.DelegatingWebMvcConfiguration。</p><p>　　resourceHandlerMapping 的定义如下。</p><pre><code>/** * Return a handler mapping ordered at Integer.MAX_VALUE-1 with mapped * resource handlers. To configure resource handling, override * {@link #addResourceHandlers}. */@Beanpublic HandlerMapping resourceHandlerMapping() {    ResourceHandlerRegistry registry = new ResourceHandlerRegistry(this.applicationContext,            this.servletContext, mvcContentNegotiationManager());    addResourceHandlers(registry);    AbstractHandlerMapping handlerMapping = registry.getHandlerMapping();    if (handlerMapping != null) {        handlerMapping.setPathMatcher(mvcPathMatcher());        handlerMapping.setUrlPathHelper(mvcUrlPathHelper());        handlerMapping.setInterceptors(new ResourceUrlProviderExposingInterceptor(mvcResourceUrlProvider()));        handlerMapping.setCorsConfigurations(getCorsConfigurations());    }    else {        handlerMapping = new EmptyHandlerMapping();    }    return handlerMapping;}    </code></pre><p>　　请大家先记住ResourceHandlerRegistry这个类。</p><p>　   首先看一下addResourceHandlers(registry);这个方法，父类DelegatingWebMvcConfiguration做了实现，如下。</p><pre><code>private final WebMvcConfigurerComposite configurers = new WebMvcConfigurerComposite();@Overrideprotected void addResourceHandlers(ResourceHandlerRegistry registry) {    this.configurers.addResourceHandlers(registry);}</code></pre><p>　　其中WebMvcConfigurerComposite是操作了WebMvcConfigurer类型的对象的集合。在org.springframework.boot.autoconfigure.web.WebMvcAutoConfiguration这个springmvc的自动配置类中，有一个WebMvcConfigurer的实现类，如下。</p><pre><code>// Defined as a nested config to ensure WebMvcConfigurerAdapter is not read when not// on the classpath@Configuration@Import(EnableWebMvcConfiguration.class)@EnableConfigurationProperties({ WebMvcProperties.class, ResourceProperties.class })public static class WebMvcAutoConfigurationAdapter extends WebMvcConfigurerAdapter {    ...    @Override    public void addResourceHandlers(ResourceHandlerRegistry registry) {        if (!this.resourceProperties.isAddMappings()) {            logger.debug(&quot;Default resource handling disabled&quot;);            return;        }        Integer cachePeriod = this.resourceProperties.getCachePeriod();        if (!registry.hasMappingForPattern(&quot;/webjars/**&quot;)) {            customizeResourceHandlerRegistration(                    registry.addResourceHandler(&quot;/webjars/**&quot;)                            .addResourceLocations(                                    &quot;classpath:/META-INF/resources/webjars/&quot;)                    .setCachePeriod(cachePeriod));        }        String staticPathPattern = this.mvcProperties.getStaticPathPattern();        if (!registry.hasMappingForPattern(staticPathPattern)) {            customizeResourceHandlerRegistration(                    registry.addResourceHandler(staticPathPattern)                            .addResourceLocations(                                    this.resourceProperties.getStaticLocations())                    .setCachePeriod(cachePeriod));        }    }    ...}</code></pre><p>　　上面的addResourceHandlers方法中，增加了默认的mapping pattern = /webjars/** ，默认的resource location是classpath:/META-INF/resources/webjars/。正是这里的配置，我们在集成swagger的时候，就可以正常访问到swagger webjars中的js文件了。其中红色的代码部分就是用户可以自定义的默认静态资源访问方式，并通过ResourceHandlerRegistry对象进行注册。接着看一下mvcProperties和resourceProperties对应的类吧。</p><p>@ConfigurationProperties(“spring.mvc”)<br>public class WebMvcProperties {<br>    …</p><pre><code>/** * Path pattern used for static resources. */private String staticPathPattern = &quot;/**&quot;;...</code></pre><p>}<br>　　WebMvcProperties类中的staticPathPattern field 对应了spring.mvc.static-path-pattern这个属性，可以看到默认值是 “/**”。</p><p>@ConfigurationProperties(prefix = “spring.resources”, ignoreUnknownFields = false)<br>public class ResourceProperties implements ResourceLoaderAware {</p><pre><code>.....private static final String[] SERVLET_RESOURCE_LOCATIONS = { &quot;/&quot; };private static final String[] CLASSPATH_RESOURCE_LOCATIONS = {        &quot;classpath:/META-INF/resources/&quot;, &quot;classpath:/resources/&quot;,        &quot;classpath:/static/&quot;, &quot;classpath:/public/&quot; };private static final String[] RESOURCE_LOCATIONS;static {    RESOURCE_LOCATIONS = new String[CLASSPATH_RESOURCE_LOCATIONS.length            + SERVLET_RESOURCE_LOCATIONS.length];    System.arraycopy(SERVLET_RESOURCE_LOCATIONS, 0, RESOURCE_LOCATIONS, 0,            SERVLET_RESOURCE_LOCATIONS.length);    System.arraycopy(CLASSPATH_RESOURCE_LOCATIONS, 0, RESOURCE_LOCATIONS,            SERVLET_RESOURCE_LOCATIONS.length, CLASSPATH_RESOURCE_LOCATIONS.length);}private String[] staticLocations = RESOURCE_LOCATIONS;......</code></pre><p>}<br>　　ResourceProperties中staticLocations field 对应了 spring.resources.static-locations 这个属性。可以看到默认值是classpath:[/META-INF/resources/, /resources/, /static/, /public/], servlet context:/</p><h2 id="四、静态资源的Bean配置"><a href="#四、静态资源的Bean配置" class="headerlink" title="四、静态资源的Bean配置"></a>四、静态资源的Bean配置</h2><p>　　在了解了springboot默认资源的配置的原理（即 spring.mvc.static-path-pattern 和 spring.resources.static-locations），我们可以增加一个WebMvcConfigurer类型的bean，来添加静态资源的访问方式，还记得上面说的“请记住ResourceHandlerRegistry这个类“，下面就用到了哦。</p><pre><code>@Configurationpublic class ResourceWebMvcConfigurer extends WebMvcConfigurerAdapter {    @Override    public void addResourceHandlers(ResourceHandlerRegistry registry) {        registry.addResourceHandler(&quot;/resources/**&quot;)                .addResourceLocations(&quot;classpath:/public-resources/&quot;)                .setCacheControl(CacheControl.maxAge(1, TimeUnit.HOURS).cachePublic());    }}  那么当访问路径中包含&quot;resources/**&quot;的时候，resource handler就会去classpath:/public-resources目录下寻找了。</code></pre><h2 id="五、静态资源的查找"><a href="#五、静态资源的查找" class="headerlink" title="五、静态资源的查找"></a>五、静态资源的查找</h2><p>　　参考org.springframework.web.servlet.resource.ResourceHttpRequestHandler，ResourceHttpRequestHandler中通过org.springframework.web.servlet.resource.PathResourceResolver进行查找。</p><p>　　举个例子，下图是springboot打包之后的目录结构，现在想要通过url访问application.properties文件，springboot默认的静态文件配置可以吗？当然需要用事实来说话了。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/25/s51qoX4HnaMZStm.png" alt="">　　 </p><p> 　　我们已经知道，默认的resource locations中有个 servlet-context:/，访问你的url是<a href="http://localhost:8080/工程名/application.properties，调试一下PathResourceResolver，结果如下。" target="_blank" rel="noopener">http://localhost:8080/工程名/application.properties，调试一下PathResourceResolver，结果如下。</a></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/25/2VDsiZYPKINy9TE.png" alt=""></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.loli.net/2019/09/25/JdwZq1y6pBSbDOi.png" alt="">　　</p><p>　　发现servlet-context的根路径如上图所示，查看一下这个路径对应的目录，发现什么都没有，所以很显然无法找到我们要找的文件了。毕竟一般使用springboot都是jar项目，servlet-context path下没有用户自定义的资源。</p><h2 id="六、其他方式"><a href="#六、其他方式" class="headerlink" title="六、其他方式"></a>六、其他方式</h2><p>　　在Servlet3协议规范中，包含在JAR文件/META-INFO/resources/路径下的资源可以直接访问了。如果将springboot项目打包成war包，可以配置一个默认的servlet。在WebMvcConfigurationSupport中已经定义好了，不过默认是一个EmptyHandlerMapping。</p><pre><code>/** * Return a handler mapping ordered at Integer.MAX_VALUE with a mapped * default servlet handler. To configure &quot;default&quot; Servlet handling, * override {@link #configureDefaultServletHandling}. */@Beanpublic HandlerMapping defaultServletHandlerMapping() {    DefaultServletHandlerConfigurer configurer = new DefaultServletHandlerConfigurer(servletContext);    configureDefaultServletHandling(configurer);    AbstractHandlerMapping handlerMapping = configurer.getHandlerMapping();    handlerMapping = handlerMapping != null ? handlerMapping : new EmptyHandlerMapping();    return handlerMapping;}</code></pre><p>　　可以通过自定义一个WebMvcConfigurer类型的bean，改写configureDefaultServletHandling 方法，如下。</p><pre><code>@Configurationpublic class MyWebConfigurer extends WebMvcConfigurerAdapter {    @Override    public void configureDefaultServletHandling(DefaultServletHandlerConfigurer configurer) {        configurer.enable();    }}</code></pre><p>　　这样就设置了一个默认的servlet，在加载静态资源的时候就会按照servelt方式去加载了。</p><p>转自:<a href="https://www.cnblogs.com/hujunzheng/p/9682960.html" target="_blank" rel="noopener">https://www.cnblogs.com/hujunzheng/p/9682960.html</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;一-前言&quot;&gt;&lt;a href=&quot;#一-前言&quot; class=&quot;headerlink&quot; title=&quot;一 前言&quot;&gt;&lt;/a&gt;一 前言&lt;/h2&gt;&lt;p&gt;　　springboot配置静态资源方式是多种多样，接下来我会介绍其中几种方式，并解析一下其中的原理。&lt;br&gt;
    
    </summary>
    
      <category term="笔记" scheme="http://codewey.com/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="SpringBoot" scheme="http://codewey.com/tags/SpringBoot/"/>
    
      <category term="java" scheme="http://codewey.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>用了五年的笔记本键盘坏掉了</title>
    <link href="http://codewey.com/post/laptop-keyboard-disable-enable/"/>
    <id>http://codewey.com/post/laptop-keyboard-disable-enable/</id>
    <published>2019-01-20T08:18:51.000Z</published>
    <updated>2019-09-22T07:24:07.000Z</updated>
    
    <content type="html"><![CDATA[<p>用了五年的笔记本，在今天键盘突然就阵亡了，毫无征兆o(╥﹏╥)o.<a id="more"></a>键盘失灵的键位还特别的有规律，让我有点怀疑并不是硬件的问题。于是就网上找了各种方法都无果，最后就放大招，重装了系统。。。。。很遗憾，重装仍然无用，可能真的是坏掉了吧，感觉也没有修的价值了，果断某东趁着活动剁手买了款机械键盘，真香~(#^.^#)，每次开机，由于键盘内部可能存在接触不良的情况，个别键总是抖动，让我无法进行操作。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://deweyliu-1258441093.cos.ap-guangzhou.myqcloud.com/%E7%AC%94%E8%AE%B0%E6%9C%AC%E9%94%AE%E7%9B%98%E5%9D%8F%E6%8E%89%E4%BA%86/20190416011434904.png" alt=""></p><p>果断一顿操作：</p><p>WIN+R打开CMD命令行输入以下命令</p><p>禁用内置键盘</p><p><code>sc config i8042prt start= disabled</code></p><p>启用内置键盘</p><p><code>sc config i8042prt start= auto</code></p><p>注意:等号后面有一个空格,不要漏了</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;用了五年的笔记本，在今天键盘突然就阵亡了，毫无征兆o(╥﹏╥)o.
    
    </summary>
    
      <category term="Windows" scheme="http://codewey.com/categories/Windows/"/>
    
    
      <category term="Windows" scheme="http://codewey.com/tags/Windows/"/>
    
      <category term="dos" scheme="http://codewey.com/tags/dos/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud微服务版本灰度发布新神器</title>
    <link href="http://codewey.com/post/spring-cloud-version-god-tool/"/>
    <id>http://codewey.com/post/spring-cloud-version-god-tool/</id>
    <published>2018-12-20T06:54:48.000Z</published>
    <updated>2019-04-07T10:13:31.000Z</updated>
    
    <content type="html"><![CDATA[<article data-v-a7f310c8="" itemscope="itemscope" itemtype="http://schema.org/Article" class="entry-content-box" data-v-2f10e8c4=""><meta itemprop="url" content="https://juejin.im/entry/5b54985b518825597f6b7475"><meta itemprop="headline" content="Spring Cloud微服务版本灰度发布新神器"><!----><meta itemprop="datePublished" content="2018-07-22T14:44:43.623Z"><meta itemprop="image" content="https://b-gold-cdn.xitu.io/icon/icon-128.png"><div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="方志朋"><meta itemprop="url" content="https://juejin.im/user/580382465bbb50005b76ad36"></div><div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"><div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://b-gold-cdn.xitu.io/icon/icon-white-180.png"><meta itemprop="width" content="180"><meta itemprop="height" content="180"></div><br>    强烈建议star、fork该项目，该项目可以作为学习改造Spring Cloud组件的案例项目。<br>   Nepxion Discovery是一款对Spring Cloud的服务注册发现的增强中间件，其功能包括多版本灰度发布，黑/白名单的IP地址过滤，限制注册等，支持Eureka、Consul和Zookeeper。现有的Spring Cloud微服务可以方便引入该插件，代码零侵入，使用者只需要做如下简单的事情：<br><br>    <a id="more"></a><br><br>    <ul><br>        <li><br>            引入相关Plugin Starter依赖到pom.xml<br>        </li><br>        <li><br>            必须为微服务定义一个版本号（version），在application.properties或者yaml的metadata里<br>        </li><br>        <li><br>            必须为微服务自定义一个便于为微服务归类的Key，例如组名（group）或者应用名（application），在application.properties或者yaml的metadata里，便于远程配置中心推送和灰度界面分析<br>        </li><br>        <li><br>           使用者只需要关注相关规则推送。可以采用如下方式之一<br>        </li><br>        <li><br>           通过远程配置中心推送规则<br>        </li><br>        <li><br>            通过控制台界面推送规则<br>        </li><br>        <li><br>            通过客户端工具（例如Postman）推送推测<br>        </li><br>    </ul><br>    <h2 data-id="heading-0">Quick Start</h2><br>    <ul><br>        <li><br>           图形化演示操作<br>        </li><br>        <li><br>            请访问<a href="http://www.iqiyi.com/w_19rzwzovrl.html，视频清晰度改成720P，然后最大化播放" target="_blank" rel="noopener">http://www.iqiyi.com/w_19rzwzovrl.html，视频清晰度改成720P，然后最大化播放</a><br>        </li><br>        <li><br>            请访问<a href="https://pan.baidu.com/s/1eq_N56VbgSCaTXYQ5aKqiA，获取更清晰的视频" target="_blank" rel="noopener">https://pan.baidu.com/s/1eq_N56VbgSCaTXYQ5aKqiA，获取更清晰的视频</a><br>        </li><br>        <li><br>            更多教程和示例查看最下面的“示例演示”，<br>        </li><br>    </ul><br>    <h2 data-id="heading-1">痛点</h2><br>      现有Spring Cloud的痛点<br>    <ul><br>        <li><br>            如果你是运维负责人，是否会经常发现，你掌管的测试环境中的服务注册中心，被一些不负责的开发人员把他本地开发环境注册上来，造成测试人员测试失败。你希望可以把本地开发环境注册给屏蔽掉，不让注册<br>        </li><br>        <li><br>           如果你是运维负责人，生产环境的某个微服务集群下的某个实例，暂时出了问题，但又不希望它下线。你希望可以把该实例给屏蔽掉，暂时不让它被调用<br>        </li><br>        <li><br>           如果你是业务负责人，鉴于业务服务的快速迭代性，微服务集群下的实例发布不同的版本。你希望根据版本管理策略进行路由，提供给下游微服务区别调用，达到多版本灰度访问控制<br>        </li><br>        <li><br>          如果你是测试负责人，希望对微服务做A/B测试，那么通过动态改变版本达到该目的<br>        </li><br>    </ul><br>    <h2 data-id="heading-2">简介</h2><br>    <ul><br>        <li><br>           实现对基于Spring Cloud的微服务和Zuul网关的支持<br>        </li><br>        <li><br>           具有极大灵活性 - 支持在任何环节做过滤控制和版本灰度发布<br>        </li><br>        <li><br>           具有极小限制性 - 只要开启了服务注册发现，程序入口加了@EnableDiscoveryClient<br>        </li><br>        <li><br>          实现服务注册层面的控制<br>        </li><br>        <li><br>          基于黑/白名单的IP地址过滤机制禁止对相应的微服务进行注册<br>        </li><br>        <li><br>          基于最大注册数的限制微服务注册。一旦微服务集群下注册的实例数目已经达到上限，将禁止后续的微服务进行注册<br>        </li><br>        <li><br>          实现服务发现层面的控制<br>        </li><br>        <li><br>          基于黑/白名单的IP地址过滤机制禁止对相应的微服务被发现<br>        </li><br>        <li><br>          基于版本配对，通过对消费端和提供端可访问版本对应关系的配置，在服务发现和负载均衡层面，进行多版本访问控制<br>        </li><br>        <li><br>           实现灰度发布<br>        </li><br>        <li><br>           通过规则改变，实现灰度发布<br>        </li><br>        <li><br>          通过版本切换，实现灰度发布<br>        </li><br>        <li><br>          实现通过XML进行上述规则的定义<br>        </li><br>        <li><br>          实现通过事件总线机制（EventBus）的功能，实现发布/订阅功能<br>        </li><br>        <li><br>          对接远程配置中心，默认集成阿里巴巴的Nacos，异步接受远程配置中心主动推送规则信息，动态改变微服务的规则<br>        </li><br>        <li><br>          结合Spring Boot Actuator，异步接受Rest主动推送规则信息，动态改变微服务的规则<br>        </li><br>        <li><br>          结合Spring Boot Actuator，动态改变微服务的版本<br>        </li><br>        <li><br>          在服务注册层面的控制中，一旦禁止注册的条件触发，主动推送异步事件，以便使用者订阅<br>        </li><br>        <li><br>          实现通过Listener机制进行扩展<br>        </li><br>        <li><br>          使用者可以自定义更多的规则过滤条件<br>        </li><br>        <li><br>          使用者可以对服务注册发现核心事件进行监听<br>        </li><br>        <li><br>          实现支持Spring Boot Actuator和Swagger集成<br>        </li><br>        <li><br>          实现独立控制台，支持对规则和版本集中管理，未来考虑界面实现<br>        </li><br>        <li><br>          实现支持未来扩展更多的服务注册中心<br>        </li><br>        <li><br>          实现图形化的灰度发布功能<br>        </li><br>    </ul><br>    <h2 data-id="heading-3">名词解释</h2><br>    <ul><br>        <li><br>          IP地址，即根据微服务上报的它所在机器的IP地址。本系统内部强制以IP地址上报，禁止HostName上报，杜绝Spring Cloud应用在Docker或者Kubernetes部署时候出现问题<br>        </li><br>        <li><br>          本地版本，即初始化读取本地配置文件获取的版本，也可以是第一次读取远程配置中心获取的版本。本地版本和初始版本是同一个概念<br>        </li><br>        <li><br>          动态版本，即灰度发布时的版本。动态版本和灰度版本是同一个概念<br>        </li><br>        <li><br>          本地规则，即初始化读取本地配置文件获取的规则，也可以是第一次读取远程配置中心获取的规则。本地规则和初始规则是同一个概念<br>        </li><br>        <li><br>          动态规则，即灰度发布时的规则。动态规则和灰度规则是同一个概念<br>        </li><br>        <li><br>          事件总线，即基于Google Guava的EventBus构建的组件。在使用上，通过事件总线推送动态版本和动态规则的时候，前者只支持异步，后者支持异步和同步<br>        </li><br>        <li><br>          远程配置中心，即可以存储规则配置XML格式的配置中心，可以包括不限于Apollo，DisConf，Spring Cloud Config<br>        </li><br>    </ul><br>    <h2 data-id="heading-4">场景</h2><br>    <ul><br>        <li><br>           黑/白名单的IP地址注册的过滤<br>        </li><br>        <li><br>           开发环境的本地微服务（例如IP地址为172.16.0.8）不希望被注册到测试环境的服务注册发现中心，那么可以在配置中心维护一个黑/白名单的IP地址过滤（支持全局和局部的过滤）的规则<br>        </li><br>        <li><br>           我们可以通过提供一份黑/白名单达到该效果<br>        </li><br>        <li><br>           最大注册数的限制的过滤<br>        </li><br>        <li><br>           当某个微服务注册数目已经达到上限（例如10个），那么后面起来的微服务，将再也不能注册上去<br>        </li><br>        <li><br>           黑/白名单的IP地址发现的过滤<br>        </li><br>        <li><br>           开发环境的本地微服务（例如IP地址为172.16.0.8）已经注册到测试环境的服务注册发现中心，那么可以在配置中心维护一个黑/白名单的IP地址过滤（支持全局和局部的过滤）的规则，该本地微服务不会被其他测试环境的微服务所调用<br>        </li><br>        <li><br>            我们可以通过推送一份黑/白名单达到该效果<br>        </li><br>        <li><br>           多版本灰度访问控制<br>        </li><br>        <li><br>           A服务调用B服务，而B服务有两个实例（B1、B2），虽然三者相同的服务名，但功能上有差异，需求是在某个时刻，A服务只能调用B1，禁止调用B2。在此场景下，我们在application.properties里为B1维护一个版本为1.0，为B2维护一个版本为1.1<br>        </li><br>        <li><br>           我们可以通过推送A服务调用某个版本的B服务对应关系的配置，达到某种意义上的灰度控制，切换版本的时候，我们只需要再次推送即可<br>        </li><br>        <li><br>           动态改变微服务版本<br>        </li><br>        <li><br>           在A/B测试中，通过动态改变版本，不重启微服务，达到访问版本的路径改变<br>        </li><br>    </ul><br>    <h2 data-id="heading-5">架构</h2><br>       简单描述一下，本系统的核心模块“基于版本控制的灰度发布”，从网关（Zuul）开始的灰度发布操作过程<br>    <ul><br>        <li><br>            灰度发布前<br>        </li><br>        <li><br>            假设当前生产环境，调用路径为网关(V1.0)-&gt;服务A(V1.0)-&gt;服务B(V1.0)<br>        </li><br>        <li><br>           运维将发布新的生产环境，部署新服务集群，服务A(V1.1)，服务B(V1.1)<br>        </li><br>        <li><br>           由于网关(1.0)并未指向服务A(V1.1)，服务B(V1.1)，所以它们是不能被调用的<br>        </li><br>        <li><br>            灰度发布中<br>        </li><br>        <li><br>           新增用作灰度发布的网关(V1.1)，指向服务A(V1.1)-&gt;服务B(V1.1)<br>        </li><br>        <li><br>           灰度网关(V1.1)发布到服务注册发现中心，但禁止被服务发现，网关外的调用进来无法负载均衡到网关(V1.1)上<br>        </li><br>        <li><br>            在灰度网关(V1.1)-&gt;服务A(V1.1)-&gt;服务B(V1.1)这条调用路径做灰度测试<br>        </li><br>        <li><br>            灰度测试成功后，把网关(V1.0)指向服务A(V1.1)-&gt;服务B(V1.1)<br>        </li><br>        <li><br>            灰度发布后<br>        </li><br>        <li><br>           下线服务A(V1.0)，服务B(V1.0)，灰度成功<br>        </li><br>        <li><br>           灰度网关(V1.1)可以不用下线，留作下次版本上线再次灰度发布<br>        </li><br>    </ul><br>    架构图<br>    <img data-src="https://user-gold-cdn.xitu.io/2018/7/22/164c2733c95e8887?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" data-type="jpeg" class="lazyload inited loaded" data-width="1080" data-height="737" src="https://user-gold-cdn.xitu.io/2018/7/22/164c2733c95e8887?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"><br>    兼容<br>    版本兼容情况<br>    <ul><br>        <li><br>           Spring Cloud F版，请采用4.x.x版本，具体代码参考master分支<br>        </li><br>        <li><br>            Spring Cloud C版、D版和E版，请采用3.x.x版本，具体代码参考Edgware分支<br>        </li><br>        <li><br>           4.x.x版本由于Swagger和Spring Boot 2.x.x版本的Actuator用法有冲突，故暂时不支持Endpoint功能，其他功能和3.x.x版本一致<br>        </li><br>    </ul><br>    中间件兼容情况<br>    <ul><br>        <li><br>            Consul<br>        </li><br>        <li><br>            Spring Cloud F版，最好采用Consul的1.2.1服务器版本（或者更高），从<a href="https://releases.hashicorp.com/consul/1.2.1/获取" target="_blank" rel="noopener">https://releases.hashicorp.com/consul/1.2.1/获取</a><br>        </li><br>        <li><br>           Spring Cloud C版、D版和E版，必须采用Consul的0.9.3服务器版本（或者更低），从<a href="https://releases.hashicorp.com/consul/0.9.3/获取" target="_blank" rel="noopener">https://releases.hashicorp.com/consul/0.9.3/获取</a><br>        </li><br>        <li><br>            Zookeeper<br>        </li><br>        <li><br>            Spring Cloud F版，必须采用Zookeeper的3.5.x服务器版本（或者更高）<br>        </li><br>        <li><br>            Spring Cloud C版、D版和E版，最好采用Zookeeper的3.5.0以下服务器版本（或者更低）<br>        </li><br>        <li><br>            Eureka<br>        </li><br>        <li><br>            跟Spring Cloud版本保持一致<br>        </li><br>    </ul><br>    <h2 data-id="heading-6">依赖</h2><br>    微服务选择相应的插件引入，最后一个如需对接Nacos远程配置中心，则引入<br>    <pre><code><ol><li><code>&lt;dependency&gt;</code></li><li><code> &nbsp; &nbsp;&lt;groupId&gt;com.nepxion&lt;/groupId&gt;</code></li><li><code> &nbsp; &nbsp;&lt;artifactId&gt;discovery-plugin-starter-eureka&lt;/artifactId&gt;</code></li><li><code> &nbsp; &nbsp;&lt;version&gt;${discovery.plugin.version}&lt;/version&gt;</code></li><li><code>&lt;/dependency&gt;</code></li><li><code></code></li><li><code>&lt;dependency&gt;</code></li><li><code> &nbsp; &nbsp;&lt;groupId&gt;com.nepxion&lt;/groupId&gt;</code></li><li><code> &nbsp; &nbsp;&lt;artifactId&gt;discovery-plugin-starter-consul&lt;/artifactId&gt;</code></li><li><code> &nbsp; &nbsp;&lt;version&gt;${discovery.plugin.version}&lt;/version&gt;</code></li><li><code>&lt;/dependency&gt;</code></li><li><code></code></li><li><code>&lt;dependency&gt;</code></li><li><code> &nbsp; &nbsp;&lt;groupId&gt;com.nepxion&lt;/groupId&gt;</code></li><li><code> &nbsp; &nbsp;&lt;artifactId&gt;discovery-plugin-starter-zookeeper&lt;/artifactId&gt;</code></li><li><code> &nbsp; &nbsp;&lt;version&gt;${discovery.plugin.version}&lt;/version&gt;</code></li><li><code>&lt;/dependency&gt;</code></li><li><code></code></li><li><code>&lt;dependency&gt;</code></li><li><code> &nbsp; &nbsp;&lt;groupId&gt;com.nepxion&lt;/groupId&gt;</code></li><li><code> &nbsp; &nbsp;&lt;artifactId&gt;discovery-plugin-config-center-extension-nacos&lt;/artifactId&gt;</code></li><li><code> &nbsp; &nbsp;&lt;version&gt;${discovery.plugin.version}&lt;/version&gt;</code></li><li><code>&lt;/dependency&gt;</code></li></ol></code></pre><br>    独立控制台引入，最后一个如需对接Nacos远程配置中心，则引入<br>    <pre><code><ol><li><code>&lt;dependency&gt;</code></li><li><code> &nbsp; &nbsp;&lt;groupId&gt;com.nepxion&lt;/groupId&gt;</code></li><li><code> &nbsp; &nbsp;&lt;artifactId&gt;discovery-console-starter&lt;/artifactId&gt;</code></li><li><code> &nbsp; &nbsp;&lt;version&gt;${discovery.plugin.version}&lt;/version&gt;</code></li><li><code>&lt;/dependency&gt;</code></li><li><code></code></li><li><code>&lt;dependency&gt;</code></li><li><code> &nbsp; &nbsp;&lt;groupId&gt;com.nepxion&lt;/groupId&gt;</code></li><li><code> &nbsp; &nbsp;&lt;artifactId&gt;discovery-console-extension-nacos&lt;/artifactId&gt;</code></li><li><code> &nbsp; &nbsp;&lt;version&gt;${discovery.plugin.version}&lt;/version&gt;</code></li><li><code>&lt;/dependency&gt;</code></li></ol></code></pre><br>    <h2 data-id="heading-7">工程</h2><br>    <table><br>        <thead><br>            <tr><br>                <th>工程名</th><br>                <th>描述</th><br>            </tr><br>        </thead><br>        <tbody><br>            <tr><br>                <td>discovery-plugin-framework</td><br>                <td>核心框架</td><br>            </tr><br>            <tr><br>                <td>discovery-plugin-framework-eureka</td><br>                <td>核心框架的Eureka实现</td><br>            </tr><br>            <tr><br>                <td>discovery-plugin-framework-consul</td><br>                <td>核心框架的Consul实现</td><br>            </tr><br>            <tr><br>                <td>discovery-plugin-framework-zookeeper</td><br>                <td>核心框架的Zookeeper实现</td><br>            </tr><br>            <tr><br>                <td>discovery-plugin-config-center</td><br>                <td>配置中心实现</td><br>            </tr><br>            <tr><br>                <td>discovery-plugin-config-center-extension-nacos</td><br>                <td>配置中心的Nacos扩展</td><br>            </tr><br>            <tr><br>                <td>discovery-plugin-admin-center</td><br>                <td>管理中心实现</td><br>            </tr><br>            <tr><br>                <td>discovery-plugin-starter-eureka</td><br>                <td>Eureka Starter</td><br>            </tr><br>            <tr><br>                <td>discovery-plugin-starter-consul</td><br>                <td>Consul Starter</td><br>            </tr><br>            <tr><br>                <td>discovery-plugin-starter-zookeeper</td><br>                <td>Zookeeper Starter</td><br>            </tr><br>            <tr><br>                <td>discovery-console</td><br>                <td>独立控制台，提供给UI</td><br>            </tr><br>            <tr><br>                <td>discovery-console-extension-nacos</td><br>                <td>独立控制台的Nacos扩展</td><br>            </tr><br>            <tr><br>                <td>discovery-console-starter</td><br>                <td>Console Starter</td><br>            </tr><br>            <tr><br>                <td>discovery-console-desktop</td><br>                <td>图形化灰度发布等桌面程序</td><br>            </tr><br>            <tr><br>                <td>discovery-springcloud-example-console</td><br>                <td>独立控制台示例</td><br>            </tr><br>            <tr><br>                <td>discovery-springcloud-example-eureka</td><br>                <td>Eureka服务器</td><br>            </tr><br>            <tr><br>                <td>discovery-springcloud-example</td><br>                <td>灰度发布等示例</td><br>            </tr><br>        </tbody><br>    </table><br>    <h2 data-id="heading-8">规则和策略</h2><br>    <h3 data-id="heading-9">规则示例</h3><br>    请不要被吓到，我只是把注释写的很详细而已，里面配置没几行<br>    <pre><code><ol><li><code>&lt;?xml version=”1.0” encoding=”UTF-8”?&gt;</code></li><li><code>&lt;rule&gt;</code></li><li><code> &nbsp; &nbsp;&lt;!– 如果不想开启相关功能，只需要把相关节点删除即可，例如不想要黑名单功能，把blacklist节点删除 –&gt;</code></li><li><code> &nbsp; &nbsp;&lt;register&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– 服务注册的黑/白名单注册过滤，只在服务启动的时候生效。白名单表示只允许指定IP地址前缀注册，黑名单表示不允许指定IP地址前缀注册。每个服务只能同时开启要么白名单，要么黑名单 –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– filter-type，可选值blacklist/whitelist，表示白名单或者黑名单 –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– service-name，表示服务名 –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– filter-value，表示黑/白名单的IP地址列表。IP地址一般用前缀来表示，如果多个用“;”分隔，不允许出现空格 –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– 表示下面所有服务，不允许10.10和11.11为前缀的IP地址注册（全局过滤） –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;blacklist filter-value=”10.10;11.11”&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– 表示下面服务，不允许172.16和10.10和11.11为前缀的IP地址注册 –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;service service-name=”discovery-springcloud-example-a” filter-value=”172.16”/&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;/blacklist&gt;</code></li><li><code></code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– &lt;whitelist filter-value=””&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;service service-name=”” filter-value=””/&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;/whitelist&gt; &nbsp;–&gt;</code></li><li><code></code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– 服务注册的数目限制注册过滤，只在服务启动的时候生效。当某个服务的实例注册达到指定数目时候，更多的实例将无法注册 –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– service-name，表示服务名 –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– filter-value，表示最大实例注册数 –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– 表示下面所有服务，最大实例注册数为10000（全局配置） –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;count filter-value=”10000”&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– 表示下面服务，最大实例注册数为5000，全局配置值10000将不起作用，以局部配置值为准 –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;service service-name=”discovery-springcloud-example-a” filter-value=”5000”/&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;/count&gt;</code></li><li><code> &nbsp; &nbsp;&lt;/register&gt;</code></li><li><code></code></li><li><code> &nbsp; &nbsp;&lt;discovery&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– 服务发现的黑/白名单发现过滤，使用方式跟“服务注册的黑/白名单过滤”一致 –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– 表示下面所有服务，不允许10.10和11.11为前缀的IP地址被发现（全局过滤） –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;blacklist filter-value=”10.10;11.11”&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– 表示下面服务，不允许172.16和10.10和11.11为前缀的IP地址被发现 –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;service service-name=”discovery-springcloud-example-b” filter-value=”172.16”/&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;/blacklist&gt;</code></li><li><code></code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– 服务发现的多版本灰度访问控制 –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– service-name，表示服务名 –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– version-value，表示可供访问的版本，如果多个用“;”分隔，不允许出现空格 –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;version&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– 表示消费端服务a的1.0，允许访问提供端服务b的1.0和1.1版本 –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;service consumer-service-name=”discovery-springcloud-example-a” provider-service-name=”discovery-springcloud-example-b” consumer-version-value=”1.0” provider-version-value=”1.0;1.1”/&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– 表示消费端服务b的1.0，允许访问提供端服务c的1.0和1.1版本 –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;service consumer-service-name=”discovery-springcloud-example-b” provider-service-name=”discovery-springcloud-example-c” consumer-version-value=”1.0” provider-version-value=”1.0;1.1”/&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– 表示消费端服务b的1.1，允许访问提供端服务c的1.2版本 –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;service consumer-service-name=”discovery-springcloud-example-b” provider-service-name=”discovery-springcloud-example-c” consumer-version-value=”1.1” provider-version-value=”1.2”/&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;/version&gt;</code></li><li><code> &nbsp; &nbsp;&lt;/discovery&gt;</code></li><li><code>&lt;/rule&gt;</code></li></ol></code></pre><br>    <h3 data-id="heading-10">多版本灰度规则策略</h3><br>    <pre><code><ol><li><code>版本策略介绍</code></li><li><code>1. 标准配置，举例如下</code></li><li><code> &nbsp; &lt;service consumer-service-name=”a” provider-service-name=”b” consumer-version-value=”1.0” provider-version-value=”1.0,1.1”/&gt; 表示消费端1.0版本，允许访问提供端1.0和1.1版本</code></li><li><code>2. 版本值不配置，举例如下</code></li><li><code> &nbsp; &lt;service consumer-service-name=”a” provider-service-name=”b” provider-version-value=”1.0,1.1”/&gt; 表示消费端任何版本，允许访问提供端1.0和1.1版本</code></li><li><code> &nbsp; &lt;service consumer-service-name=”a” provider-service-name=”b” consumer-version-value=”1.0”/&gt; 表示消费端1.0版本，允许访问提供端任何版本</code></li><li><code> &nbsp; &lt;service consumer-service-name=”a” provider-service-name=”b”/&gt; 表示消费端任何版本，允许访问提供端任何版本</code></li><li><code>3. 版本值空字符串，举例如下</code></li><li><code> &nbsp; &lt;service consumer-service-name=”a” provider-service-name=”b” consumer-version-value=”” provider-version-value=”1.0,1.1”/&gt; 表示消费端任何版本，允许访问提供端1.0和1.1版本</code></li><li><code> &nbsp; &lt;service consumer-service-name=”a” provider-service-name=”b” consumer-version-value=”1.0” provider-version-value=””/&gt; 表示消费端1.0版本，允许访问提供端任何版本</code></li><li><code> &nbsp; &lt;service consumer-service-name=”a” provider-service-name=”b” consumer-version-value=”” provider-version-value=””/&gt; 表示消费端任何版本，允许访问提供端任何版本</code></li><li><code>4. 版本对应关系未定义，默认消费端任何版本，允许访问提供端任何版本</code></li><li><code></code></li><li><code>特殊情况处理，在使用上需要极力避免该情况发生</code></li><li><code>1. 消费端的application.properties未定义版本号，则该消费端可以访问提供端任何版本</code></li><li><code>2. 提供端的application.properties未定义版本号，当消费端在xml里不做任何版本配置，才可以访问该提供端</code></li></ol></code></pre><br>    <h3 data-id="heading-11">动态改变规则策略</h3><br>    微服务启动的时候，由于规则（例如：rule.xml）已经配置在本地，使用者希望改变一下规则，而不重启微服务，达到规则的改变<br>    <ul><br>        <li><br>            规则分为本地规则和动态规则<br>        </li><br>        <li><br>            本地规则是通过在本地规则（例如：rule.xml）文件定义的，也可以从远程配置中心获取，在微服务启动的时候读取<br>        </li><br>        <li><br>            动态规则是通过POST方式动态设置，或者由远程配置中心推送设置<br>        </li><br>        <li><br>            规则初始化的时候，如果接入了远程配置中心，先读取远程规则，如果不存在，再读取本地规则文件<br>        </li><br>        <li><br>            多规则灰度获取规则的时候，先获取动态规则，如果不存在，再获取本地规则<br>        </li><br>    </ul><br>    <h3 data-id="heading-12">动态改变版本策略</h3><br>    微服务启动的时候，由于版本已经写死在application.properties里，使用者希望改变一下版本，而不重启微服务，达到访问版本的路径改变<br>    <ul><br>        <li><br>            版本分为本地版本和动态版本<br>        </li><br>        <li><br>            本地版本是通过在application.properties里配置的，在微服务启动的时候读取<br>        </li><br>        <li><br>            动态版本是通过POST方式动态设置<br>        </li><br>        <li><br>            多版本灰度获取版本值的时候，先获取动态版本，如果不存在，再获取本地版本<br>        </li><br>    </ul><br>    <h3 data-id="heading-13">黑/白名单的IP地址注册的过滤策略</h3><br>    微服务启动的时候，禁止指定的IP地址注册到服务注册发现中心。支持黑/白名单，白名单表示只允许指定IP地址前缀注册，黑名单表示不允许指定IP地址前缀注册<br>    <ul><br>        <li><br>            全局过滤，指注册到服务注册发现中心的所有微服务，只有IP地址包含在全局过滤字段的前缀中，都允许注册（对于白名单而言），或者不允许注册（对于黑名单而言）<br>        </li><br>        <li><br>            局部过滤，指专门针对某个微服务而言，那么真正的过滤条件是全局过滤+局部过滤结合在一起<br>        </li><br>    </ul><br>    <h3 data-id="heading-14">最大注册数的限制的过滤策略</h3><br>    微服务启动的时候，一旦微服务集群下注册的实例数目已经达到上限（可配置），将禁止后续的微服务进行注册<br>    <ul><br>        <li><br>            全局配置值，只下面配置所有的微服务集群，最多能注册多少个<br>        </li><br>        <li><br>            局部配置值，指专门针对某个微服务而言，那么该值如存在，全局配置值失效<br>        </li><br>    </ul><br>    <h3 data-id="heading-15">黑/白名单的IP地址发现的过滤策略</h3><br>    微服务启动的时候，禁止指定的IP地址被服务发现。它使用的方式和“黑/白名单的IP地址注册的过滤”一致<br>    <h3 data-id="heading-16">版本属性字段定义策略</h3><br>    不同的服务注册发现组件对应的版本配置值<br>    <pre><code><ol><li><code># Eureka config</code></li><li><code>eureka.instance.metadataMap.version=1.0</code></li><li><code>eureka.instance.metadataMap.group=xxx-service-group</code></li><li><code></code></li><li><code># 奇葩的Consul配置（参考<a href="https://springcloud.cc/spring-cloud-consul.html" target="_blank" rel="noopener">https://springcloud.cc/spring-cloud-consul.html</a> - 元数据和Consul标签）</code></li><li><code># Consul config（多个值用“,”分隔，例如version=1.0,value=abc）</code></li><li><code>spring.cloud.consul.discovery.tags=version=1.0,group=xxx-service-group</code></li><li><code></code></li><li><code># Zookeeper config</code></li><li><code>spring.cloud.zookeeper.discovery.metadata.version=1.0</code></li><li><code>spring.cloud.zookeeper.discovery.metadata.group=xxx-service-group</code></li></ol></code></pre><br>    <h3 data-id="heading-17">功能开关策略</h3><br>    <pre><code><ol><li><code># Plugin config</code></li><li><code># 开启和关闭服务注册层面的控制。一旦关闭，服务注册的黑/白名单过滤功能将失效，最大注册数的限制过滤功能将失效。缺失则默认为true</code></li><li><code>spring.application.register.control.enabled=true</code></li><li><code># 开启和关闭服务发现层面的控制。一旦关闭，服务多版本调用的控制功能将失效，动态屏蔽指定IP地址的服务实例被发现的功能将失效。缺失则默认为true</code></li><li><code>spring.application.discovery.control.enabled=true</code></li><li><code># 开启和关闭通过Rest方式对规则配置的控制和推送。一旦关闭，只能通过远程配置中心来控制和推送。缺失则默认为true</code></li><li><code>spring.application.config.rest.control.enabled=true</code></li><li><code># 本地规则文件的路径，支持两种方式：classpath:rule.xml - 规则文件放在resources目录下，便于打包进jar；file:rule.xml - 规则文件放在工程根目录下，放置在外部便于修改。缺失则默认为不装载本地规则</code></li><li><code>spring.application.config.path=classpath:rule.xml</code></li><li><code># 为微服务归类的Key，一般通过group字段来归类，例如eureka.instance.metadataMap.group=xxx-group或者eureka.instance.metadataMap.application=xxx-application。缺失则默认为group</code></li><li><code># spring.application.group.key=group</code></li><li><code># spring.application.group.key=application</code></li></ol></code></pre><br>    <h2 data-id="heading-18">配置中心</h2><br>    <h3 data-id="heading-19">跟远程配置中心整合</h3><br>    本系统默认跟Nacos集成，如何安装使用，请参考<a href="https://github.com/alibaba/nacos。使用者也可以跟携程Apollo，百度DisConf等远程配置中心整合，实现规则读取和订阅" target="_blank" rel="noopener">https://github.com/alibaba/nacos。使用者也可以跟携程Apollo，百度DisConf等远程配置中心整合，实现规则读取和订阅</a><br>    <ul><br>        <li><br>            拉取配置，参考discovery-plugin-config-center-extension-nacos工程<br>        </li><br>        <li><br>            推送配置，参考discovery-console-extension-nacos工程<br>        </li><br>    </ul><br>    <h2 data-id="heading-20">管理中心</h2><br>    <blockquote><br>        PORT端口号为server.port或者management.port都可以（management.port开放只支持3.x.x版本）<br>        <h3 data-id="heading-21">配置接口</h3><br>        <h3 data-id="heading-22">版本接口</h3><br>        <h3 data-id="heading-23">路由接口</h3><br>        参考Swagger界面，如下图<br>    </blockquote><br>    <img data-src="https://user-gold-cdn.xitu.io/2018/7/22/164c2733cb52283a?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" data-type="png" class="lazyload inited loaded" data-width="1080" data-height="964" src="https://user-gold-cdn.xitu.io/2018/7/22/164c2733cb52283a?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"><br>    <h2 data-id="heading-24">独立控制台</h2><br>    为UI提供相关接口，包括<br>    <ul><br>        <li><br>            一系列批量功能<br>        </li><br>        <li><br>            跟Nacos集成，实现配置推送和清除<br>        </li><br>    </ul><br>    <blockquote><br>        PORT端口号为server.port或者management.port都可以（management.port开放只支持3.x.x版本）<br>        <h3 data-id="heading-25">控制台接口</h3><br>        参考Swagger界面，如下图<br>    </blockquote><br>    <img data-src="https://user-gold-cdn.xitu.io/2018/7/22/164c2733c892375f?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" data-type="jpeg" class="lazyload inited loaded" data-width="1080" data-height="829" src="https://user-gold-cdn.xitu.io/2018/7/22/164c2733c892375f?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"><br>    <h2 data-id="heading-26">扩展和自定义更多规则或者监听</h2><br>    使用者可以继承如下类<br>    <ul><br>        <li><br>            AbstractRegisterListener，实现服务注册的扩展和监听<br>        </li><br>        <li><br>            AbstractDiscoveryListener，实现服务发现的扩展和监听，注意，在Consul下，同时会触发service和management两个实例的事件，需要区别判断，如下图<br>        </li><br>    </ul><br>    集成了健康检查的Consul控制台<br>    <img data-src="https://user-gold-cdn.xitu.io/2018/7/22/164c2733c962de18?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" data-type="png" class="lazyload inited loaded" data-width="1080" data-height="387" src="https://user-gold-cdn.xitu.io/2018/7/22/164c2733c962de18?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"><br>    <h2 data-id="heading-27">示例演示</h2><br>    <h3 data-id="heading-28">场景描述</h3><br>    本例将模拟一个较为复杂的场景，如下图<br>    <img data-src="https://user-gold-cdn.xitu.io/2018/7/22/164c2733eb71dd1b?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" data-type="jpeg" class="lazyload inited loaded" data-width="1080" data-height="917" src="https://user-gold-cdn.xitu.io/2018/7/22/164c2733eb71dd1b?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"><br>    <ul><br>        <li><br>            系统部署情况：<br>        </li><br>        <li><br>            网关Zuul集群部署了1个<br>        </li><br>        <li><br>            微服务集群部署了3个，分别是A服务集群、B服务集群、C服务集群，分别对应的实例数为2、2、3<br>        </li><br>        <li><br>            微服务集群的调用关系为网关Zuul-&gt;服务A-&gt;服务B-&gt;服务C<br>        </li><br>        <li><br>            系统调用关系<br>        </li><br>        <li><br>            网关Zuul的1.0版本只能调用服务A的1.0版本，网关Zuul的1.1版本只能调用服务A的1.1版本<br>        </li><br>        <li><br>            服务A的1.0版本只能调用服务B的1.0版本，服务A的1.1版本只能调用服务B的1.1版本<br>        </li><br>        <li><br>            服务B的1.0版本只能调用服务C的1.0和1.1版本，服务B的1.1版本只能调用服务C的1.2版本<br>        </li><br>    </ul><br>    用规则来表述上述关系<br>    <pre><code><ol><li><code>&lt;?xml version=”1.0” encoding=”UTF-8”?&gt;</code></li><li><code>&lt;rule&gt;</code></li><li><code> &nbsp; &nbsp;&lt;discovery&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;version&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– 表示网关z的1.0，允许访问提供端服务a的1.0版本 –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;service consumer-service-name=”discovery-springcloud-example-zuul” provider-service-name=”discovery-springcloud-example-a” consumer-version-value=”1.0” provider-version-value=”1.0”/&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– 表示网关z的1.1，允许访问提供端服务a的1.1版本 –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;service consumer-service-name=”discovery-springcloud-example-zuul” provider-service-name=”discovery-springcloud-example-a” consumer-version-value=”1.1” provider-version-value=”1.1”/&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– 表示消费端服务a的1.0，允许访问提供端服务b的1.0版本 –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;service consumer-service-name=”discovery-springcloud-example-a” provider-service-name=”discovery-springcloud-example-b” consumer-version-value=”1.0” provider-version-value=”1.0”/&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– 表示消费端服务a的1.1，允许访问提供端服务b的1.1版本 –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;service consumer-service-name=”discovery-springcloud-example-a” provider-service-name=”discovery-springcloud-example-b” consumer-version-value=”1.1” provider-version-value=”1.1”/&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– 表示消费端服务b的1.0，允许访问提供端服务c的1.0和1.1版本 –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;service consumer-service-name=”discovery-springcloud-example-b” provider-service-name=”discovery-springcloud-example-c” consumer-version-value=”1.0” provider-version-value=”1.0;1.1”/&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;!– 表示消费端服务b的1.1，允许访问提供端服务c的1.2版本 –&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;service consumer-service-name=”discovery-springcloud-example-b” provider-service-name=”discovery-springcloud-example-c” consumer-version-value=”1.1” provider-version-value=”1.2”/&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;/version&gt;</code></li><li><code> &nbsp; &nbsp;&lt;/discovery&gt;</code></li><li><code>&lt;/rule&gt;</code></li></ol></code></pre><br>    上述微服务分别见discovery-springcloud-example字样的8个DiscoveryApplication，分别对应各自的application.properties。这8个应用，对应的版本和端口号如下表<br>    <table><br>        <thead><br>            <tr><br>                <th>微服务</th><br>                <th>服务端口</th><br>                <th>管理端口</th><br>                <th>版本</th><br>            </tr><br>        </thead><br>        <tbody><br>            <tr><br>                <td>A1</td><br>                <td>1100</td><br>                <td>5100</td><br>                <td>1.0</td><br>            </tr><br>            <tr><br>                <td>A2</td><br>                <td>1101</td><br>                <td>5101</td><br>                <td>1.1</td><br>            </tr><br>            <tr><br>                <td>B1</td><br>                <td>1200</td><br>                <td>5200</td><br>                <td>1.0</td><br>            </tr><br>            <tr><br>                <td>B2</td><br>                <td>1201</td><br>                <td>5201</td><br>                <td>1.1</td><br>            </tr><br>            <tr><br>                <td>C1</td><br>                <td>1300</td><br>                <td>5300</td><br>                <td>1.0</td><br>            </tr><br>            <tr><br>                <td>C2</td><br>                <td>1301</td><br>                <td>5301</td><br>                <td>1.1</td><br>            </tr><br>            <tr><br>                <td>C3</td><br>                <td>1302</td><br>                <td>5302</td><br>                <td>1.2</td><br>            </tr><br>            <tr><br>                <td>Zuul</td><br>                <td>1400</td><br>                <td>5400</td><br>                <td>1.0</td><br>            </tr><br>        </tbody><br>    </table><br>    独立控制台见discovery-springcloud-example-console，对应的版本和端口号如下表<br>    <table><br>        <thead><br>            <tr><br>                <th>服务端口</th><br>                <th>管理端口</th><br>            </tr><br>        </thead><br>        <tbody><br>            <tr><br>                <td>2222</td><br>                <td>3333</td><br>            </tr><br>        </tbody><br>    </table><br>    <h3 data-id="heading-29">开始演示</h3><br>    <ul><br>        <li><br>            启动服务注册发现中心，默认是Eureka。可供选择的有Eureka，Zuul，Zookeeper。Eureka，请启动discovery-springcloud-example-eureka下的应用，后两者自行安装服务器<br>        </li><br>        <li><br>            根据上面选择的服务注册发现中心，对示例下的discovery-springcloud-example/pom.xml进行组件切换<br>        </li><br>    </ul><br>    <pre><code><ol><li><code>&lt;dependency&gt;</code></li><li><code> &nbsp; &nbsp;&lt;groupId&gt;com.nepxion&lt;/groupId&gt;</code></li><li><code> &nbsp; &nbsp;&lt;artifactId&gt;discovery-plugin-starter-eureka&lt;/artifactId&gt;</code></li><li><code> &nbsp; &nbsp;&lt;!– &lt;artifactId&gt;discovery-plugin-starter-consul&lt;/artifactId&gt; –&gt;</code></li><li><code> &nbsp; &nbsp;&lt;!– &lt;artifactId&gt;discovery-plugin-starter-zookeeper&lt;/artifactId&gt; –&gt;</code></li><li><code> &nbsp; &nbsp;&lt;version&gt;${discovery.plugin.version}&lt;/version&gt;</code></li><li><code>&lt;/dependency&gt;</code></li></ol></code></pre><br>    <ul><br>        <li><br>            根据上面选择的服务注册发现中心，对控制台下的discovery-springcloud-example-console/pom.xml进行组件切换切换<br>        </li><br>    </ul><br>    <pre><code><ol><li><code>&lt;dependency&gt;</code></li><li><code> &nbsp; &nbsp;&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</code></li><li><code> &nbsp; &nbsp;&lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</code></li><li><code> &nbsp; &nbsp;&lt;!– &lt;artifactId&gt;spring-cloud-starter-consul-discovery&lt;/artifactId&gt; –&gt;</code></li><li><code> &nbsp; &nbsp;&lt;!– &lt;artifactId&gt;spring-cloud-starter-zookeeper-discovery&lt;/artifactId&gt; –&gt;</code></li><li><code>&lt;/dependency&gt;</code></li></ol></code></pre><br>    <h3 data-id="heading-30">服务注册过滤的操作演示</h3><br>    黑/白名单的IP地址注册的过滤<br>    <ul><br>        <li><br>            在rule.xml把本地IP地址写入到相应地方<br>        </li><br>        <li><br>            启动DiscoveryApplicationA1.java<br>        </li><br>        <li><br>            抛出禁止注册的异常，即本地服务受限于黑名单的IP地址列表，不会注册到服务注册发现中心；白名单操作也是如此，不过逻辑刚好相反<br>        </li><br>    </ul><br>    最大注册数的限制的过滤<br>    <ul><br>        <li><br>            在rule.xml修改最大注册数为0<br>        </li><br>        <li><br>            启动DiscoveryApplicationA1.java<br>        </li><br>        <li><br>            抛出禁止注册的异常，即本地服务受限于最大注册数，不会注册到服务注册发现中心<br>        </li><br>    </ul><br>    黑/白名单的IP地址发现的过滤<br>    <ul><br>        <li><br>            在rule.xml把本地IP地址写入到相应地方<br>        </li><br>        <li><br>            启动DiscoveryApplicationA1.java和DiscoveryApplicationB1.java、DiscoveryApplicationB2.java<br>        </li><br>        <li><br>            你会发现A服务无法获取B服务的任何实例，即B服务受限于黑名单的IP地址列表，不会被A服务的发现；白名单操作也是如此，不过逻辑刚好相反<br>        </li><br>    </ul><br>    <h3 data-id="heading-31">服务发现和负载均衡控制的操作演示</h3><br>    <h4 data-id="heading-32">基于图形化方式的多版本灰度访问控制</h4><br>    <ul><br>        <li><br>            请访问<a href="http://www.iqiyi.com/w_19s07thtsh.html，视频清晰度改成720P，然后最大化播放" target="_blank" rel="noopener">http://www.iqiyi.com/w_19s07thtsh.html，视频清晰度改成720P，然后最大化播放</a><br>        </li><br>        <li><br>            请访问<a href="https://pan.baidu.com/s/1eq_N56VbgSCaTXYQ5aKqiA，获取更清晰的视频" target="_blank" rel="noopener">https://pan.baidu.com/s/1eq_N56VbgSCaTXYQ5aKqiA，获取更清晰的视频</a><br>        </li><br>    </ul><br><br>    <img data-src="https://user-gold-cdn.xitu.io/2018/7/22/164c2733f4a84432?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" data-type="png" class="lazyload inited loaded" data-width="1080" data-height="496" src="https://user-gold-cdn.xitu.io/2018/7/22/164c2733f4a84432?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"><br>    <img data-src="https://user-gold-cdn.xitu.io/2018/7/22/164c27341aa44d0e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" data-type="png" class="lazyload inited loaded" data-width="1080" data-height="763" src="https://user-gold-cdn.xitu.io/2018/7/22/164c27341aa44d0e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"><br><br>    基于Rest方式的多版本灰度访问控制<br>    基于服务的操作过程和效果<br>    <ul><br>        <li><br>            启动discovery-springcloud-example下7个DiscoveryApplication（除去Zuul），无先后顺序，等待全部启动完毕<br>        </li><br>        <li><br>            下面URL的端口号，可以是服务端口号，也可以是管理端口号<br>        </li><br>        <li><br>            通过版本切换，达到灰度访问控制，针对A服务<br>        </li><br>        <li><br>            1.1 通过Postman或者浏览器，执行POST&nbsp;<a href="http://localhost:1100/routes，填入discovery-springcloud-example-b;discovery-springcloud-example-c，查看路由路径，如图1，可以看到符合预期的调用路径" target="_blank" rel="noopener">http://localhost:1100/routes，填入discovery-springcloud-example-b;discovery-springcloud-example-c，查看路由路径，如图1，可以看到符合预期的调用路径</a><br>        </li><br>        <li><br>            1.2 通过Postman或者浏览器，执行POST&nbsp;<a href="http://localhost:1100/version/update，填入1.1，动态把服务A的版本从1.0切换到1.1" target="_blank" rel="noopener">http://localhost:1100/version/update，填入1.1，动态把服务A的版本从1.0切换到1.1</a><br>        </li><br>        <li><br>            1.3 通过Postman或者浏览器，再执行第一步操作，如图2，可以看到符合预期的调用路径，通过版本切换，灰度访问控制成功<br>        </li><br>        <li><br>            通过规则改变，达到灰度访问控制，针对B服务<br>        </li><br>        <li><br>            2.1 通过Postman或者浏览器，执行POST&nbsp;<a href="http://localhost:1200/config/update-sync，发送新的规则XML（内容见下面）" target="_blank" rel="noopener">http://localhost:1200/config/update-sync，发送新的规则XML（内容见下面）</a><br>        </li><br>        <li><br>            2.2 通过Postman或者浏览器，执行POST&nbsp;<a href="http://localhost:1201/config/update-sync，发送新的规则XML（内容见下面）" target="_blank" rel="noopener">http://localhost:1201/config/update-sync，发送新的规则XML（内容见下面）</a><br>        </li><br>        <li><br>            2.3 上述操作也可以通过独立控制台，进行批量更新，见图5。操作的逻辑：B服务的所有版本都只能访问C服务3.0版本，而本例中C服务3.0版本是不存在的，意味着这么做B服务不能访问C服务<br>        </li><br>        <li><br>            2.4 重复1.1步骤，发现调用路径只有A服务-&gt;B服务，如图3，通过规则改变，灰度访问控制成功<br>        </li><br>        <li><br>            负载均衡的灰度测试<br>        </li><br>        <li><br>            3.1 通过Postman或者浏览器，执行POST&nbsp;<a href="http://localhost:1100/invoke，这是example内置的访问路径示例（通过Feign实现）" target="_blank" rel="noopener">http://localhost:1100/invoke，这是example内置的访问路径示例（通过Feign实现）</a><br>        </li><br>        <li><br>            3.2 重复“通过版本切换，达到灰度访问控制”或者“通过规则改变，达到灰度访问控制”操作，查看Ribbon负载均衡的灰度结果，如图4<br>        </li><br>        <li><br>            上述操作，都是单次操作，如需要批量操作，可通过“独立控制台”接口，它集成批量操作和推送到远程配置中心的功能，可以取代上面的某些调用方式<br>        </li><br>        <li><br>            其它更多操作，请参考“配置中心”、“管理中心”和“独立控制台”<br>        </li><br>    </ul><br>    新XML规则<br>    <pre><code><ol><li><code>&lt;?xml version=”1.0” encoding=”UTF-8”?&gt;</code></li><li><code>&lt;rule&gt;</code></li><li><code> &nbsp; &nbsp;&lt;discovery&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;version&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;service consumer-service-name=”discovery-springcloud-example-b” provider-service-name=”discovery-springcloud-example-c” consumer-version-value=”” provider-version-value=”3.0”/&gt;</code></li><li><code> &nbsp; &nbsp; &nbsp; &nbsp;&lt;/version&gt;</code></li><li><code> &nbsp; &nbsp;&lt;/discovery&gt;</code></li><li><code>&lt;/rule&gt;</code></li></ol></code></pre><br>    <img data-src="https://user-gold-cdn.xitu.io/2018/7/22/164c273461578b55?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" data-type="png" class="lazyload inited loaded" data-width="654" data-height="612" src="https://user-gold-cdn.xitu.io/2018/7/22/164c273461578b55?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"><br>    <img data-src="https://user-gold-cdn.xitu.io/2018/7/22/164c27347067221a?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" data-type="png" class="lazyload inited loaded" data-width="668" data-height="500" src="https://user-gold-cdn.xitu.io/2018/7/22/164c27347067221a?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"><br>    <img data-src="https://user-gold-cdn.xitu.io/2018/7/22/164c2734732d985b?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" data-type="png" class="lazyload inited loaded" data-width="574" data-height="354" src="https://user-gold-cdn.xitu.io/2018/7/22/164c2734732d985b?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"><br>    <img data-src="https://user-gold-cdn.xitu.io/2018/7/22/164c27347658b7e1?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" data-type="png" class="lazyload inited loaded" data-width="1080" data-height="699" src="https://user-gold-cdn.xitu.io/2018/7/22/164c27347658b7e1?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"><br>    <img data-src="https://user-gold-cdn.xitu.io/2018/7/22/164c27347a81d43d?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" data-type="png" class="lazyload inited loaded" data-width="1080" data-height="654" src="https://user-gold-cdn.xitu.io/2018/7/22/164c27347a81d43d?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"><br>    <img data-src="https://user-gold-cdn.xitu.io/2018/7/22/164c27347a81d43d?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" data-type="png" class="lazyload inited loaded" data-width="1080" data-height="654" src="https://user-gold-cdn.xitu.io/2018/7/22/164c27347a81d43d?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"><br>    基于网关的操作过程和效果<br>    <ul><br>        <li><br>            在上面基础上，启动discovery-springcloud-example下DiscoveryApplicationZuul<br>        </li><br>        <li><br>            因为Zuul是一种特殊的微服务，所有操作过程跟上面完全一致<br>        </li><br>    </ul><br>    <img data-src="https://user-gold-cdn.xitu.io/2018/7/22/164c2734898bf386?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" data-type="png" class="lazyload inited loaded" data-width="750" data-height="761" src="https://user-gold-cdn.xitu.io/2018/7/22/164c2734898bf386?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"><br>    <img data-src="https://user-gold-cdn.xitu.io/2018/7/22/164c273494b31e95?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" data-type="png" class="lazyload inited loaded" data-width="1080" data-height="722" src="https://user-gold-cdn.xitu.io/2018/7/22/164c273494b31e95?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"><br>    项目地址：<a href="https://github.com/Nepxion/Discovery" target="_blank" rel="noopener">https://github.com/Nepxion/Discovery</a>&nbsp;<br>  </div></article><p>  转自：<a href="https://juejin.im/entry/5b54985b518825597f6b7475" target="_blank" rel="noopener">https://juejin.im/entry/5b54985b518825597f6b7475</a></p>]]></content>
    
    <summary type="html">
    
      &lt;article data-v-a7f310c8=&quot;&quot; itemscope=&quot;itemscope&quot; itemtype=&quot;http://schema.org/Article&quot; class=&quot;entry-content-box&quot; data-v-2f10e8c4=&quot;&quot;&gt;&lt;meta itemprop=&quot;url&quot; content=&quot;https://juejin.im/entry/5b54985b518825597f6b7475&quot;&gt;&lt;meta itemprop=&quot;headline&quot; content=&quot;Spring Cloud微服务版本灰度发布新神器&quot;&gt;&lt;!----&gt;&lt;meta itemprop=&quot;datePublished&quot; content=&quot;2018-07-22T14:44:43.623Z&quot;&gt;&lt;meta itemprop=&quot;image&quot; content=&quot;https://b-gold-cdn.xitu.io/icon/icon-128.png&quot;&gt;&lt;div itemprop=&quot;author&quot; itemscope=&quot;itemscope&quot; itemtype=&quot;http://schema.org/Person&quot;&gt;&lt;meta itemprop=&quot;name&quot; content=&quot;方志朋&quot;&gt;&lt;meta itemprop=&quot;url&quot; content=&quot;https://juejin.im/user/580382465bbb50005b76ad36&quot;&gt;&lt;/div&gt;&lt;div itemprop=&quot;publisher&quot; itemscope=&quot;itemscope&quot; itemtype=&quot;http://schema.org/Organization&quot;&gt;&lt;meta itemprop=&quot;name&quot; content=&quot;掘金&quot;&gt;&lt;div itemprop=&quot;logo&quot; itemscope=&quot;itemscope&quot; itemtype=&quot;https://schema.org/ImageObject&quot;&gt;&lt;meta itemprop=&quot;url&quot; content=&quot;https://b-gold-cdn.xitu.io/icon/icon-white-180.png&quot;&gt;&lt;meta itemprop=&quot;width&quot; content=&quot;180&quot;&gt;&lt;meta itemprop=&quot;height&quot; content=&quot;180&quot;&gt;&lt;/div&gt;&lt;br&gt;    强烈建议star、fork该项目，该项目可以作为学习改造Spring Cloud组件的案例项目。&lt;br&gt;   Nepxion Discovery是一款对Spring Cloud的服务注册发现的增强中间件，其功能包括多版本灰度发布，黑/白名单的IP地址过滤，限制注册等，支持Eureka、Consul和Zookeeper。现有的Spring Cloud微服务可以方便引入该插件，代码零侵入，使用者只需要做如下简单的事情：&lt;br&gt;&lt;br&gt;
    
    </summary>
    
      <category term="java" scheme="http://codewey.com/categories/java/"/>
    
    
      <category term="java" scheme="http://codewey.com/tags/java/"/>
    
      <category term="SpringCloud" scheme="http://codewey.com/tags/SpringCloud/"/>
    
  </entry>
  
  <entry>
    <title>EnableDiscoveryClient与EnableEurekaClient的区别(Edgware版本)</title>
    <link href="http://codewey.com/post/spring-cloud-enableDiscoveryClient-and-enableEurekaClient/"/>
    <id>http://codewey.com/post/spring-cloud-enableDiscoveryClient-and-enableEurekaClient/</id>
    <published>2018-12-20T05:47:27.000Z</published>
    <updated>2019-04-07T09:54:32.000Z</updated>
    
    <content type="html"><![CDATA[<p>在基于SpringCloud做开发的时候，EnableDiscoveryClient和EnableEurekaClient这两个注解我们并不陌生，今天就来聊聊它们的区别，和网上更早期的类似文章不同的是：本文会聊到Dalston之后的版本中，这两个注解的区别；<br><a id="more"></a></p><h2 id="Spring-Cloud版本说明"><a href="#Spring-Cloud版本说明" class="headerlink" title="Spring Cloud版本说明"></a>Spring Cloud版本说明</h2><p>大致发展情况如下：<br>Angle -&gt; Brixton -&gt; Camden -&gt; Dalston -&gt; Edgware -&gt; Finchley</p><h2 id="文章概览"><a href="#文章概览" class="headerlink" title="文章概览"></a>文章概览</h2><p>全文由以下几部分组成，注意Dalston版本是个很重要的时间点，这之后的版本中EnableDiscoveryClient、EnableEurekaClient的作用发生了很大的变化，因此我们接下来的讨论都要先分清楚是Dalston版本之前还是之后： </p><ol><li>问题的起源； </li><li>来自作者的权威答案（Dalston或更早期的版本）； </li><li>官方文档（Dalston或更早期的版本）； </li><li>看源码（Dalston或更早期的版本）； </li><li>Edgware版本中EnableEurekaClient的变化； </li><li>Edgware版本官方文档对EnableDiscoveryClient的解释； </li><li>源码揭示EnableDiscoveryClient的变化； </li><li>一点遗留问题待确定； </li><li>小结；</li></ol><h2 id="问题的起源"><a href="#问题的起源" class="headerlink" title="问题的起源"></a>问题的起源</h2><p>在使用Spring Cloud的Dalston版本或更早期的版本中，为了将应用发布到Eureka注册中心，我们会在配置类中增加@EnableDiscoveryClient或者@EnableEurekaClient注解，例如以下代码：</p><pre><code>package com.bolingcavalry.springclouddeepprovider;import org.springframework.boot.SpringApplication;import org.springframework.boot.autoconfigure.SpringBootApplication;import org.springframework.cloud.client.discovery.EnableDiscoveryClient;@SpringBootApplication@EnableDiscoveryClientpublic class SpringclouddeepproviderApplication {    public static void main(String[] args) {        SpringApplication.run(SpringclouddeepproviderApplication.class, args);    }}</code></pre><p> 于是就有了疑问：<font color="blue">EnableDiscoveryClient和EnableEurekaClient的区别和关系。</font></p><p> 来自作者的权威答案（Dalston或更早期的版本）</p><p> 请注意，下面这段内容的背景是Spring Cloud的Dalston版本，或更早期的版本，这一点很重要！<br>EnableDiscoveryClient和EnableEurekaClient的区别在网上有不少文章分析，但最权威的答案应该来自这两个类的作者Spencer Gibb，他在StackOverflow上有回复，地址是：<a href="https://stackoverflow.com/questions/31976236/whats-the-difference-between-enableeurekaclient-and-enablediscoveryclient" target="_blank" rel="noopener">https://stackoverflow.com/questions/31976236/whats-the-difference-between-enableeurekaclient-and-enablediscoveryclient</a></p><p>内容如下图：<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdn.net/2018091319173812?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JvbGluZ19jYXZhbHJ5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p><p>我的理解：注册发现服务有三种实现方式：eureka、consul、zookeeper，EnableDiscoveryClient注解在common包中，通过项目的classpath来决定使用哪种实现，而EnableEurekaClient注解在netflix包中，只会使用eureka这种实现方式；</p><p>有两个时间点需要注意： </p><ol><li>Spencer Gibb的这段话发表于2015年8月13日； </li><li>Spencer Gibb于2017年10月25日，在Spring官方博客宣布Edgware.RC1版本发布，如下图，此时距离他在StackOverflow上那个回答已经过去了两年：<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdn.net/20180914062521357?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JvbGluZ19jYXZhbHJ5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></li></ol><p>因此，如果您使用的Spring Cloud版本是Edgware或者更新的版本，您在考虑EnableDiscoveryClient和EnableEurekaClient的区别时，Spencer Gibb在StackOverflow上的那个解释就未必准确了，因为您的版本距离他当时的版本已经有了两年以上的间隔；</p><h2 id="官方文档（Dalston或更早期的版本）"><a href="#官方文档（Dalston或更早期的版本）" class="headerlink" title="官方文档（Dalston或更早期的版本）"></a>官方文档（Dalston或更早期的版本）</h2><p>在Spring官方博客，于2014年12月9日宣布Spring Cloud 1.0.0.RC1发布，地址是：<a href="https://spring.io/blog/2014/12/19/spring-cloud-1-0-0-rc1-available-now，里面有段描述如下图红框所示：" target="_blank" rel="noopener">https://spring.io/blog/2014/12/19/spring-cloud-1-0-0-rc1-available-now，里面有段描述如下图红框所示：</a></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdn.net/20180914064020904?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JvbGluZ19jYXZhbHJ5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p><p>我对以上描述的理解： </p><ol><li>服务注册发现功能被抽象后放入spring-cloud-commons库，该库的EnableDiscoveryClient可以取代旧的EnableEurekaClient，使用注解EnableDiscoveryClient就能启用服务注册发现功能； </li><li>同理，EnableHystrix也被EnableCircuitBreaker取代了；</li></ol><p>可见，从Spring Cloud 1.0.0.RC1版本开始，就已经不推荐使用EnableEurekaClient和EnableHystrix了；</p><h2 id="看源码（Dalston或更早期的版本）"><a href="#看源码（Dalston或更早期的版本）" class="headerlink" title="看源码（Dalston或更早期的版本）"></a>看源码（Dalston或更早期的版本）</h2><p>看一下Dalston版本的EnableEurekaClient源码：</p><pre><code>@Target(ElementType.TYPE)@Retention(RetentionPolicy.RUNTIME)@Documented@Inherited@EnableDiscoveryClientpublic @interface EnableEurekaClient {}</code></pre><p>上述代码显示，EnableEurekaClient 中使用了EnableDiscoveryClient，因此，从使用者角度来看两者确实已经没有什么区别了，按照官方的建议使用EnableDiscoveryClient其实是个不错的选择；</p><h2 id="Edgware版本中EnableEurekaClient的变化"><a href="#Edgware版本中EnableEurekaClient的变化" class="headerlink" title="Edgware版本中EnableEurekaClient的变化"></a>Edgware版本中EnableEurekaClient的变化</h2><p>来看看Edgware版本中，EnableEurekaClient.java的内容：</p><pre><code>@Target(ElementType.TYPE)@Retention(RetentionPolicy.RUNTIME)@Documented@Inheritedpublic @interface EnableEurekaClient {}</code></pre><p>如上所示，之前版本中的@EnableDiscoveryClient注解已经不存在了，而且也没有用到任何@Import注解，因此，EnableEurekaClient这个注解已经没什么用处了，在代码中用不用它，是没什么差别的；</p><h2 id="Edgware版本官方文档对EnableDiscoveryClient的解释"><a href="#Edgware版本官方文档对EnableDiscoveryClient的解释" class="headerlink" title="Edgware版本官方文档对EnableDiscoveryClient的解释"></a>Edgware版本官方文档对EnableDiscoveryClient的解释</h2><p>Dalston之后的第一个版本为Edgware，Spring官方博客在2017年10月25日宣布发布，一起来看看此版本的EnableEurekaClient和EnableDiscoveryClient的区别；</p><p>首先还是看官方博客，关键信息如下图： </p><p><a href="https://img-blog.csdn.net/20180914085834726?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JvbGluZ19jYXZhbHJ5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" target="_blank" rel="noopener">https://img-blog.csdn.net/20180914085834726?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JvbGluZ19jYXZhbHJ5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70</a></p><p>我对以上内容的理解： </p><ol><li>EnableDiscoveryClient注解现在是可选项了(你用不用这个注解，是不会影响服务注册发现功能的)； </li><li>只要依赖了以spring-cloud-starter-netflix为前缀的库(例如spring-cloud-starter-netflix-eureka-client)，就启用了服务注册发现功能； </li><li>使用配置项spring.cloud.service-registry.auto-registration.enabled=false即可禁止服务注册发现功能；</li></ol><p>从官方博客上看来EnableDiscoveryClient注解已经不会影响服务注册发现功能了；</p><h2 id="如何理解“-EnableDiscoveryClient-is-now-optional”？"><a href="#如何理解“-EnableDiscoveryClient-is-now-optional”？" class="headerlink" title="如何理解“@EnableDiscoveryClient is now optional”？"></a>如何理解“@EnableDiscoveryClient is now optional”？</h2><p>既然注解@EnableDiscoveryClient用或者不用都不影响服务注册发现功能，那为什么官方文档将其描述为”is now optional”（可选项），为什么不直接废弃这个注解呢？<br>从官方文档对EnableDiscoveryClient的描述，我们可以看个明白，如下图：<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdn.net/20180916113248257?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JvbGluZ19jYXZhbHJ5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p><p>上图是Edgware版本的开发文档，地址：<a href="http://cloud.spring.io/spring-cloud-static/Edgware.SR4/multi/multi__spring_cloud_commons_common_abstractions.html#__enablediscoveryclient" target="_blank" rel="noopener">http://cloud.spring.io/spring-cloud-static/Edgware.SR4/multi/multi__spring_cloud_commons_common_abstractions.html#__enablediscoveryclient</a></p><p>从上图描述可以看出，spring容器在查询spring.factories的过程中，如果找到了EnableDiscoveryClient的配置，就会实例化该配置对应的服务注册发现：例如eureka、consul、zookeeper等；</p><p>红框中提到，EnableDiscoveryClient不是必须的，只要classpath中存在DiscoveryClient的实现就可以保证将应用注册到注册中心了，这个功能是如何实现的，后面我们会分析到(和spring.factories有关)；</p><p>源码揭示EnableDiscoveryClient的变化<br>通过源码来确认官方文档的信息，这种方式可以加深对Spring Cloud的理解；</p><p>寻找突破点：<br>面对浩瀚的源码，如何下手呢？前面官方文档的那句话给了我们一个线索，如下图红框所示： </p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdn.net/20180915161227128?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JvbGluZ19jYXZhbHJ5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p><p>只依赖以spring-cloud-starter-netflix为前缀的库(例如spring-cloud-starter-netflix-eureka-client)，就启用了服务注册发现功能，这个特性让我想起了spring容器通过META-INF/spring.factories文件加载配置的能力；</p><p>于是打开工程spring-cloud-netflix-eureka-client(Edgware版对应的该工程版本号为1.4.0.RELEASE)，去看src\main\resources\META-INF目录下的spring.factories文件，发现在springboot的自动配置项中，出现了一个关键配置EurekaDiscoveryClientConfiguration，如下图：<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdn.net/20180915175452612?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JvbGluZ19jYXZhbHJ5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p><p>EurekaDiscoveryClientConfiguration负责启动实现服务注册发现功能，实现机制相对复杂，在此不展开细说了，看看部分源码如下：<br><img src="https://img-blog.csdn.net/20180915175715628?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JvbGluZ19jYXZhbHJ5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p><p>真相大白：服务注册发现功能是否启动，是由配置类EurekaDiscoveryClientConfiguration控制的，在Edgware版本中，如果开启了springboot的自动配置，那么EurekaDiscoveryClientConfiguration就会生效，因此不是靠EnableDiscoveryClient注解来控制了；</p><p>现在我们对Edgware版本的服务注册发现已经有所了解，再去看看Dalston版本下的spring.factories，应该能有不少收获；</p><p>Dalston版的Spring Cloud，其spring-cloud-netflix-eureka-client工程的版本号为1.3.6.RELEASE，打开该工程下面的spring.factories文件，内容如下： </p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdn.net/2018091517501845?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JvbGluZ19jYXZhbHJ5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p><p>真相大白：在Dalston版本下，使用注解EnableDiscoveryClient才会使配置类EurekaDiscoveryClientConfiguration生效；</p><h2 id="一点遗留问题待确定"><a href="#一点遗留问题待确定" class="headerlink" title="一点遗留问题待确定"></a>一点遗留问题待确定</h2><p>前面我们在Edgware和Dalston版本下分别打开spring-cloud-netflix-eureka-client工程的spring.factories，通过对比spring.factories，弄清楚了服务注册发现功能是如何启动的；</p><p>但是似乎有个问题： </p><ol><li>在Edgware版本中，官方建议使用spring-cloud-netflix-eureka-client作为starter； </li><li>在Dalston版本中，官方建议使用spring-cloud-starter-eureka作为start，也就是所我们的pom.xml中并没有出现spring-cloud-netflix-eureka-client；</li></ol><p>那么问题来了，如果Dalston版本中没有用到spring-cloud-netflix-eureka-client库，那么它的spring.factories自然也就不会生效，那我们刚才的分析岂不是无用了？</p><p>除非是被pom.xml中的其他库间接依赖了，还是创建一个工程来验证一下吧；</p><p>基于maven创建一个springboot工程，里面依赖了Spring Cloud的Dalston版本，pom.xml内容如下：</p><pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;    xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;    &lt;groupId&gt;com.bolingcavalry&lt;/groupId&gt;    &lt;artifactId&gt;springclouddeepprovider&lt;/artifactId&gt;    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;    &lt;packaging&gt;jar&lt;/packaging&gt;    &lt;name&gt;springclouddeepprovider&lt;/name&gt;    &lt;description&gt;Demo project for Spring Cloud service provider&lt;/description&gt;    &lt;parent&gt;        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;        &lt;version&gt;1.5.9.RELEASE&lt;/version&gt;    &lt;/parent&gt;    &lt;properties&gt;        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;        &lt;java.version&gt;1.8&lt;/java.version&gt;    &lt;/properties&gt;    &lt;dependencies&gt;        &lt;dependency&gt;            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;        &lt;/dependency&gt;        &lt;dependency&gt;            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;            &lt;artifactId&gt;spring-cloud-starter-eureka&lt;/artifactId&gt;        &lt;/dependency&gt;        &lt;dependency&gt;            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;            &lt;scope&gt;test&lt;/scope&gt;        &lt;/dependency&gt;    &lt;/dependencies&gt;    &lt;dependencyManagement&gt;        &lt;dependencies&gt;            &lt;dependency&gt;                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;                &lt;version&gt;Dalston.SR5&lt;/version&gt;                &lt;type&gt;pom&lt;/type&gt;                &lt;scope&gt;import&lt;/scope&gt;            &lt;/dependency&gt;        &lt;/dependencies&gt;    &lt;/dependencyManagement&gt;    &lt;build&gt;        &lt;plugins&gt;            &lt;plugin&gt;                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;            &lt;/plugin&gt;        &lt;/plugins&gt;    &lt;/build&gt;&lt;/project&gt;</code></pre><p>注意starter用的是spring官方推荐的spring-cloud-starter-eureka，现在工程目录下执行命令mvn dependency:tree看依赖关系，如下图红框所示，spring-cloud-netflix-eureka-client被spring-cloud-starter-eureka间接依赖了：<br><img src="https://img-blog.csdn.net/20180915181831557?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JvbGluZ19jYXZhbHJ5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p><p>之前的疑惑已解开，分析如下： </p><ol><li>由于spring-cloud-starter-eureka的间接依赖，spring-cloud-netflix-eureka-client会出现在classpath中； </li><li>因此spring启动时会扫描到spring-cloud-netflix-eureka-client.jar包中的spring.factories文件； </li><li>如果当前工程使用了EnableDiscoveryClient注解，按照spring.factories中的配置，配置类EurekaDiscoveryClientConfiguration会生效，进而开启服务注册发现功能；</li></ol><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>至此，EnableDiscoveryClient与EnableEurekaClient的区别我们已经全部弄明白了，在这里小结一下吧：</p><p>在Spring Cloud的Dalston及其之前的版本中： </p><ol><li>从2014年的Spring Cloud 1.0.0.RC1版本开始，官方就推荐使用EnableDiscoveryClient来取代EnableEurekaClient； </li><li>EnableEurekaClient源码中使用了注解EnableDiscoveryClient，因此如果要使用eureka的注册发现服务，两者功能是一样的； </li><li>EnableDiscoveryClient注解在spring.factories配置中通过配置项EurekaDiscoveryClientConfiguration来开启服务注册发现功能；</li></ol><p>在Dalston之后的版本中（不含Dalston）： </p><ol><li>在spring.factories配置中，配置类EurekaDiscoveryClientConfiguration被配置到springboot的自动配置注解中，与EnableDiscoveryClient注解没有关系了,也就是说只要开启了springboot的自动配置，服务注册发现功能就会启用； </li><li>EnableEurekaClient源码中没有使用注解EnableDiscoveryClient，此时EnableEurekaClient已经没用了；</li></ol><p><hr><br>转自： <a href="https://blog.csdn.net/boling_cavalry/article/details/82668480" target="_blank" rel="noopener">https://blog.csdn.net/boling_cavalry/article/details/82668480</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在基于SpringCloud做开发的时候，EnableDiscoveryClient和EnableEurekaClient这两个注解我们并不陌生，今天就来聊聊它们的区别，和网上更早期的类似文章不同的是：本文会聊到Dalston之后的版本中，这两个注解的区别；&lt;br&gt;
    
    </summary>
    
      <category term="java" scheme="http://codewey.com/categories/java/"/>
    
    
      <category term="SpringBoot" scheme="http://codewey.com/tags/SpringBoot/"/>
    
      <category term="java" scheme="http://codewey.com/tags/java/"/>
    
      <category term="SpringCloud" scheme="http://codewey.com/tags/SpringCloud/"/>
    
  </entry>
  
  <entry>
    <title>slf4j比log4j更优秀的一点是可以使用占位符</title>
    <link href="http://codewey.com/post/slf4j&amp;log4j/"/>
    <id>http://codewey.com/post/slf4j&amp;log4j/</id>
    <published>2018-12-14T08:48:13.000Z</published>
    <updated>2019-04-06T09:35:10.000Z</updated>
    
    <content type="html"><![CDATA[<p>对于log4j来说，使用logger.debug()消息的时候，如果需要连接字符串，则很麻烦，需要类似这样：</p><pre><code>private static Logger logger = Logger.getLogger(ExchangeService.class);logger.debug(&quot;你好，我是&quot;+name+&quot;,你好呀&quot;);</code></pre><a id="more"></a>    <p>使用这种方式的时候，要写很多+号和双引号””，但如果使用slf4j的话，就会方便很多：</p><pre><code>protected Logger logger = LoggerFactory.getLogger(getClass());logger.debug(&quot;你好，我是{},你好呀&quot;,name);</code></pre><p>使用{}占位，然后再将参数紧跟在,后面，这样就省去了很多+号和双引号””。</p><p>我很喜欢slf4j的这个优点，那么在写单纯的Java字符串时，除了使用+号，stringbuffer将字符串拼接起来，还有其它便捷的方法可以利用吗，尤其是没有类似slf4j占位符的方法？</p><p>答案当然是有的：</p><pre><code>String.format(&quot;%s过大，不超过%sM&quot;, msg, size)</code></pre><p>String的format方法可以做到。</p><p>转自：<a href="https://blog.csdn.net/qing_gee/article/details/79396800" target="_blank" rel="noopener">https://blog.csdn.net/qing_gee/article/details/79396800</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;对于log4j来说，使用logger.debug()消息的时候，如果需要连接字符串，则很麻烦，需要类似这样：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;private static Logger logger = Logger.getLogger(ExchangeService.class);
logger.debug(&amp;quot;你好，我是&amp;quot;+name+&amp;quot;,你好呀&amp;quot;);
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
      <category term="java" scheme="http://codewey.com/categories/java/"/>
    
    
      <category term="java" scheme="http://codewey.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>Quartz使用总结。---在某一个有规律的时间点干某件事。</title>
    <link href="http://codewey.com/post/quartz-sometime-todo/"/>
    <id>http://codewey.com/post/quartz-sometime-todo/</id>
    <published>2018-12-13T07:04:24.000Z</published>
    <updated>2019-04-07T09:56:49.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="废话的前言"><a href="#废话的前言" class="headerlink" title="废话的前言"></a>废话的前言</h2><p>以前凭借年轻，凡事都靠脑记。现在工作几年后发现，很多以前看过、用过的东西，再次拿起的时候总觉得记不牢靠。”好记性不如烂笔头”应该是某位上了年纪的大叔的切肤之痛（仅次于上了年纪的难言之瘾）。</p><a id="more"></a><p></p><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">我觉得这事得怪怪中国的应试教育，中国的考试方式就是要求把脑袋当数据库，以前中学那点知识，确实还能装得下。但现在所需的知识量再一次性装入大脑，就是内存溢出的节奏。另，再相信什么人脑只开发5%的蠢话了（「人脑只用了不到 5%」 的说法是否确有科学依据？）。更可行的方式，应该学学数据库，大脑只记忆知识的索引，而把知识的本身定义在外部的存储中（比如笔记）。基于这个理念，现在准备学着写点总结性的笔记。</p><p></p><p></p><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">那为什么不能基于google学习呢？因为google的索引不是你自己，不能精确找到你想要的东西。但它的好处是更海量，能给你原本压根不知道东西。所以，配合使用，疗效更好。</p><p></p><p></p><h2 style="margin:10px 0px; padding:0px; color:rgb(0,0,0); line-height:1.5; font-size:21px"><a name="t2"></a><br><a target="_blank" class="anchor" name="user-content-quartz%E5%8F%AF%E4%BB%A5%E7%94%A8%E6%9D%A5%E5%81%9A%E4%BB%80%E4%B9%88" href="http://www.cnblogs.com/drift-ice/p/3817269.html#quartz%E5%8F%AF%E4%BB%A5%E7%94%A8%E6%9D%A5%E5%81%9A%E4%BB%80%E4%B9%88" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)"></a>Quartz可以用来做什么？</h2><p></p><p></p><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">Quartz是一个任务调度框架。比如你遇到这样的问题</p><p></p><p><ul style="margin:15px 0px 15px 35px; padding:0px; border:0px"></ul></p><p><li style="margin:0px; padding:0px; list-style:disc">想每月25号，信用卡自动还款</li><li style="margin:0px; padding:0px; list-style:disc">想每年4月1日自己给当年暗恋女神发一封匿名贺卡</li><li style="margin:0px; padding:0px; list-style:disc">想每隔1小时，备份一下自己的爱情动作片 学习笔记到云盘</li></p><p></p><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">这些问题总结起来就是：在某一个有规律的时间点干某件事。并且时间的触发的条件可以非常复杂（比如每月最后一个工作日的17:50），复杂到需要一个专门的框架来干这个事。 Quartz就是来干这样的事，你给它一个触发条件的定义，它负责到了时间点，触发相应的Job起来干活。</p><p></p><p></p><h2 style="margin:10px 0px; padding:0px; color:rgb(0,0,0); line-height:1.5; font-size:21px"><a name="t3"></a><br><a target="_blank" class="anchor" name="user-content-%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E7%A4%BA%E4%BE%8B" href="http://www.cnblogs.com/drift-ice/p/3817269.html#%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E7%A4%BA%E4%BE%8B" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)"></a>一个简单的示例</h2><p></p><p></p><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">这里面的所有例子都是基于Quartz 2.2.1</p><p></p><div class="highlight highlight-java" style="margin:0px 0px 15px; padding:0px; border:1px solid rgb(221,221,221); background:rgb(248,248,248)"><br><pre style="margin-top:15px; margin-bottom:15px; padding:0px; white-space:pre-wrap; word-wrap:break-word; border:0px; font-family:Consolas,&quot;Liberation Mono&quot;,Courier,monospace; font-size:12px"><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">package</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">com</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">test</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">quartz</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">;</span><br><br><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">import</span> <span class="nn" style="margin:0px; padding:0px; line-height:1.8; color:rgb(85,85,85)">static</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">org</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">quartz</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">DateBuilder</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">newDate</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">;</span><br><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">import</span> <span class="nn" style="margin:0px; padding:0px; line-height:1.8; color:rgb(85,85,85)">static</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">org</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">quartz</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">JobBuilder</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">newJob</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">;</span><br><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">import</span> <span class="nn" style="margin:0px; padding:0px; line-height:1.8; color:rgb(85,85,85)">static</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">org</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">quartz</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">SimpleScheduleBuilder</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">simpleSchedule</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">;</span><br><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">import</span> <span class="nn" style="margin:0px; padding:0px; line-height:1.8; color:rgb(85,85,85)">static</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">org</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">quartz</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">TriggerBuilder</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">newTrigger</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">;</span><br><br><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">import</span> <span class="nn" style="margin:0px; padding:0px; line-height:1.8; color:rgb(85,85,85)">java.util.GregorianCalendar</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">;</span><br><br><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">import</span> <span class="nn" style="margin:0px; padding:0px; line-height:1.8; color:rgb(85,85,85)">org.quartz.JobDetail</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">;</span><br><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">import</span> <span class="nn" style="margin:0px; padding:0px; line-height:1.8; color:rgb(85,85,85)">org.quartz.Scheduler</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">;</span><br><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">import</span> <span class="nn" style="margin:0px; padding:0px; line-height:1.8; color:rgb(85,85,85)">org.quartz.Trigger</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">;</span><br><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">import</span> <span class="nn" style="margin:0px; padding:0px; line-height:1.8; color:rgb(85,85,85)">org.quartz.impl.StdSchedulerFactory</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">;</span><br><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">import</span> <span class="nn" style="margin:0px; padding:0px; line-height:1.8; color:rgb(85,85,85)">org.quartz.impl.calendar.AnnualCalendar</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">;</span><br><br><span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">public</span> <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">class</span> <span class="nc" style="margin:0px; padding:0px; line-height:1.8; color:rgb(68,85,136); font-weight:bold">QuartzTest</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">{</span><br><br>    <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">public</span> <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">static</span> <span class="kt" style="margin:0px; padding:0px; line-height:1.8; color:rgb(68,85,136); font-weight:bold">void</span> <span class="nf" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,0,0); font-weight:bold">main</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">String</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">[]</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">args</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">{</span><br>        <span class="k" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">try</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">{</span><br>            <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//创建scheduler</span><br>            <span class="n" style="margin:0px; padding:0px; line-height:1.8">Scheduler</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">scheduler</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">=</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">StdSchedulerFactory</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">getDefaultScheduler</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br><br>            <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//定义一个Trigger</span><br>            <span class="n" style="margin:0px; padding:0px; line-height:1.8">Trigger</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">trigger</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">=</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">newTrigger</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">().</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">withIdentity</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“trigger1”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“group1”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//定义name/group</span><br>                <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">startNow</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">()</span><span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//一旦加入scheduler，立即生效</span><br>                <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">withSchedule</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">simpleSchedule</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">()</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//使用SimpleTrigger</span><br>                    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">withIntervalInSeconds</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">1</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//每隔一秒执行一次</span><br>                    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">repeatForever</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">())</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//一直执行，奔腾到老不停歇</span><br>                <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">build</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br><br>            <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//定义一个JobDetail</span><br>            <span class="n" style="margin:0px; padding:0px; line-height:1.8">JobDetail</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">job</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">=</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">newJob</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">HelloQuartz</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">class</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//定义Job类为HelloQuartz类，这是真正的执行逻辑所在</span><br>                <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">withIdentity</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“job1”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“group1”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//定义name/group</span><br>                <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">usingJobData</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“name”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“quartz”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//定义属性</span><br>                <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">build</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br><br>            <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//加入这个调度</span><br>            <span class="n" style="margin:0px; padding:0px; line-height:1.8">scheduler</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">scheduleJob</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">job</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">trigger</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">);</span><br><br>            <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//启动之</span><br>            <span class="n" style="margin:0px; padding:0px; line-height:1.8">scheduler</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">start</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br><br>            <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//运行一段时间后关闭</span><br>            <span class="n" style="margin:0px; padding:0px; line-height:1.8">Thread</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">sleep</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">10000</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">);</span><br>            <span class="n" style="margin:0px; padding:0px; line-height:1.8">scheduler</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">shutdown</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="kc" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">true</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">);</span><br>        <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">}</span> <span class="k" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">catch</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">Exception</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">e</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">{</span><br>            <span class="n" style="margin:0px; padding:0px; line-height:1.8">e</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">printStackTrace</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br>        <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">}</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">}</span><br><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">}</span><br></pre><br></div><br><div class="highlight highlight-java" style="margin:0px 0px 15px; padding:0px; border:1px solid rgb(221,221,221); background:rgb(248,248,248)"><br><pre style="margin-top:15px; margin-bottom:15px; padding:0px; white-space:pre-wrap; word-wrap:break-word; border:0px; font-family:Consolas,&quot;Liberation Mono&quot;,Courier,monospace; font-size:12px"><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">package</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">com</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">test</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">quartz</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">;</span><br><br><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">import</span> <span class="nn" style="margin:0px; padding:0px; line-height:1.8; color:rgb(85,85,85)">java.util.Date</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">;</span><br><br><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">import</span> <span class="nn" style="margin:0px; padding:0px; line-height:1.8; color:rgb(85,85,85)">org.quartz.DisallowConcurrentExecution</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">;</span><br><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">import</span> <span class="nn" style="margin:0px; padding:0px; line-height:1.8; color:rgb(85,85,85)">org.quartz.Job</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">;</span><br><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">import</span> <span class="nn" style="margin:0px; padding:0px; line-height:1.8; color:rgb(85,85,85)">org.quartz.JobDetail</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">;</span><br><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">import</span> <span class="nn" style="margin:0px; padding:0px; line-height:1.8; color:rgb(85,85,85)">org.quartz.JobExecutionContext</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">;</span><br><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">import</span> <span class="nn" style="margin:0px; padding:0px; line-height:1.8; color:rgb(85,85,85)">org.quartz.JobExecutionException</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">;</span><br><br><span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">public</span> <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">class</span> <span class="nc" style="margin:0px; padding:0px; line-height:1.8; color:rgb(68,85,136); font-weight:bold">HelloQuartz</span> <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">implements</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">Job</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">{</span><br>    <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">public</span> <span class="kt" style="margin:0px; padding:0px; line-height:1.8; color:rgb(68,85,136); font-weight:bold">void</span> <span class="nf" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,0,0); font-weight:bold">execute</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">JobExecutionContext</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">context</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">throws</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">JobExecutionException</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">{</span><br>        <span class="n" style="margin:0px; padding:0px; line-height:1.8">JobDetail</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">detail</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">=</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">context</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">getJobDetail</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br>        <span class="n" style="margin:0px; padding:0px; line-height:1.8">String</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">name</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">=</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">detail</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">getJobDataMap</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">().</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">getString</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“name”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">);</span><br>        <span class="n" style="margin:0px; padding:0px; line-height:1.8">System</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">out</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">println</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“say hello to “</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">+</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">name</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">+</span> <span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“ at “</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">+</span> <span class="k" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">new</span> <span class="nf" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,0,0); font-weight:bold">Date</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">());</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">}</span><br><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">}</span><br></pre><br></div><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">这个例子很好的覆盖了Quartz最重要的3个基本要素：</p><br><ul style="margin:15px 0px 15px 35px; padding:0px; border:0px"><br><li style="margin:0px; padding:0px; list-style:disc">Scheduler：调度器。所有的调度都是由它控制。</li><li style="margin:0px; padding:0px; list-style:disc">Trigger： 定义触发的条件。例子中，它的类型是SimpleTrigger，每隔1秒中执行一次（什么是SimpleTrigger下面会有详述）。</li><li style="margin:0px; padding:0px; list-style:disc">JobDetail &amp; Job： JobDetail 定义的是任务数据，而真正的执行逻辑是在Job中，例子中是HelloQuartz。 为什么设计成JobDetail + Job，不直接使用Job？这是因为任务是有可能并发执行，如果Scheduler直接使用Job，就会存在对同一个Job实例并发访问的问题。而JobDetail &amp; Job 方式，sheduler每次执行，都会根据JobDetail创建一个新的Job实例，这样就可以规避并发访问的问题。</li></ul><br><h3 style="margin:10px 0px; padding:0px; color:rgb(0,0,0); font-size:16px; line-height:1.5"><a name="t4"></a><br><a target="_blank" class="anchor" name="user-content-quartz-api" href="http://www.cnblogs.com/drift-ice/p/3817269.html#quartz-api" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)"></a>Quartz API</h3><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">Quartz的API的风格在2.x以后，采用的是DSL风格（通常意味着fluent interface风格），就是示例中newTrigger()那一段东西。它是通过Builder实现的，就是以下几个。（<strong> 下面大部分代码都要引用这些Builder </strong> )</p><br><div class="highlight highlight-java" style="margin:0px 0px 15px; padding:0px; border:1px solid rgb(221,221,221); background:rgb(248,248,248)"><br><pre style="margin-top:15px; margin-bottom:15px; padding:0px; white-space:pre-wrap; word-wrap:break-word; border:0px; font-family:Consolas,&quot;Liberation Mono&quot;,Courier,monospace; font-size:12px"><span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//job相关的builder</span><br><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">import</span> <span class="nn" style="margin:0px; padding:0px; line-height:1.8; color:rgb(85,85,85)">static</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">org</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">quartz</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">JobBuilder</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.<em>;</em></span><br><br><span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//trigger相关的builder</span><br><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">import</span> <span class="nn" style="margin:0px; padding:0px; line-height:1.8; color:rgb(85,85,85)">static</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">org</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">quartz</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">TriggerBuilder</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.;</span><br><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">import</span> <span class="nn" style="margin:0px; padding:0px; line-height:1.8; color:rgb(85,85,85)">static</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">org</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">quartz</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">SimpleScheduleBuilder</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.<em>;</em></span><br><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">import</span> <span class="nn" style="margin:0px; padding:0px; line-height:1.8; color:rgb(85,85,85)">static</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">org</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">quartz</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">CronScheduleBuilder</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.;</span><br><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">import</span> <span class="nn" style="margin:0px; padding:0px; line-height:1.8; color:rgb(85,85,85)">static</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">org</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">quartz</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">DailyTimeIntervalScheduleBuilder</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.<em>;</em></span><br><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">import</span> <span class="nn" style="margin:0px; padding:0px; line-height:1.8; color:rgb(85,85,85)">static</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">org</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">quartz</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">CalendarIntervalScheduleBuilder</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.;</span><br><br><span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//日期相关的builder</span><br><span class="kn" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">import</span> <span class="nn" style="margin:0px; padding:0px; line-height:1.8; color:rgb(85,85,85)">static</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">org</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">quartz</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">DateBuilder</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.<em>;</em></span><br></pre><br></div><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">DSL风格写起来会更加连贯，畅快，而且由于不是使用setter的风格，语义上会更容易理解一些。对比一下：</p><br><div class="highlight highlight-java" style="margin:0px 0px 15px; padding:0px; border:1px solid rgb(221,221,221); background:rgb(248,248,248)"><br><pre style="margin-top:15px; margin-bottom:15px; padding:0px; white-space:pre-wrap; word-wrap:break-word; border:0px; font-family:Consolas,&quot;Liberation Mono&quot;,Courier,monospace; font-size:12px"><span class="n" style="margin:0px; padding:0px; line-height:1.8">JobDetail</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">jobDetail</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">=</span><span class="k" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">new</span> <span class="nf" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,0,0); font-weight:bold">JobDetailImpl</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“jobDetail1”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“group1”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">HelloQuartz</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">class</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">);</span><br><span class="n" style="margin:0px; padding:0px; line-height:1.8">jobDetail</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">getJobDataMap</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">().</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">put</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“name”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“quartz”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">);</span><br><br><span class="n" style="margin:0px; padding:0px; line-height:1.8">SimpleTriggerImpl</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">trigger</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">=</span><span class="k" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">new</span> <span class="nf" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,0,0); font-weight:bold">SimpleTriggerImpl</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“trigger1”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“group1”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">);</span><br><span class="n" style="margin:0px; padding:0px; line-height:1.8">trigger</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">setStartTime</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="k" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">new</span> <span class="nf" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,0,0); font-weight:bold">Date</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">());</span><br><span class="n" style="margin:0px; padding:0px; line-height:1.8">trigger</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">setRepeatInterval</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">1</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">);</span><br><span class="n" style="margin:0px; padding:0px; line-height:1.8">trigger</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">setRepeatCount</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(-</span><span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">1</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">);</span><br></pre><br></div><br><h3 style="margin:10px 0px; padding:0px; color:rgb(0,0,0); font-size:16px; line-height:1.5"><a name="t5"></a><br><a target="_blank" class="anchor" name="user-content-%E5%85%B3%E4%BA%8Ename%E5%92%8Cgroup" href="http://www.cnblogs.com/drift-ice/p/3817269.html#%E5%85%B3%E4%BA%8Ename%E5%92%8Cgroup" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)"></a>关于name和group</h3><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">JobDetail和Trigger都有name和group。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">name是它们在这个sheduler里面的唯一标识。如果我们要更新一个JobDetail定义，只需要设置一个name相同的JobDetail实例即可。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">group是一个组织单元，sheduler会提供一些对整组操作的API，比如 scheduler.resumeJobs()。</p><br><h2 style="margin:10px 0px; padding:0px; color:rgb(0,0,0); line-height:1.5; font-size:21px"><a name="t6"></a><br><a target="_blank" class="anchor" name="user-content-trigger" href="http://www.cnblogs.com/drift-ice/p/3817269.html#trigger" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)"></a>Trigger</h2><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">在开始详解每一种Trigger之前，需要先了解一下Trigger的一些共性。</p><br><h3 style="margin:10px 0px; padding:0px; color:rgb(0,0,0); font-size:16px; line-height:1.5"><a name="t7"></a><br><a target="_blank" class="anchor" name="user-content-starttime--endtime" href="http://www.cnblogs.com/drift-ice/p/3817269.html#starttime--endtime" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)"></a>StartTime<br> &amp; EndTime</h3><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">startTime和endTime指定的Trigger会被触发的时间区间。在这个区间之外，Trigger是不会被触发的。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px"><strong> 所有Trigger都会包含这两个属性 </strong></p><br><h3 style="margin:10px 0px; padding:0px; color:rgb(0,0,0); font-size:16px; line-height:1.5"><a name="t8"></a><br><a target="_blank" class="anchor" name="user-content-%E4%BC%98%E5%85%88%E7%BA%A7priority" href="http://www.cnblogs.com/drift-ice/p/3817269.html#%E4%BC%98%E5%85%88%E7%BA%A7priority" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)"></a>优先级（Priority）</h3><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">当scheduler比较繁忙的时候，可能在同一个时刻，有多个Trigger被触发了，但资源不足（比如线程池不足）。那么这个时候比剪刀石头布更好的方式，就是设置优先级。优先级高的先执行。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">需要注意的是，优先级只有在同一时刻执行的Trigger之间才会起作用，如果一个Trigger是9:00，另一个Trigger是9:30。那么无论后一个优先级多高，前一个都是先执行。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">优先级的值默认是5，当为负数时使用默认值。最大值似乎没有指定，但建议遵循Java的标准，使用1-10，不然鬼才知道看到【优先级为10】是时，上头还有没有更大的值。</p><br><h3 style="margin:10px 0px; padding:0px; color:rgb(0,0,0); font-size:16px; line-height:1.5"><a name="t9"></a><br><a target="_blank" class="anchor" name="user-content-misfire%E9%94%99%E5%A4%B1%E8%A7%A6%E5%8F%91%E7%AD%96%E7%95%A5" href="http://www.cnblogs.com/drift-ice/p/3817269.html#misfire%E9%94%99%E5%A4%B1%E8%A7%A6%E5%8F%91%E7%AD%96%E7%95%A5" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)"></a>Misfire(错失触发）策略</h3><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">类似的Scheduler资源不足的时候，或者机器崩溃重启等，有可能某一些Trigger在应该触发的时间点没有被触发，也就是Miss Fire了。这个时候Trigger需要一个策略来处理这种情况。每种Trigger可选的策略各不相同。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">这里有两个点需要重点注意：</p><br><ul style="margin:15px 0px 15px 35px; padding:0px; border:0px"><br><li style="margin:0px; padding:0px; list-style:disc">MisFire的触发是有一个阀值，这个阀值是配置在JobStore的。比RAMJobStore是org.quartz.jobStore.misfireThreshold。只有超过这个阀值，才会算MisFire。小于这个阀值，Quartz是会全部重新触发。</li></ul><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">所有MisFire的策略实际上都是解答两个问题：</p><br><ol style="margin:15px 0px; padding:0px 0px 0px 40px; border:0px"><br><li style="margin:0px; padding:0px; list-style:decimal">已经MisFire的任务还要重新触发吗？</li><li style="margin:0px; padding:0px; list-style:decimal">如果发生MisFire，要调整现有的调度时间吗？</li></ol><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">比如SimpleTrigger的MisFire策略有：</p><br><ul style="margin:15px 0px 15px 35px; padding:0px; border:0px"><br><li style="margin:0px; padding:0px; list-style:disc"><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">MISFIRE_INSTRUCTION_IGNORE_MISFIRE_POLICY</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">这个不是忽略已经错失的触发的意思，而是说忽略MisFire策略。它会在资源合适的时候，重新触发所有的MisFire任务，并且不会影响现有的调度时间。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">比如，SimpleTrigger每15秒执行一次，而中间有5分钟时间它都MisFire了，一共错失了20个，5分钟后，假设资源充足了，并且任务允许并发，它会被一次性触发。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">这个属性是所有Trigger都适用。</p><br></li><li style="margin:0px; padding:0px; list-style:disc"><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">MISFIRE_INSTRUCTION_FIRE_NOW</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">忽略已经MisFire的任务，并且立即执行调度。这通常只适用于只执行一次的任务。</p><br></li><li style="margin:0px; padding:0px; list-style:disc"><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">MISFIRE_INSTRUCTION_RESCHEDULE_NOW_WITH_EXISTING_REPEAT_COUNT</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">将startTime设置当前时间，立即重新调度任务，包括的MisFire的</p><br></li><li style="margin:0px; padding:0px; list-style:disc"><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">MISFIRE_INSTRUCTION_RESCHEDULE_NOW_WITH_REMAINING_REPEAT_COUNT</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">类似MISFIRE_INSTRUCTION_RESCHEDULE_NOW_WITH_EXISTING_REPEAT_COUNT，区别在于会忽略已经MisFire的任务</p><br></li><li style="margin:0px; padding:0px; list-style:disc"><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">MISFIRE_INSTRUCTION_RESCHEDULE_NEXT_WITH_EXISTING_COUNT</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">在下一次调度时间点，重新开始调度任务，包括的MisFire的</p><br></li><li style="margin:0px; padding:0px; list-style:disc"><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">MISFIRE_INSTRUCTION_RESCHEDULE_NEXT_WITH_REMAINING_COUNT</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">类似于MISFIRE_INSTRUCTION_RESCHEDULE_NEXT_WITH_EXISTING_COUNT，区别在于会忽略已经MisFire的任务。</p><br></li><li style="margin:0px; padding:0px; list-style:disc"><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">MISFIRE_INSTRUCTION_SMART_POLICY</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">所有的Trigger的MisFire默认值都是这个，大致意思是“把处理逻辑交给聪明的Quartz去决定”。基本策略是，</p><br><ol style="margin:15px 0px; padding:0px 0px 0px 40px; border:0px"><br><li style="margin:0px; padding:0px; list-style:disc">如果是只执行一次的调度，使用MISFIRE_INSTRUCTION_FIRE_NOW</li><li style="margin:0px; padding:0px; list-style:disc">如果是无限次的调度(repeatCount是无限的)，使用MISFIRE_INSTRUCTION_RESCHEDULE_NEXT_WITH_REMAINING_COUNT</li><li style="margin:0px; padding:0px; list-style:disc">否则，使用MISFIRE_INSTRUCTION_RESCHEDULE_NOW_WITH_EXISTING_REPEAT_COUNT</li></ol><br></li></ul><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">MisFire的东西挺繁杂的，可以参考<a target="_blank" href="http://java.dzone.com/articles/quartz-scheduler-misfire" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)">这篇</a></p><br><h3 style="margin:10px 0px; padding:0px; color:rgb(0,0,0); font-size:16px; line-height:1.5"><a name="t10"></a><br><a target="_blank" class="anchor" name="user-content-calendar" href="http://www.cnblogs.com/drift-ice/p/3817269.html#calendar" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)"></a>Calendar</h3><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">这里的Calendar不是jdk的java.util.Calendar，不是为了计算日期的。它的作用是在于补充Trigger的时间。可以排除或加入某一些特定的时间点。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">以”每月25日零点自动还卡债“为例，我们想排除掉每年的2月25号零点这个时间点（因为有2.14，所以2月一定会破产）。这个时间，就可以用Calendar来实现。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">例子：</p><br><div class="highlight highlight-java" style="margin:0px 0px 15px; padding:0px; border:1px solid rgb(221,221,221); background:rgb(248,248,248)"><br><pre style="margin-top:15px; margin-bottom:15px; padding:0px; white-space:pre-wrap; word-wrap:break-word; border:0px; font-family:Consolas,&quot;Liberation Mono&quot;,Courier,monospace; font-size:12px"><span class="n" style="margin:0px; padding:0px; line-height:1.8">AnnualCalendar</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">cal</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">=</span> <span class="k" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">new</span> <span class="nf" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,0,0); font-weight:bold">AnnualCalendar</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//定义一个每年执行Calendar，精度为天，即不能定义到2.25号下午2:00</span><br><span class="n" style="margin:0px; padding:0px; line-height:1.8">java</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">util</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">Calendar</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">excludeDay</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">=</span> <span class="k" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">new</span> <span class="nf" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,0,0); font-weight:bold">GregorianCalendar</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br><span class="n" style="margin:0px; padding:0px; line-height:1.8">excludeDay</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">setTime</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">newDate</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">().</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">inMonthOnDay</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">2</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">25</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">).</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">build</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">());</span><br><span class="n" style="margin:0px; padding:0px; line-height:1.8">cal</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">setDayExcluded</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">excludeDay</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="kc" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">true</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">);</span>  <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//设置排除2.25这个日期</span><br><span class="n" style="margin:0px; padding:0px; line-height:1.8">scheduler</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">addCalendar</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“FebCal”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">cal</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="kc" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">false</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="kc" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">false</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">);</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//scheduler加入这个Calendar</span><br><br><span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//定义一个Trigger</span><br><span class="n" style="margin:0px; padding:0px; line-height:1.8">Trigger</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">trigger</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">=</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">newTrigger</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">().</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">withIdentity</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“trigger1”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“group1”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">startNow</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">()</span><span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//一旦加入scheduler，立即生效</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">modifiedByCalendar</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“FebCal”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//使用Calendar !!</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">withSchedule</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">simpleSchedule</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">()</span><br>        <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">withIntervalInSeconds</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">1</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span><br>        <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">repeatForever</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">())</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">build</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br></pre><br></div><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">Quartz体贴地为我们提供以下几种Calendar，注意，所有的Calendar既可以是排除，也可以是包含，取决于：</p><br><ul style="margin:15px 0px 15px 35px; padding:0px; border:0px"><br><li style="margin:0px; padding:0px; list-style:disc">HolidayCalendar。指定特定的日期，比如20140613。精度到天。</li><li style="margin:0px; padding:0px; list-style:disc">DailyCalendar。指定每天的时间段（rangeStartingTime, rangeEndingTime)，格式是HH:MM[:SS[:mmm]]。也就是最大精度可以到毫秒。</li><li style="margin:0px; padding:0px; list-style:disc">WeeklyCalendar。指定每星期的星期几，可选值比如为java.util.Calendar.SUNDAY。精度是天。</li><li style="margin:0px; padding:0px; list-style:disc">MonthlyCalendar。指定每月的几号。可选值为1-31。精度是天</li><li style="margin:0px; padding:0px; list-style:disc">AnnualCalendar。 指定每年的哪一天。使用方式如上例。精度是天。</li><li style="margin:0px; padding:0px; list-style:disc">CronCalendar。指定Cron表达式。精度取决于Cron表达式，也就是最大精度可以到秒。</li></ul><br><h2 style="margin:10px 0px; padding:0px; color:rgb(0,0,0); line-height:1.5; font-size:21px"><a name="t11"></a><br><a target="_blank" class="anchor" name="user-content-trigger%E5%AE%9E%E7%8E%B0%E7%B1%BB" href="http://www.cnblogs.com/drift-ice/p/3817269.html#trigger%E5%AE%9E%E7%8E%B0%E7%B1%BB" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)"></a>Trigger实现类</h2><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">Quartz有以下几种Trigger实现:</p><br><h3 style="margin:10px 0px; padding:0px; color:rgb(0,0,0); font-size:16px; line-height:1.5"><a name="t12"></a><br><a target="_blank" class="anchor" name="user-content-simpletrigger" href="http://www.cnblogs.com/drift-ice/p/3817269.html#simpletrigger" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)"></a>SimpleTrigger</h3><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">指定从某一个时间开始，以一定的时间间隔（单位是毫秒）执行的任务。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">它适合的任务类似于：9:00 开始，每隔1小时，执行一次。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">它的属性有：</p><br><ul style="margin:15px 0px 15px 35px; padding:0px; border:0px"><br><li style="margin:0px; padding:0px; list-style:disc">repeatInterval 重复间隔</li><li style="margin:0px; padding:0px; list-style:disc">repeatCount 重复次数。实际执行次数是 repeatCount+1。因为在startTime的时候一定会执行一次。<strong> 下面有关repeatCount 属性的都是同理。　</strong></li></ul><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">例子：</p><br><div class="highlight highlight-java" style="margin:0px 0px 15px; padding:0px; border:1px solid rgb(221,221,221); background:rgb(248,248,248)"><br><pre style="margin-top:15px; margin-bottom:15px; padding:0px; white-space:pre-wrap; word-wrap:break-word; border:0px; font-family:Consolas,&quot;Liberation Mono&quot;,Courier,monospace; font-size:12px"><span class="n" style="margin:0px; padding:0px; line-height:1.8">simpleSchedule</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">()</span><br>        <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">withIntervalInHours</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">1</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//每小时执行一次</span><br>        <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">repeatForever</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">()</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//次数不限</span><br>        <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">build</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br><br><span class="n" style="margin:0px; padding:0px; line-height:1.8">simpleSchedule</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">()</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">withIntervalInMinutes</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">1</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//每分钟执行一次</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">withRepeatCount</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">10</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//次数为10次</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">build</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br></pre><br></div><br><h3 style="margin:10px 0px; padding:0px; color:rgb(0,0,0); font-size:16px; line-height:1.5"><a name="t13"></a><br><a target="_blank" class="anchor" name="user-content-calendarintervaltrigger" href="http://www.cnblogs.com/drift-ice/p/3817269.html#calendarintervaltrigger" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)"></a>CalendarIntervalTrigger</h3><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">类似于SimpleTrigger，指定从某一个时间开始，以一定的时间间隔执行的任务。 但是不同的是SimpleTrigger指定的时间间隔为<span style="margin:0px; padding:0px">毫秒</span>，没办法指定每隔一个月执行一次（每月的时间间隔不是固定值），而CalendarIntervalTrigger支持的间隔单位有<span style="margin:0px; padding:0px">秒，分钟，小时，天，月，年，星期</span>。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">相较于SimpleTrigger有两个优势：1、更方便，比如每隔1小时执行，你不用自己去计算1小时等于多少毫秒。 2、支持不是固定长度的间隔，比如间隔为月和年。但劣势是精度只能到秒。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">它适合的任务类似于：9:00 开始执行，并且以后每周 9:00 执行一次</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">它的属性有:</p><br><ul style="margin:15px 0px 15px 35px; padding:0px; border:0px"><br><li style="margin:0px; padding:0px; list-style:disc">interval 执行间隔</li><li style="margin:0px; padding:0px; list-style:disc">intervalUnit 执行间隔的单位（秒，分钟，小时，天，月，年，星期）</li></ul><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">例子:</p><br><div class="highlight highlight-java" style="margin:0px 0px 15px; padding:0px; border:1px solid rgb(221,221,221); background:rgb(248,248,248)"><br><pre style="margin-top:15px; margin-bottom:15px; padding:0px; white-space:pre-wrap; word-wrap:break-word; border:0px; font-family:Consolas,&quot;Liberation Mono&quot;,Courier,monospace; font-size:12px"><span class="n" style="margin:0px; padding:0px; line-height:1.8">calendarIntervalSchedule</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">()</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">withIntervalInDays</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">1</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//每天执行一次</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">build</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br><br><span class="n" style="margin:0px; padding:0px; line-height:1.8">calendarIntervalSchedule</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">()</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">withIntervalInWeeks</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">1</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//每周执行一次</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">build</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br></pre><br></div><br><h3 style="margin:10px 0px; padding:0px; color:rgb(0,0,0); font-size:16px; line-height:1.5"><a name="t14"></a><br><a target="_blank" class="anchor" name="user-content-dailytimeintervaltrigger" href="http://www.cnblogs.com/drift-ice/p/3817269.html#dailytimeintervaltrigger" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)"></a>DailyTimeIntervalTrigger</h3><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">指定每天的某个时间段内，以一定的时间间隔执行任务。并且它可以支持指定星期。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">它适合的任务类似于：指定每天9:00 至 18:00 ，每隔70秒执行一次，并且只要周一至周五执行。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">它的属性有:</p><br><ul style="margin:15px 0px 15px 35px; padding:0px; border:0px"><br><li style="margin:0px; padding:0px; list-style:disc">startTimeOfDay 每天开始时间</li><li style="margin:0px; padding:0px; list-style:disc">endTimeOfDay 每天结束时间</li><li style="margin:0px; padding:0px; list-style:disc">daysOfWeek 需要执行的星期</li><li style="margin:0px; padding:0px; list-style:disc">interval 执行间隔</li><li style="margin:0px; padding:0px; list-style:disc">intervalUnit 执行间隔的单位（秒，分钟，小时，天，月，年，星期）</li><li style="margin:0px; padding:0px; list-style:disc">repeatCount 重复次数</li></ul><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">例子:</p><br><div class="highlight highlight-java" style="margin:0px 0px 15px; padding:0px; border:1px solid rgb(221,221,221); background:rgb(248,248,248)"><br><pre style="margin-top:15px; margin-bottom:15px; padding:0px; white-space:pre-wrap; word-wrap:break-word; border:0px; font-family:Consolas,&quot;Liberation Mono&quot;,Courier,monospace; font-size:12px"><span class="n" style="margin:0px; padding:0px; line-height:1.8">dailyTimeIntervalSchedule</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">()</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">startingDailyAt</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">TimeOfDay</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">hourAndMinuteOfDay</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">9</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">0</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">))</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//第天9：00开始</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">endingDailyAt</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">TimeOfDay</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">hourAndMinuteOfDay</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">16</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">0</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">))</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//16：00 结束 </span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">onDaysOfTheWeek</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">MONDAY</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">TUESDAY</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">WEDNESDAY</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">THURSDAY</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">FRIDAY</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//周一至周五执行</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">withIntervalInHours</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">1</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//每间隔1小时执行一次</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">withRepeatCount</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">100</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//最多重复100次（实际执行100+1次）</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">build</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br><br><span class="n" style="margin:0px; padding:0px; line-height:1.8">dailyTimeIntervalSchedule</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">()</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">startingDailyAt</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">TimeOfDay</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">hourAndMinuteOfDay</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">9</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">0</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">))</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//第天9：00开始</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">endingDailyAfterCount</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">10</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//每天执行10次，这个方法实际上根据 startTimeOfDay+intervalcount 算出 endTimeOfDay</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">onDaysOfTheWeek</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">MONDAY</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">TUESDAY</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">WEDNESDAY</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">THURSDAY</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">FRIDAY</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//周一至周五执行</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">withIntervalInHours</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">1</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//每间隔1小时执行一次</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">build</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br></pre><br></div><br><h3 style="margin:10px 0px; padding:0px; color:rgb(0,0,0); font-size:16px; line-height:1.5"><a name="t15"></a><br><a target="_blank" class="anchor" name="user-content-crontrigger" href="http://www.cnblogs.com/drift-ice/p/3817269.html#crontrigger" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)"></a>CronTrigger</h3><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">适合于更复杂的任务，它支持类型于Linux Cron的语法（并且更强大）。基本上它覆盖了以上三个Trigger的绝大部分能力（但不是全部）—— 当然，也更难理解。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">它适合的任务类似于：每天0:00,9:00,18:00各执行一次。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">它的属性只有:</p><br><ul style="margin:15px 0px 15px 35px; padding:0px; border:0px"><br><li style="margin:0px; padding:0px; list-style:disc">Cron表达式。但这个表示式本身就够复杂了。下面会有说明。</li></ul><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">例子：</p><br><div class="highlight highlight-java" style="margin:0px 0px 15px; padding:0px; border:1px solid rgb(221,221,221); background:rgb(248,248,248)"><br><pre style="margin-top:15px; margin-bottom:15px; padding:0px; white-space:pre-wrap; word-wrap:break-word; border:0px; font-family:Consolas,&quot;Liberation Mono&quot;,Courier,monospace; font-size:12px"><span class="n" style="margin:0px; padding:0px; line-height:1.8">cronSchedule</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“0 0/2 8-17 <em> </em> ?”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">// 每天8:00-17:00，每隔2分钟执行一次</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">build</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br><br><span class="n" style="margin:0px; padding:0px; line-height:1.8">cronSchedule</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“0 30 9 ? <em> MON”</em></span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">// 每周一，9:30执行一次</span><br><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">build</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br><br><span class="n" style="margin:0px; padding:0px; line-height:1.8">weeklyOnDayAndHourAndMinute</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">MONDAY</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span><span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">9</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">30</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//等同于 0 30 9 ?  MON </span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">build</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br></pre><br></div><br><h4 style="margin:10px 0px; padding:0px; color:rgb(0,0,0)"><a target="_blank" class="anchor" name="user-content-cron%E8%A1%A8%E8%BE%BE%E5%BC%8F" href="http://www.cnblogs.com/drift-ice/p/3817269.html#cron%E8%A1%A8%E8%BE%BE%E5%BC%8F" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)"></a>Cron表达式</h4><br><div class="table-box"><table style="margin:15px 0px; padding:0px; border:0px; border-collapse:collapse; word-break:break-word"><br><thead style="margin:0px; padding:0px"><br><tr style="margin:0px; padding:0px"><br><th style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>位置</th><br><th style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>时间域</th><br><th style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>允许值</th><br><th style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>特殊值</th><br></tr><br></thead><br><tbody style="margin:0px; padding:0px"><br><tr style="margin:0px; padding:0px"><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>1</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>秒</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>0-59</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>, - <em> /</em></td><br></tr><br><tr style="margin:0px; padding:0px"><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>2</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>分钟</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>0-59</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>, -  /</td><br></tr><br><tr style="margin:0px; padding:0px"><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>3</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>小时</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>0-23</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>, - <em> /</em></td><br></tr><br><tr style="margin:0px; padding:0px"><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>4</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>日期</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>1-31</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>, -  ? / L W C</td><br></tr><br><tr style="margin:0px; padding:0px"><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>5</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>月份</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>1-12</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>, - <em> /</em></td><br></tr><br><tr style="margin:0px; padding:0px"><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>6</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>星期</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>1-7</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>, -  ? / L C #</td><br></tr><br><tr style="margin:0px; padding:0px"><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>7</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>年份（可选）</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>1-31</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>, - <em> /</em></td><br></tr><br></tbody><br></table></div><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">星号(<span style="margin:0px; padding:0px">)：可用在所有字段中，表示对应时间域的每一个时刻，例如，</span>&nbsp;在分钟字段时，表示“每分钟”；</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">问号（?）：该字符只在日期和星期字段中使用，它通常指定为“无意义的值”，相当于点位符；</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">减号(-)：表达一个范围，如在小时字段中使用“10-12”，则表示从10到12点，即10,11,12；</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">逗号(,)：表达一个列表值，如在星期字段中使用“MON,WED,FRI”，则表示星期一，星期三和星期五；</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">斜杠(/)：x/y表达一个等步长序列，x为起始值，y为增量步长值。如在分钟字段中使用0/15，则表示为0,15,30和45秒，而5/15在分钟字段中表示5,20,35,50，你也可以使用/y，它等同于0/y；</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">L：该字符只在日期和星期字段中使用，代表“Last”的意思，但它在两个字段中意思不同。L在日期字段中，表示这个月份的最后一天，如一月的31号，非闰年二月的28号；如果L用在星期中，则表示星期六，等同于7。但是，如果L出现在星期字段里，而且在前面有一个数值X，则表示“这个月的最后X天”，例如，6L表示该月的最后星期五；</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">W：该字符只能出现在日期字段里，是对前导日期的修饰，表示离该日期最近的工作日。例如15W表示离该月15号最近的工作日，如果该月15号是星期六，则匹配14号星期五；如果15日是星期日，则匹配16号星期一；如果15号是星期二，那结果就是15号星期二。但必须注意关联的匹配日期不能够跨月，如你指定1W，如果1号是星期六，结果匹配的是3号星期一，而非上个月最后的那天。W字符串只能指定单一日期，而不能指定日期范围；</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">LW组合：在日期字段可以组合使用LW，它的意思是当月的最后一个工作日；</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">井号(#)：该字符只能在星期字段中使用，表示当月某个工作日。如6#3表示当月的第三个星期五(6表示星期五，#3表示当前的第三个)，而4#5表示当月的第五个星期三，假设当月没有第五个星期三，忽略不触发；</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">C：该字符只在日期和星期字段中使用，代表“Calendar”的意思。它的意思是计划所关联的日期，如果日期没有被关联，则相当于日历中所有日期。例如5C在日期字段中就相当于日历5日以后的第一天。1C在星期字段中相当于星期日后的第一天。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">Cron表达式对特殊字符的大小写不敏感，对代表星期的缩写英文大小写也不敏感。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">一些例子：</p><br><div class="table-box"><table style="margin:15px 0px; padding:0px; border:0px; border-collapse:collapse; word-break:break-word"><br><thead style="margin:0px; padding:0px"><br><tr style="margin:0px; padding:0px"><br><th style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>表示式</th><br><th style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>说明</th><br></tr><br></thead><br><tbody style="margin:0px; padding:0px"><br><tr style="margin:0px; padding:0px"><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>0 0 12 <em> </em> ?</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>每天12点运行</td><br></tr><br><tr style="margin:0px; padding:0px"><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>0 15 10 ? <em> </em></td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>每天10:15运行</td><br></tr><br><tr style="margin:0px; padding:0px"><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>0 15 10 <em> </em> ?</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>每天10:15运行</td><br></tr><br><tr style="margin:0px; padding:0px"><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>0 15 10 <em> </em> ? <em></em></td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>每天10:15运行</td><br></tr><br><tr style="margin:0px; padding:0px"><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>0 15 10  <em> ? 2008</em></td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>在2008年的每天10：15运行</td><br></tr><br><tr style="margin:0px; padding:0px"><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>0  14 <em> </em> ?</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>每天14点到15点之间每分钟运行一次，开始于14:00，结束于14:59。</td><br></tr><br><tr style="margin:0px; padding:0px"><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>0 0/5 14 <em> </em> ?</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>每天14点到15点每5分钟运行一次，开始于14:00，结束于14:55。</td><br></tr><br><tr style="margin:0px; padding:0px"><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>0 0/5 14,18 <em> </em> ?</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>每天14点到15点每5分钟运行一次，此外每天18点到19点每5钟也运行一次。</td><br></tr><br><tr style="margin:0px; padding:0px"><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>0 0-5 14 <em> </em> ?</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>每天14:00点到14:05，每分钟运行一次。</td><br></tr><br><tr style="margin:0px; padding:0px"><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>0 10,44 14 ? 3 WED</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>3月每周三的14:10分到14:44，每分钟运行一次。</td><br></tr><br><tr style="margin:0px; padding:0px"><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>0 15 10 ? <em> MON-FRI</em></td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>每周一，二，三，四，五的10:15分运行。</td><br></tr><br><tr style="margin:0px; padding:0px"><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>0 15 10 15  ?</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>每月15日10:15分运行。</td><br></tr><br><tr style="margin:0px; padding:0px"><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>0 15 10 L <em> ?</em></td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>每月最后一天10:15分运行。</td><br></tr><br><tr style="margin:0px; padding:0px"><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>0 15 10 ?  6L</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>每月最后一个星期五10:15分运行。</td><br></tr><br><tr style="margin:0px; padding:0px"><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>0 15 10 ? <em> 6L 2007-2009</em></td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>在2007,2008,2009年每个月的最后一个星期五的10:15分运行。</td><br></tr><br><tr style="margin:0px; padding:0px"><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>0 15 10 ?  6#3</td><br><td style="margin:0px; padding:3px; border:1px solid silver; border-collapse:collapse"><br>每月第三个星期五的10:15分运行。</td><br></tr><br></tbody><br></table></div><br><h2 style="margin:10px 0px; padding:0px; color:rgb(0,0,0); line-height:1.5; font-size:21px"><a name="t16"></a><br><a target="_blank" class="anchor" name="user-content-jobdetail--job" href="http://www.cnblogs.com/drift-ice/p/3817269.html#jobdetail--job" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)"></a>JobDetail<br> &amp; Job</h2><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">JobDetail是任务的定义，而Job是任务的执行逻辑。在JobDetail里会引用一个Job Class定义。一个最简单的例子</p><br><div class="highlight highlight-java" style="margin:0px 0px 15px; padding:0px; border:1px solid rgb(221,221,221); background:rgb(248,248,248)"><br><pre style="margin-top:15px; margin-bottom:15px; padding:0px; white-space:pre-wrap; word-wrap:break-word; border:0px; font-family:Consolas,&quot;Liberation Mono&quot;,Courier,monospace; font-size:12px"><span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">public</span> <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">class</span> <span class="nc" style="margin:0px; padding:0px; line-height:1.8; color:rgb(68,85,136); font-weight:bold">JobTest</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">{</span><br>    <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">public</span> <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">static</span> <span class="kt" style="margin:0px; padding:0px; line-height:1.8; color:rgb(68,85,136); font-weight:bold">void</span> <span class="nf" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,0,0); font-weight:bold">main</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">String</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">[]</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">args</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">throws</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">SchedulerException</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">IOException</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">{</span><br>           <span class="n" style="margin:0px; padding:0px; line-height:1.8">JobDetail</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">job</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">=</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">newJob</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">()</span><br>               <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">ofType</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">DoNothingJob</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">class</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//引用Job Class</span><br>               <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">withIdentity</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“job1”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“group1”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//设置name/group</span><br>               <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">withDescription</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“this is a test job”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//设置描述</span><br>               <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">usingJobData</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“age”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">18</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//加入属性到ageJobDataMap</span><br>               <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">build</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br><br>           <span class="n" style="margin:0px; padding:0px; line-height:1.8">job</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">getJobDataMap</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">().</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">put</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“name”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“quertz”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">);</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//加入属性name到JobDataMap</span><br><br>           <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//定义一个每秒执行一次的SimpleTrigger</span><br>           <span class="n" style="margin:0px; padding:0px; line-height:1.8">Trigger</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">trigger</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">=</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">newTrigger</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">()</span><br>                   <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">startNow</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">()</span><br>                   <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">withIdentity</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“trigger1”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span><br>                   <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">withSchedule</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">simpleSchedule</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">()</span><br>                       <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">withIntervalInSeconds</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">1</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span><br>                       <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">repeatForever</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">())</span><br>                   <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">build</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br><br>           <span class="n" style="margin:0px; padding:0px; line-height:1.8">Scheduler</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">sche</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">=</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">StdSchedulerFactory</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">getDefaultScheduler</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br>           <span class="n" style="margin:0px; padding:0px; line-height:1.8">sche</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">scheduleJob</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">job</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">trigger</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">);</span><br><br>           <span class="n" style="margin:0px; padding:0px; line-height:1.8">sche</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">start</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br><br>           <span class="n" style="margin:0px; padding:0px; line-height:1.8">System</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">in</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">read</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br><br>           <span class="n" style="margin:0px; padding:0px; line-height:1.8">sche</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">shutdown</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">}</span><br><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">}</span><br><br><br><span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">public</span> <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">class</span> <span class="nc" style="margin:0px; padding:0px; line-height:1.8; color:rgb(68,85,136); font-weight:bold">DoNothingJob</span> <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">implements</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">Job</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">{</span><br>    <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">public</span> <span class="kt" style="margin:0px; padding:0px; line-height:1.8; color:rgb(68,85,136); font-weight:bold">void</span> <span class="nf" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,0,0); font-weight:bold">execute</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">JobExecutionContext</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">context</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">throws</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">JobExecutionException</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">{</span><br>        <span class="n" style="margin:0px; padding:0px; line-height:1.8">System</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">out</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">println</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“do nothing”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">);</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">}</span><br><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">}</span><br></pre><br></div><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">从上例我们可以看出，要定义一个任务，需要干几件事：</p><br><ol style="margin:15px 0px; padding:0px 0px 0px 40px; border:0px"><br><li style="margin:0px; padding:0px; list-style:decimal">创建一个org.quartz.Job的实现类，并实现实现自己的业务逻辑。比如上面的DoNothingJob。</li><li style="margin:0px; padding:0px; list-style:decimal">定义一个JobDetail，引用这个实现类</li><li style="margin:0px; padding:0px; list-style:decimal">加入scheduleJob</li></ol><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">Quartz调度一次任务，会干如下的事：</p><br><ol style="margin:15px 0px; padding:0px 0px 0px 40px; border:0px"><br><li style="margin:0px; padding:0px; list-style:decimal">JobClass jobClass=JobDetail.getJobClass()</li><li style="margin:0px; padding:0px; list-style:decimal">Job jobInstance=jobClass.newInstance()。所以Job实现类，必须有一个public的无参构建方法。</li><li style="margin:0px; padding:0px; list-style:decimal">jobInstance.execute(JobExecutionContext context)。JobExecutionContext是Job运行的上下文，可以获得Trigger、Scheduler、JobDetail的信息。</li></ol><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">也就是说，每次调度都会创建一个新的Job实例，这样的好处是有些任务并发执行的时候，不存在对临界资源的访问问题——当然，如果需要共享JobDataMap的时候，还是存在临界资源的并发访问的问题。</p><br><h3 style="margin:10px 0px; padding:0px; color:rgb(0,0,0); font-size:16px; line-height:1.5"><a name="t17"></a><br><a target="_blank" class="anchor" name="user-content-jobdatamap" href="http://www.cnblogs.com/drift-ice/p/3817269.html#jobdatamap" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)"></a>JobDataMap</h3><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">Job都次都是newInstance的实例，那我怎么传值给它？ 比如我现在有两个发送邮件的任务，一个是发给”liLei”,一个发给”hanmeimei”,不能说我要写两个Job实现类LiLeiSendEmailJob和HanMeiMeiSendEmailJob。实现的办法是通过JobDataMap。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">每一个JobDetail都会有一个JobDataMap。JobDataMap本质就是一个Map的扩展类，只是提供了一些更便捷的方法，比如getString()之类的。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">我们可以在定义JobDetail，加入属性值，方式有二：</p><br><div class="highlight highlight-java" style="margin:0px 0px 15px; padding:0px; border:1px solid rgb(221,221,221); background:rgb(248,248,248)"><br><pre style="margin-top:15px; margin-bottom:15px; padding:0px; white-space:pre-wrap; word-wrap:break-word; border:0px; font-family:Consolas,&quot;Liberation Mono&quot;,Courier,monospace; font-size:12px"><span class="n" style="margin:0px; padding:0px; line-height:1.8">newJob</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">().</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">usingJobData</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“age”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">18</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//加入属性到ageJobDataMap</span><br><br> <span class="n" style="margin:0px; padding:0px; line-height:1.8">or</span><br><br> <span class="n" style="margin:0px; padding:0px; line-height:1.8">job</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">getJobDataMap</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">().</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">put</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“name”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“quertz”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">);</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//加入属性name到JobDataMap</span><br></pre><br></div><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">然后在Job中可以获取这个JobDataMap的值，方式同样有二：</p><br><div class="highlight highlight-java" style="margin:0px 0px 15px; padding:0px; border:1px solid rgb(221,221,221); background:rgb(248,248,248)"><br><pre style="margin-top:15px; margin-bottom:15px; padding:0px; white-space:pre-wrap; word-wrap:break-word; border:0px; font-family:Consolas,&quot;Liberation Mono&quot;,Courier,monospace; font-size:12px"><span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">public</span> <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">class</span> <span class="nc" style="margin:0px; padding:0px; line-height:1.8; color:rgb(68,85,136); font-weight:bold">HelloQuartz</span> <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">implements</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">Job</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">{</span><br>    <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">private</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">String</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">name</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">;</span><br><br>    <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">public</span> <span class="kt" style="margin:0px; padding:0px; line-height:1.8; color:rgb(68,85,136); font-weight:bold">void</span> <span class="nf" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,0,0); font-weight:bold">execute</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">JobExecutionContext</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">context</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">throws</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">JobExecutionException</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">{</span><br>        <span class="n" style="margin:0px; padding:0px; line-height:1.8">JobDetail</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">detail</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">=</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">context</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">getJobDetail</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span><br>        <span class="n" style="margin:0px; padding:0px; line-height:1.8">JobDataMap</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">map</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">=</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">detail</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">getJobDataMap</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">();</span> <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//方法一：获得JobDataMap</span><br>        <span class="n" style="margin:0px; padding:0px; line-height:1.8">System</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">out</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">println</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“say hello to “</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">+</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">name</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">+</span> <span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“[“</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">+</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">map</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">getInt</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“age”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">+</span> <span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“]”</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">+</span> <span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“ at “</span><br>                           <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">+</span> <span class="k" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">new</span> <span class="nf" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,0,0); font-weight:bold">Date</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">());</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">}</span><br><br>    <span class="c1" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">//方法二：属性的setter方法，会将JobDataMap的属性自动注入</span><br>    <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">public</span> <span class="kt" style="margin:0px; padding:0px; line-height:1.8; color:rgb(68,85,136); font-weight:bold">void</span> <span class="nf" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,0,0); font-weight:bold">setName</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">String</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">name</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">{</span><br>        <span class="k" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">this</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">name</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">=</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">name</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">;</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">}</span><br><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">}</span><br></pre><br></div><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">对于同一个JobDetail实例，执行的多个Job实例，是共享同样的JobDataMap，也就是说，如果你在任务里修改了里面的值，会对其他Job实例（并发的或者后续的）造成影响。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">除了JobDetail，Trigger同样有一个JobDataMap，共享范围是所有使用这个Trigger的Job实例。</p><br><h3 style="margin:10px 0px; padding:0px; color:rgb(0,0,0); font-size:16px; line-height:1.5"><a name="t18"></a><br><a target="_blank" class="anchor" name="user-content-job%E5%B9%B6%E5%8F%91" href="http://www.cnblogs.com/drift-ice/p/3817269.html#job%E5%B9%B6%E5%8F%91" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)"></a>Job并发</h3><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">Job是有可能并发执行的，比如一个任务要执行10秒中，而调度算法是每秒中触发1次，那么就有可能多个任务被并发执行。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">有时候我们并不想任务并发执行，比如这个任务要去”获得数据库中所有未发送邮件的名单“，如果是并发执行，就需要一个数据库锁去避免一个数据被多次处理。这个时候一个@DisallowConcurrentExecution解决这个问题。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">就是这样</p><br><div class="highlight highlight-java" style="margin:0px 0px 15px; padding:0px; border:1px solid rgb(221,221,221); background:rgb(248,248,248)"><br><pre style="margin-top:15px; margin-bottom:15px; padding:0px; white-space:pre-wrap; word-wrap:break-word; border:0px; font-family:Consolas,&quot;Liberation Mono&quot;,Courier,monospace; font-size:12px"><span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">public</span> <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">class</span> <span class="nc" style="margin:0px; padding:0px; line-height:1.8; color:rgb(68,85,136); font-weight:bold">DoNothingJob</span> <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">implements</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">Job</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">{</span><br>    <span class="nd" style="margin:0px; padding:0px; line-height:1.8">@DisallowConcurrentExecution</span><br>    <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">public</span> <span class="kt" style="margin:0px; padding:0px; line-height:1.8; color:rgb(68,85,136); font-weight:bold">void</span> <span class="nf" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,0,0); font-weight:bold">execute</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">JobExecutionContext</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">context</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span> <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">throws</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">JobExecutionException</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">{</span><br>        <span class="n" style="margin:0px; padding:0px; line-height:1.8">System</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">out</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">println</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="s" style="margin:0px; padding:0px; line-height:1.8; color:rgb(221,17,68)">“do nothing”</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">);</span><br>    <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">}</span><br><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">}</span><br></pre><br></div><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">注意，@DisallowConcurrentExecution是对JobDetail实例生效，也就是如果你定义两个JobDetail，引用同一个Job类，是可以并发执行的。</p><br><h3 style="margin:10px 0px; padding:0px; color:rgb(0,0,0); font-size:16px; line-height:1.5"><a name="t19"></a><br><a target="_blank" class="anchor" name="user-content-jobexecutionexception" href="http://www.cnblogs.com/drift-ice/p/3817269.html#jobexecutionexception" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)"></a>JobExecutionException</h3><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">Job.execute()方法是不允许抛出除JobExecutionException之外的所有异常的（包括RuntimeException)，所以编码的时候，最好是try-catch住所有的Throwable，小心处理。</p><br><h3 style="margin:10px 0px; padding:0px; color:rgb(0,0,0); font-size:16px; line-height:1.5"><a name="t20"></a><br><a target="_blank" class="anchor" name="user-content-%E5%85%B6%E4%BB%96%E5%B1%9E%E6%80%A7" href="http://www.cnblogs.com/drift-ice/p/3817269.html#%E5%85%B6%E4%BB%96%E5%B1%9E%E6%80%A7" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)"></a>其他属性</h3><br><ul style="margin:15px 0px 15px 35px; padding:0px; border:0px"><br><li style="margin:0px; padding:0px; list-style:disc"><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">Durability(耐久性？)</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">如果一个任务不是durable，那么当没有Trigger关联它的时候，它就会被自动删除。</p><br></li><li style="margin:0px; padding:0px; list-style:disc"><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">RequestsRecovery</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">如果一个任务是”requests recovery”，那么当任务运行过程非正常退出时（比如进程崩溃，机器断电，但不包括抛出异常这种情况），Quartz再次启动时，会重新运行一次这个任务实例。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">可以通过JobExecutionContext.isRecovering()查询任务是否是被恢复的。</p><br></li></ul><br><h2 style="margin:10px 0px; padding:0px; color:rgb(0,0,0); line-height:1.5; font-size:21px"><a name="t21"></a><br><a target="_blank" class="anchor" name="user-content-scheduler" href="http://www.cnblogs.com/drift-ice/p/3817269.html#scheduler" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)"></a>Scheduler</h2><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">Scheduler就是Quartz的大脑，所有任务都是由它来设施。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">Schduelr包含一个两个重要组件: JobStore和ThreadPool。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">JobStore是会来存储运行时信息的，包括Trigger,Schduler,JobDetail，业务锁等。它有多种实现RAMJob(内存实现)，JobStoreTX(JDBC，事务由Quartz管理），JobStoreCMT(JDBC，使用容器事务)，ClusteredJobStore(集群实现)、TerracottaJobStore(<a target="_blank" href="http://yale.iteye.com/blog/1541612" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)">什么是Terractta</a>)。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">ThreadPool就是线程池，Quartz有自己的线程池实现。所有任务的都会由线程池执行。</p><br><h3 style="margin:10px 0px; padding:0px; color:rgb(0,0,0); font-size:16px; line-height:1.5"><a name="t22"></a><br><a target="_blank" class="anchor" name="user-content-schedulerfactory" href="http://www.cnblogs.com/drift-ice/p/3817269.html#schedulerfactory" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)"></a>SchedulerFactory</h3><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">SchdulerFactory，顾名思义就是来用创建Schduler了，有两个实现：DirectSchedulerFactory和 StdSchdulerFactory。前者可以用来在代码里定制你自己的Schduler参数。后者是直接读取classpath下的quartz.properties（不存在就都使用默认值）配置来实例化Schduler。通常来讲，我们使用StdSchdulerFactory也就足够了。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">SchdulerFactory本身是支持创建RMI stub的，可以用来管理远程的Scheduler，功能与本地一样，可以远程提交个Job什么的。</p><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">DirectSchedulerFactory的创建接口</p><br><div class="highlight highlight-java" style="margin:0px 0px 15px; padding:0px; border:1px solid rgb(221,221,221); background:rgb(248,248,248)"><br><pre style="margin-top:15px; margin-bottom:15px; padding:0px; white-space:pre-wrap; word-wrap:break-word; border:0px; font-family:Consolas,&quot;Liberation Mono&quot;,Courier,monospace; font-size:12px">    <span class="cm" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">/*<em></em></span><br><span class="cm" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">      Same as</span><br><span class="cm" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">     <em> {@link DirectSchedulerFactory#createScheduler(ThreadPool threadPool, JobStore jobStore)},</em></span><br><span class="cm" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">      with the addition of specifying the scheduler name and instance ID. This</span><br><span class="cm" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">     <em> scheduler can only be retrieved via</em></span><br><span class="cm" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">      {@link DirectSchedulerFactory#getScheduler(String)}</span><br><span class="cm" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">     <em></em></span><br><span class="cm" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">      @param schedulerName</span><br><span class="cm" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">     <em>          The name for the scheduler.</em></span><br><span class="cm" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">      @param schedulerInstanceId</span><br><span class="cm" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">     <em>          The instance ID for the scheduler.</em></span><br><span class="cm" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">      @param threadPool</span><br><span class="cm" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">     <em>          The thread pool for executing jobs</em></span><br><span class="cm" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">      @param jobStore</span><br><span class="cm" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">     <em>          The type of job store</em></span><br><span class="cm" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">      @throws SchedulerException</span><br><span class="cm" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">     <em>           if initialization failed</em></span><br><span class="cm" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,153,136); font-style:italic">     /</span><br>    <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">public</span> <span class="kt" style="margin:0px; padding:0px; line-height:1.8; color:rgb(68,85,136); font-weight:bold">void</span> <span class="nf" style="margin:0px; padding:0px; line-height:1.8; color:rgb(153,0,0); font-weight:bold">createScheduler</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">(</span><span class="n" style="margin:0px; padding:0px; line-height:1.8">String</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">schedulerName</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span><br>            <span class="n" style="margin:0px; padding:0px; line-height:1.8">String</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">schedulerInstanceId</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">ThreadPool</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">threadPool</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">,</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">JobStore</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">jobStore</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">)</span><br>        <span class="kd" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">throws</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">SchedulerException</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">;</span><br></pre><br></div><br><p style="margin:10px auto; padding-top:0px; padding-bottom:0px; border:0px">StdSchdulerFactory的配置例子， 更多配置，参考<a target="_blank" href="http://quartz-scheduler.org/documentation/quartz-2.2.x/configuration/" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)">Quartz配置指南</a>：</p><br><div class="highlight highlight-java" style="margin:0px 0px 15px; padding:0px; border:1px solid rgb(221,221,221); background:rgb(248,248,248)"><br><pre style="margin-top:15px; margin-bottom:15px; padding:0px; white-space:pre-wrap; word-wrap:break-word; border:0px; font-family:Consolas,&quot;Liberation Mono&quot;,Courier,monospace; font-size:12px"><span class="n" style="margin:0px; padding:0px; line-height:1.8">org</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">quartz</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">scheduler</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">instanceName</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">=</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">DefaultQuartzScheduler</span><br><span class="n" style="margin:0px; padding:0px; line-height:1.8">org</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">quartz</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">threadPool</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">class</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">=</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">org</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">quartz</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">simpl</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">SimpleThreadPool</span><br><span class="n" style="margin:0px; padding:0px; line-height:1.8">org</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">quartz</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">threadPool</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">threadCount</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">=</span> <span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">10</span><br><span class="n" style="margin:0px; padding:0px; line-height:1.8">org</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">quartz</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">threadPool</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">threadPriority</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">=</span> <span class="mi" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,153,153)">5</span><br><span class="n" style="margin:0px; padding:0px; line-height:1.8">org</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">quartz</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">threadPool</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">threadsInheritContextClassLoaderOfInitializingThread</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">=</span> <span class="kc" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">true</span><br><span class="n" style="margin:0px; padding:0px; line-height:1.8">org</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">quartz</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">jobStore</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">class</span> <span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">=</span> <span class="n" style="margin:0px; padding:0px; line-height:1.8">org</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">quartz</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">simpl</span><span class="o" style="margin:0px; padding:0px; line-height:1.8; font-weight:bold">.</span><span class="na" style="margin:0px; padding:0px; line-height:1.8; color:rgb(0,128,128)">RAMJobStore</span></pre><br></div><br><br><br><div id="cnblogs_post_body" style="margin:0px 0px 20px; padding:0px; word-break:break-word; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px"><br><h2 style="margin:10px 0px; padding:0px; color:rgb(0,0,0); line-height:1.5; font-size:21px"><a name="t23"></a><br>这里未讲的稍微高级的主题</h2><br><ul style="margin:15px 0px 15px 35px; padding:0px; border:0px"><br><li style="margin:0px; padding:0px; list-style:disc">JobStore&nbsp;<a target="_blank" href="http://quartz-scheduler.org/documentation/quartz-2.2.x/tutorials/tutorial-lesson-09" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)">介绍</a>、<a target="_blank" href="http://quartz-scheduler.org/documentation/quartz-2.2.x/configuration/" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)">配置</a></li><li style="margin:0px; padding:0px; list-style:disc">集群:&nbsp;<a target="_blank" href="http://quartz-scheduler.org/documentation/quartz-2.2.x/tutorials/tutorial-lesson-11" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)">介绍</a>、<a target="_blank" href="http://quartz-scheduler.org/documentation/quartz-2.2.x/configuration/ConfigJDBCJobStoreClustering" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)">配置</a></li><li style="margin:0px; padding:0px; list-style:disc">RMI</li><li style="margin:0px; padding:0px; list-style:disc">监听器&nbsp;<a target="_blank" href="http://quartz-scheduler.org/documentation/quartz-2.2.x/tutorials/tutorial-lesson-07" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)">TriggerListeners<br> and JobListeners</a>、<a target="_blank" href="http://quartz-scheduler.org/documentation/quartz-2.2.x/tutorials/tutorial-lesson-08" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)">SchedulerListeners</a></li><li style="margin:0px; padding:0px; list-style:disc">插件</li></ul><br><h2 style="margin:10px 0px; padding:0px; color:rgb(0,0,0); line-height:1.5; font-size:21px"><a name="t24"></a><br><a target="_blank" class="anchor" name="user-content-%E5%8F%82%E8%80%83" href="http://www.cnblogs.com/drift-ice/p/3817269.html#%E5%8F%82%E8%80%83" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)"></a>参考</h2><br><ul style="margin:15px 0px 15px 35px; padding:0px; border:0px"><br><li style="margin:0px; padding:0px; list-style:disc">主要的资料来自<a target="_blank" href="http://quartz-scheduler.org/documentation/quartz-2.2.x/tutorials/" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)">官方文档</a>，这里有教程，例子，配置等，非常详细</li><li style="margin:0px; padding:0px; list-style:disc">Cron表达式的说明，大段引用自<a target="_blank" href="http://www.blogjava.net/baoyaer/articles/155645.html" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)">这里</a></li><li style="margin:0px; padding:0px; list-style:disc">中文文档，虽然版本比较旧，但是很多东西还是没过时的，比如插件、RMI，<a target="_blank" href="http://vdisk.weibo.com/s/Ca_zRC6PBQeh8" rel="nofollow" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom:1px dotted rgb(51,51,51)">Quartz_Job_Scheduling_Framework_CN_V1.0.0</a></li></ul><br></div><br><div class="clear" style="margin:0px; padding:0px; clear:both; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px"><br></div><br><div id="blog_post_info_block" style="margin:20px 0px 0px; padding:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px"><br><div id="BlogPostCategory" style="margin:0px 0px 10px; padding:0px"></div><br><div id="EntryTag" style="margin-top:0px!important; margin-right:0px; margin-bottom:0px; margin-left:0px; padding:0px; font-size:9pt"><br></div><br></div><br><p></p><br>            <br>                      ]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;废话的前言&quot;&gt;&lt;a href=&quot;#废话的前言&quot; class=&quot;headerlink&quot; title=&quot;废话的前言&quot;&gt;&lt;/a&gt;废话的前言&lt;/h2&gt;&lt;p&gt;以前凭借年轻，凡事都靠脑记。现在工作几年后发现，很多以前看过、用过的东西，再次拿起的时候总觉得记不牢靠。”好记性不如烂笔头”应该是某位上了年纪的大叔的切肤之痛（仅次于上了年纪的难言之瘾）。&lt;/p&gt;
    
    </summary>
    
      <category term="java" scheme="http://codewey.com/categories/java/"/>
    
    
      <category term="java" scheme="http://codewey.com/tags/java/"/>
    
      <category term="quartz" scheme="http://codewey.com/tags/quartz/"/>
    
  </entry>
  
  <entry>
    <title>高并发，分布式电商订单号生成</title>
    <link href="http://codewey.com/post/high-concurrency-order/"/>
    <id>http://codewey.com/post/high-concurrency-order/</id>
    <published>2018-12-06T03:56:35.000Z</published>
    <updated>2019-04-06T09:14:15.000Z</updated>
    
    <content type="html"><![CDATA[<p>在分布式与高并发的情况下，生成订单号应满足以下几点：</p><p>全局唯一</p><p>订单号信息安全要求（不可推测性）</p><p>趋势递增要求</p><p>效率（生成、使用、索引）</p><p>控制并发（时间）<br><a id="more"></a></p><p></p><h2> 策略一：UUID和GUID（通用唯一识别码）</h2><br>组成：当前日期+时间+时钟序列+机器识别码（Mac地址或其他），正常情况下十几年之内可以达到全球唯一性。<p></p><p>优点：简单</p><pre><code>UUID.randomUUID()</code></pre><p>缺点：</p><ol><li><p>用户不友好，无序，不可读</p></li><li><p>索引关联效率较低，查询慢</p></li><li><p>分布式集群情况下有几率重复</p></li></ol><p></p><h2>策略二：数据库自增ID</h2><br>在数据库集群环境下，不同的数据库节点可以设置不同的起步值、相同的步长值来实现订单号唯一<p></p><pre><code>tab_A   起步值1   步长值10111213141tab_B   起步值2   步长值10212223242</code></pre><p>优点：</p><ol><li><p>无需编码</p></li><li><p>递增</p></li></ol><p>缺点：</p><ol><li><p>DB单点故障</p></li><li><p>高并发下插入数据需要事务机制</p></li><li><p>扩展性瓶颈</p></li></ol><h2 id="策略三：Twitter-SnowFlake"><a href="#策略三：Twitter-SnowFlake" class="headerlink" title="策略三：Twitter SnowFlake"></a>策略三：Twitter SnowFlake</h2><p>整体上按照时间自增排序，并且整个分布式系统内不会产生ID碰撞(由数据中心ID和机器ID作区分)，并且效率较高，SnowFlake每秒能够产生26wID左右。</p><p>优点：</p><ol><li>低位趋势递增</li></ol><p>缺点：</p><ol><li>依赖服务器时间（极端情况：更改服务器时间会导致ID重复）</li></ol><h2 id="策略四：Redis-自增"><a href="#策略四：Redis-自增" class="headerlink" title="策略四：Redis 自增"></a>策略四：Redis 自增</h2><p>redis 提供incr(key)方法， 将key中的数字值增1，如key不存在，key的值会被初始化为0。</p><p>优点：</p><ol><li><p>无单点故障</p></li><li><p>性能优于DB</p></li><li><p>递增</p></li></ol><p>缺点：</p><ol><li>redis集群维护</li></ol><p><hr><br>转自：<a href="https://blog.csdn.net/qq_15807785/article/details/81331376" target="_blank" rel="noopener">https://blog.csdn.net/qq_15807785/article/details/81331376</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在分布式与高并发的情况下，生成订单号应满足以下几点：&lt;/p&gt;
&lt;p&gt;全局唯一&lt;/p&gt;
&lt;p&gt;订单号信息安全要求（不可推测性）&lt;/p&gt;
&lt;p&gt;趋势递增要求&lt;/p&gt;
&lt;p&gt;效率（生成、使用、索引）&lt;/p&gt;
&lt;p&gt;控制并发（时间）&lt;br&gt;
    
    </summary>
    
      <category term="高并发" scheme="http://codewey.com/categories/%E9%AB%98%E5%B9%B6%E5%8F%91/"/>
    
    
      <category term="高并发" scheme="http://codewey.com/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/"/>
    
      <category term="分布式" scheme="http://codewey.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>开发环境、生产环境、测试环境的基本理解和区别</title>
    <link href="http://codewey.com/post/dev-pro-fat-env-diff/"/>
    <id>http://codewey.com/post/dev-pro-fat-env-diff/</id>
    <published>2018-12-04T07:29:59.000Z</published>
    <updated>2019-04-06T08:46:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>   对于刚刚来到一个新的团队或是新环境的“新人”来说，当你无所事事且故作投入之时，听着几个“老人”在自己可视范围之外或严肃或轻松的讨论着业务，其措辞拿捏精准，语气抑扬顿挫，期间，涉及到一些的概念可能难免让你不明觉厉……然默默道：”高端，大气，上档次！“</p><p>   ”不识庐山真面目，只缘身在此山中“，对于一些术语，它既有官方称呼，也有通俗叫法，对于不明觉厉的我只是正巧漫步在这座叫做大山的山中啊！<br>   <a id="more"></a></p><p>菜鸟话多……</p><p>开发环境：开发环境是程序猿们专门用于开发的服务器，配置可以比较随意， 为了开发调试方便，一般打开全部错误报告。</p><p>测试环境：一般是克隆一份生产环境的配置，一个程序在测试环境工作不正常，那么肯定不能把它发布到生产机上。</p><p>生产环境：是值正式提供对外服务的，一般会关掉错误报告，打开错误日志。</p><p>三个环境也可以说是系统开发的三个阶段：开发-&gt;测试-&gt;上线，其中生产环境也就是通常说的真实环境。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;   对于刚刚来到一个新的团队或是新环境的“新人”来说，当你无所事事且故作投入之时，听着几个“老人”在自己可视范围之外或严肃或轻松的讨论着业务，其措辞拿捏精准，语气抑扬顿挫，期间，涉及到一些的概念可能难免让你不明觉厉……然默默道：”高端，大气，上档次！“&lt;/p&gt;
&lt;p&gt;   ”不识庐山真面目，只缘身在此山中“，对于一些术语，它既有官方称呼，也有通俗叫法，对于不明觉厉的我只是正巧漫步在这座叫做大山的山中啊！&lt;br&gt;
    
    </summary>
    
      <category term="理论" scheme="http://codewey.com/categories/%E7%90%86%E8%AE%BA/"/>
    
    
      <category term="软件工程" scheme="http://codewey.com/tags/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>redis五大类型用法</title>
    <link href="http://codewey.com/post/redis-five-type-usage-method/"/>
    <id>http://codewey.com/post/redis-five-type-usage-method/</id>
    <published>2018-11-29T04:00:16.000Z</published>
    <updated>2019-04-06T08:31:26.000Z</updated>
    
    <content type="html"><![CDATA[<p>五大类型：<br><a id="more"></a></p><div id="cnblogs_post_body" class="blogpost-body"><pre><span style="font-size: 15px; color: #000000;">Redis五大类型:<br>字符串（String）、哈希/散列/字典（Hash）、列表（List）、集合（Set）、有序集合（sorted&nbsp;set）五种<span style="font-size: 15px; color: #000000;"><br>Controller:@Resource RedisTemplate&lt;String, String&gt; redisTemplate;</span><span style="font-size: 15px; color: #000000;"><br>总括:<br>redisTemplate.opsForValue();//操作字符串</span><br>redisTemplate.opsForHash();<span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;">//操作hash</span></span><br>redisTemplate.opsForList();<span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;">//操作list</span></span><br>redisTemplate.opsForSet();<span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;">//操作set</span></span><br>redisTemplate.opsForZSet();<span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;">//操作有序set<br></span></span><br><br>String:<br></span></pre><br><pre><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;">1.redisTemplate.opsForValue().set(key,value)); </span><br><span style="font-size: 15px; color: #000000;">2.redisTemplate</span>.opsForValue().get(key)); <span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><br><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;">3.redisTemplate.opsForValue().get(key, start, end);</span></span></span></span></span></span></span></span><br><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;">4.redisTemplate.opsForValue()</span></span></span>.getAndSet(key, <span class="string">value);<br>5.redisTemplate.opsForValue().getBit(key, offset);//下方注释<br>6.redisTemplate.opsForValue().multiGet(keys);<span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><br>7.redisTemplate.opsForValue().setBit(key, offset, value);//下方注释<br>8.redisTemplate.opsForValue().set(K key, V value, long timeout, TimeUnit unit);//TimeUnit是timeout的类型,如毫秒\秒\天等<br>9.redisTemplate.opsForValue().setIfAbsent(key, value);<br>10.redisTemplate.opsForValue().set(K key, V value, long offset);//博主此处未做java验证</span></span></span></span><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><br><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;">11.redisTemplate.opsForValue().size(key));<br>12.redisTemplate.opsForValue().multiGet(Collection&lt;K&gt; keys);<br>13.redisTemplate.opsForValue().multiSetIfAbsent(Map&lt;? extends K, ? extends V&gt; m);<br>14.同8<br>15\16\17\18\19.redisTemplate.opsForValue().increment(K key, long delta);或.increment(K key, double delta);</span></span></span></span></span></span></span></span></span></span></span><br></span><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;">20.redisTemplate.opsForValue().append(key, value);//在key键对应值的右面追加值value<br>可以看到并没有删除等方法,博主研究了一下可以这样:21.del key——21.redisTemplate.opsForValue().getOperations().delete(key);<br style="font-size: 15px; color: #000000;"><br></span></span></span></span></pre><br><table style="width: 588px; height: 420px;"><br><thead><br><tr><th>&nbsp;<span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;">编号</span></span></span></span></th><th>命令</th><th>描述说明</th></tr><br></thead><br><tbody><br><tr><br><td>1</td><br><td><a title="SET key value" href="http://www.yiibai.com/redis/strings_set.html" target="_blank" rel="noopener">SET key value</a></td><br><td>此命令设置指定键的值。</td><br></tr><br><tr><br><td>2</td><br><td><a title="GET key" href="http://www.yiibai.com/redis/strings_get.html" target="_blank" rel="noopener">GET key</a></td><br><td>获取指定键的值。</td><br></tr><br><tr><br><td>3</td><br><td><a title="GETRANGE key start end" href="http://www.yiibai.com/redis/strings_getrange.html" target="_blank" rel="noopener">GETRANGE key start end</a></td><br><td>获取存储在键上的字符串的子字符串。</td><br></tr><br><tr><br><td>4</td><br><td><a title="GETSET key value" href="http://www.yiibai.com/redis/strings_getset.html" target="_blank" rel="noopener">GETSET key value</a></td><br><td>设置键的字符串值并返回其旧值。</td><br></tr><br><tr><br><td>5</td><br><td><a title="GETBIT key offset" href="http://www.yiibai.com/redis/strings_getbit.html" target="_blank" rel="noopener">GETBIT key offset</a></td><br><td>返回在键处存储的字符串值中偏移处的位值。</td><br></tr><br><tr><br><td>6</td><br><td><a title="MGET key1 [key2..]" href="http://www.yiibai.com/redis/strings_mget.html" target="_blank" rel="noopener">MGET key1 [key2..]</a></td><br><td>获取所有给定键的值</td><br></tr><br><tr><br><td>7</td><br><td><a title="SETBIT key offset value" href="http://www.yiibai.com/redis/strings_setbit.html" target="_blank" rel="noopener">SETBIT key offset value</a></td><br><td>存储在键上的字符串值中设置或清除偏移处的位</td><br></tr><br><tr><br><td>8</td><br><td><a title="SETEX key seconds value" href="http://www.yiibai.com/redis/strings_setex.html" target="_blank" rel="noopener">SETEX key seconds value</a></td><br><td>使用键和到期时间来设置值</td><br></tr><br><tr><br><td>9</td><br><td><a title="SETNX key value" href="http://www.yiibai.com/redis/strings_setnx.html" target="_blank" rel="noopener">SETNX key value</a></td><br><td>设置键的值，仅当键不存在时</td><br></tr><br><tr><br><td>10</td><br><td><a title="SETRANGE key offset value" href="http://www.yiibai.com/redis/strings_setrange.html" target="_blank" rel="noopener">SETRANGE key offset value</a></td><br><td>在指定偏移处开始的键处覆盖字符串的一部分</td><br></tr><br><tr><br><td>11</td><br><td><a title="STRLEN key" href="http://www.yiibai.com/redis/strings_strlen.html" target="_blank" rel="noopener">STRLEN key</a></td><br><td>获取存储在键中的值的长度</td><br></tr><br><tr><br><td>12</td><br><td><a title="MSET key value [key value ...]" href="http://www.yiibai.com/redis/strings_mset.html" target="_blank" rel="noopener">MSET key value [key value …]</a></td><br><td>为多个键分别设置它们的值</td><br></tr><br><tr><br><td>13</td><br><td><a title="MSETNX key value [key value ...]" href="http://www.yiibai.com/redis/strings_msetnx.html" target="_blank" rel="noopener">MSETNX key value [key value …]</a></td><br><td>为多个键分别设置它们的值，仅当键不存在时</td><br></tr><br><tr><br><td>14</td><br><td><a title="PSETEX key milliseconds value" href="http://www.yiibai.com/redis/strings_psetex.html" target="_blank" rel="noopener">PSETEX key milliseconds value</a></td><br><td>设置键的值和到期时间(以毫秒为单位)</td><br></tr><br><tr><br><td>15</td><br><td><a title="INCR key" href="http://www.yiibai.com/redis/strings_incr.html" target="_blank" rel="noopener">INCR key</a></td><br><td>将键的整数值增加<code>1</code></td><br></tr><br><tr><br><td>16</td><br><td><a title="INCRBY key increment" href="http://www.yiibai.com/redis/strings_incrby.html" target="_blank" rel="noopener">INCRBY key increment</a></td><br><td>将键的整数值按给定的数值增加</td><br></tr><br><tr><br><td>17</td><br><td><a title="INCRBYFLOAT key increment" href="http://www.yiibai.com/redis/strings_incrbyfloat.html" target="_blank" rel="noopener">INCRBYFLOAT key increment</a></td><br><td>将键的浮点值按给定的数值增加</td><br></tr><br><tr><br><td>18</td><br><td><a title="DECR key" href="http://www.yiibai.com/redis/strings_decr.html" target="_blank" rel="noopener">DECR key</a></td><br><td>将键的整数值减<code>1</code></td><br></tr><br><tr><br><td>19</td><br><td><a title="DECRBY key decrement" href="http://www.yiibai.com/redis/strings_decrby.html" target="_blank" rel="noopener">DECRBY key decrement</a></td><br><td>按给定数值减少键的整数值</td><br></tr><br><tr><br><td>20</td><br><td><a title="APPEND key value" href="http://www.yiibai.com/redis/strings_append.html" target="_blank" rel="noopener">APPEND key value</a></td><br><td>将指定值附加到键</td><br></tr><br></tbody><br></table><br><pre><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;">.setBit(key, offset, value):key键对应的值value对应的ascii码,在offset的位置(从左向右数)变为value.(此处感谢<a href="http://blog.csdn.net/hgd613/article/details/54095729" target="_blank">@参考文章</a>对我理解的帮助),由于二进制只有0和1,此处value只能取0和1,如图,其他值是超出范围的<br>.getBit(key, offset):获取键对应值的ascii码的在offset处位值.<br><a href="http://baike.baidu.com/link?url=hFE0BW6q93N2OGtcRV_ynPJ2LejPUatY1tZvKH_oULO04YeQwwJatKduQe6dyeDBJV1s2CFcYoeFPMHGoUnYO_" target="_blank">@ascii码对照表</a><br><br></span></span></span></span><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://images2015.cnblogs.com/blog/1116057/201703/1116057-20170325161238690-289853671.png" alt=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://images2015.cnblogs.com/blog/1116057/201703/1116057-20170325161834393-31223536.png" alt=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://images2015.cnblogs.com/blog/1116057/201703/1116057-20170325162156596-1955722327.png" alt=""></span></pre><br><p>&nbsp;</p><br><p>&nbsp;</p><br><pre><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;">Hash:<br></span></span></span></span></pre><br><pre><span style="font-size: 15px; color: #000000;">1.redisTemplate.opsForHash().delete(H key, Object… hashKeys);//…表示可以传入多个map的key，用，隔开。或用数组传值<br><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;">2.redisTemplate.opsForHash().hasKey(key, hashKey)；<br>3.redisTemplate.opsForHash().get(key, hashKey)；<br>4.redisTemplate.opsForHash().entries(key);//返回map集合<br>5、6.redisTemplate.opsForHash().increment(H key, HK hashKey, long delta);//或increment(H key, HK hashKey, double delta);；<br>7.redisTemplate.opsForHash().keys(key)；//返回map的key集合Set<br>8.redisTemplate.opsForHash().size(key)；<br>9.redisTemplate.opsForHash().multiGet(H key, Collection&lt;HK&gt; hashKeys);<br>10.redisTemplate.opsForHash().putAll(H key, Map&lt;? extends HK, ? extends HV&gt; m)；<br>11.redisTemplate.opsForHash().put(key, hashKey, value);<br>12.redisTemplate.opsForHash().putIfAbsent(key, hashKey, value)；<br>13.<span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;">redisTemplate.opsForHash().values(key);//返回map中的value集合List</span></span></span></span>；</span></span></span></span></pre><br><table><br><thead><br><tr><th><span style="font-size: 15px; color: #000000;">序号</span>&nbsp;</th><th>命令</th><th>说明</th></tr><br></thead><br><tbody><br><tr><br><td>1</td><br><td><a title="HDEL key field2 [field2]" href="http://www.yiibai.com/redis/hashes_hdel.html" target="_blank" rel="noopener">HDEL key field2 [field2]</a></td><br><td>删除一个或多个哈希字段。</td><br></tr><br><tr><br><td>2</td><br><td><a title="HEXISTS key field" href="http://www.yiibai.com/redis/hashes_hexists.html" target="_blank" rel="noopener">HEXISTS key field</a></td><br><td>判断是否存在散列字段。</td><br></tr><br><tr><br><td>3</td><br><td><a title="HGET key field" href="http://www.yiibai.com/redis/hashes_hget.html" target="_blank" rel="noopener">HGET key field</a></td><br><td>获取存储在指定键的哈希字段的值。</td><br></tr><br><tr><br><td>4</td><br><td><a title="HGETALL key" href="http://www.yiibai.com/redis/hashes_hgetall.html" target="_blank" rel="noopener">HGETALL key</a></td><br><td>获取存储在指定键的哈希中的所有字段和值</td><br></tr><br><tr><br><td>5</td><br><td><a title="HINCRBY key field increment" href="http://www.yiibai.com/redis/hashes_hincrby.html" target="_blank" rel="noopener">HINCRBY key field increment</a></td><br><td>将哈希字段的整数值按给定数字增加</td><br></tr><br><tr><br><td>6</td><br><td><a title="HINCRBYFLOAT key field increment" href="http://www.yiibai.com/redis/hashes_hincrbyfloat.html" target="_blank" rel="noopener">HINCRBYFLOAT key field increment</a></td><br><td>将哈希字段的浮点值按给定数值增加</td><br></tr><br><tr><br><td>7</td><br><td><a title="HKEYS key" href="http://www.yiibai.com/redis/hashes_hkeys.html" target="_blank" rel="noopener">HKEYS key</a></td><br><td>获取哈希中的所有字段</td><br></tr><br><tr><br><td>8</td><br><td><a title="HLEN key" href="http://www.yiibai.com/redis/hashes_hlen.html" target="_blank" rel="noopener">HLEN key</a></td><br><td>获取散列中的字段数量</td><br></tr><br><tr><br><td>9</td><br><td><a title="HMGET key field1 [field2]" href="http://www.yiibai.com/redis/hashes_hmget.html" target="_blank" rel="noopener">HMGET key field1 [field2]</a></td><br><td>获取所有给定哈希字段的值</td><br></tr><br><tr><br><td>10</td><br><td><a title="HMSET key field1 value1 [field2 value2 ]" href="http://www.yiibai.com/redis/hashes_hmset.html" target="_blank" rel="noopener">HMSET key field1 value1 [field2 value2 ]</a></td><br><td>为多个哈希字段分别设置它们的值</td><br></tr><br><tr><br><td>11</td><br><td><a title="HSET key field value" href="http://www.yiibai.com/redis/hashes_hset.html" target="_blank" rel="noopener">HSET key field value</a></td><br><td>设置散列字段的字符串值</td><br></tr><br><tr><br><td>12</td><br><td><a title="HSETNX key field value" href="http://www.yiibai.com/redis/hashes_hsetnx.html" target="_blank" rel="noopener">HSETNX key field value</a></td><br><td>仅当字段不存在时，才设置散列字段的值</td><br></tr><br><tr><br><td>13</td><br><td><a title="HVALS key" href="http://www.yiibai.com/redis/hashes_hvals.html" target="_blank" rel="noopener">HVALS key</a></td><br><td>获取哈希中的所有值</td><br></tr><br></tbody><br></table><br><pre><span style="font-size: 15px; color: #000000;">List：<br><br>redisTemplate.opsForList().leftPush(key,&nbsp;value);//从左向右存压栈<br>redisTemplate.opsForList().leftPop(key);//从左出栈<br>redisTemplate.opsForList().size(key);//队/栈长<br>redisTemplate.opsForList().range(key,&nbsp;start,&nbsp;end);//范围检索,返回List<br>redisTemplate.opsForList().remove(key,&nbsp;i,&nbsp;value);//移除key中值为value的i个,<span class="comment">返回删除的个数；如果没有这个元素则返回0 <br>redisTemplate.opsForList().index(key,&nbsp;index);//检索<br>redisTemplate.opsForList().set(key,&nbsp;index,&nbsp;value);//赋值<br>redisTemplate.opsForList().trim(key,&nbsp;start,&nbsp;end);//裁剪,void,<span class="comment">删除除了[start,end]以外的所有元素&nbsp; <br>redisTemplate.opsForList().rightPopAndLeftPush(String sourceKey, String destinationKey);//<span class="comment">将源key的队列的右边的一个值删除，然后塞入目标key的队列的左边，返回这个值<br><span style="font-size: 15px; color: #000000;">注意:要缓存的对象必须实现Serializable接口,因为 Spring 会将对象先序列化再存入 Redis,否则报异常nested exception is java.lang.IllegalArgumentException: DefaultSerializer requires a Serializable……//；；/<br><br></span></span></span></span></span></pre><br><table><br><thead><br><tr><th><span style="font-size: 15px; color: #000000;"><span class="comment"><span class="comment"><span class="comment"><span style="font-size: 15px; color: #000000;">序号</span></span></span></span></span>&nbsp;</th><th>命令</th><th>说明</th></tr><br></thead><br><tbody><br><tr><br><td>1</td><br><td><a title="BLPOP key1 [key2 ] timeout" href="http://www.yiibai.com/redis/lists_blpop.html" target="_blank" rel="noopener">BLPOP key1 [key2 ] timeout</a></td><br><td>删除并获取列表中的第一个元素，或阻塞，直到有一个元素可用</td><br></tr><br><tr><br><td>2</td><br><td><a title="BRPOP key1 [key2 ] timeout" href="http://www.yiibai.com/redis/lists_brpop.html" target="_blank" rel="noopener">BRPOP key1 [key2 ] timeout</a></td><br><td>删除并获取列表中的最后一个元素，或阻塞，直到有一个元素可用</td><br></tr><br><tr><br><td>3</td><br><td><a title="BRPOPLPUSH source destination timeout" href="http://www.yiibai.com/redis/lists_brpoplpush.html" target="_blank" rel="noopener">BRPOPLPUSH source destination timeout</a></td><br><td>从列表中弹出值，将其推送到另一个列表并返回它; 或阻塞，直到一个可用</td><br></tr><br><tr><br><td>4</td><br><td><a title="LINDEX key index" href="http://www.yiibai.com/redis/lists_lindex.html" target="_blank" rel="noopener">LINDEX key index</a></td><br><td>通过其索引从列表获取元素</td><br></tr><br><tr><br><td>5</td><br><td><a title="LINSERT key BEFORE/AFTER pivot value" href="http://www.yiibai.com/redis/lists_linsert.html" target="_blank" rel="noopener">LINSERT key BEFORE/AFTER pivot value</a></td><br><td>在列表中的另一个元素之前或之后插入元素</td><br></tr><br><tr><br><td>6</td><br><td><a title="LLEN key" href="http://www.yiibai.com/redis/lists_llen.html" target="_blank" rel="noopener">LLEN key</a></td><br><td>获取列表的长度</td><br></tr><br><tr><br><td>7</td><br><td><a title="LPOP key" href="http://www.yiibai.com/redis/lists_lpop.html" target="_blank" rel="noopener">LPOP key</a></td><br><td>删除并获取列表中的第一个元素</td><br></tr><br><tr><br><td>8</td><br><td><a title="LPUSH key value1 [value2]" href="http://www.yiibai.com/redis/lists_lpush.html" target="_blank" rel="noopener">LPUSH key value1 [value2]</a></td><br><td>将一个或多个值添加到列表</td><br></tr><br><tr><br><td>9</td><br><td><a title="LPUSHX key value" href="http://www.yiibai.com/redis/lists_lpushx.html" target="_blank" rel="noopener">LPUSHX key value</a></td><br><td>仅当列表存在时，才向列表添加值</td><br></tr><br><tr><br><td>10</td><br><td><a title="LRANGE key start stop" href="http://www.yiibai.com/redis/lists_lrange.html" target="_blank" rel="noopener">LRANGE key start stop</a></td><br><td>从列表中获取一系列元素</td><br></tr><br><tr><br><td>11</td><br><td><a title="LREM key count value" href="http://www.yiibai.com/redis/lists_lrem.html" target="_blank" rel="noopener">LREM key count value</a></td><br><td>从列表中删除元素</td><br></tr><br><tr><br><td>12</td><br><td><a title="LSET key index value" href="http://www.yiibai.com/redis/lists_lset.html" target="_blank" rel="noopener">LSET key index value</a></td><br><td>通过索引在列表中设置元素的值</td><br></tr><br><tr><br><td>13</td><br><td><a title="LTRIM key start stop" href="http://www.yiibai.com/redis/lists_ltrim.html" target="_blank" rel="noopener">LTRIM key start stop</a></td><br><td>修剪列表的指定范围</td><br></tr><br><tr><br><td>14</td><br><td><a title="RPOP key" href="http://www.yiibai.com/redis/lists_rpop.html" target="_blank" rel="noopener">RPOP key</a></td><br><td>删除并获取列表中的最后一个元素</td><br></tr><br><tr><br><td>15</td><br><td><a title="RPOPLPUSH source destination" href="http://www.yiibai.com/redis/lists_rpoplpush.html" target="_blank" rel="noopener">RPOPLPUSH source destination</a></td><br><td>删除列表中的最后一个元素，将其附加到另一个列表并返回</td><br></tr><br><tr><br><td>16</td><br><td><a title="RPUSH key value1 [value2]" href="http://www.yiibai.com/redis/lists_rpush.html" target="_blank" rel="noopener">RPUSH key value1 [value2]</a></td><br><td>将一个或多个值附加到列表</td><br></tr><br><tr><br><td>17</td><br><td><a title="RPUSHX key value" href="http://www.yiibai.com/redis/lists_rpushx.html" target="_blank" rel="noopener">RPUSHX key value</a></td><br><td>仅当列表存在时才将值附加到列表</td><br></tr><br></tbody><br></table><br><pre><span style="font-size: 15px; color: #000000;"><span class="comment"><span class="comment"><span class="comment"><span style="font-size: 15px; color: #000000;"><br>Set：<br></span></span></span></span></span></pre><br><pre><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><br>redisTemplate.opsForValue().getAndSet(key, value)<br><br></span></span></span></span></pre><br><table><br><thead><br><tr><th>&nbsp;<span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;">序号</span></span></span></span></th><th>命令</th><th>说明</th></tr><br></thead><br><tbody><br><tr><br><td>1</td><br><td><a title="SADD key member1 [member2]" href="http://www.yiibai.com/redis/sets_sadd.html" target="_blank" rel="noopener">SADD key member1 [member2]</a></td><br><td>将一个或多个成员添加到集合</td><br></tr><br><tr><br><td>2</td><br><td><a title="SCARD key" href="http://www.yiibai.com/redis/sets_scard.html" target="_blank" rel="noopener">SCARD key</a></td><br><td>获取集合中的成员数</td><br></tr><br><tr><br><td>3</td><br><td><a title="SDIFF key1 [key2]" href="http://www.yiibai.com/redis/sets_sdiff.html" target="_blank" rel="noopener">SDIFF key1 [key2]</a></td><br><td>减去多个集合</td><br></tr><br><tr><br><td>4</td><br><td><a title="SDIFFSTORE destination key1 [key2]" href="http://www.yiibai.com/redis/sets_sdiffstore.html" target="_blank" rel="noopener">SDIFFSTORE destination key1 [key2]</a></td><br><td>减去多个集并将结果集存储在键中</td><br></tr><br><tr><br><td>5</td><br><td><a title="SINTER key1 [key2]" href="http://www.yiibai.com/redis/sets_sinter.html" target="_blank" rel="noopener">SINTER key1 [key2]</a></td><br><td>相交多个集合</td><br></tr><br><tr><br><td>6</td><br><td><a title="SINTERSTORE destination key1 [key2]" href="http://www.yiibai.com/redis/sets_sinterstore.html" target="_blank" rel="noopener">SINTERSTORE destination key1 [key2]</a></td><br><td>交叉多个集合并将结果集存储在键中</td><br></tr><br><tr><br><td>7</td><br><td><a title="SISMEMBER key member" href="http://www.yiibai.com/redis/sets_sismember.html" target="_blank" rel="noopener">SISMEMBER key member</a></td><br><td>判断确定给定值是否是集合的成员</td><br></tr><br><tr><br><td>8</td><br><td><a title="SMOVE source destination member" href="http://www.yiibai.com/redis/sets_smove.html" target="_blank" rel="noopener">SMOVE source destination member</a></td><br><td>将成员从一个集合移动到另一个集合</td><br></tr><br><tr><br><td>9</td><br><td><a title="SPOP key" href="http://www.yiibai.com/redis/sets_spop.html" target="_blank" rel="noopener">SPOP key</a></td><br><td>从集合中删除并返回随机成员</td><br></tr><br><tr><br><td>10</td><br><td><a title="SRANDMEMBER key [count]" href="http://www.yiibai.com/redis/sets_srandmember.html" target="_blank" rel="noopener">SRANDMEMBER key [count]</a></td><br><td>从集合中获取一个或多个随机成员</td><br></tr><br><tr><br><td>11</td><br><td><a title="SREM key member1 [member2]" href="http://www.yiibai.com/redis/sets_srem.html" target="_blank" rel="noopener">SREM key member1 [member2]</a></td><br><td>从集合中删除一个或多个成员</td><br></tr><br><tr><br><td>12</td><br><td><a title="SUNION key1 [key2]" href="http://www.yiibai.com/redis/sets_sunion.html" target="_blank" rel="noopener">SUNION key1 [key2]</a></td><br><td>添加多个集合</td><br></tr><br><tr><br><td>13</td><br><td><a title="SUNIONSTORE destination key1 [key2]" href="http://www.yiibai.com/redis/sets_sunionstore.html" target="_blank" rel="noopener">SUNIONSTORE destination key1 [key2]</a></td><br><td>添加多个集并将结果集存储在键中</td><br></tr><br><tr><br><td>14</td><br><td><a title="SSCAN key cursor [MATCH pattern] [COUNT count]" href="http://www.yiibai.com/redis/sets_sscan.html" target="_blank" rel="noopener">SSCAN key cursor [MATCH pattern] [COUNT count]</a></td><br><td>递增地迭代集合中的元素</td><br></tr><br></tbody><br></table><br><pre><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;"><span style="font-size: 15px; color: #000000;">&nbsp;</span></span></span></span></pre><br><pre><span style="font-size: 15px; color: #000000;"><span class="comment"><span class="comment"><span class="comment"><span style="font-size: 15px; color: #000000;">&nbsp;艾玛，太累了，写着写着发现不用这么麻烦，看到文章中的表了吗？若在java中找不到相应方法就对照表中的一些”字段“在java中找，肯定能找到，而且基本不会浪费多少时间。关于List与Set万能的后人补充吧！<br></span></span></span></span></span></pre></div><p>转自：<a href="https://www.cnblogs.com/yanan7890/p/6617305.html" target="_blank" rel="noopener">https://www.cnblogs.com/yanan7890/p/6617305.html</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;五大类型：&lt;br&gt;
    
    </summary>
    
      <category term="redis" scheme="http://codewey.com/categories/redis/"/>
    
    
      <category term="redis" scheme="http://codewey.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>nginx 基本原理与配置</title>
    <link href="http://codewey.com/post/Nginx-Basic-Principles/"/>
    <id>http://codewey.com/post/Nginx-Basic-Principles/</id>
    <published>2018-11-25T16:38:53.000Z</published>
    <updated>2019-09-25T16:54:17.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="一、选用-Nginx-的理由"><a href="#一、选用-Nginx-的理由" class="headerlink" title="一、选用 Nginx 的理由"></a>一、选用 Nginx 的理由</h3><p><strong>1）支持高并发连接</strong></p><p>得益于 Nginx 使用最新的 epoll（Linux 2.6 内核）和 kqueue(FreeBSD) 网络 I/O 模型，官方测试 Nginx 可最高支持 5 万的并发连接，在实际的生产环境中，可实际支持 2~4 万的并发连接数。<br><a id="more"></a><br><strong>2）内存消耗低</strong></p><p><strong>3）成本低</strong></p><p><strong>4）配置简单</strong></p><p><strong>5）支持 Rewrite 重写规则，能够根据域名、URL 的不同将 http 请求分发到不同的后端服务器群组。</strong></p><p><strong>6）内置健康检查功能，如果 Nginx proxy 后端的某台服务器宕机了，不会影响前端访问</strong></p><p><strong>7）节省带宽，支持 GZIP 压缩，可添加浏览器本地缓存的 header</strong></p><p><strong>8）稳定性高，用于反向代理，宕机概率极低</strong></p><p><strong>9）支持热部署，启动容易，几乎可以 7x24 小时不间断运行，且支持不间断服务的情况下，对软件进行升级。</strong></p><h3 id="二、Nginx-的启停"><a href="#二、Nginx-的启停" class="headerlink" title="二、Nginx 的启停"></a>二、Nginx 的启停</h3><p>运行环境：max os, Nginx 通过 brew install 安装，路径为：/usr/local/Cellar/nginx/1.10.2_1/</p><p><strong>1、启动</strong></p><pre><code>nginx [-c path]</code></pre><p>-c 选项可用来指定配置文件路径， 如 nginx -c </p><pre><code>/usr/local/etc/nginx.conf</code></pre><p><strong>2、停止</strong></p><p>一般通过发送系统信号给 Nginx 主进程的方式来停止。可通过<br>ps -ef | grep nginx 查看进程号</p><pre><code>$ ps -ef | grep nginx  501  3709     1   0  3:10下午 ??         0:00.00 nginx: master process nginx  501  3710  3709   0  3:10下午 ??         0:00.00 nginx: worker process  501  3711  3709   0  3:10下午 ??         0:00.01 nginx: worker process  501  3712  3709   0  3:10下午 ??         0:00.01 nginx: worker process  501  3713  3709   0  3:10下午 ??         0:00.01 nginx: worker process  501  3724   686   0  3:11下午 ttys001    0:00.00 grep nginx</code></pre><p>如上所示，3709 为主进程，3710 ~ 3713 为工作子进程。nginx.conf 配置文件中指定了 pid 文件的存放路径， 如 / usr/local/var/run/nginx.pid， 其中存放了当前 Nginx 运行的主进程号，可通过该进程号，来平滑停止 Nginx 服务。</p><p><strong>1)  平滑停止</strong></p><pre><code>$ kill -QUIT 3709$ ps -ef | grep nginx  501  3989   686   0  3:49下午 ttys001    0:00.00 grep nginx# 或者，通过pid文件获取主进程号来停止$ kill -QUIT `cat /usr/local/var/run/nginx.pid`2）快速停止$ kill -TERM 3709$ ps -ef | grep nginx  501  3989   686   0  3:49下午 ttys001    0:00.00 grep nginx# 或者，通过pid文件获取主进程号来停止$ kill -TERM `cat /usr/local/var/run/nginx.pid`# 另一种方式$ kill -INT 3709$ ps -ef | grep nginx  501  3989   686   0  3:49下午 ttys001    0:00.00 grep nginx# 或者，通过pid文件获取主进程号来停止$ kill -INT `cat /usr/local/var/run/nginx.pid`3）强制停止$ pkill -9 nginx$ ps -ef | grep nginx  501  4081   686   0  3:57下午 ttys001    0:00.00 grep nginx</code></pre><p><strong>3、平滑重启</strong></p><p>如果修改了配置文件 nginx.conf，想重启 Nginx，需要发送信号给 Nginx 主进程来实现。</p><pre><code>$ ps -ef | grep nginx  501  4188     1   0  4:13下午 ??         0:00.00 nginx: master process nginx  501  4189  4188   0  4:13下午 ??         0:00.00 nginx: worker process  501  4190  4188   0  4:13下午 ??         0:00.00 nginx: worker process  501  4191  4188   0  4:13下午 ??         0:00.00 nginx: worker process  501  4192  4188   0  4:13下午 ??         0:00.00 nginx: worker process  501  4195   686   0  4:13下午 ttys001    0:00.00 grep nginx$ kill -HUP `cat /usr/local/var/run/nginx.pid`$ ps -ef | grep nginx  501  4188     1   0  4:13下午 ??         0:00.01 nginx: master process nginx  501  4201  4188   0  4:13下午 ??         0:00.00 nginx: worker process  501  4202  4188   0  4:13下午 ??         0:00.00 nginx: worker process  501  4203  4188   0  4:13下午 ??         0:00.00 nginx: worker process  501  4204  4188   0  4:13下午 ??         0:00.00 nginx: worker process  501  4206   686   0  4:13下午 ttys001    0:00.00 grep nginx</code></pre><p>可以看出，重启的只是工作进程，当接收到 HUP 信号后，当前工作进程会关闭监听套接字，并继续为当前连接的客户端服务，当所有客户端服务完成后，旧的工作进程关闭。</p><p><strong>4、其他信号</strong></p><p><strong>USR1: 重新打开日志文件，切割日志文件时有用</strong></p><p><strong>USR2: 平滑升级可执行程序</strong></p><p><strong>WINCTH: 从容关闭工作进程</strong></p><pre><code>$ kill -WINCH `cat /usr/local/var/run/nginx.pid`$ ps -ef | grep nginx  501  4188     1   0  4:13下午 ??         0:00.01 nginx: master process nginx  501  4258   686   0  4:21下午 ttys001    0:00.00 grep nginx</code></pre><h3 id="三、Nginx-基本配置"><a href="#三、Nginx-基本配置" class="headerlink" title="三、Nginx 基本配置"></a>三、Nginx 基本配置</h3><p><strong>1、虚拟主机配置</strong></p><p>虚拟主机提供了同一台服务器，同一个 Nginx 进程上运行多个网站的功能，Nginx 支持配置多种类型的虚拟主机： 基于 IP 的， 基于域名的， 基于端口号的。</p><p>在 nginx.conf 中，一台简化的虚拟主机配置如下：</p><pre><code>http {    server {        listen       8080;        server_name  localhost;        access_log  logs/host.access.log  main;        location / {            root   html;            index  index.html index.htm;          }    }}</code></pre><p>基于 IP 的虚拟主机配置</p><p>通过 ifconfig 和 route 命令为当前服务器主机添加 IP 别名，如下：</p><pre><code>$ ifconfig eth0:1 192.168.1.102 broadcast 192.168.1.255 netmask 255.255.255.0 up$ route add -host 192.168.1.102 dev eth0:1接下来分别对 192.168.1.101 和 192.168.1.102 配置虚拟主机http {    # 第一个虚拟主机    server {        # 监听的IP和端口        listen      192.168.1.101:8080;        # 主机名称        server_name  192.168.1.101;        # 访问日志文件存放路径        access_log  logs/host.access.log  main;        location / {            # html网页文件存放目录            root   /data0/htmldoc/server1;            # 默认首页文件，从左至右，找不到index.html，就查找index.htm，都查找不到则报错            index  index.html index.htm;          }    }    # 第二个虚拟主机    server {        listen       192.168.1.102:8080;        server_name  192.168.1.102;        access_log  logs/host.access.log  main;        location / {            root   /data0/htmldoc/server2;            index  index.html index.htm;          }    }}</code></pre><p>基于域名的虚拟主机配置</p><p>配置你的 DNS 服务器，将你的 IP 映射到不同的域名即可实现，可以有效解决 IP 地址不足的问题。</p><pre><code>http {    # 第一个虚拟主机    server {        # 监听的IP和端口        listen      8080;        # 主机名称        server_name  aaa.ssl.com;        # 访问日志文件存放路径        access_log  logs/host.access.log  main;        location / {            # html网页文件存放目录            root   /data0/htmldoc/server1;            # 默认首页文件，从左至右，找不到index.html，就查找index.htm，都查找不到则报错            index  index.html index.htm;          }    }    # 第二个虚拟主机    server {        listen       8080;        server_name  bbb.ssl.com;        access_log  logs/host.access.log  main;        location / {            root   /data0/htmldoc/server2;            index  index.html index.htm;          }    }}</code></pre><p><strong>2、日志文件配置与切割</strong></p><p>1）配置 log_format 日志格式 log_format name format [format..]</p><pre><code>log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;&apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;&apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</code></pre><p>name 用来指定日志格式的名称，保持唯一性。</p><p>remoteaddr 用于记录远程客户端 IP 地址，还有另外一个变量http_x_forwarded_for 用来记录用户的 X-Forwarded-For IP 地址。</p><p>2）配置日志文件存放路径</p><p>access_log path [format [ buffer=size | off]]</p><p>path: 存放路径</p><p>format: 日志格式名称，log_format 中设置的 name</p><p>buffer: 内存缓冲区大小</p><p>off: 表示关闭日志记录</p><p>如： access_log /data0/logs/log1 combined buffer=32k;</p><p><strong>3) 日志切割</strong></p><p>a) 重命名原日志文件，然后向 Nginx 主进程发送 USR1 信号，让 Nginx 重新生成一个新的日志文件。</p><p>mv /data0/logs/access.log /data0/logs/20170716.log</p><p>kill -USR1 <code>cat /usr/local/var/run/nginx.pid</code></p><p>b）按天定时切割日志文件的方式</p><pre><code># !/bin/bash# 这个脚本须在每天的00：00运行, 保存为cut_nginx.log.sh# Nginx日志文件的存放路径logs_path=&quot;/data0/logs&quot;mkdir -p ${logs_path}$(date -d &quot;yesterday&quot;+&quot;%Y&quot;)/$(date -d &quot;yesterday&quot;+&quot;%m&quot;)/mv ${logs_path}access.log ${logs_path}$(date -d &quot;yesterday&quot;+&quot;%Y&quot;)/$(date -d &quot;yesterday&quot;+&quot;%m&quot;)/access_$(date -d &quot;yesterday&quot;+&quot;%Y%m%d&quot;).logkill -USR1 `cat /usr/local/var/nginx/nginx.pid`配置 crontab 每天凌晨 00:00 定时执行该脚本crontab -e输入：00 00 * * * /bin/bash /usr/local/var/nginx/sbin/cut_nginx.log.sh</code></pre><p><strong>3、压缩配置</strong></p><p>gzip 压缩后，页面大小可变为原来的 30% 甚至更小，这样用户浏览页面时速度会快很多。</p><p><strong>4、自动列目录</strong></p><pre><code>location / {            # html网页文件存放目录            root   /Users/qwe/Desktop;            # 自动列出目录            autoindex on;          }</code></pre><p><strong>5、浏览器本地缓存设置</strong></p><p>浏览器将用户最近请求过的页面存储到本地磁盘，当用户再次访问时，可以直接从本地磁盘显示文档，加速页面浏览速度，节约网络资源。</p><p>浏览器缓存通过 expires 指令输出 header 头来实现 。</p><p>语法： expires [time | epoch | max | off]</p><p>默认值： expires off</p><p>作用域：http, server, location</p><p>用途： 使用本指令可以控制 HTTP 应答中的 “Expires” 和“Cache-Control”</p><p>epoch 指定 Expires 值为 1 January，1970，00：00：01 GMT</p><p>max 指定 Expires 值为 31 December，2037 23：59：59 GMT， Cache-Control 值为 10 年</p><p>-1 指定 “Expires” 值为服务器当前时间，即永远过期。</p><p>Cache-Control 的值由你指定的时间来决定， 负数表示 no-cache， 正数或零为你指定时间的秒数。</p><p>”off“表示不修改 “Expires” 和”Cache-Control“的值。</p><p>一般对常见格式的图片、Flash 文件缓存 30 天，对 js、css 文件缓存 1 小时。如下：</p><pre><code>location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$ {         expires 30d; }location ~ .*\.(js|css)${         expires 1h; }</code></pre><p>   原文：<a href="https://www.cnblogs.com/java-wgm/p/7160530.html" target="_blank" rel="noopener">https://www.cnblogs.com/java-wgm/p/7160530.html</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;一、选用-Nginx-的理由&quot;&gt;&lt;a href=&quot;#一、选用-Nginx-的理由&quot; class=&quot;headerlink&quot; title=&quot;一、选用 Nginx 的理由&quot;&gt;&lt;/a&gt;一、选用 Nginx 的理由&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;1）支持高并发连接&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;得益于 Nginx 使用最新的 epoll（Linux 2.6 内核）和 kqueue(FreeBSD) 网络 I/O 模型，官方测试 Nginx 可最高支持 5 万的并发连接，在实际的生产环境中，可实际支持 2~4 万的并发连接数。&lt;br&gt;
    
    </summary>
    
      <category term="笔记" scheme="http://codewey.com/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="Nginx" scheme="http://codewey.com/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>已知一个下载文件的后端接口，前端如何请求该接口，实现点击按钮、下载文件到本地。</title>
    <link href="http://codewey.com/post/download-file-method/"/>
    <id>http://codewey.com/post/download-file-method/</id>
    <published>2018-11-22T11:45:31.000Z</published>
    <updated>2019-04-06T08:07:25.000Z</updated>
    
    <content type="html"><![CDATA[<p>在线例子：<a href="https://hamupp.github.io/gitblog/app/jsBasic/jsButtonDownloadFile/index.html" target="_blank" rel="noopener">https://hamupp.github.io/gitblog/app/jsBasic/jsButtonDownloadFile/index.html</a><br><a id="more"></a><br>方法一：window.open(“下载文件的后端接口”);</p><p><em>html结构</em></p><pre><code>&lt;button type=&quot;button&quot; id=&quot;btn1&quot;&gt;下载一个zip（方法1）&lt;/button&gt;&lt;button type=&quot;button&quot; id=&quot;btn2&quot;&gt;下载一个zip（方法2）&lt;/button&gt;</code></pre><p><em>js部分</em></p><pre><code>var $eleBtn1 = $(&quot;#btn1&quot;);var $eleBtn2 = $(&quot;#btn2&quot;);//已知一个下载文件的后端接口：https://codeload.github.com/douban/douban-client/legacy.zip/master//方法一：window.open()$eleBtn1.click(function(){    window.open(&quot;https://codeload.github.com/douban/douban-client/legacy.zip/master&quot;);});</code></pre><p>   然而有个问题：浏览器会打开一个新窗口，然后迅速自动关闭，体验非常不好。</p><p>方法二：通过form提交</p><p>由于ajax函数的返回类型只有xml、text、json、html等类型，没有“流”类型，所以通过ajax去请求该接口是无法下载文件的，所以我们创建一个新的form元素来请求接口。</p><p><em>js部分</em></p><pre><code>//方法二：通过form$eleBtn2.click(function(){    var $eleForm = $(&quot;&lt;form method=&apos;get&apos;&gt;&lt;/form&gt;&quot;);    $eleForm.attr(&quot;action&quot;,&quot;https://codeload.github.com/douban/douban-client/legacy.zip/master&quot;);    $(document.body).append($eleForm);    //提交表单，实现下载    $eleForm.submit();});</code></pre><p>转自：<a href="https://blog.csdn.net/qq_33058239/article/details/78840275" target="_blank" rel="noopener">https://blog.csdn.net/qq_33058239/article/details/78840275</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在线例子：&lt;a href=&quot;https://hamupp.github.io/gitblog/app/jsBasic/jsButtonDownloadFile/index.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://hamupp.github.io/gitblog/app/jsBasic/jsButtonDownloadFile/index.html&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="html" scheme="http://codewey.com/categories/html/"/>
    
    
      <category term="js" scheme="http://codewey.com/tags/js/"/>
    
      <category term="html" scheme="http://codewey.com/tags/html/"/>
    
  </entry>
  
  <entry>
    <title>java根据list中对象的属性找出list重复数据或去除list重复数据</title>
    <link href="http://codewey.com/post/java-list-remov-repeat/"/>
    <id>http://codewey.com/post/java-list-remov-repeat/</id>
    <published>2018-11-12T12:54:47.000Z</published>
    <updated>2019-04-06T07:52:11.000Z</updated>
    
    <content type="html"><![CDATA[<p>在实际开发中，经常会遇到需要找出(删除)一个list中某些元素的属性相同的元素，或者两个list中某些元素的属性相等的元素，这种方法很多，这里整理列出一些：<br>废话不说，上代码，有注释掉的你们自己看<br><a id="more"></a></p><pre><code>import java.util.ArrayList;import java.util.HashMap;import java.util.List;import java.util.Map;public class Test {    public static void main(String[] args) {        List&lt;Student&gt; testList = new ArrayList&lt;Student&gt;();        testList.add(new Student(&quot;张一&quot;));        testList.add(new Student(&quot;张二&quot;));        testList.add(new Student(&quot;张三&quot;));        testList.add(new Student(&quot;老王&quot;));        testList.add(new Student(&quot;张四&quot;));        testList.add(new Student(&quot;张五&quot;));        testList.add(new Student(&quot;张六&quot;));        testList.add(new Student(&quot;张七&quot;));        testList.add(new Student(&quot;老王&quot;));        testList.add(new Student(&quot;张八&quot;));        testList.add(new Student(&quot;张九&quot;));        testList.add(new Student(&quot;老王&quot;));        List&lt;Student&gt; repeatList = new ArrayList&lt;Student&gt;();//用于存放重复的元素的list        // 以一种方法：两个循环(最蠢的方法)        for (int i = 0; i &lt; testList.size() - 1; i++) {            for (int j = testList.size() - 1; j &gt; i; j--) {                if (testList.get(j).getStuName().equals(testList.get(i).getStuName())) {                    repeatList.add(testList.get(j));//把相同元素加入list(找出相同的)                    testList.remove(j);//删除重复元素                }            }        }//      for(Student s : repeatList){//          System.out.println(&quot;相同的元素:&quot; + s.getStuName());//      }        //第二种方法：利用map.containsKey()        Map&lt;String, Integer&gt; map = new HashMap&lt;&gt;();         for(Student s : testList){            //1:map.containsKey()   检测key是否重复            if(map.containsKey(s.getStuName())){                repeatList.add(s);//获取重复的学生名称                Integer num = map.get(s.getStuName());                map.put(s.getStuName(), num+1);            }else{                map.put(s.getStuName(), 1);            }            //2: 这个key是不是存在对应的value(key是否在map中)//          Integer count = map.get(s.getStuName());//这种写法也可以，异曲同工//          if (count == null) {//              map.put(s.getStuName(), 1);//          } else {//              map.put(s.getStuName(), (count + 1));//          }        }//      for(Student s : repeatList){//          System.out.println(&quot;相同的元素:&quot; + s.getStuName());//      }//      for(Map.Entry&lt;String, Integer&gt; entry : map.entrySet()){//          System.out.println(&quot;学生:&quot; + entry.getKey() + &quot;的名字出现了：&quot; + entry.getValue() + &quot;次&quot;);//      }        //第三种方法：contains()方法  这个个人认为有一定的局限性，个人理解哈        List&lt;Integer&gt; repeatList1 = new ArrayList&lt;&gt;();          List&lt;Integer&gt; list = new ArrayList&lt;&gt;();          list.add(1);        list.add(2);        list.add(1);        list.add(3);        list.add(4);        list.add(1);        list.add(5);        for(int i=0;i&lt;list.size();i++){              if(!repeatList1.contains(list.get(i))){                  repeatList1.add(list.get(i));              }          }         for(Integer s : repeatList1){            System.out.println(s);        }    }</code></pre><p>Student类：</p><pre><code>public class Student {public Student(String stuName){    this.stuName = stuName;}private String  stuName;public String getStuName() {    return stuName;}public void setStuName(String stuName) {    this.stuName = stuName;}</code></pre><p>}</p><p>这个是java8的stream，由于我用的和是jdk7 这里就找了一个 给你们当例子看，有兴趣可以看stream相关的知识，很强大的功能</p><pre><code>List&lt;String&gt; list = Arrays.asList(&quot;123&quot;, &quot;1234&quot;, &quot;12345&quot;, &quot;123456&quot;, &quot;1234567&quot;, &quot;122222223&quot;, &quot;123&quot;, &quot;1234&quot;, &quot;2422&quot;);Map&lt;String, Long&gt; collect = list.stream().collect(Collectors.groupingBy(Function.identity(), Collectors.counting()));System.out.println(collect);</code></pre><p>就列出这么几种，应该够用了 </p><p>转自：<a href="https://blog.csdn.net/qq_34203492/article/details/78561562" target="_blank" rel="noopener">https://blog.csdn.net/qq_34203492/article/details/78561562</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在实际开发中，经常会遇到需要找出(删除)一个list中某些元素的属性相同的元素，或者两个list中某些元素的属性相等的元素，这种方法很多，这里整理列出一些：&lt;br&gt;废话不说，上代码，有注释掉的你们自己看&lt;br&gt;
    
    </summary>
    
      <category term="java" scheme="http://codewey.com/categories/java/"/>
    
    
      <category term="java" scheme="http://codewey.com/tags/java/"/>
    
      <category term="基础" scheme="http://codewey.com/tags/%E5%9F%BA%E7%A1%80/"/>
    
  </entry>
  
</feed>
